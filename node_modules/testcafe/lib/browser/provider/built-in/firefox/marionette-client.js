'use strict';

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _net = require('net');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _promisifiedFunctions = require('../../../../utils/promisified-functions');

var _delay = require('../../../../utils/delay');

var _delay2 = _interopRequireDefault(_delay);

var _clientFunctions = require('../../utils/client-functions');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const CONNECTION_TIMEOUT = 30000;
const CONNECTION_RETRY_DELAY = 300;
const MAX_RESIZE_RETRY_COUNT = 2;
const HEADER_SEPARATOR = ':';

module.exports = class MarionetteClient {
    constructor(port = 2828, host = '127.0.0.1') {
        this.currentPacketNumber = 1;
        this.events = new _events2.default();
        this.port = port;
        this.host = host;
        this.socket = new _net.Socket();
        this.buffer = Buffer.alloc(0);
        this.getPacketPromise = _pinkie2.default.resolve();
        this.sendPacketPromise = _pinkie2.default.resolve();

        this.protocolInfo = {
            applicationType: '',
            marionetteProtocol: ''
        };

        this.sessionInfo = null;
    }

    _attemptToConnect(port, host) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this.socket.connect(port, host);

            var connectionPromise = _pinkie2.default.race([(0, _promisifyEvent2.default)(_this.socket, 'connect'), (0, _promisifyEvent2.default)(_this.socket, 'error')]);

            return yield connectionPromise.then(function () {
                return true;
            }).catch(function () {
                _this.socket.removeAllListeners('connect');
                return (0, _delay2.default)(CONNECTION_RETRY_DELAY);
            });
        })();
    }

    _connectSocket(port, host) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const connectionStartTime = Date.now();

            var connected = yield _this2._attemptToConnect(port, host);

            while (!connected && Date.now() - connectionStartTime < CONNECTION_TIMEOUT) connected = yield _this2._attemptToConnect(port, host);

            if (!connected) throw new Error('Unable to connect');

            _this2.socket.on('data', function (data) {
                return _this2._handleNewData(data);
            });
        })();
    }

    _writeSocket(message) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this3.socket.write(message)) yield (0, _promisifyEvent2.default)(_this3.socket, 'drain');
        })();
    }

    _handleNewData(data) {
        if (!data) return;

        this.buffer = Buffer.concat([this.buffer, data]);

        this.events.emit('new-data');
    }

    _getPacket() {
        var _this4 = this;

        this.getPacketPromise = this.getPacketPromise.then((0, _asyncToGenerator3.default)(function* () {
            var headerEndIndex = _this4.buffer.indexOf(HEADER_SEPARATOR);

            while (headerEndIndex < 0) {
                yield (0, _promisifyEvent2.default)(_this4.events, 'new-data');

                headerEndIndex = _this4.buffer.indexOf(HEADER_SEPARATOR);
            }

            var packet = {
                length: NaN,
                body: null
            };

            packet.length = parseInt(_this4.buffer.toString('utf8', 0, headerEndIndex), 10) || 0;

            var bodyStartIndex = headerEndIndex + HEADER_SEPARATOR.length;
            var bodyEndIndex = bodyStartIndex + packet.length;

            if (packet.length) {
                while (_this4.buffer.length < bodyEndIndex) yield (0, _promisifyEvent2.default)(_this4.events, 'new-data');

                packet.body = JSON.parse(_this4.buffer.toString('utf8', bodyStartIndex, bodyEndIndex));
            }

            _this4.buffer = _this4.buffer.slice(bodyEndIndex);

            return packet;
        }));

        return this.getPacketPromise;
    }

    _sendPacket(payload) {
        var _this5 = this;

        this.sendPacketPromise = this.sendPacketPromise.then((0, _asyncToGenerator3.default)(function* () {
            var body = [0, _this5.currentPacketNumber++, payload.command, payload.parameters];
            var serialized = (0, _stringify2.default)(body);
            var message = Buffer.byteLength(serialized, 'utf8') + HEADER_SEPARATOR + serialized;

            _this5._writeSocket(message);
        }));

        return this.sendPacketPromise;
    }

    _throwMarionetteError(error) {
        throw new Error(`${error.error}${error.message ? ': ' + error.message : ''}`);
    }

    _getResponse(packet) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var packetNumber = _this6.currentPacketNumber;

            yield _this6._sendPacket(packet);

            var responsePacket = yield _this6._getPacket();

            while (!responsePacket.body || responsePacket.body[1] !== packetNumber) responsePacket = yield _this6._getPacket();

            if (responsePacket.body[2]) _this6._throwMarionetteError(responsePacket.body[2]);

            return responsePacket.body[3];
        })();
    }

    connect() {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this7._connectSocket(_this7.port, _this7.host);

            var infoPacket = yield _this7._getPacket();

            _this7.protocolInfo = {
                applicationType: infoPacket.body.applicationType,
                marionetteProtocol: infoPacket.body.marionetteProtocol
            };

            _this7.sessionInfo = yield _this7._getResponse({ command: 'newSession' });
        })();
    }

    dispose() {
        this.socket.end();
        this.buffer = null;
    }

    executeScript(code) {
        var _this8 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this8._getResponse({ command: 'executeScript', parameters: { script: `return (${code})()` } });
        })();
    }

    takeScreenshot(path) {
        var _this9 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var screenshot = yield _this9._getResponse({ command: 'takeScreenshot' });

            yield (0, _promisifiedFunctions.writeFile)(path, screenshot.value, { encoding: 'base64' });
        })();
    }

    setWindowSize(width, height) {
        var _this10 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var _ref3 = yield _this10.executeScript(_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT),
                pageRect = _ref3.value;

            var attemptCounter = 0;

            while (attemptCounter++ < MAX_RESIZE_RETRY_COUNT && (pageRect.width !== width || pageRect.height !== height)) {
                var currentRect = yield _this10._getResponse({ command: 'getWindowRect' });

                yield _this10._getResponse({
                    command: 'setWindowRect',

                    parameters: {
                        x: currentRect.x,
                        y: currentRect.y,
                        width: width + (currentRect.width - pageRect.width),
                        height: height + (currentRect.height - pageRect.height)
                    }
                });

                var _ref4 = yield _this10.executeScript(_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

                pageRect = _ref4.value;
            }
        })();
    }

    quit() {
        var _this11 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this11._getResponse({ command: 'quit' });
        })();
    }
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2ZpcmVmb3gvbWFyaW9uZXR0ZS1jbGllbnQuanMiXSwibmFtZXMiOlsiQ09OTkVDVElPTl9USU1FT1VUIiwiQ09OTkVDVElPTl9SRVRSWV9ERUxBWSIsIk1BWF9SRVNJWkVfUkVUUllfQ09VTlQiLCJIRUFERVJfU0VQQVJBVE9SIiwibW9kdWxlIiwiZXhwb3J0cyIsIk1hcmlvbmV0dGVDbGllbnQiLCJjb25zdHJ1Y3RvciIsInBvcnQiLCJob3N0IiwiY3VycmVudFBhY2tldE51bWJlciIsImV2ZW50cyIsIkV2ZW50RW1pdHRlciIsInNvY2tldCIsIlNvY2tldCIsImJ1ZmZlciIsIkJ1ZmZlciIsImFsbG9jIiwiZ2V0UGFja2V0UHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwic2VuZFBhY2tldFByb21pc2UiLCJwcm90b2NvbEluZm8iLCJhcHBsaWNhdGlvblR5cGUiLCJtYXJpb25ldHRlUHJvdG9jb2wiLCJzZXNzaW9uSW5mbyIsIl9hdHRlbXB0VG9Db25uZWN0IiwiY29ubmVjdCIsImNvbm5lY3Rpb25Qcm9taXNlIiwicmFjZSIsInRoZW4iLCJjYXRjaCIsInJlbW92ZUFsbExpc3RlbmVycyIsIl9jb25uZWN0U29ja2V0IiwiY29ubmVjdGlvblN0YXJ0VGltZSIsIkRhdGUiLCJub3ciLCJjb25uZWN0ZWQiLCJFcnJvciIsIm9uIiwiX2hhbmRsZU5ld0RhdGEiLCJkYXRhIiwiX3dyaXRlU29ja2V0IiwibWVzc2FnZSIsIndyaXRlIiwiY29uY2F0IiwiZW1pdCIsIl9nZXRQYWNrZXQiLCJoZWFkZXJFbmRJbmRleCIsImluZGV4T2YiLCJwYWNrZXQiLCJsZW5ndGgiLCJOYU4iLCJib2R5IiwicGFyc2VJbnQiLCJ0b1N0cmluZyIsImJvZHlTdGFydEluZGV4IiwiYm9keUVuZEluZGV4IiwiSlNPTiIsInBhcnNlIiwic2xpY2UiLCJfc2VuZFBhY2tldCIsInBheWxvYWQiLCJjb21tYW5kIiwicGFyYW1ldGVycyIsInNlcmlhbGl6ZWQiLCJieXRlTGVuZ3RoIiwiX3Rocm93TWFyaW9uZXR0ZUVycm9yIiwiZXJyb3IiLCJfZ2V0UmVzcG9uc2UiLCJwYWNrZXROdW1iZXIiLCJyZXNwb25zZVBhY2tldCIsImluZm9QYWNrZXQiLCJkaXNwb3NlIiwiZW5kIiwiZXhlY3V0ZVNjcmlwdCIsImNvZGUiLCJzY3JpcHQiLCJ0YWtlU2NyZWVuc2hvdCIsInBhdGgiLCJzY3JlZW5zaG90IiwidmFsdWUiLCJlbmNvZGluZyIsInNldFdpbmRvd1NpemUiLCJ3aWR0aCIsImhlaWdodCIsIkdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCIsInBhZ2VSZWN0IiwiYXR0ZW1wdENvdW50ZXIiLCJjdXJyZW50UmVjdCIsIngiLCJ5IiwicXVpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFHQSxNQUFNQSxxQkFBeUIsS0FBL0I7QUFDQSxNQUFNQyx5QkFBeUIsR0FBL0I7QUFDQSxNQUFNQyx5QkFBeUIsQ0FBL0I7QUFDQSxNQUFNQyxtQkFBeUIsR0FBL0I7O0FBRUFDLE9BQU9DLE9BQVAsR0FBaUIsTUFBTUMsZ0JBQU4sQ0FBdUI7QUFDcENDLGdCQUFhQyxPQUFPLElBQXBCLEVBQTBCQyxPQUFPLFdBQWpDLEVBQThDO0FBQzFDLGFBQUtDLG1CQUFMLEdBQTJCLENBQTNCO0FBQ0EsYUFBS0MsTUFBTCxHQUEyQixJQUFJQyxnQkFBSixFQUEzQjtBQUNBLGFBQUtKLElBQUwsR0FBMkJBLElBQTNCO0FBQ0EsYUFBS0MsSUFBTCxHQUEyQkEsSUFBM0I7QUFDQSxhQUFLSSxNQUFMLEdBQTJCLElBQUlDLFdBQUosRUFBM0I7QUFDQSxhQUFLQyxNQUFMLEdBQTJCQyxPQUFPQyxLQUFQLENBQWEsQ0FBYixDQUEzQjtBQUNBLGFBQUtDLGdCQUFMLEdBQTJCQyxpQkFBUUMsT0FBUixFQUEzQjtBQUNBLGFBQUtD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LFlBQVlMLEtBQVosR0FBb0JHLFNBQVNILEtBQXRDLENBSEE7QUFJUkMsZ0NBQVFBLFVBQVVJLFlBQVlKLE1BQVosR0FBcUJFLFNBQVNGLE1BQXhDO0FBSkE7QUFIUSxpQkFBbEIsQ0FBTjs7QUFIMEcsNEJBY25GLE1BQU0sUUFBS1YsYUFBTCxDQUFtQlcsa0RBQW5CLENBZDZFOztBQWNoR0Msd0JBZGdHLFNBY3ZHTixLQWR1RztBQWU3RztBQW5CK0I7QUFvQm5DOztBQUVLVyxRQUFOLEdBQWM7QUFBQTs7QUFBQTtBQUNWLGtCQUFNLFFBQUt2QixZQUFMLENBQWtCLEVBQUVOLFNBQVMsTUFBWCxFQUFsQixDQUFOO0FBRFU7QUFFYjtBQXRMbUMsQ0FBeEMiLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9idWlsdC1pbi9maXJlZm94L21hcmlvbmV0dGUtY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCB7IFNvY2tldCB9IGZyb20gJ25ldCc7XG5pbXBvcnQgcHJvbWlzaWZ5RXZlbnQgZnJvbSAncHJvbWlzaWZ5LWV2ZW50JztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IHdyaXRlRmlsZSB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL3Byb21pc2lmaWVkLWZ1bmN0aW9ucyc7XG5pbXBvcnQgZGVsYXkgZnJvbSAnLi4vLi4vLi4vLi4vdXRpbHMvZGVsYXknO1xuaW1wb3J0IHsgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIH0gZnJvbSAnLi4vLi4vdXRpbHMvY2xpZW50LWZ1bmN0aW9ucyc7XG5cblxuY29uc3QgQ09OTkVDVElPTl9USU1FT1VUICAgICA9IDMwMDAwO1xuY29uc3QgQ09OTkVDVElPTl9SRVRSWV9ERUxBWSA9IDMwMDtcbmNvbnN0IE1BWF9SRVNJWkVfUkVUUllfQ09VTlQgPSAyO1xuY29uc3QgSEVBREVSX1NFUEFSQVRPUiAgICAgICA9ICc6JztcblxubW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBNYXJpb25ldHRlQ2xpZW50IHtcbiAgICBjb25zdHJ1Y3RvciAocG9ydCA9IDI4MjgsIGhvc3QgPSAnMTI3LjAuMC4xJykge1xuICAgICAgICB0aGlzLmN1cnJlbnRQYWNrZXROdW1iZXIgPSAxO1xuICAgICAgICB0aGlzLmV2ZW50cyAgICAgICAgICAgICAgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgICAgIHRoaXMucG9ydCAgICAgICAgICAgICAgICA9IHBvcnQ7XG4gICAgICAgIHRoaXMuaG9zdCAgICAgICAgICAgICAgICA9IGhvc3Q7XG4gICAgICAgIHRoaXMuc29ja2V0ICAgICAgICAgICAgICA9IG5ldyBTb2NrZXQoKTtcbiAgICAgICAgdGhpcy5idWZmZXIgICAgICAgICAgICAgID0gQnVmZmVyLmFsbG9jKDApO1xuICAgICAgICB0aGlzLmdldFBhY2tldFByb21pc2UgICAgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgdGhpcy5zZW5kUGFja2V0UHJvbWlzZSAgID0gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgdGhpcy5wcm90b2NvbEluZm8gPSB7XG4gICAgICAgICAgICBhcHBsaWNhdGlvblR5cGU6ICAgICcnLFxuICAgICAgICAgICAgbWFyaW9uZXR0ZVByb3RvY29sOiAnJyxcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNlc3Npb25JbmZvID0gbnVsbDtcbiAgICB9XG5cbiAgICBhc3luYyBfYXR0ZW1wdFRvQ29ubmVjdCAocG9ydCwgaG9zdCkge1xuICAgICAgICB0aGlzLnNvY2tldC5jb25uZWN0KHBvcnQsIGhvc3QpO1xuXG4gICAgICAgIHZhciBjb25uZWN0aW9uUHJvbWlzZSA9IFByb21pc2UucmFjZShbXG4gICAgICAgICAgICBwcm9taXNpZnlFdmVudCh0aGlzLnNvY2tldCwgJ2Nvbm5lY3QnKSxcbiAgICAgICAgICAgIHByb21pc2lmeUV2ZW50KHRoaXMuc29ja2V0LCAnZXJyb3InKVxuICAgICAgICBdKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgY29ubmVjdGlvblByb21pc2VcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRydWUpXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycygnY29ubmVjdCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBkZWxheShDT05ORUNUSU9OX1JFVFJZX0RFTEFZKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIF9jb25uZWN0U29ja2V0IChwb3J0LCBob3N0KSB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgICAgIHZhciBjb25uZWN0ZWQgPSBhd2FpdCB0aGlzLl9hdHRlbXB0VG9Db25uZWN0KHBvcnQsIGhvc3QpO1xuXG4gICAgICAgIHdoaWxlICghY29ubmVjdGVkICYmIERhdGUubm93KCkgLSBjb25uZWN0aW9uU3RhcnRUaW1lIDwgQ09OTkVDVElPTl9USU1FT1VUKVxuICAgICAgICAgICAgY29ubmVjdGVkID0gYXdhaXQgdGhpcy5fYXR0ZW1wdFRvQ29ubmVjdChwb3J0LCBob3N0KTtcblxuICAgICAgICBpZiAoIWNvbm5lY3RlZClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIGNvbm5lY3QnKTtcblxuICAgICAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIGRhdGEgPT4gdGhpcy5faGFuZGxlTmV3RGF0YShkYXRhKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3dyaXRlU29ja2V0IChtZXNzYWdlKSB7XG4gICAgICAgIGlmICghdGhpcy5zb2NrZXQud3JpdGUobWVzc2FnZSkpXG4gICAgICAgICAgICBhd2FpdCBwcm9taXNpZnlFdmVudCh0aGlzLnNvY2tldCwgJ2RyYWluJyk7XG4gICAgfVxuXG4gICAgX2hhbmRsZU5ld0RhdGEgKGRhdGEpIHtcbiAgICAgICAgaWYgKCFkYXRhKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbdGhpcy5idWZmZXIsIGRhdGFdKTtcblxuICAgICAgICB0aGlzLmV2ZW50cy5lbWl0KCduZXctZGF0YScpO1xuICAgIH1cblxuICAgIF9nZXRQYWNrZXQgKCkge1xuICAgICAgICB0aGlzLmdldFBhY2tldFByb21pc2UgPSB0aGlzLmdldFBhY2tldFByb21pc2UudGhlbihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICB2YXIgaGVhZGVyRW5kSW5kZXggPSB0aGlzLmJ1ZmZlci5pbmRleE9mKEhFQURFUl9TRVBBUkFUT1IpO1xuXG4gICAgICAgICAgICB3aGlsZSAoaGVhZGVyRW5kSW5kZXggPCAwKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcHJvbWlzaWZ5RXZlbnQodGhpcy5ldmVudHMsICduZXctZGF0YScpO1xuXG4gICAgICAgICAgICAgICAgaGVhZGVyRW5kSW5kZXggPSB0aGlzLmJ1ZmZlci5pbmRleE9mKEhFQURFUl9TRVBBUkFUT1IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgcGFja2V0ID0ge1xuICAgICAgICAgICAgICAgIGxlbmd0aDogTmFOLFxuICAgICAgICAgICAgICAgIGJvZHk6ICAgbnVsbFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcGFja2V0Lmxlbmd0aCA9IHBhcnNlSW50KHRoaXMuYnVmZmVyLnRvU3RyaW5nKCd1dGY4JywgMCwgaGVhZGVyRW5kSW5kZXgpLCAxMCkgfHwgMDtcblxuICAgICAgICAgICAgdmFyIGJvZHlTdGFydEluZGV4ID0gaGVhZGVyRW5kSW5kZXggKyBIRUFERVJfU0VQQVJBVE9SLmxlbmd0aDtcbiAgICAgICAgICAgIHZhciBib2R5RW5kSW5kZXggICA9IGJvZHlTdGFydEluZGV4ICsgcGFja2V0Lmxlbmd0aDtcblxuICAgICAgICAgICAgaWYgKHBhY2tldC5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5idWZmZXIubGVuZ3RoIDwgYm9keUVuZEluZGV4KVxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBwcm9taXNpZnlFdmVudCh0aGlzLmV2ZW50cywgJ25ldy1kYXRhJyk7XG5cbiAgICAgICAgICAgICAgICBwYWNrZXQuYm9keSA9IEpTT04ucGFyc2UodGhpcy5idWZmZXIudG9TdHJpbmcoJ3V0ZjgnLCBib2R5U3RhcnRJbmRleCwgYm9keUVuZEluZGV4KSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc2xpY2UoYm9keUVuZEluZGV4KTtcblxuICAgICAgICAgICAgcmV0dXJuIHBhY2tldDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFja2V0UHJvbWlzZTtcbiAgICB9XG5cbiAgICBfc2VuZFBhY2tldCAocGF5bG9hZCkge1xuICAgICAgICB0aGlzLnNlbmRQYWNrZXRQcm9taXNlID0gdGhpcy5zZW5kUGFja2V0UHJvbWlzZS50aGVuKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHZhciBib2R5ICAgICAgID0gWzAsIHRoaXMuY3VycmVudFBhY2tldE51bWJlcisrLCBwYXlsb2FkLmNvbW1hbmQsIHBheWxvYWQucGFyYW1ldGVyc107XG4gICAgICAgICAgICB2YXIgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KGJvZHkpO1xuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgICAgPSBCdWZmZXIuYnl0ZUxlbmd0aChzZXJpYWxpemVkLCAndXRmOCcpICsgSEVBREVSX1NFUEFSQVRPUiArIHNlcmlhbGl6ZWQ7XG5cbiAgICAgICAgICAgIHRoaXMuX3dyaXRlU29ja2V0KG1lc3NhZ2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kUGFja2V0UHJvbWlzZTtcbiAgICB9XG5cbiAgICBfdGhyb3dNYXJpb25ldHRlRXJyb3IgKGVycm9yKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtlcnJvci5lcnJvcn0ke2Vycm9yLm1lc3NhZ2UgPyAnOiAnICsgZXJyb3IubWVzc2FnZSA6ICcnfWApO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRSZXNwb25zZSAocGFja2V0KSB7XG4gICAgICAgIHZhciBwYWNrZXROdW1iZXIgPSB0aGlzLmN1cnJlbnRQYWNrZXROdW1iZXI7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fc2VuZFBhY2tldChwYWNrZXQpO1xuXG4gICAgICAgIHZhciByZXNwb25zZVBhY2tldCA9IGF3YWl0IHRoaXMuX2dldFBhY2tldCgpO1xuXG4gICAgICAgIHdoaWxlICghcmVzcG9uc2VQYWNrZXQuYm9keSB8fCByZXNwb25zZVBhY2tldC5ib2R5WzFdICE9PSBwYWNrZXROdW1iZXIpXG4gICAgICAgICAgICByZXNwb25zZVBhY2tldCA9IGF3YWl0IHRoaXMuX2dldFBhY2tldCgpO1xuXG4gICAgICAgIGlmIChyZXNwb25zZVBhY2tldC5ib2R5WzJdKVxuICAgICAgICAgICAgdGhpcy5fdGhyb3dNYXJpb25ldHRlRXJyb3IocmVzcG9uc2VQYWNrZXQuYm9keVsyXSk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlUGFja2V0LmJvZHlbM107XG4gICAgfVxuXG4gICAgYXN5bmMgY29ubmVjdCAoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2Nvbm5lY3RTb2NrZXQodGhpcy5wb3J0LCB0aGlzLmhvc3QpO1xuXG4gICAgICAgIHZhciBpbmZvUGFja2V0ID0gYXdhaXQgdGhpcy5fZ2V0UGFja2V0KCk7XG5cbiAgICAgICAgdGhpcy5wcm90b2NvbEluZm8gPSB7XG4gICAgICAgICAgICBhcHBsaWNhdGlvblR5cGU6ICAgIGluZm9QYWNrZXQuYm9keS5hcHBsaWNhdGlvblR5cGUsXG4gICAgICAgICAgICBtYXJpb25ldHRlUHJvdG9jb2w6IGluZm9QYWNrZXQuYm9keS5tYXJpb25ldHRlUHJvdG9jb2xcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnNlc3Npb25JbmZvID0gYXdhaXQgdGhpcy5fZ2V0UmVzcG9uc2UoeyBjb21tYW5kOiAnbmV3U2Vzc2lvbicgfSk7XG4gICAgfVxuXG4gICAgZGlzcG9zZSAoKSB7XG4gICAgICAgIHRoaXMuc29ja2V0LmVuZCgpO1xuICAgICAgICB0aGlzLmJ1ZmZlciA9IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZVNjcmlwdCAoY29kZSkge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0UmVzcG9uc2UoeyBjb21tYW5kOiAnZXhlY3V0ZVNjcmlwdCcsIHBhcmFtZXRlcnM6IHsgc2NyaXB0OiBgcmV0dXJuICgke2NvZGV9KSgpYCB9IH0pO1xuICAgIH1cblxuICAgIGFzeW5jIHRha2VTY3JlZW5zaG90IChwYXRoKSB7XG4gICAgICAgIHZhciBzY3JlZW5zaG90ID0gYXdhaXQgdGhpcy5fZ2V0UmVzcG9uc2UoeyBjb21tYW5kOiAndGFrZVNjcmVlbnNob3QnIH0pO1xuXG4gICAgICAgIGF3YWl0IHdyaXRlRmlsZShwYXRoLCBzY3JlZW5zaG90LnZhbHVlLCB7IGVuY29kaW5nOiAnYmFzZTY0JyB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBzZXRXaW5kb3dTaXplICh3aWR0aCwgaGVpZ2h0KSB7XG4gICAgICAgIHZhciB7IHZhbHVlOiBwYWdlUmVjdCB9ID0gYXdhaXQgdGhpcy5leGVjdXRlU2NyaXB0KEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCk7XG4gICAgICAgIHZhciBhdHRlbXB0Q291bnRlciAgICAgID0gMDtcblxuICAgICAgICB3aGlsZSAoYXR0ZW1wdENvdW50ZXIrKyA8IE1BWF9SRVNJWkVfUkVUUllfQ09VTlQgJiYgKHBhZ2VSZWN0LndpZHRoICE9PSB3aWR0aCB8fCBwYWdlUmVjdC5oZWlnaHQgIT09IGhlaWdodCkpIHtcbiAgICAgICAgICAgIHZhciBjdXJyZW50UmVjdCA9IGF3YWl0IHRoaXMuX2dldFJlc3BvbnNlKHsgY29tbWFuZDogJ2dldFdpbmRvd1JlY3QnIH0pO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9nZXRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgY29tbWFuZDogJ3NldFdpbmRvd1JlY3QnLFxuXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgICAgICAgICB4OiAgICAgIGN1cnJlbnRSZWN0LngsXG4gICAgICAgICAgICAgICAgICAgIHk6ICAgICAgY3VycmVudFJlY3QueSxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6ICB3aWR0aCArIChjdXJyZW50UmVjdC53aWR0aCAtIHBhZ2VSZWN0LndpZHRoKSxcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQgKyAoY3VycmVudFJlY3QuaGVpZ2h0IC0gcGFnZVJlY3QuaGVpZ2h0KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAoeyB2YWx1ZTogcGFnZVJlY3QgfSA9IGF3YWl0IHRoaXMuZXhlY3V0ZVNjcmlwdChHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHF1aXQgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLl9nZXRSZXNwb25zZSh7IGNvbW1hbmQ6ICdxdWl0JyB9KTtcbiAgICB9XG59O1xuXG4iXX0=
