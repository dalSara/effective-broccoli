'use strict';

exports.__esModule = true;

var _symbol = require('babel-runtime/core-js/symbol');

var _symbol2 = _interopRequireDefault(_symbol);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _indentString = require('indent-string');

var _indentString2 = _interopRequireDefault(_indentString);

var _lodash = require('lodash');

var _momentLoader = require('../utils/moment-loader');

var _momentLoader2 = _interopRequireDefault(_momentLoader);

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _string = require('../utils/string');

var _getViewportWidth = require('../utils/get-viewport-width');

var _getViewportWidth2 = _interopRequireDefault(_getViewportWidth);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// NOTE: we should not expose internal state to
// the plugin, to avoid accidental rewrites.
// Therefore we use symbols to store them.

/*global Symbol*/
var stream = (0, _symbol2.default)();
var wordWrapEnabled = (0, _symbol2.default)();
var indent = (0, _symbol2.default)();
var errorDecorator = (0, _symbol2.default)();

class ReporterPluginHost {
    constructor(plugin, outStream) {
        this[stream] = outStream || process.stdout;
        this[wordWrapEnabled] = false;
        this[indent] = 0;

        var useColors = this[stream] === process.stdout && _chalk2.default.enabled && !plugin.noColors;

        this.chalk = new _chalk2.default.constructor({ enabled: useColors });
        this.moment = _momentLoader2.default;
        this.viewportWidth = (0, _getViewportWidth2.default)(this[stream]);

        this.symbols = _osFamily2.default.win ? { ok: '√', err: '×' } : { ok: '✓', err: '✖' };

        (0, _lodash.assignIn)(this, plugin);

        this[errorDecorator] = this.createErrorDecorator();
    }

    // Error decorator
    createErrorDecorator() {
        return {
            'span user-agent': str => this.chalk.grey(str),

            'span subtitle': str => `- ${this.chalk.bold.red(str)} -`,
            'div message': str => this.chalk.bold.red(str),

            'div screenshot-info': _lodash.identity,
            'a screenshot-path': str => this.chalk.grey.underline(str),

            'code': _lodash.identity,

            'span syntax-string': str => this.chalk.green(str),
            'span syntax-punctuator': str => this.chalk.grey(str),
            'span syntax-keyword': str => this.chalk.cyan(str),
            'span syntax-number': str => this.chalk.magenta(str),
            'span syntax-regex': str => this.chalk.magenta(str),
            'span syntax-comment': str => this.chalk.grey.bold(str),
            'span syntax-invalid': str => this.chalk.inverse(str),

            'div code-frame': _lodash.identity,
            'div code-line': str => str + '\n',
            'div code-line-last': _lodash.identity,
            'div code-line-num': str => `   ${str} |`,
            'div code-line-num-base': str => this.chalk.bgRed(` > ${str} `) + '|',
            'div code-line-src': _lodash.identity,

            'div stack': str => '\n\n' + str,
            'div stack-line': str => str + '\n',
            'div stack-line-last': _lodash.identity,
            'div stack-line-name': str => `   at ${this.chalk.bold(str)}`,
            'div stack-line-location': str => ` (${this.chalk.grey.underline(str)})`,

            'strong': str => this.chalk.bold(str),
            'a': str => `"${this.chalk.underline(str)}"`
        };
    }

    // String helpers
    indentString(str, indentVal) {
        return (0, _indentString2.default)(str, ' ', indentVal);
    }

    wordWrap(str, indentVal, width) {
        return (0, _string.wordWrap)(str, indentVal, width);
    }

    escapeHtml(str) {
        return (0, _lodash.escape)(str);
    }

    formatError(err, prefix = '') {
        var prefixLengthWithoutColors = (0, _string.removeTTYColors)(prefix).length;
        var maxMsgLength = this.viewportWidth - this[indent] - prefixLengthWithoutColors;
        var msg = err.formatMessage(this[errorDecorator], maxMsgLength);

        if (this[wordWrapEnabled]) msg = this.wordWrap(msg, prefixLengthWithoutColors, maxMsgLength);else msg = this.indentString(msg, prefixLengthWithoutColors);

        return prefix + msg.substr(prefixLengthWithoutColors);
    }

    // Writing helpers
    newline() {
        this[stream].write('\n');

        return this;
    }

    write(text) {
        if (this[wordWrapEnabled]) text = this.wordWrap(text, this[indent], this.viewportWidth);else text = this.indentString(text, this[indent]);

        this[stream].write(text);

        return this;
    }

    useWordWrap(use) {
        this[wordWrapEnabled] = use;

        return this;
    }

    setIndent(val) {
        this[indent] = val;

        return this;
    }

    // Abstract methods implemented in plugin
    reportTaskStart() /* startTime, userAgents, testCount */{
        throw new Error('Not implemented');
    }

    reportFixtureStart() /* name, path */{
        throw new Error('Not implemented');
    }

    reportTestDone() /* name, testRunInfo */{
        throw new Error('Not implemented');
    }

    reportTaskDone() /* endTime, passed, warnings */{
        throw new Error('Not implemented');
    }
}
exports.default = ReporterPluginHost;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXBvcnRlci9wbHVnaW4taG9zdC5qcyJdLCJuYW1lcyI6WyJzdHJlYW0iLCJ3b3JkV3JhcEVuYWJsZWQiLCJpbmRlbnQiLCJlcnJvckRlY29yYXRvciIsIlJlcG9ydGVyUGx1Z2luSG9zdCIsImNvbnN0cnVjdG9yIiwicGx1Z2luIiwib3V0U3RyZWFtIiwicHJvY2VzcyIsInN0ZG91dCIsInVzZUNvbG9ycyIsImNoYWxrIiwiZW5hYmxlZCIsIm5vQ29sb3JzIiwibW9tZW50Iiwidmlld3BvcnRXaWR0aCIsInN5bWJvbHMiLCJPUyIsIndpbiIsIm9rIiwiZXJyIiwiY3JlYXRlRXJyb3JEZWNvcmF0b3IiLCJzdHIiLCJncmV5IiwiYm9sZCIsInJlZCIsImlkZW50aXR5IiwidW5kZXJsaW5lIiwiZ3JlZW4iLCJjeWFuIiwibWFnZW50YSIsImludmVyc2UiLCJiZ1JlZCIsImluZGVudFN0cmluZyIsImluZGVudFZhbCIsIndvcmRXcmFwIiwid2lkdGgiLCJlc2NhcGVIdG1sIiwiZm9ybWF0RXJyb3IiLCJwcmVmaXgiLCJwcmVmaXhMZW5ndGhXaXRob3V0Q29sb3JzIiwibGVuZ3RoIiwibWF4TXNnTGVuZ3RoIiwibXNnIiwiZm9ybWF0TWVzc2FnZSIsInN1YnN0ciIsIm5ld2xpbmUiLCJ3cml0ZSIsInRleHQiLCJ1c2VXb3JkV3JhcCIsInVzZSIsInNldEluZGVudCIsInZhbCIsInJlcG9ydFRhc2tTdGFydCIsIkVycm9yIiwicmVwb3J0Rml4dHVyZVN0YXJ0IiwicmVwb3J0VGVzdERvbmUiLCJyZXBvcnRUYXNrRG9uZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7Ozs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxJQUFJQSxTQUFrQix1QkFBdEI7QUFDQSxJQUFJQyxrQkFBa0IsdUJBQXRCO0FBQ0EsSUFBSUMsU0FBa0IsdUJBQXRCO0FBQ0EsSUFBSUMs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QUFYLENBQWhCO0FBQ0g7O0FBR0Q7QUFDQU0sY0FBVztBQUNQLGFBQUs5QyxNQUFMLEVBQWErQyxLQUFiLENBQW1CLElBQW5COztBQUVBLGVBQU8sSUFBUDtBQUNIOztBQUVEQSxVQUFPQyxJQUFQLEVBQWE7QUFDVCxZQUFJLEtBQUsvQyxlQUFMLENBQUosRUFDSStDLE9BQU8sS0FBS2IsUUFBTCxDQUFjYSxJQUFkLEVBQW9CLEtBQUs5QyxNQUFMLENBQXBCLEVBQWtDLEtBQUthLGFBQXZDLENBQVAsQ0FESixLQUdJaUMsT0FBTyxLQUFLZixZQUFMLENBQWtCZSxJQUFsQixFQUF3QixLQUFLOUMsTUFBTCxDQUF4QixDQUFQOztBQUVKLGFBQUtGLE1BQUwsRUFBYStDLEtBQWIsQ0FBbUJDLElBQW5COztBQUVBLGVBQU8sSUFBUDtBQUNIOztBQUVEQyxnQkFBYUMsR0FBYixFQUFrQjtBQUNkLGFBQUtqRCxlQUFMLElBQXdCaUQsR0FBeEI7O0FBRUEsZUFBTyxJQUFQO0FBQ0g7O0FBRURDLGNBQVdDLEdBQVgsRUFBZ0I7QUFDWixhQUFLbEQsTUFBTCxJQUFla0QsR0FBZjs7QUFFQSxlQUFPLElBQVA7QUFDSDs7QUFHRDtBQUNBQyxzQkFBaUIsc0NBQXdDO0FBQ3JELGNBQU0sSUFBSUMsS0FBSixDQUFVLGlCQUFWLENBQU47QUFDSDs7QUFFREMseUJBQW9CLGdCQUFrQjtBQUNsQyxjQUFNLElBQUlELEtBQUosQ0FBVSxpQkFBVixDQUFOO0FBQ0g7O0FBRURFLHFCQUFnQix1QkFBeUI7QUFDckMsY0FBTSxJQUFJRixLQUFKLENBQVUsaUJBQVYsQ0FBTjtBQUNIOztBQUVERyxxQkFBZ0IsK0JBQWlDO0FBQzdDLGNBQU0sSUFBSUgsS0FBSixDQUFVLGlCQUFWLENBQU47QUFDSDtBQXJJbUM7a0JBQW5CbEQsa0IiLCJmaWxlIjoicmVwb3J0ZXIvcGx1Z2luLWhvc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IGluZGVudFN0cmluZyBmcm9tICdpbmRlbnQtc3RyaW5nJztcbmltcG9ydCB7IGlkZW50aXR5LCBlc2NhcGUgYXMgZXNjYXBlSHRtbCwgYXNzaWduSW4gfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IG1vbWVudCBmcm9tICcuLi91dGlscy9tb21lbnQtbG9hZGVyJztcbmltcG9ydCBPUyBmcm9tICdvcy1mYW1pbHknO1xuaW1wb3J0IHsgd29yZFdyYXAsIHJlbW92ZVRUWUNvbG9ycyB9IGZyb20gJy4uL3V0aWxzL3N0cmluZyc7XG5pbXBvcnQgZ2V0Vmlld3BvcnRXaWR0aCBmcm9tICcuLi91dGlscy9nZXQtdmlld3BvcnQtd2lkdGgnO1xuXG4vLyBOT1RFOiB3ZSBzaG91bGQgbm90IGV4cG9zZSBpbnRlcm5hbCBzdGF0ZSB0b1xuLy8gdGhlIHBsdWdpbiwgdG8gYXZvaWQgYWNjaWRlbnRhbCByZXdyaXRlcy5cbi8vIFRoZXJlZm9yZSB3ZSB1c2Ugc3ltYm9scyB0byBzdG9yZSB0aGVtLlxuXG4vKmdsb2JhbCBTeW1ib2wqL1xudmFyIHN0cmVhbSAgICAgICAgICA9IFN5bWJvbCgpO1xudmFyIHdvcmRXcmFwRW5hYmxlZCA9IFN5bWJvbCgpO1xudmFyIGluZGVudCAgICAgICAgICA9IFN5bWJvbCgpO1xudmFyIGVycm9yRGVjb3JhdG9yICA9IFN5bWJvbCgpO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZXBvcnRlclBsdWdpbkhvc3Qge1xuICAgIGNvbnN0cnVjdG9yIChwbHVnaW4sIG91dFN0cmVhbSkge1xuICAgICAgICB0aGlzW3N0cmVhbV0gICAgICAgICAgPSBvdXRTdHJlYW0gfHwgcHJvY2Vzcy5zdGRvdXQ7XG4gICAgICAgIHRoaXNbd29yZFdyYXBFbmFibGVkXSA9IGZhbHNlO1xuICAgICAgICB0aGlzW2luZGVudF0gICAgICAgICAgPSAwO1xuXG4gICAgICAgIHZhciB1c2VDb2xvcnMgPSB0aGlzW3N0cmVhbV0gPT09IHByb2Nlc3Muc3Rkb3V0ICYmIGNoYWxrLmVuYWJsZWQgJiYgIXBsdWdpbi5ub0NvbG9ycztcblxuICAgICAgICB0aGlzLmNoYWxrICAgICAgICAgPSBuZXcgY2hhbGsuY29uc3RydWN0b3IoeyBlbmFibGVkOiB1c2VDb2xvcnMgfSk7XG4gICAgICAgIHRoaXMubW9tZW50ICAgICAgICA9IG1vbWVudDtcbiAgICAgICAgdGhpcy52aWV3cG9ydFdpZHRoID0gZ2V0Vmlld3BvcnRXaWR0aCh0aGlzW3N0cmVhbV0pO1xuXG4gICAgICAgIHRoaXMuc3ltYm9scyA9IE9TLndpbiA/XG4gICAgICAgICAgICB7IG9rOiAn4oiaJywgZXJyOiAnw5cnIH0gOlxuICAgICAgICAgICAgeyBvazogJ+KckycsIGVycjogJ+KclicgfTtcblxuICAgICAgICBhc3NpZ25Jbih0aGlzLCBwbHVnaW4pO1xuXG4gICAgICAgIHRoaXNbZXJyb3JEZWNvcmF0b3JdID0gdGhpcy5jcmVhdGVFcnJvckRlY29yYXRvcigpO1xuICAgIH1cblxuICAgIC8vIEVycm9yIGRlY29yYXRvclxuICAgIGNyZWF0ZUVycm9yRGVjb3JhdG9yICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICdzcGFuIHVzZXItYWdlbnQnOiBzdHIgPT4gdGhpcy5jaGFsay5ncmV5KHN0ciksXG5cbiAgICAgICAgICAgICdzcGFuIHN1YnRpdGxlJzogc3RyID0+IGAtICR7dGhpcy5jaGFsay5ib2xkLnJlZChzdHIpfSAtYCxcbiAgICAgICAgICAgICdkaXYgbWVzc2FnZSc6ICAgc3RyID0+IHRoaXMuY2hhbGsuYm9sZC5yZWQoc3RyKSxcblxuICAgICAgICAgICAgJ2RpdiBzY3JlZW5zaG90LWluZm8nOiBpZGVudGl0eSxcbiAgICAgICAgICAgICdhIHNjcmVlbnNob3QtcGF0aCc6ICAgc3RyID0+IHRoaXMuY2hhbGsuZ3JleS51bmRlcmxpbmUoc3RyKSxcblxuICAgICAgICAgICAgJ2NvZGUnOiBpZGVudGl0eSxcblxuICAgICAgICAgICAgJ3NwYW4gc3ludGF4LXN0cmluZyc6ICAgICBzdHIgPT4gdGhpcy5jaGFsay5ncmVlbihzdHIpLFxuICAgICAgICAgICAgJ3NwYW4gc3ludGF4LXB1bmN0dWF0b3InOiBzdHIgPT4gdGhpcy5jaGFsay5ncmV5KHN0ciksXG4gICAgICAgICAgICAnc3BhbiBzeW50YXgta2V5d29yZCc6ICAgIHN0ciA9PiB0aGlzLmNoYWxrLmN5YW4oc3RyKSxcbiAgICAgICAgICAgICdzcGFuIHN5bnRheC1udW1iZXInOiAgICAgc3RyID0+IHRoaXMuY2hhbGsubWFnZW50YShzdHIpLFxuICAgICAgICAgICAgJ3NwYW4gc3ludGF4LXJlZ2V4JzogICAgICBzdHIgPT4gdGhpcy5jaGFsay5tYWdlbnRhKHN0ciksXG4gICAgICAgICAgICAnc3BhbiBzeW50YXgtY29tbWVudCc6ICAgIHN0ciA9PiB0aGlzLmNoYWxrLmdyZXkuYm9sZChzdHIpLFxuICAgICAgICAgICAgJ3NwYW4gc3ludGF4LWludmFsaWQnOiAgICBzdHIgPT4gdGhpcy5jaGFsay5pbnZlcnNlKHN0ciksXG5cbiAgICAgICAgICAgICdkaXYgY29kZS1mcmFtZSc6ICAgICAgICAgaWRlbnRpdHksXG4gICAgICAgICAgICAnZGl2IGNvZGUtbGluZSc6ICAgICAgICAgIHN0ciA9PiBzdHIgKyAnXFxuJyxcbiAgICAgICAgICAgICdkaXYgY29kZS1saW5lLWxhc3QnOiAgICAgaWRlbnRpdHksXG4gICAgICAgICAgICAnZGl2IGNvZGUtbGluZS1udW0nOiAgICAgIHN0ciA9PiBgICAgJHtzdHJ9IHxgLFxuICAgICAgICAgICAgJ2RpdiBjb2RlLWxpbmUtbnVtLWJhc2UnOiBzdHIgPT4gdGhpcy5jaGFsay5iZ1JlZChgID4gJHtzdHJ9IGApICsgJ3wnLFxuICAgICAgICAgICAgJ2RpdiBjb2RlLWxpbmUtc3JjJzogICAgICBpZGVudGl0eSxcblxuICAgICAgICAgICAgJ2RpdiBzdGFjayc6ICAgICAgICAgICAgICAgc3RyID0+ICdcXG5cXG4nICsgc3RyLFxuICAgICAgICAgICAgJ2RpdiBzdGFjay1saW5lJzogICAgICAgICAgc3RyID0+IHN0ciArICdcXG4nLFxuICAgICAgICAgICAgJ2RpdiBzdGFjay1saW5lLWxhc3QnOiAgICAgaWRlbnRpdHksXG4gICAgICAgICAgICAnZGl2IHN0YWNrLWxpbmUtbmFtZSc6ICAgICBzdHIgPT4gYCAgIGF0ICR7dGhpcy5jaGFsay5ib2xkKHN0cil9YCxcbiAgICAgICAgICAgICdkaXYgc3RhY2stbGluZS1sb2NhdGlvbic6IHN0ciA9PiBgICgke3RoaXMuY2hhbGsuZ3JleS51bmRlcmxpbmUoc3RyKX0pYCxcblxuICAgICAgICAgICAgJ3N0cm9uZyc6IHN0ciA9PiB0aGlzLmNoYWxrLmJvbGQoc3RyKSxcbiAgICAgICAgICAgICdhJzogICAgICBzdHIgPT4gYFwiJHt0aGlzLmNoYWxrLnVuZGVybGluZShzdHIpfVwiYFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8vIFN0cmluZyBoZWxwZXJzXG4gICAgaW5kZW50U3RyaW5nIChzdHIsIGluZGVudFZhbCkge1xuICAgICAgICByZXR1cm4gaW5kZW50U3RyaW5nKHN0ciwgJyAnLCBpbmRlbnRWYWwpO1xuICAgIH1cblxuICAgIHdvcmRXcmFwIChzdHIsIGluZGVudFZhbCwgd2lkdGgpIHtcbiAgICAgICAgcmV0dXJuIHdvcmRXcmFwKHN0ciwgaW5kZW50VmFsLCB3aWR0aCk7XG4gICAgfVxuXG4gICAgZXNjYXBlSHRtbCAoc3RyKSB7XG4gICAgICAgIHJldHVybiBlc2NhcGVIdG1sKHN0cik7XG4gICAgfVxuXG4gICAgZm9ybWF0RXJyb3IgKGVyciwgcHJlZml4ID0gJycpIHtcbiAgICAgICAgdmFyIHByZWZpeExlbmd0aFdpdGhvdXRDb2xvcnMgPSByZW1vdmVUVFlDb2xvcnMocHJlZml4KS5sZW5ndGg7XG4gICAgICAgIHZhciBtYXhNc2dMZW5ndGggICAgICAgICAgICAgID0gdGhpcy52aWV3cG9ydFdpZHRoIC0gdGhpc1tpbmRlbnRdIC0gcHJlZml4TGVuZ3RoV2l0aG91dENvbG9ycztcbiAgICAgICAgdmFyIG1zZyAgICAgICAgICAgICAgICAgICAgICAgPSBlcnIuZm9ybWF0TWVzc2FnZSh0aGlzW2Vycm9yRGVjb3JhdG9yXSwgbWF4TXNnTGVuZ3RoKTtcblxuICAgICAgICBpZiAodGhpc1t3b3JkV3JhcEVuYWJsZWRdKVxuICAgICAgICAgICAgbXNnID0gdGhpcy53b3JkV3JhcChtc2csIHByZWZpeExlbmd0aFdpdGhvdXRDb2xvcnMsIG1heE1zZ0xlbmd0aCk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIG1zZyA9IHRoaXMuaW5kZW50U3RyaW5nKG1zZywgcHJlZml4TGVuZ3RoV2l0aG91dENvbG9ycyk7XG5cbiAgICAgICAgcmV0dXJuIHByZWZpeCArIG1zZy5zdWJzdHIocHJlZml4TGVuZ3RoV2l0aG91dENvbG9ycyk7XG4gICAgfVxuXG5cbiAgICAvLyBXcml0aW5nIGhlbHBlcnNcbiAgICBuZXdsaW5lICgpIHtcbiAgICAgICAgdGhpc1tzdHJlYW1dLndyaXRlKCdcXG4nKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB3cml0ZSAodGV4dCkge1xuICAgICAgICBpZiAodGhpc1t3b3JkV3JhcEVuYWJsZWRdKVxuICAgICAgICAgICAgdGV4dCA9IHRoaXMud29yZFdyYXAodGV4dCwgdGhpc1tpbmRlbnRdLCB0aGlzLnZpZXdwb3J0V2lkdGgpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0ZXh0ID0gdGhpcy5pbmRlbnRTdHJpbmcodGV4dCwgdGhpc1tpbmRlbnRdKTtcblxuICAgICAgICB0aGlzW3N0cmVhbV0ud3JpdGUodGV4dCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgdXNlV29yZFdyYXAgKHVzZSkge1xuICAgICAgICB0aGlzW3dvcmRXcmFwRW5hYmxlZF0gPSB1c2U7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgc2V0SW5kZW50ICh2YWwpIHtcbiAgICAgICAgdGhpc1tpbmRlbnRdID0gdmFsO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuXG4gICAgLy8gQWJzdHJhY3QgbWV0aG9kcyBpbXBsZW1lbnRlZCBpbiBwbHVnaW5cbiAgICByZXBvcnRUYXNrU3RhcnQgKC8qIHN0YXJ0VGltZSwgdXNlckFnZW50cywgdGVzdENvdW50ICovKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkJyk7XG4gICAgfVxuXG4gICAgcmVwb3J0Rml4dHVyZVN0YXJ0ICgvKiBuYW1lLCBwYXRoICovKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkJyk7XG4gICAgfVxuXG4gICAgcmVwb3J0VGVzdERvbmUgKC8qIG5hbWUsIHRlc3RSdW5JbmZvICovKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTm90IGltcGxlbWVudGVkJyk7XG4gICAgfVxuXG4gICAgcmVwb3J0VGFza0RvbmUgKC8qIGVuZFRpbWUsIHBhc3NlZCwgd2FybmluZ3MgKi8pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgaW1wbGVtZW50ZWQnKTtcbiAgICB9XG59XG4iXX0=
