'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _lodash = require('lodash');

var _correctFilePath = require('../utils/correct-file-path');

var _correctFilePath2 = _interopRequireDefault(_correctFilePath);

var _escapeUserAgent = require('../utils/escape-user-agent');

var _escapeUserAgent2 = _interopRequireDefault(_escapeUserAgent);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DATE_FORMAT = 'YYYY-MM-DD';
const TIME_FORMAT = 'HH-mm-ss';

const SCRENSHOT_EXTENTION = 'png';

const ERRORS_FOLDER = 'errors';

const PLACEHOLDERS = {
    DATE: '${DATE}',
    TIME: '${TIME}',
    TEST_INDEX: '${TEST_INDEX}',
    FILE_INDEX: '${FILE_INDEX}',
    QUARANTINE_ATTEMPT: '${QUARANTINE_ATTEMPT}',
    FIXTURE: '${FIXTURE}',
    TEST: '${TEST}',
    USERAGENT: '${USERAGENT}',
    BROWSER: '${BROWSER}',
    BROWSER_VERSION: '${BROWSER_VERSION}',
    OS: '${OS}',
    OS_VERSION: '${OS_VERSION}'
};

const DEFAULT_PATH_PATTERN_FOR_REPORT = `${PLACEHOLDERS.DATE}_${PLACEHOLDERS.TIME}\\test-${PLACEHOLDERS.TEST_INDEX}`;
const DEFAULT_PATH_PATTERN = `${DEFAULT_PATH_PATTERN_FOR_REPORT}\\${PLACEHOLDERS.USERAGENT}\\${PLACEHOLDERS.FILE_INDEX}.${SCRENSHOT_EXTENTION}`;
const QUARANTINE_MODE_DEFAULT_PATH_PATTERN = `${DEFAULT_PATH_PATTERN_FOR_REPORT}\\run-${PLACEHOLDERS.QUARANTINE_ATTEMPT}\\${PLACEHOLDERS.USERAGENT}\\${PLACEHOLDERS.FILE_INDEX}.${SCRENSHOT_EXTENTION}`;

class PathPattern {
    constructor(pattern, data) {
        this.pattern = this._ensurePattern(pattern, data.quarantineAttempt);
        this.data = this._addDefaultFields(data);
        this.placeholderToDataMap = this._createPlaceholderToDataMap();
    }

    _ensurePattern(pattern, quarantineAttempt) {
        if (pattern) return pattern;

        return quarantineAttempt ? QUARANTINE_MODE_DEFAULT_PATH_PATTERN : DEFAULT_PATH_PATTERN;
    }

    _addDefaultFields(data) {
        const defaultFields = {
            formattedDate: data.now.format(DATE_FORMAT),
            formattedTime: data.now.format(TIME_FORMAT),
            fileIndex: 1,
            errorFileIndex: 1
        };

        return (0, _assign2.default)({}, defaultFields, data);
    }

    _createPlaceholderToDataMap() {
        return {
            [PLACEHOLDERS.DATE]: this.data.formattedDate,
            [PLACEHOLDERS.TIME]: this.data.formattedTime,
            [PLACEHOLDERS.TEST_INDEX]: this.data.testIndex,
            [PLACEHOLDERS.QUARANTINE_ATTEMPT]: this.data.quarantineAttempt || 1,
            [PLACEHOLDERS.FIXTURE]: this.data.fixture,
            [PLACEHOLDERS.TEST]: this.data.test,
            [PLACEHOLDERS.FILE_INDEX]: forError => forError ? this.data.errorFileIndex : this.data.fileIndex,
            [PLACEHOLDERS.USERAGENT]: this.data.parsedUserAgent.toString(),
            [PLACEHOLDERS.BROWSER]: this.data.parsedUserAgent.family,
            [PLACEHOLDERS.BROWSER_VERSION]: this.data.parsedUserAgent.toVersion(),
            [PLACEHOLDERS.OS]: this.data.parsedUserAgent.os.family,
            [PLACEHOLDERS.OS_VERSION]: this.data.parsedUserAgent.os.toVersion()
        };
    }

    static _buildPath(pattern, placeholderToDataMap, forError) {
        let resultFilePath = pattern;

        for (const placeholder in placeholderToDataMap) {
            const findPlaceholderRegExp = new RegExp((0, _lodash.escapeRegExp)(placeholder), 'g');

            resultFilePath = resultFilePath.replace(findPlaceholderRegExp, () => {
                if (placeholder === PLACEHOLDERS.FILE_INDEX) {
                    const getFileIndexFn = placeholderToDataMap[placeholder];
                    let result = getFileIndexFn(forError);

                    if (forError) result = `${ERRORS_FOLDER}\\${result}`;

                    return result;
                } else if (placeholder === PLACEHOLDERS.USERAGENT) {
                    const userAgent = placeholderToDataMap[placeholder];

                    return (0, _escapeUserAgent2.default)(userAgent);
                }

                return placeholderToDataMap[placeholder];
            });
        }

        return resultFilePath;
    }

    getPath(forError) {
        const path = PathPattern._buildPath(this.pattern, this.placeholderToDataMap, forError);

        return (0, _correctFilePath2.default)(path, SCRENSHOT_EXTENTION);
    }

    getPathForReport() {
        const path = PathPattern._buildPath(DEFAULT_PATH_PATTERN_FOR_REPORT, this.placeholderToDataMap);

        return (0, _correctFilePath2.default)(path);
    }

    // For testing purposes
    static get PLACEHOLDERS() {
        return PLACEHOLDERS;
    }
}
exports.default = PathPattern;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9wYXRoLXBhdHRlcm4uanMiXSwibmFtZXMiOlsiREFURV9GT1JNQVQiLCJUSU1FX0ZPUk1BVCIsIlNDUkVOU0hPVF9FWFRFTlRJT04iLCJFUlJPUlNfRk9MREVSIiwiUExBQ0VIT0xERVJTIiwiREFURSIsIlRJTUUiLCJURVNUX0lOREVYIiwiRklMRV9JTkRFWCIsIlFVQVJBTlRJTkVfQVRURU1QVCIsIkZJWFRVUkUiLCJURVNUIiwiVVNFUkFHRU5UIiwiQlJPV1NFUiIsIkJST1dTRVJfVkVSU0lPTiIsIk9TIiwiT1NfVkVSU0lPTiIsIkRFRkFVTFRfUEFUSF9QQVRURVJOX0ZPUl9SRVBPUlQiLCJERUZBVUxUX1BBVEhfUEFUVEVSTiIsIlFVQVJBTlRJTkVfTU9ERV9ERUZBVUxUX1BBVEhfUEFUVEVSTiIsIlBhdGhQYXR0ZXJuIiwiY29uc3RydWN0b3IiLCJwYXR0ZXJuIiwiZGF0YSIsIl9lbnN1cmVQYXR0ZXJuIiwicXVhcmFudGluZUF0dGVtcHQiLCJfYWRkRGVmYXVsdEZpZWxkcyIsInBsYWNlaG9sZGVyVG9EYXRhTWFwIiwiX2NyZWF0ZVBsYWNlaG9sZGVyVG9EYXRhTWFwIiwiZGVmYXVsdEZpZWxkcyIsImZvcm1hdHRlZERhdGUiLCJub3ciLCJmb3JtYXQiLCJmb3JtYXR0ZWRUaW1lIiwiZmlsZUluZGV4IiwiZXJyb3JGaWxlSW5kZXgiLCJ0ZXN0SW5kZXgiLCJmaXh0dXJlIiwidGVzdCIsImZvckVycm9yIiwicGFyc2VkVXNlckFnZW50IiwidG9TdHJpbmciLCJmYW1pbHkiLCJ0b1ZlcnNpb24iLCJvcyIsIl9idWlsZFBhdGgiLCJyZXN1bHRGaWxlUGF0aCIsInBsYWNlaG9sZGVyIiwiZmluZFBsYWNlaG9sZGVyUmVnRXhwIiwiUmVnRXhwIiwicmVwbGFjZSIsImdldEZpbGVJbmRleEZuIiwicmVzdWx0IiwidXNlckFnZW50IiwiZ2V0UGF0aCIsInBhdGgiLCJnZXRQYXRoRm9yUmVwb3J0Il0sIm1hcHBpbmdz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Q0gsYUFsQmdCLENBQWpCO0FBbUJIOztBQUVELGVBQU9ELGNBQVA7QUFDSDs7QUFFRFEsWUFBU2YsUUFBVCxFQUFtQjtBQUNmLGNBQU1nQixPQUFPbkMsWUFBWXlCLFVBQVosQ0FBdUIsS0FBS3ZCLE9BQTVCLEVBQXFDLEtBQUtLLG9CQUExQyxFQUFnRVksUUFBaEUsQ0FBYjs7QUFFQSxlQUFPLCtCQUFnQmdCLElBQWhCLEVBQXNCckQsbUJBQXRCLENBQVA7QUFDSDs7QUFFRHNELHVCQUFvQjtBQUNoQixjQUFNRCxPQUFPbkMsWUFBWXlCLFVBQVosQ0FBdUI1QiwrQkFBdkIsRUFBd0QsS0FBS1Usb0JBQTdELENBQWI7O0FBRUEsZUFBTywrQkFBZ0I0QixJQUFoQixDQUFQO0FBQ0g7O0FBRUQ7QUFDQSxlQUFXbkQsWUFBWCxHQUEyQjtBQUN2QixlQUFPQSxZQUFQO0FBQ0g7QUF2RjRCO2tCQUFaZ0IsVyIsImZpbGUiOiJzY3JlZW5zaG90cy9wYXRoLXBhdHRlcm4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlc2NhcGVSZWdFeHAgYXMgZXNjYXBlUmUgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGNvcnJlY3RGaWxlUGF0aCBmcm9tICcuLi91dGlscy9jb3JyZWN0LWZpbGUtcGF0aCc7XG5pbXBvcnQgZXNjYXBlVXNlckFnZW50IGZyb20gJy4uL3V0aWxzL2VzY2FwZS11c2VyLWFnZW50JztcblxuY29uc3QgREFURV9GT1JNQVQgPSAnWVlZWS1NTS1ERCc7XG5jb25zdCBUSU1FX0ZPUk1BVCA9ICdISC1tbS1zcyc7XG5cbmNvbnN0IFNDUkVOU0hPVF9FWFRFTlRJT04gPSAncG5nJztcblxuY29uc3QgRVJST1JTX0ZPTERFUiA9ICdlcnJvcnMnO1xuXG5jb25zdCBQTEFDRUhPTERFUlMgPSB7XG4gICAgREFURTogICAgICAgICAgICAgICAnJHtEQVRFfScsXG4gICAgVElNRTogICAgICAgICAgICAgICAnJHtUSU1FfScsXG4gICAgVEVTVF9JTkRFWDogICAgICAgICAnJHtURVNUX0lOREVYfScsXG4gICAgRklMRV9JTkRFWDogICAgICAgICAnJHtGSUxFX0lOREVYfScsXG4gICAgUVVBUkFOVElORV9BVFRFTVBUOiAnJHtRVUFSQU5USU5FX0FUVEVNUFR9JyxcbiAgICBGSVhUVVJFOiAgICAgICAgICAgICcke0ZJWFRVUkV9JyxcbiAgICBURVNUOiAgICAgICAgICAgICAgICcke1RFU1R9JyxcbiAgICBVU0VSQUdFTlQ6ICAgICAgICAgICcke1VTRVJBR0VOVH0nLFxuICAgIEJST1dTRVI6ICAgICAgICAgICAgJyR7QlJPV1NFUn0nLFxuICAgIEJST1dTRVJfVkVSU0lPTjogICAgJyR7QlJPV1NFUl9WRVJTSU9OfScsXG4gICAgT1M6ICAgICAgICAgICAgICAgICAnJHtPU30nLFxuICAgIE9TX1ZFUlNJT046ICAgICAgICAgJyR7T1NfVkVSU0lPTn0nXG59O1xuXG5jb25zdCBERUZBVUxUX1BBVEhfUEFUVEVSTl9GT1JfUkVQT1JUICAgICAgPSBgJHtQTEFDRUhPTERFUlMuREFURX1fJHtQTEFDRUhPTERFUlMuVElNRX1cXFxcdGVzdC0ke1BMQUNFSE9MREVSUy5URVNUX0lOREVYfWA7XG5jb25zdCBERUZBVUxUX1BBVEhfUEFUVEVSTiAgICAgICAgICAgICAgICAgPSBgJHtERUZBVUxUX1BBVEhfUEFUVEVSTl9GT1JfUkVQT1JUfVxcXFwke1BMQUNFSE9MREVSUy5VU0VSQUdFTlR9XFxcXCR7UExBQ0VIT0xERVJTLkZJTEVfSU5ERVh9LiR7U0NSRU5TSE9UX0VYVEVOVElPTn1gO1xuY29uc3QgUVVBUkFOVElORV9NT0RFX0RFRkFVTFRfUEFUSF9QQVRURVJOID0gYCR7REVGQVVMVF9QQVRIX1BBVFRFUk5fRk9SX1JFUE9SVH1cXFxccnVuLSR7UExBQ0VIT0xERVJTLlFVQVJBTlRJTkVfQVRURU1QVH1cXFxcJHtQTEFDRUhPTERFUlMuVVNFUkFHRU5UfVxcXFwke1BMQUNFSE9MREVSUy5GSUxFX0lOREVYfS4ke1NDUkVOU0hPVF9FWFRFTlRJT059YDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGF0aFBhdHRlcm4ge1xuICAgIGNvbnN0cnVjdG9yIChwYXR0ZXJuLCBkYXRhKSB7XG4gICAgICAgIHRoaXMucGF0dGVybiAgICAgICAgICAgICAgPSB0aGlzLl9lbnN1cmVQYXR0ZXJuKHBhdHRlcm4sIGRhdGEucXVhcmFudGluZUF0dGVtcHQpO1xuICAgICAgICB0aGlzLmRhdGEgICAgICAgICAgICAgICAgID0gdGhpcy5fYWRkRGVmYXVsdEZpZWxkcyhkYXRhKTtcbiAgICAgICAgdGhpcy5wbGFjZWhvbGRlclRvRGF0YU1hcCA9IHRoaXMuX2NyZWF0ZVBsYWNlaG9sZGVyVG9EYXRhTWFwKCk7XG4gICAgfVxuXG4gICAgX2Vuc3VyZVBhdHRlcm4gKHBhdHRlcm4sIHF1YXJhbnRpbmVBdHRlbXB0KSB7XG4gICAgICAgIGlmIChwYXR0ZXJuKVxuICAgICAgICAgICAgcmV0dXJuIHBhdHRlcm47XG5cbiAgICAgICAgcmV0dXJuIHF1YXJhbnRpbmVBdHRlbXB0ID8gUVVBUkFOVElORV9NT0RFX0RFRkFVTFRfUEFUSF9QQVRURVJOIDogREVGQVVMVF9QQVRIX1BBVFRFUk47XG4gICAgfVxuXG4gICAgX2FkZERlZmF1bHRGaWVsZHMgKGRhdGEpIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdEZpZWxkcyA9IHtcbiAgICAgICAgICAgIGZvcm1hdHRlZERhdGU6ICBkYXRhLm5vdy5mb3JtYXQoREFURV9GT1JNQVQpLFxuICAgICAgICAgICAgZm9ybWF0dGVkVGltZTogIGRhdGEubm93LmZvcm1hdChUSU1FX0ZPUk1BVCksXG4gICAgICAgICAgICBmaWxlSW5kZXg6ICAgICAgMSxcbiAgICAgICAgICAgIGVycm9yRmlsZUluZGV4OiAxXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRGaWVsZHMsIGRhdGEpO1xuICAgIH1cblxuICAgIF9jcmVhdGVQbGFjZWhvbGRlclRvRGF0YU1hcCAoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLkRBVEVdOiAgICAgICAgICAgICAgIHRoaXMuZGF0YS5mb3JtYXR0ZWREYXRlLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5USU1FXTogICAgICAgICAgICAgICB0aGlzLmRhdGEuZm9ybWF0dGVkVGltZSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVEVTVF9JTkRFWF06ICAgICAgICAgdGhpcy5kYXRhLnRlc3RJbmRleCxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuUVVBUkFOVElORV9BVFRFTVBUXTogdGhpcy5kYXRhLnF1YXJhbnRpbmVBdHRlbXB0IHx8IDEsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLkZJWFRVUkVdOiAgICAgICAgICAgIHRoaXMuZGF0YS5maXh0dXJlLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5URVNUXTogICAgICAgICAgICAgICB0aGlzLmRhdGEudGVzdCxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuRklMRV9JTkRFWF06ICAgICAgICAgZm9yRXJyb3IgPT4gZm9yRXJyb3IgPyB0aGlzLmRhdGEuZXJyb3JGaWxlSW5kZXggOiB0aGlzLmRhdGEuZmlsZUluZGV4LFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5VU0VSQUdFTlRdOiAgICAgICAgICB0aGlzLmRhdGEucGFyc2VkVXNlckFnZW50LnRvU3RyaW5nKCksXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLkJST1dTRVJdOiAgICAgICAgICAgIHRoaXMuZGF0YS5wYXJzZWRVc2VyQWdlbnQuZmFtaWx5LFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5CUk9XU0VSX1ZFUlNJT05dOiAgICB0aGlzLmRhdGEucGFyc2VkVXNlckFnZW50LnRvVmVyc2lvbigpLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5PU106ICAgICAgICAgICAgICAgICB0aGlzLmRhdGEucGFyc2VkVXNlckFnZW50Lm9zLmZhbWlseSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuT1NfVkVSU0lPTl06ICAgICAgICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC5vcy50b1ZlcnNpb24oKVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBfYnVpbGRQYXRoIChwYXR0ZXJuLCBwbGFjZWhvbGRlclRvRGF0YU1hcCwgZm9yRXJyb3IpIHtcbiAgICAgICAgbGV0IHJlc3VsdEZpbGVQYXRoID0gcGF0dGVybjtcblxuICAgICAgICBmb3IgKGNvbnN0IHBsYWNlaG9sZGVyIGluIHBsYWNlaG9sZGVyVG9EYXRhTWFwKSB7XG4gICAgICAgICAgICBjb25zdCBmaW5kUGxhY2Vob2xkZXJSZWdFeHAgPSBuZXcgUmVnRXhwKGVzY2FwZVJlKHBsYWNlaG9sZGVyKSwgJ2cnKTtcblxuICAgICAgICAgICAgcmVzdWx0RmlsZVBhdGggPSByZXN1bHRGaWxlUGF0aC5yZXBsYWNlKGZpbmRQbGFjZWhvbGRlclJlZ0V4cCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwbGFjZWhvbGRlciA9PT0gUExBQ0VIT0xERVJTLkZJTEVfSU5ERVgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2V0RmlsZUluZGV4Rm4gPSBwbGFjZWhvbGRlclRvRGF0YU1hcFtwbGFjZWhvbGRlcl07XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgICAgICAgICAgID0gZ2V0RmlsZUluZGV4Rm4oZm9yRXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JFcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGAke0VSUk9SU19GT0xERVJ9XFxcXCR7cmVzdWx0fWA7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwbGFjZWhvbGRlciA9PT0gUExBQ0VIT0xERVJTLlVTRVJBR0VOVCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyQWdlbnQgPSBwbGFjZWhvbGRlclRvRGF0YU1hcFtwbGFjZWhvbGRlcl07XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVzY2FwZVVzZXJBZ2VudCh1c2VyQWdlbnQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZWhvbGRlclRvRGF0YU1hcFtwbGFjZWhvbGRlcl07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHRGaWxlUGF0aDtcbiAgICB9XG5cbiAgICBnZXRQYXRoIChmb3JFcnJvcikge1xuICAgICAgICBjb25zdCBwYXRoID0gUGF0aFBhdHRlcm4uX2J1aWxkUGF0aCh0aGlzLnBhdHRlcm4sIHRoaXMucGxhY2Vob2xkZXJUb0RhdGFNYXAsIGZvckVycm9yKTtcblxuICAgICAgICByZXR1cm4gY29ycmVjdEZpbGVQYXRoKHBhdGgsIFNDUkVOU0hPVF9FWFRFTlRJT04pO1xuICAgIH1cblxuICAgIGdldFBhdGhGb3JSZXBvcnQgKCkge1xuICAgICAgICBjb25zdCBwYXRoID0gUGF0aFBhdHRlcm4uX2J1aWxkUGF0aChERUZBVUxUX1BBVEhfUEFUVEVSTl9GT1JfUkVQT1JULCB0aGlzLnBsYWNlaG9sZGVyVG9EYXRhTWFwKTtcblxuICAgICAgICByZXR1cm4gY29ycmVjdEZpbGVQYXRoKHBhdGgpO1xuICAgIH1cblxuICAgIC8vIEZvciB0ZXN0aW5nIHB1cnBvc2VzXG4gICAgc3RhdGljIGdldCBQTEFDRUhPTERFUlMgKCkge1xuICAgICAgICByZXR1cm4gUExBQ0VIT0xERVJTO1xuICAgIH1cbn1cbiJdfQ==
