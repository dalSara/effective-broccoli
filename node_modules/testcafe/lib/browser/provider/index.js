'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _testcafeBrowserTools = require('testcafe-browser-tools');

var _testcafeBrowserTools2 = _interopRequireDefault(_testcafeBrowserTools);

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _connection = require('../connection');

var _connection2 = _interopRequireDefault(_connection);

var _delay = require('../../utils/delay');

var _delay2 = _interopRequireDefault(_delay);

var _clientFunctions = require('./utils/client-functions');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BROWSER_OPENING_DELAY = 2000;

const RESIZE_DIFF_SIZE = {
    width: 100,
    height: 100
};

function sumSizes(sizeA, sizeB) {
    return {
        width: sizeA.width + sizeB.width,
        height: sizeA.height + sizeB.height
    };
}

function subtractSizes(sizeA, sizeB) {
    return {
        width: sizeA.width - sizeB.width,
        height: sizeA.height - sizeB.height
    };
}

class BrowserProvider {
    constructor(plugin) {
        this.plugin = plugin;
        this.initPromise = _pinkie2.default.resolve(false);

        this.isMultiBrowser = this.plugin.isMultiBrowser;
        // HACK: The browser window has different border sizes in normal and maximized modes. So, we need to be sure that the window is
        // not maximized before resizing it in order to keep the mechanism of correcting the client area size working. When browser is started,
        // we are resizing it for the first time to switch the window to normal mode, and for the second time - to restore the client area size.
        this.localBrowsersInfo = {};
    }

    _createLocalBrowserInfo(browserId) {
        if (this.localBrowsersInfo[browserId]) return;

        this.localBrowsersInfo[browserId] = {
            windowDescriptor: null,
            maxScreenSize: null,
            resizeCorrections: null
        };
    }

    _getWindowDescriptor(browserId) {
        return this.localBrowsersInfo[browserId] && this.localBrowsersInfo[browserId].windowDescriptor;
    }

    _getMaxScreenSize(browserId) {
        return this.localBrowsersInfo[browserId] && this.localBrowsersInfo[browserId].maxScreenSize;
    }

    _getResizeCorrections(browserId) {
        return this.localBrowsersInfo[browserId] && this.localBrowsersInfo[browserId].resizeCorrections;
    }

    _isBrowserIdle(browserId) {
        const connection = _connection2.default.getById(browserId);

        return connection.idle;
    }

    _calculateResizeCorrections(browserId) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this._isBrowserIdle(browserId)) return;

            var title = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_TITLE_SCRIPT);

            if (!(yield _testcafeBrowserTools2.default.isMaximized(title))) return;

            var currentSize = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);
            var etalonSize = subtractSizes(currentSize, RESIZE_DIFF_SIZE);

            yield _testcafeBrowserTools2.default.resize(title, currentSize.width, currentSize.height, etalonSize.width, etalonSize.height);

            var resizedSize = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);
            var correctionSize = subtractSizes(resizedSize, etalonSize);

            yield _testcafeBrowserTools2.default.resize(title, resizedSize.width, resizedSize.height, etalonSize.width, etalonSize.height);

            resizedSize = yield _this.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            correctionSize = sumSizes(correctionSize, subtractSizes(resizedSize, etalonSize));

            if (_this.localBrowsersInfo[browserId]) _this.localBrowsersInfo[browserId].resizeCorrections = correctionSize;

            yield _testcafeBrowserTools2.default.maximize(title);
        })();
    }

    _calculateMacSizeLimits(browserId) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this2._isBrowserIdle(browserId)) return;

            var sizeInfo = yield _this2.plugin.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            if (_this2.localBrowsersInfo[browserId]) {
                _this2.localBrowsersInfo[browserId].maxScreenSize = {
                    width: sizeInfo.availableWidth - (sizeInfo.outerWidth - sizeInfo.width),
                    height: sizeInfo.availableHeight - (sizeInfo.outerHeight - sizeInfo.height)
                };
            }
        })();
    }

    _ensureBrowserWindowDescriptor(browserId) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this3._getWindowDescriptor(browserId)) return;

            yield _this3._createLocalBrowserInfo(browserId);

            // NOTE: delay to ensure the window finished the opening
            yield _this3.plugin.waitForConnectionReady(browserId);
            yield (0, _delay2.default)(BROWSER_OPENING_DELAY);

            if (_this3.localBrowsersInfo[browserId]) _this3.localBrowsersInfo[browserId].windowDescriptor = yield _testcafeBrowserTools2.default.findWindow(browserId);
        })();
    }

    _ensureBrowserWindowParameters(browserId) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this4._ensureBrowserWindowDescriptor(browserId);

            if (_osFamily2.default.win && !_this4._getResizeCorrections(browserId)) yield _this4._calculateResizeCorrections(browserId);else if (_osFamily2.default.mac && !_this4._getMaxScreenSize(browserId)) yield _this4._calculateMacSizeLimits(browserId);
        })();
    }

    _closeLocalBrowser(browserId) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _testcafeBrowserTools2.default.close(_this5._getWindowDescriptor(browserId));
        })();
    }

    _resizeLocalBrowserWindow(browserId, width, height, currentWidth, currentHeight) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const resizeCorrections = _this6._getResizeCorrections(browserId);

            if (resizeCorrections && (yield _testcafeBrowserTools2.default.isMaximized(_this6._getWindowDescriptor(browserId)))) {
                width -= resizeCorrections.width;
                height -= resizeCorrections.height;
            }

            yield _testcafeBrowserTools2.default.resize(_this6._getWindowDescriptor(browserId), currentWidth, currentHeight, width, height);
        })();
    }

    _takeLocalBrowserScreenshot(browserId, screenshotPath) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _testcafeBrowserTools2.default.screenshot(_this7._getWindowDescriptor(browserId), screenshotPath);
        })();
    }

    _canResizeLocalBrowserWindowToDimensions(browserId, width, height) {
        var _this8 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_osFamily2.default.mac) return true;

            var maxScreenSize = _this8._getMaxScreenSize(browserId);

            return width <= maxScreenSize.width && height <= maxScreenSize.height;
        })();
    }

    _maximizeLocalBrowserWindow(browserId) {
        var _this9 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _testcafeBrowserTools2.default.maximize(_this9._getWindowDescriptor(browserId));
        })();
    }

    init() {
        var _this10 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var initialized = yield _this10.initPromise;

            if (initialized) return;

            _this10.initPromise = _this10.plugin.init().then(function () {
                return true;
            });

            try {
                yield _this10.initPromise;
            } catch (error) {
                _this10.initPromise = _pinkie2.default.resolve(false);

                throw error;
            }
        })();
    }

    dispose() {
        var _this11 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var initialized = yield _this11.initPromise;

            if (!initialized) return;

            _this11.initPromise = _this11.plugin.dispose().then(function () {
                return false;
            });

            try {
                yield _this11.initPromise;
            } catch (error) {
                _this11.initPromise = _pinkie2.default.resolve(false);

                throw error;
            }
        })();
    }

    isLocalBrowser(browserId, browserName) {
        var _this12 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this12.plugin.isLocalBrowser(browserId, browserName);
        })();
    }

    openBrowser(browserId, pageUrl, browserName) {
        var _this13 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this13.plugin.openBrowser(browserId, pageUrl, browserName);

            var isLocalBrowser = yield _this13.plugin.isLocalBrowser(browserId);

            if (isLocalBrowser) yield _this13._ensureBrowserWindowParameters(browserId);
        })();
    }

    closeBrowser(browserId) {
        var _this14 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var isLocalBrowser = yield _this14.plugin.isLocalBrowser(browserId);
            var customActionsInfo = yield _this14.hasCustomActionForBrowser(browserId);
            var hasCustomCloseBrowser = customActionsInfo.hasCloseBrowser;
            var usePluginsCloseBrowser = hasCustomCloseBrowser || !isLocalBrowser;

            if (usePluginsCloseBrowser) yield _this14.plugin.closeBrowser(browserId);else yield _this14._closeLocalBrowser(browserId);

            if (isLocalBrowser) delete _this14.localBrowsersInfo[browserId];
        })();
    }

    getBrowserList() {
        var _this15 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this15.plugin.getBrowserList();
        })();
    }

    isValidBrowserName(browserName) {
        var _this16 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this16.plugin.isValidBrowserName(browserName);
        })();
    }

    resizeWindow(browserId, width, height, currentWidth, currentHeight) {
        var _this17 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var isLocalBrowser = yield _this17.plugin.isLocalBrowser(browserId);
            var customActionsInfo = yield _this17.hasCustomActionForBrowser(browserId);
            var hasCustomResizeWindow = customActionsInfo.hasResizeWindow;

            if (isLocalBrowser && !hasCustomResizeWindow) {
                yield _this17._resizeLocalBrowserWindow(browserId, width, height, currentWidth, currentHeight);
                return;
            }

            yield _this17.plugin.resizeWindow(browserId, width, height, currentWidth, currentHeight);
        })();
    }

    canResizeWindowToDimensions(browserId, width, height) {
        var _this18 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var isLocalBrowser = yield _this18.plugin.isLocalBrowser(browserId);
            var customActionsInfo = yield _this18.hasCustomActionForBrowser(browserId);
            var hasCustomCanResizeToDimensions = customActionsInfo.hasCanResizeWindowToDimensions;

            if (isLocalBrowser && !hasCustomCanResizeToDimensions) return yield _this18._canResizeLocalBrowserWindowToDimensions(browserId, width, height);

            return yield _this18.plugin.canResizeWindowToDimensions(browserId, width, height);
        })();
    }

    maximizeWindow(browserId) {
        var _this19 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var isLocalBrowser = yield _this19.plugin.isLocalBrowser(browserId);
            var customActionsInfo = yield _this19.hasCustomActionForBrowser(browserId);
            var hasCustomMaximizeWindow = customActionsInfo.hasMaximizeWindow;

            if (isLocalBrowser && !hasCustomMaximizeWindow) return yield _this19._maximizeLocalBrowserWindow(browserId);

            return yield _this19.plugin.maximizeWindow(browserId);
        })();
    }

    takeScreenshot(browserId, screenshotPath, pageWidth, pageHeight) {
        var _this20 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var isLocalBrowser = yield _this20.plugin.isLocalBrowser(browserId);
            var customActionsInfo = yield _this20.hasCustomActionForBrowser(browserId);
            var hasCustomTakeScreenshot = customActionsInfo.hasTakeScreenshot;

            if (isLocalBrowser && !hasCustomTakeScreenshot) {
                yield _this20._takeLocalBrowserScreenshot(browserId, screenshotPath, pageWidth, pageHeight);
                return;
            }

            yield _this20.plugin.takeScreenshot(browserId, screenshotPath, pageWidth, pageHeight);
        })();
    }

    hasCustomActionForBrowser(browserId) {
        var _this21 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return _this21.plugin.hasCustomActionForBrowser(browserId);
        })();
    }

    reportJobResult(browserId, status, data) {
        var _this22 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this22.plugin.reportJobResult(browserId, status, data);
        })();
    }
}
exports.default = BrowserProvider;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2luZGV4LmpzIl0sIm5hbWVzIjpbIkJST1dTRVJfT1BFTklOR19ERUxBWSIsIlJFU0laRV9ESUZGX1NJWkUiLCJ3aWR0aCIsImhlaWdodCIsInN1bVNpemVzIiwic2l6ZUEiLCJzaXplQiIsInN1YnRyYWN0U2l6ZXMiLCJCcm93c2VyUHJvdmlkZXIiLCJjb25zdHJ1Y3RvciIsInBsdWdpbiIsImluaXRQcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJpc011bHRpQnJvd3NlciIsImxvY2FsQnJvd3NlcnNJbmZvIiwiX2NyZWF0ZUxvY2FsQnJvd3NlckluZm8iLCJicm93c2VySWQiLCJ3aW5kb3dEZXNjcmlwdG9yIiwibWF4U2NyZWVuU2l6ZSIsInJlc2l6ZUNvcnJlY3Rpb25zIiwiX2dldFdpbmRvd0Rlc2NyaXB0b3IiLCJfZ2V0TWF4U2NyZWVuU2l6ZSIsIl9nZXRSZXNpemVDb3JyZWN0aW9ucyIsIl9pc0Jyb3dzZXJJZGxlIiwiY29ubmVjdGlvbiIsIkJyb3dzZXJDb25uZWN0aW9uIiwiZ2V0QnlJZCIsImlkbGUiLCJfY2FsY3VsYXRlUmVzaXplQ29ycmVjdGlvbnMiLCJ0aXRsZSIsInJ1bkluaXRTY3JpcHQiLCJHRVRfVElUTEVfU0NSSVBUIiwiYnJvd3NlclRvb2xzIiwiaXNNYXhpbWl6ZWQiLCJjdXJyZW50U2l6ZSIsIkdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCIsImV0YWxvblNpemUiLCJyZXNpemUiLCJyZXNpemVkU2l6ZSIsImNvcnJlY3Rpb25TaXplIiwibWF4aW1pemUiLCJfY2FsY3VsYXRlTWFjU2l6ZUxpbWl0cyIsInNpemVJbmZvIiwiYXZhaWxhYmxlV2lkdGgiLCJvdXRlcldpZHRoIiwiYXZhaWxhYmxlSGVpZ2h0Iiwib3V0ZXJIZWlnaHQiLCJfZW5zdXJlQnJvd3NlcldpbmRvd0Rlc2NyaXB0b3IiLCJ3YWl0Rm9yQ29ubmVjdGlvblJlYWR5IiwiZmluZFdpbmRvdyIsIl9lbnN1cmVCcm93c2VyV2luZG93UGFyYW1ldGVycyIsIk9TIiwid2luIiwibWFjIiwiX2Nsb3NlTG9jYWxCcm93c2VyIiwiY2xvc2UiLCJfcmVzaXplTG9jYWxCcm93c2VyV2luZG93IiwiY3VycmVudFdpZHRoIiwiY3VycmVudEhlaWdodCIsIl90YWtlTG9jYWxCcm93c2VyU2NyZWVuc2hvdCIsInNjcmVlbnNob3RQYXRoIiwic2NyZWVuc2hvdCIsIl9jYW5SZXNpemVMb2NhbEJyb3dzZXJXaW5kb3dUb0RpbWVuc2lvbnMiLCJfbWF4aW1pemVMb2NhbEJyb3dzZXJXaW5kb3ciLCJpbml0IiwiaW5pdGlhbGl6ZWQiLCJ0aGVuIiwiZXJyb3IiLCJkaXNwb3NlIiwiaXNMb2NhbEJyb3dzZXIiLCJicm93c2VyTmFtZSIsIm9wZW5Ccm93c2VyIiwicGFnZVVybCIsImNsb3NlQnJvd3NlciIsImN1c3RvbUFjdGlvbnNJbmZvIiwiaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3NlciIsImhhc0N1c3RvbUNsb3NlQnJvd3NlciIsImhhc0Nsb3NlQnJvd3NlciIsInVzZVBsdWdpbnNDbG9zZUJyb3dzZXIiLCJnZXRCcm93c2VyTGlzdCIsImlzVmFsaWRCcm93c2VyTmFtZSIsInJlc2l6ZVdpbmRvdyIsImhhc0N1c3RvbVJlc2l6ZVdpbmRvdyIsImhhc1Jlc2l6ZVdpbmRvdyIsImNhblJlc2l6ZVdpbmRvd1RvRGltZW5zaW9ucyIsImhhc0N1c3RvbUNhblJlc2l6ZVRvRGltZW5zaW9ucyIsImhhc0NhblJlc2l6ZVdpbmRvd1RvRGltZW5zaW9ucyIsIm1heGltaXplV2luZG93IiwiaGFzQ3VzdG9tTWF4aW1pemVXaW5kb3ciLCJoYXNNYXhpbWl6ZVdpbmRvdyIsInRha2VTY3JlZW5zaG90IiwicGFnZVdpZHRoIiwicGFnZUhlaWdodCIsImhhc0N1c3RvbVRha2VTY3JlZW5zaG90IiwiaGFzVGFrZVNjcmVlbnNob3QiLCJyZXBvcnRKb2JSZXN1bHQiLCJzdGF0dXMiLCJkYXRhIl0sIm1hcHBpbmdzIjoiOzs7Ozs7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M0IsRUFBc0M0QyxjQUF0QyxFQUFzRCtCLFNBQXRELEVBQWlFQyxVQUFqRSxDQUFOO0FBVm9FO0FBV3ZFOztBQUVLakIsNkJBQU4sQ0FBaUMzRCxTQUFqQyxFQUE0QztBQUFBOztBQUFBO0FBQ3hDLG1CQUFPLFFBQUtQLE1BQUwsQ0FBWWtFLHlCQUFaLENBQXNDM0QsU0FBdEMsQ0FBUDtBQUR3QztBQUUzQzs7QUFFSytFLG1CQUFOLENBQXVCL0UsU0FBdkIsRUFBa0NnRixNQUFsQyxFQUEwQ0MsSUFBMUMsRUFBZ0Q7QUFBQTs7QUFBQTtBQUM1QyxrQkFBTSxRQUFLeEYsTUFBTCxDQUFZc0YsZUFBWixDQUE0Qi9FLFNBQTVCLEVBQXVDZ0YsTUFBdkMsRUFBK0NDLElBQS9DLENBQU47QUFENEM7QUFFL0M7QUFoUmdDO2tCQUFoQjFGLGUiLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgYnJvd3NlclRvb2xzIGZyb20gJ3Rlc3RjYWZlLWJyb3dzZXItdG9vbHMnO1xuaW1wb3J0IE9TIGZyb20gJ29zLWZhbWlseSc7XG5pbXBvcnQgQnJvd3NlckNvbm5lY3Rpb24gZnJvbSAnLi4vY29ubmVjdGlvbic7XG5pbXBvcnQgZGVsYXkgZnJvbSAnLi4vLi4vdXRpbHMvZGVsYXknO1xuaW1wb3J0IHsgR0VUX1RJVExFX1NDUklQVCwgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUIH0gZnJvbSAnLi91dGlscy9jbGllbnQtZnVuY3Rpb25zJztcblxuXG5jb25zdCBCUk9XU0VSX09QRU5JTkdfREVMQVkgPSAyMDAwO1xuXG5jb25zdCBSRVNJWkVfRElGRl9TSVpFID0ge1xuICAgIHdpZHRoOiAgMTAwLFxuICAgIGhlaWdodDogMTAwXG59O1xuXG5cbmZ1bmN0aW9uIHN1bVNpemVzIChzaXplQSwgc2l6ZUIpIHtcbiAgICByZXR1cm4ge1xuICAgICAgICB3aWR0aDogIHNpemVBLndpZHRoICsgc2l6ZUIud2lkdGgsXG4gICAgICAgIGhlaWdodDogc2l6ZUEuaGVpZ2h0ICsgc2l6ZUIuaGVpZ2h0XG4gICAgfTtcbn1cblxuZnVuY3Rpb24gc3VidHJhY3RTaXplcyAoc2l6ZUEsIHNpemVCKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgd2lkdGg6ICBzaXplQS53aWR0aCAtIHNpemVCLndpZHRoLFxuICAgICAgICBoZWlnaHQ6IHNpemVBLmhlaWdodCAtIHNpemVCLmhlaWdodFxuICAgIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJyb3dzZXJQcm92aWRlciB7XG4gICAgY29uc3RydWN0b3IgKHBsdWdpbikge1xuICAgICAgICB0aGlzLnBsdWdpbiAgICAgID0gcGx1Z2luO1xuICAgICAgICB0aGlzLmluaXRQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcblxuICAgICAgICB0aGlzLmlzTXVsdGlCcm93c2VyID0gdGhpcy5wbHVnaW4uaXNNdWx0aUJyb3dzZXI7XG4gICAgICAgIC8vIEhBQ0s6IFRoZSBicm93c2VyIHdpbmRvdyBoYXMgZGlmZmVyZW50IGJvcmRlciBzaXplcyBpbiBub3JtYWwgYW5kIG1heGltaXplZCBtb2Rlcy4gU28sIHdlIG5lZWQgdG8gYmUgc3VyZSB0aGF0IHRoZSB3aW5kb3cgaXNcbiAgICAgICAgLy8gbm90IG1heGltaXplZCBiZWZvcmUgcmVzaXppbmcgaXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgbWVjaGFuaXNtIG9mIGNvcnJlY3RpbmcgdGhlIGNsaWVudCBhcmVhIHNpemUgd29ya2luZy4gV2hlbiBicm93c2VyIGlzIHN0YXJ0ZWQsXG4gICAgICAgIC8vIHdlIGFyZSByZXNpemluZyBpdCBmb3IgdGhlIGZpcnN0IHRpbWUgdG8gc3dpdGNoIHRoZSB3aW5kb3cgdG8gbm9ybWFsIG1vZGUsIGFuZCBmb3IgdGhlIHNlY29uZCB0aW1lIC0gdG8gcmVzdG9yZSB0aGUgY2xpZW50IGFyZWEgc2l6ZS5cbiAgICAgICAgdGhpcy5sb2NhbEJyb3dzZXJzSW5mbyA9IHt9O1xuICAgIH1cblxuICAgIF9jcmVhdGVMb2NhbEJyb3dzZXJJbmZvIChicm93c2VySWQpIHtcbiAgICAgICAgaWYgKHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0gPSB7XG4gICAgICAgICAgICB3aW5kb3dEZXNjcmlwdG9yOiAgbnVsbCxcbiAgICAgICAgICAgIG1heFNjcmVlblNpemU6ICAgICBudWxsLFxuICAgICAgICAgICAgcmVzaXplQ29ycmVjdGlvbnM6IG51bGxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfZ2V0V2luZG93RGVzY3JpcHRvciAoYnJvd3NlcklkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0gJiYgdGhpcy5sb2NhbEJyb3dzZXJzSW5mb1ticm93c2VySWRdLndpbmRvd0Rlc2NyaXB0b3I7XG4gICAgfVxuXG4gICAgX2dldE1heFNjcmVlblNpemUgKGJyb3dzZXJJZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5sb2NhbEJyb3dzZXJzSW5mb1ticm93c2VySWRdICYmIHRoaXMubG9jYWxCcm93c2Vyc0luZm9bYnJvd3NlcklkXS5tYXhTY3JlZW5TaXplO1xuICAgIH1cblxuICAgIF9nZXRSZXNpemVDb3JyZWN0aW9ucyAoYnJvd3NlcklkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0gJiYgdGhpcy5sb2NhbEJyb3dzZXJzSW5mb1ticm93c2VySWRdLnJlc2l6ZUNvcnJlY3Rpb25zO1xuICAgIH1cblxuICAgIF9pc0Jyb3dzZXJJZGxlIChicm93c2VySWQpIHtcbiAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IEJyb3dzZXJDb25uZWN0aW9uLmdldEJ5SWQoYnJvd3NlcklkKTtcblxuICAgICAgICByZXR1cm4gY29ubmVjdGlvbi5pZGxlO1xuICAgIH1cblxuICAgIGFzeW5jIF9jYWxjdWxhdGVSZXNpemVDb3JyZWN0aW9ucyAoYnJvd3NlcklkKSB7XG4gICAgICAgIGlmICghdGhpcy5faXNCcm93c2VySWRsZShicm93c2VySWQpKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHZhciB0aXRsZSA9IGF3YWl0IHRoaXMucGx1Z2luLnJ1bkluaXRTY3JpcHQoYnJvd3NlcklkLCBHRVRfVElUTEVfU0NSSVBUKTtcblxuICAgICAgICBpZiAoIWF3YWl0IGJyb3dzZXJUb29scy5pc01heGltaXplZCh0aXRsZSkpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdmFyIGN1cnJlbnRTaXplID0gYXdhaXQgdGhpcy5wbHVnaW4ucnVuSW5pdFNjcmlwdChicm93c2VySWQsIEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCk7XG4gICAgICAgIHZhciBldGFsb25TaXplICA9IHN1YnRyYWN0U2l6ZXMoY3VycmVudFNpemUsIFJFU0laRV9ESUZGX1NJWkUpO1xuXG4gICAgICAgIGF3YWl0IGJyb3dzZXJUb29scy5yZXNpemUodGl0bGUsIGN1cnJlbnRTaXplLndpZHRoLCBjdXJyZW50U2l6ZS5oZWlnaHQsIGV0YWxvblNpemUud2lkdGgsIGV0YWxvblNpemUuaGVpZ2h0KTtcblxuICAgICAgICB2YXIgcmVzaXplZFNpemUgICAgPSBhd2FpdCB0aGlzLnBsdWdpbi5ydW5Jbml0U2NyaXB0KGJyb3dzZXJJZCwgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUKTtcbiAgICAgICAgdmFyIGNvcnJlY3Rpb25TaXplID0gc3VidHJhY3RTaXplcyhyZXNpemVkU2l6ZSwgZXRhbG9uU2l6ZSk7XG5cbiAgICAgICAgYXdhaXQgYnJvd3NlclRvb2xzLnJlc2l6ZSh0aXRsZSwgcmVzaXplZFNpemUud2lkdGgsIHJlc2l6ZWRTaXplLmhlaWdodCwgZXRhbG9uU2l6ZS53aWR0aCwgZXRhbG9uU2l6ZS5oZWlnaHQpO1xuXG4gICAgICAgIHJlc2l6ZWRTaXplID0gYXdhaXQgdGhpcy5wbHVnaW4ucnVuSW5pdFNjcmlwdChicm93c2VySWQsIEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCk7XG5cbiAgICAgICAgY29ycmVjdGlvblNpemUgPSBzdW1TaXplcyhjb3JyZWN0aW9uU2l6ZSwgc3VidHJhY3RTaXplcyhyZXNpemVkU2l6ZSwgZXRhbG9uU2l6ZSkpO1xuXG4gICAgICAgIGlmICh0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0pXG4gICAgICAgICAgICB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0ucmVzaXplQ29ycmVjdGlvbnMgPSBjb3JyZWN0aW9uU2l6ZTtcblxuICAgICAgICBhd2FpdCBicm93c2VyVG9vbHMubWF4aW1pemUodGl0bGUpO1xuICAgIH1cblxuXG4gICAgYXN5bmMgX2NhbGN1bGF0ZU1hY1NpemVMaW1pdHMgKGJyb3dzZXJJZCkge1xuICAgICAgICBpZiAoIXRoaXMuX2lzQnJvd3NlcklkbGUoYnJvd3NlcklkKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB2YXIgc2l6ZUluZm8gPSBhd2FpdCB0aGlzLnBsdWdpbi5ydW5Jbml0U2NyaXB0KGJyb3dzZXJJZCwgR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUKTtcblxuICAgICAgICBpZiAodGhpcy5sb2NhbEJyb3dzZXJzSW5mb1ticm93c2VySWRdKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0ubWF4U2NyZWVuU2l6ZSA9IHtcbiAgICAgICAgICAgICAgICB3aWR0aDogIHNpemVJbmZvLmF2YWlsYWJsZVdpZHRoIC0gKHNpemVJbmZvLm91dGVyV2lkdGggLSBzaXplSW5mby53aWR0aCksXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBzaXplSW5mby5hdmFpbGFibGVIZWlnaHQgLSAoc2l6ZUluZm8ub3V0ZXJIZWlnaHQgLSBzaXplSW5mby5oZWlnaHQpXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX2Vuc3VyZUJyb3dzZXJXaW5kb3dEZXNjcmlwdG9yIChicm93c2VySWQpIHtcbiAgICAgICAgaWYgKHRoaXMuX2dldFdpbmRvd0Rlc2NyaXB0b3IoYnJvd3NlcklkKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhd2FpdCB0aGlzLl9jcmVhdGVMb2NhbEJyb3dzZXJJbmZvKGJyb3dzZXJJZCk7XG5cbiAgICAgICAgLy8gTk9URTogZGVsYXkgdG8gZW5zdXJlIHRoZSB3aW5kb3cgZmluaXNoZWQgdGhlIG9wZW5pbmdcbiAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4ud2FpdEZvckNvbm5lY3Rpb25SZWFkeShicm93c2VySWQpO1xuICAgICAgICBhd2FpdCBkZWxheShCUk9XU0VSX09QRU5JTkdfREVMQVkpO1xuXG4gICAgICAgIGlmICh0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0pXG4gICAgICAgICAgICB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF0ud2luZG93RGVzY3JpcHRvciA9IGF3YWl0IGJyb3dzZXJUb29scy5maW5kV2luZG93KGJyb3dzZXJJZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2Vuc3VyZUJyb3dzZXJXaW5kb3dQYXJhbWV0ZXJzIChicm93c2VySWQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fZW5zdXJlQnJvd3NlcldpbmRvd0Rlc2NyaXB0b3IoYnJvd3NlcklkKTtcblxuICAgICAgICBpZiAoT1Mud2luICYmICF0aGlzLl9nZXRSZXNpemVDb3JyZWN0aW9ucyhicm93c2VySWQpKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fY2FsY3VsYXRlUmVzaXplQ29ycmVjdGlvbnMoYnJvd3NlcklkKTtcbiAgICAgICAgZWxzZSBpZiAoT1MubWFjICYmICF0aGlzLl9nZXRNYXhTY3JlZW5TaXplKGJyb3dzZXJJZCkpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9jYWxjdWxhdGVNYWNTaXplTGltaXRzKGJyb3dzZXJJZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2Nsb3NlTG9jYWxCcm93c2VyIChicm93c2VySWQpIHtcbiAgICAgICAgYXdhaXQgYnJvd3NlclRvb2xzLmNsb3NlKHRoaXMuX2dldFdpbmRvd0Rlc2NyaXB0b3IoYnJvd3NlcklkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3Jlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdyAoYnJvd3NlcklkLCB3aWR0aCwgaGVpZ2h0LCBjdXJyZW50V2lkdGgsIGN1cnJlbnRIZWlnaHQpIHtcbiAgICAgICAgY29uc3QgcmVzaXplQ29ycmVjdGlvbnMgPSB0aGlzLl9nZXRSZXNpemVDb3JyZWN0aW9ucyhicm93c2VySWQpO1xuXG4gICAgICAgIGlmIChyZXNpemVDb3JyZWN0aW9ucyAmJiBhd2FpdCBicm93c2VyVG9vbHMuaXNNYXhpbWl6ZWQodGhpcy5fZ2V0V2luZG93RGVzY3JpcHRvcihicm93c2VySWQpKSkge1xuICAgICAgICAgICAgd2lkdGggLT0gcmVzaXplQ29ycmVjdGlvbnMud2lkdGg7XG4gICAgICAgICAgICBoZWlnaHQgLT0gcmVzaXplQ29ycmVjdGlvbnMuaGVpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgYnJvd3NlclRvb2xzLnJlc2l6ZSh0aGlzLl9nZXRXaW5kb3dEZXNjcmlwdG9yKGJyb3dzZXJJZCksIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCwgd2lkdGgsIGhlaWdodCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3Rha2VMb2NhbEJyb3dzZXJTY3JlZW5zaG90IChicm93c2VySWQsIHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgIGF3YWl0IGJyb3dzZXJUb29scy5zY3JlZW5zaG90KHRoaXMuX2dldFdpbmRvd0Rlc2NyaXB0b3IoYnJvd3NlcklkKSwgc2NyZWVuc2hvdFBhdGgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9jYW5SZXNpemVMb2NhbEJyb3dzZXJXaW5kb3dUb0RpbWVuc2lvbnMgKGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCkge1xuICAgICAgICBpZiAoIU9TLm1hYylcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuXG4gICAgICAgIHZhciBtYXhTY3JlZW5TaXplID0gdGhpcy5fZ2V0TWF4U2NyZWVuU2l6ZShicm93c2VySWQpO1xuXG4gICAgICAgIHJldHVybiB3aWR0aCA8PSBtYXhTY3JlZW5TaXplLndpZHRoICYmIGhlaWdodCA8PSBtYXhTY3JlZW5TaXplLmhlaWdodDtcbiAgICB9XG5cbiAgICBhc3luYyBfbWF4aW1pemVMb2NhbEJyb3dzZXJXaW5kb3cgKGJyb3dzZXJJZCkge1xuICAgICAgICBhd2FpdCBicm93c2VyVG9vbHMubWF4aW1pemUodGhpcy5fZ2V0V2luZG93RGVzY3JpcHRvcihicm93c2VySWQpKTtcbiAgICB9XG5cbiAgICBhc3luYyBpbml0ICgpIHtcbiAgICAgICAgdmFyIGluaXRpYWxpemVkID0gYXdhaXQgdGhpcy5pbml0UHJvbWlzZTtcblxuICAgICAgICBpZiAoaW5pdGlhbGl6ZWQpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5pbml0UHJvbWlzZSA9IHRoaXMucGx1Z2luXG4gICAgICAgICAgICAuaW5pdCgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0cnVlKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5pbml0UHJvbWlzZTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuaW5pdFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoZmFsc2UpO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGRpc3Bvc2UgKCkge1xuICAgICAgICB2YXIgaW5pdGlhbGl6ZWQgPSBhd2FpdCB0aGlzLmluaXRQcm9taXNlO1xuXG4gICAgICAgIGlmICghaW5pdGlhbGl6ZWQpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5pbml0UHJvbWlzZSA9IHRoaXMucGx1Z2luXG4gICAgICAgICAgICAuZGlzcG9zZSgpXG4gICAgICAgICAgICAudGhlbigoKSA9PiBmYWxzZSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuaW5pdFByb21pc2U7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aGlzLmluaXRQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKGZhbHNlKTtcblxuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBpc0xvY2FsQnJvd3NlciAoYnJvd3NlcklkLCBicm93c2VyTmFtZSkge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wbHVnaW4uaXNMb2NhbEJyb3dzZXIoYnJvd3NlcklkLCBicm93c2VyTmFtZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgb3BlbkJyb3dzZXIgKGJyb3dzZXJJZCwgcGFnZVVybCwgYnJvd3Nlck5hbWUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4ub3BlbkJyb3dzZXIoYnJvd3NlcklkLCBwYWdlVXJsLCBicm93c2VyTmFtZSk7XG5cbiAgICAgICAgdmFyIGlzTG9jYWxCcm93c2VyID0gYXdhaXQgdGhpcy5wbHVnaW4uaXNMb2NhbEJyb3dzZXIoYnJvd3NlcklkKTtcblxuICAgICAgICBpZiAoaXNMb2NhbEJyb3dzZXIpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9lbnN1cmVCcm93c2VyV2luZG93UGFyYW1ldGVycyhicm93c2VySWQpO1xuICAgIH1cblxuICAgIGFzeW5jIGNsb3NlQnJvd3NlciAoYnJvd3NlcklkKSB7XG4gICAgICAgIHZhciBpc0xvY2FsQnJvd3NlciAgICAgICAgID0gYXdhaXQgdGhpcy5wbHVnaW4uaXNMb2NhbEJyb3dzZXIoYnJvd3NlcklkKTtcbiAgICAgICAgdmFyIGN1c3RvbUFjdGlvbnNJbmZvICAgICAgPSBhd2FpdCB0aGlzLmhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIoYnJvd3NlcklkKTtcbiAgICAgICAgdmFyIGhhc0N1c3RvbUNsb3NlQnJvd3NlciAgPSBjdXN0b21BY3Rpb25zSW5mby5oYXNDbG9zZUJyb3dzZXI7XG4gICAgICAgIHZhciB1c2VQbHVnaW5zQ2xvc2VCcm93c2VyID0gaGFzQ3VzdG9tQ2xvc2VCcm93c2VyIHx8ICFpc0xvY2FsQnJvd3NlcjtcblxuICAgICAgICBpZiAodXNlUGx1Z2luc0Nsb3NlQnJvd3NlcilcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLmNsb3NlQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9jbG9zZUxvY2FsQnJvd3Nlcihicm93c2VySWQpO1xuXG4gICAgICAgIGlmIChpc0xvY2FsQnJvd3NlcilcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxvY2FsQnJvd3NlcnNJbmZvW2Jyb3dzZXJJZF07XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QnJvd3Nlckxpc3QgKCkge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wbHVnaW4uZ2V0QnJvd3Nlckxpc3QoKTtcbiAgICB9XG5cbiAgICBhc3luYyBpc1ZhbGlkQnJvd3Nlck5hbWUgKGJyb3dzZXJOYW1lKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnBsdWdpbi5pc1ZhbGlkQnJvd3Nlck5hbWUoYnJvd3Nlck5hbWUpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2l6ZVdpbmRvdyAoYnJvd3NlcklkLCB3aWR0aCwgaGVpZ2h0LCBjdXJyZW50V2lkdGgsIGN1cnJlbnRIZWlnaHQpIHtcbiAgICAgICAgdmFyIGlzTG9jYWxCcm93c2VyICAgICAgICA9IGF3YWl0IHRoaXMucGx1Z2luLmlzTG9jYWxCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIHZhciBjdXN0b21BY3Rpb25zSW5mbyAgICAgPSBhd2FpdCB0aGlzLmhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIoYnJvd3NlcklkKTtcbiAgICAgICAgdmFyIGhhc0N1c3RvbVJlc2l6ZVdpbmRvdyA9IGN1c3RvbUFjdGlvbnNJbmZvLmhhc1Jlc2l6ZVdpbmRvdztcblxuXG4gICAgICAgIGlmIChpc0xvY2FsQnJvd3NlciAmJiAhaGFzQ3VzdG9tUmVzaXplV2luZG93KSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9yZXNpemVMb2NhbEJyb3dzZXJXaW5kb3coYnJvd3NlcklkLCB3aWR0aCwgaGVpZ2h0LCBjdXJyZW50V2lkdGgsIGN1cnJlbnRIZWlnaHQpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4ucmVzaXplV2luZG93KGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KTtcbiAgICB9XG5cbiAgICBhc3luYyBjYW5SZXNpemVXaW5kb3dUb0RpbWVuc2lvbnMgKGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCkge1xuICAgICAgICB2YXIgaXNMb2NhbEJyb3dzZXIgICAgICAgICAgICAgICAgID0gYXdhaXQgdGhpcy5wbHVnaW4uaXNMb2NhbEJyb3dzZXIoYnJvd3NlcklkKTtcbiAgICAgICAgdmFyIGN1c3RvbUFjdGlvbnNJbmZvICAgICAgICAgICAgICA9IGF3YWl0IHRoaXMuaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICB2YXIgaGFzQ3VzdG9tQ2FuUmVzaXplVG9EaW1lbnNpb25zID0gY3VzdG9tQWN0aW9uc0luZm8uaGFzQ2FuUmVzaXplV2luZG93VG9EaW1lbnNpb25zO1xuXG5cbiAgICAgICAgaWYgKGlzTG9jYWxCcm93c2VyICYmICFoYXNDdXN0b21DYW5SZXNpemVUb0RpbWVuc2lvbnMpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2FuUmVzaXplTG9jYWxCcm93c2VyV2luZG93VG9EaW1lbnNpb25zKGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucGx1Z2luLmNhblJlc2l6ZVdpbmRvd1RvRGltZW5zaW9ucyhicm93c2VySWQsIHdpZHRoLCBoZWlnaHQpO1xuICAgIH1cblxuICAgIGFzeW5jIG1heGltaXplV2luZG93IChicm93c2VySWQpIHtcbiAgICAgICAgdmFyIGlzTG9jYWxCcm93c2VyICAgICAgICAgID0gYXdhaXQgdGhpcy5wbHVnaW4uaXNMb2NhbEJyb3dzZXIoYnJvd3NlcklkKTtcbiAgICAgICAgdmFyIGN1c3RvbUFjdGlvbnNJbmZvICAgICAgID0gYXdhaXQgdGhpcy5oYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIHZhciBoYXNDdXN0b21NYXhpbWl6ZVdpbmRvdyA9IGN1c3RvbUFjdGlvbnNJbmZvLmhhc01heGltaXplV2luZG93O1xuXG4gICAgICAgIGlmIChpc0xvY2FsQnJvd3NlciAmJiAhaGFzQ3VzdG9tTWF4aW1pemVXaW5kb3cpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fbWF4aW1pemVMb2NhbEJyb3dzZXJXaW5kb3coYnJvd3NlcklkKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wbHVnaW4ubWF4aW1pemVXaW5kb3coYnJvd3NlcklkKTtcbiAgICB9XG5cbiAgICBhc3luYyB0YWtlU2NyZWVuc2hvdCAoYnJvd3NlcklkLCBzY3JlZW5zaG90UGF0aCwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0KSB7XG4gICAgICAgIHZhciBpc0xvY2FsQnJvd3NlciAgICAgICAgICA9IGF3YWl0IHRoaXMucGx1Z2luLmlzTG9jYWxCcm93c2VyKGJyb3dzZXJJZCk7XG4gICAgICAgIHZhciBjdXN0b21BY3Rpb25zSW5mbyAgICAgICA9IGF3YWl0IHRoaXMuaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3Nlcihicm93c2VySWQpO1xuICAgICAgICB2YXIgaGFzQ3VzdG9tVGFrZVNjcmVlbnNob3QgPSBjdXN0b21BY3Rpb25zSW5mby5oYXNUYWtlU2NyZWVuc2hvdDtcblxuICAgICAgICBpZiAoaXNMb2NhbEJyb3dzZXIgJiYgIWhhc0N1c3RvbVRha2VTY3JlZW5zaG90KSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl90YWtlTG9jYWxCcm93c2VyU2NyZWVuc2hvdChicm93c2VySWQsIHNjcmVlbnNob3RQYXRoLCBwYWdlV2lkdGgsIHBhZ2VIZWlnaHQpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4udGFrZVNjcmVlbnNob3QoYnJvd3NlcklkLCBzY3JlZW5zaG90UGF0aCwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0KTtcbiAgICB9XG5cbiAgICBhc3luYyBoYXNDdXN0b21BY3Rpb25Gb3JCcm93c2VyIChicm93c2VySWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGx1Z2luLmhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIoYnJvd3NlcklkKTtcbiAgICB9XG5cbiAgICBhc3luYyByZXBvcnRKb2JSZXN1bHQgKGJyb3dzZXJJZCwgc3RhdHVzLCBkYXRhKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnJlcG9ydEpvYlJlc3VsdChicm93c2VySWQsIHN0YXR1cywgZGF0YSk7XG4gICAgfVxufVxuIl19
