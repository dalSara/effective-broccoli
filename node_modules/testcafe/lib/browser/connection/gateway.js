'use strict';

exports.__esModule = true;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _readFileRelative = require('read-file-relative');

var _http = require('../../utils/http');

var _remotesQueue = require('./remotes-queue');

var _remotesQueue2 = _interopRequireDefault(_remotesQueue);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Const
const IDLE_PAGE_SCRIPT = (0, _readFileRelative.readSync)('../../client/browser/idle-page/index.js');
const IDLE_PAGE_STYLE = (0, _readFileRelative.readSync)('../../client/browser/idle-page/styles.css');
const IDLE_PAGE_LOGO = (0, _readFileRelative.readSync)('../../client/browser/idle-page/logo.svg', true);

// Gateway
class BrowserConnectionGateway {
    constructor(proxy) {
        this.connections = {};
        this.remotesQueue = new _remotesQueue2.default();
        this.domain = proxy.server1Info.domain;

        this.connectUrl = `${this.domain}/browser/connect`;

        this._registerRoutes(proxy);
    }

    _dispatch(url, proxy, handler, method = 'GET') {
        proxy[method](url, (req, res, si, params) => {
            var connection = this.connections[params.id];

            (0, _http.preventCaching)(res);

            if (connection) handler(req, res, connection);else (0, _http.respond404)(res);
        });
    }

    _registerRoutes(proxy) {
        this._dispatch('/browser/connect/{id}', proxy, BrowserConnectionGateway.onConnection);
        this._dispatch('/browser/heartbeat/{id}', proxy, BrowserConnectionGateway.onHeartbeat);
        this._dispatch('/browser/idle/{id}', proxy, BrowserConnectionGateway.onIdle);
        this._dispatch('/browser/idle-forced/{id}', proxy, BrowserConnectionGateway.onIdleForced);
        this._dispatch('/browser/status/{id}', proxy, BrowserConnectionGateway.onStatusRequest);
        this._dispatch('/browser/status-done/{id}', proxy, BrowserConnectionGateway.onStatusRequestOnTestDone);
        this._dispatch('/browser/init-script/{id}', proxy, BrowserConnectionGateway.onInitScriptRequest);
        this._dispatch('/browser/init-script/{id}', proxy, BrowserConnectionGateway.onInitScriptResponse, 'POST');

        proxy.GET('/browser/connect', (req, res) => this._connectNextRemoteBrowser(req, res));
        proxy.GET('/browser/connect/', (req, res) => this._connectNextRemoteBrowser(req, res));

        proxy.GET('/browser/assets/index.js', { content: IDLE_PAGE_SCRIPT, contentType: 'application/x-javascript' });
        proxy.GET('/browser/assets/styles.css', { content: IDLE_PAGE_STYLE, contentType: 'text/css' });
        proxy.GET('/browser/assets/logo.svg', { content: IDLE_PAGE_LOGO, contentType: 'image/svg+xml' });
    }

    // Helpers
    static ensureConnectionReady(res, connection) {
        if (!connection.ready) {
            (0, _http.respond500)(res, 'The connection is not ready yet.');
            return false;
        }

        return true;
    }

    // Route handlers
    static onConnection(req, res, connection) {
        if (connection.ready) (0, _http.respond500)(res, 'The connection is already established.');else {
            var userAgent = req.headers['user-agent'];

            connection.establish(userAgent);
            (0, _http.redirect)(res, connection.idleUrl);
        }
    }

    static onHeartbeat(req, res, connection) {
        if (BrowserConnectionGateway.ensureConnectionReady(res, connection)) {
            var status = connection.heartbeat();

            (0, _http.respondWithJSON)(res, status);
        }
    }

    static onIdle(req, res, connection) {
        if (BrowserConnectionGateway.ensureConnectionReady(res, connection)) res.end(connection.renderIdlePage());
    }

    static onIdleForced(req, res, connection) {
        return (0, _asyncToGenerator3.default)(function* () {
            if (BrowserConnectionGateway.ensureConnectionReady(res, connection)) {
                const status = yield connection.getStatus(true);

                (0, _http.redirect)(res, status.url);
            }
        })();
    }

    static onStatusRequest(req, res, connection) {
        return (0, _asyncToGenerator3.default)(function* () {
            return BrowserConnectionGateway._onStatusRequestCore(req, res, connection, false);
        })();
    }

    static onStatusRequestOnTestDone(req, res, connection) {
        return (0, _asyncToGenerator3.default)(function* () {
            return BrowserConnectionGateway._onStatusRequestCore(req, res, connection, true);
        })();
    }

    static _onStatusRequestCore(req, res, connection, isTestDone) {
        return (0, _asyncToGenerator3.default)(function* () {
            if (BrowserConnectionGateway.ensureConnectionReady(res, connection)) {
                var status = yield connection.getStatus(isTestDone);

                (0, _http.respondWithJSON)(res, status);
            }
        })();
    }

    static onInitScriptRequest(req, res, connection) {
        if (BrowserConnectionGateway.ensureConnectionReady(res, connection)) {
            var script = connection.getInitScript();

            (0, _http.respondWithJSON)(res, script);
        }
    }

    static onInitScriptResponse(req, res, connection) {
        if (BrowserConnectionGateway.ensureConnectionReady(res, connection)) {
            var data = '';

            req.on('data', chunk => {
                data += chunk;
            });

            req.on('end', () => {
                connection.handleInitScriptResult(data);

                res.end();
            });
        }
    }

    _connectNextRemoteBrowser(req, res) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            (0, _http.preventCaching)(res);

            var remoteConnection = yield _this.remotesQueue.shift();

            if (remoteConnection) (0, _http.redirect)(res, remoteConnection.url);else (0, _http.respond500)(res, 'There are no available connections to establish.');
        })();
    }

    // API
    startServingConnection(connection) {
        this.connections[connection.id] = connection;

        if (connection.browserInfo.providerName === 'remote') this.remotesQueue.add(connection);
    }

    stopServingConnection(connection) {
        delete this.connections[connection.id];

        if (connection.browserInfo.providerName === 'remote') this.remotesQueue.remove(connection);
    }

    close() {
        (0, _keys2.default)(this.connections).forEach(id => this.connections[id].close());
    }
}
exports.default = BrowserConnectionGateway;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2Nvbm5lY3Rpb24vZ2F0ZXdheS5qcyJdLCJuYW1lcyI6WyJJRExFX1BBR0VfU0NSSVBUIiwiSURMRV9QQUdFX1NUWUxFIiwiSURMRV9QQUdFX0xPR08iLCJCcm93c2VyQ29ubmVjdGlvbkdhdGV3YXkiLCJjb25zdHJ1Y3RvciIsInByb3h5IiwiY29ubmVjdGlvbnMiLCJyZW1vdGVzUXVldWUiLCJSZW1vdGVzUXVldWUiLCJkb21haW4iLCJzZXJ2ZXIxSW5mbyIsImNvbm5lY3RVcmwiLCJfcmVnaXN0ZXJSb3V0ZXMiLCJfZGlzcGF0Y2giLCJ1cmwiLCJoYW5kbGVyIiwibWV0aG9kIiwicmVxIiwicmVzIiwic2kiLCJwYXJhbXMiLCJjb25uZWN0aW9uIiwiaWQiLCJvbkNvbm5lY3Rpb24iLCJvbkhlYXJ0YmVhdCIsIm9uSWRsZSIsIm9uSWRsZUZvcmNlZCIsIm9uU3RhdHVzUmVxdWVzdCIsIm9uU3RhdHVzUmVxdWVzdE9uVGVzdERvbmUiLCJvbkluaXRTY3JpcHRSZXF1ZXN0Iiwib25Jbml0U2NyaXB0UmVzcG9uc2UiLCJHRVQiLCJfY29ubmVjdE5leHRSZW1vdGVCcm93c2VyIiwiY29udGVudCIsImNvbnRlbnRUeXBlIiwiZW5zdXJlQ29ubmVjdGlvblJlYWR5IiwicmVhZHkiLCJ1c2VyQWdlbnQiLCJoZWFkZXJzIiwiZXN0YWJsaXNoIiwiaWRsZVVybCIsInN0YXR1cyIsImhlYXJ0YmVhdCIsImVuZCIsInJlbmRlcklkbGVQYWdlIiwiZ2V0U3RhdHVzIiwiX29uU3RhdHVzUmVxdWVzdENvcmUiLCJpc1Rlc3REb25lIiwic2NyaXB0IiwiZ2V0SW5pdFNjcmlwdCIsImRhdGEiLCJvbiIsImNodW5rIiwiaGFuZGxlSW5pdFNjcmlwdFJlc3VsdCIsInJlbW90ZUNvbm5lY3Rpb24iLCJzaGlmdCIsInN0YXJ0U2VydmluZ0Nvbm5lY3Rpb24iLCJicm93c2VySW5mbyIsInByb3ZpZGVyTmFtZSIsImFkZCIsInN0b3BTZXJ2aW5n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V0FBWCxDQUF1QkMsWUFBdkIsS0FBd0MsUUFBNUMsRUFDSSxLQUFLbkQsWUFBTCxDQUFrQnNELE1BQWxCLENBQXlCeEMsVUFBekI7QUFDUDs7QUFFRHlDLFlBQVM7QUFDTCw0QkFBWSxLQUFLeEQsV0FBakIsRUFBOEJ5RCxPQUE5QixDQUFzQ3pDLE1BQU0sS0FBS2hCLFdBQUwsQ0FBaUJnQixFQUFqQixFQUFxQndDLEtBQXJCLEVBQTVDO0FBQ0g7QUEzSnlDO2tCQUF6QjNELHdCIiwiZmlsZSI6ImJyb3dzZXIvY29ubmVjdGlvbi9nYXRld2F5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVhZFN5bmMgYXMgcmVhZCB9IGZyb20gJ3JlYWQtZmlsZS1yZWxhdGl2ZSc7XG5pbXBvcnQgeyByZXNwb25kNDA0LCByZXNwb25kNTAwLCByZXNwb25kV2l0aEpTT04sIHJlZGlyZWN0LCBwcmV2ZW50Q2FjaGluZyB9IGZyb20gJy4uLy4uL3V0aWxzL2h0dHAnO1xuaW1wb3J0IFJlbW90ZXNRdWV1ZSBmcm9tICcuL3JlbW90ZXMtcXVldWUnO1xuXG5cbi8vIENvbnN0XG5jb25zdCBJRExFX1BBR0VfU0NSSVBUID0gcmVhZCgnLi4vLi4vY2xpZW50L2Jyb3dzZXIvaWRsZS1wYWdlL2luZGV4LmpzJyk7XG5jb25zdCBJRExFX1BBR0VfU1RZTEUgID0gcmVhZCgnLi4vLi4vY2xpZW50L2Jyb3dzZXIvaWRsZS1wYWdlL3N0eWxlcy5jc3MnKTtcbmNvbnN0IElETEVfUEFHRV9MT0dPICAgPSByZWFkKCcuLi8uLi9jbGllbnQvYnJvd3Nlci9pZGxlLXBhZ2UvbG9nby5zdmcnLCB0cnVlKTtcblxuLy8gR2F0ZXdheVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5IHtcbiAgICBjb25zdHJ1Y3RvciAocHJveHkpIHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9ucyAgPSB7fTtcbiAgICAgICAgdGhpcy5yZW1vdGVzUXVldWUgPSBuZXcgUmVtb3Rlc1F1ZXVlKCk7XG4gICAgICAgIHRoaXMuZG9tYWluICAgICAgID0gcHJveHkuc2VydmVyMUluZm8uZG9tYWluO1xuXG4gICAgICAgIHRoaXMuY29ubmVjdFVybCA9IGAke3RoaXMuZG9tYWlufS9icm93c2VyL2Nvbm5lY3RgO1xuXG4gICAgICAgIHRoaXMuX3JlZ2lzdGVyUm91dGVzKHByb3h5KTtcbiAgICB9XG5cbiAgICBfZGlzcGF0Y2ggKHVybCwgcHJveHksIGhhbmRsZXIsIG1ldGhvZCA9ICdHRVQnKSB7XG4gICAgICAgIHByb3h5W21ldGhvZF0odXJsLCAocmVxLCByZXMsIHNpLCBwYXJhbXMpID0+IHtcbiAgICAgICAgICAgIHZhciBjb25uZWN0aW9uID0gdGhpcy5jb25uZWN0aW9uc1twYXJhbXMuaWRdO1xuXG4gICAgICAgICAgICBwcmV2ZW50Q2FjaGluZyhyZXMpO1xuXG4gICAgICAgICAgICBpZiAoY29ubmVjdGlvbilcbiAgICAgICAgICAgICAgICBoYW5kbGVyKHJlcSwgcmVzLCBjb25uZWN0aW9uKTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICByZXNwb25kNDA0KHJlcyk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9yZWdpc3RlclJvdXRlcyAocHJveHkpIHtcbiAgICAgICAgdGhpcy5fZGlzcGF0Y2goJy9icm93c2VyL2Nvbm5lY3Qve2lkfScsIHByb3h5LCBCcm93c2VyQ29ubmVjdGlvbkdhdGV3YXkub25Db25uZWN0aW9uKTtcbiAgICAgICAgdGhpcy5fZGlzcGF0Y2goJy9icm93c2VyL2hlYXJ0YmVhdC97aWR9JywgcHJveHksIEJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5vbkhlYXJ0YmVhdCk7XG4gICAgICAgIHRoaXMuX2Rpc3BhdGNoKCcvYnJvd3Nlci9pZGxlL3tpZH0nLCBwcm94eSwgQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5Lm9uSWRsZSk7XG4gICAgICAgIHRoaXMuX2Rpc3BhdGNoKCcvYnJvd3Nlci9pZGxlLWZvcmNlZC97aWR9JywgcHJveHksIEJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5vbklkbGVGb3JjZWQpO1xuICAgICAgICB0aGlzLl9kaXNwYXRjaCgnL2Jyb3dzZXIvc3RhdHVzL3tpZH0nLCBwcm94eSwgQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5Lm9uU3RhdHVzUmVxdWVzdCk7XG4gICAgICAgIHRoaXMuX2Rpc3BhdGNoKCcvYnJvd3Nlci9zdGF0dXMtZG9uZS97aWR9JywgcHJveHksIEJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5vblN0YXR1c1JlcXVlc3RPblRlc3REb25lKTtcbiAgICAgICAgdGhpcy5fZGlzcGF0Y2goJy9icm93c2VyL2luaXQtc2NyaXB0L3tpZH0nLCBwcm94eSwgQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5Lm9uSW5pdFNjcmlwdFJlcXVlc3QpO1xuICAgICAgICB0aGlzLl9kaXNwYXRjaCgnL2Jyb3dzZXIvaW5pdC1zY3JpcHQve2lkfScsIHByb3h5LCBCcm93c2VyQ29ubmVjdGlvbkdhdGV3YXkub25Jbml0U2NyaXB0UmVzcG9uc2UsICdQT1NUJyk7XG5cbiAgICAgICAgcHJveHkuR0VUKCcvYnJvd3Nlci9jb25uZWN0JywgKHJlcSwgcmVzKSA9PiB0aGlzLl9jb25uZWN0TmV4dFJlbW90ZUJyb3dzZXIocmVxLCByZXMpKTtcbiAgICAgICAgcHJveHkuR0VUKCcvYnJvd3Nlci9jb25uZWN0LycsIChyZXEsIHJlcykgPT4gdGhpcy5fY29ubmVjdE5leHRSZW1vdGVCcm93c2VyKHJlcSwgcmVzKSk7XG5cbiAgICAgICAgcHJveHkuR0VUKCcvYnJvd3Nlci9hc3NldHMvaW5kZXguanMnLCB7IGNvbnRlbnQ6IElETEVfUEFHRV9TQ1JJUFQsIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24veC1qYXZhc2NyaXB0JyB9KTtcbiAgICAgICAgcHJveHkuR0VUKCcvYnJvd3Nlci9hc3NldHMvc3R5bGVzLmNzcycsIHsgY29udGVudDogSURMRV9QQUdFX1NUWUxFLCBjb250ZW50VHlwZTogJ3RleHQvY3NzJyB9KTtcbiAgICAgICAgcHJveHkuR0VUKCcvYnJvd3Nlci9hc3NldHMvbG9nby5zdmcnLCB7IGNvbnRlbnQ6IElETEVfUEFHRV9MT0dPLCBjb250ZW50VHlwZTogJ2ltYWdlL3N2Zyt4bWwnIH0pO1xuICAgIH1cblxuICAgIC8vIEhlbHBlcnNcbiAgICBzdGF0aWMgZW5zdXJlQ29ubmVjdGlvblJlYWR5IChyZXMsIGNvbm5lY3Rpb24pIHtcbiAgICAgICAgaWYgKCFjb25uZWN0aW9uLnJlYWR5KSB7XG4gICAgICAgICAgICByZXNwb25kNTAwKHJlcywgJ1RoZSBjb25uZWN0aW9uIGlzIG5vdCByZWFkeSB5ZXQuJyk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cblxuICAgIC8vIFJvdXRlIGhhbmRsZXJzXG4gICAgc3RhdGljIG9uQ29ubmVjdGlvbiAocmVxLCByZXMsIGNvbm5lY3Rpb24pIHtcbiAgICAgICAgaWYgKGNvbm5lY3Rpb24ucmVhZHkpXG4gICAgICAgICAgICByZXNwb25kNTAwKHJlcywgJ1RoZSBjb25uZWN0aW9uIGlzIGFscmVhZHkgZXN0YWJsaXNoZWQuJyk7XG5cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB2YXIgdXNlckFnZW50ID0gcmVxLmhlYWRlcnNbJ3VzZXItYWdlbnQnXTtcblxuICAgICAgICAgICAgY29ubmVjdGlvbi5lc3RhYmxpc2godXNlckFnZW50KTtcbiAgICAgICAgICAgIHJlZGlyZWN0KHJlcywgY29ubmVjdGlvbi5pZGxlVXJsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBvbkhlYXJ0YmVhdCAocmVxLCByZXMsIGNvbm5lY3Rpb24pIHtcbiAgICAgICAgaWYgKEJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5lbnN1cmVDb25uZWN0aW9uUmVhZHkocmVzLCBjb25uZWN0aW9uKSkge1xuICAgICAgICAgICAgdmFyIHN0YXR1cyA9IGNvbm5lY3Rpb24uaGVhcnRiZWF0KCk7XG5cbiAgICAgICAgICAgIHJlc3BvbmRXaXRoSlNPTihyZXMsIHN0YXR1cyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgb25JZGxlIChyZXEsIHJlcywgY29ubmVjdGlvbikge1xuICAgICAgICBpZiAoQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5LmVuc3VyZUNvbm5lY3Rpb25SZWFkeShyZXMsIGNvbm5lY3Rpb24pKVxuICAgICAgICAgICAgcmVzLmVuZChjb25uZWN0aW9uLnJlbmRlcklkbGVQYWdlKCkpO1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBvbklkbGVGb3JjZWQgKHJlcSwgcmVzLCBjb25uZWN0aW9uKSB7XG4gICAgICAgIGlmIChCcm93c2VyQ29ubmVjdGlvbkdhdGV3YXkuZW5zdXJlQ29ubmVjdGlvblJlYWR5KHJlcywgY29ubmVjdGlvbikpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IGNvbm5lY3Rpb24uZ2V0U3RhdHVzKHRydWUpO1xuXG4gICAgICAgICAgICByZWRpcmVjdChyZXMsIHN0YXR1cy51cmwpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIGFzeW5jIG9uU3RhdHVzUmVxdWVzdCAocmVxLCByZXMsIGNvbm5lY3Rpb24pIHtcbiAgICAgICAgcmV0dXJuIEJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5fb25TdGF0dXNSZXF1ZXN0Q29yZShyZXEsIHJlcywgY29ubmVjdGlvbiwgZmFsc2UpO1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBvblN0YXR1c1JlcXVlc3RPblRlc3REb25lIChyZXEsIHJlcywgY29ubmVjdGlvbikge1xuICAgICAgICByZXR1cm4gQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5Ll9vblN0YXR1c1JlcXVlc3RDb3JlKHJlcSwgcmVzLCBjb25uZWN0aW9uLCB0cnVlKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgX29uU3RhdHVzUmVxdWVzdENvcmUgKHJlcSwgcmVzLCBjb25uZWN0aW9uLCBpc1Rlc3REb25lKSB7XG4gICAgICAgIGlmIChCcm93c2VyQ29ubmVjdGlvbkdhdGV3YXkuZW5zdXJlQ29ubmVjdGlvblJlYWR5KHJlcywgY29ubmVjdGlvbikpIHtcbiAgICAgICAgICAgIHZhciBzdGF0dXMgPSBhd2FpdCBjb25uZWN0aW9uLmdldFN0YXR1cyhpc1Rlc3REb25lKTtcblxuICAgICAgICAgICAgcmVzcG9uZFdpdGhKU09OKHJlcywgc3RhdHVzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBvbkluaXRTY3JpcHRSZXF1ZXN0IChyZXEsIHJlcywgY29ubmVjdGlvbikge1xuICAgICAgICBpZiAoQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5LmVuc3VyZUNvbm5lY3Rpb25SZWFkeShyZXMsIGNvbm5lY3Rpb24pKSB7XG4gICAgICAgICAgICB2YXIgc2NyaXB0ID0gY29ubmVjdGlvbi5nZXRJbml0U2NyaXB0KCk7XG5cbiAgICAgICAgICAgIHJlc3BvbmRXaXRoSlNPTihyZXMsIHNjcmlwdCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgb25Jbml0U2NyaXB0UmVzcG9uc2UgKHJlcSwgcmVzLCBjb25uZWN0aW9uKSB7XG4gICAgICAgIGlmIChCcm93c2VyQ29ubmVjdGlvbkdhdGV3YXkuZW5zdXJlQ29ubmVjdGlvblJlYWR5KHJlcywgY29ubmVjdGlvbikpIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gJyc7XG5cbiAgICAgICAgICAgIHJlcS5vbignZGF0YScsIGNodW5rID0+IHtcbiAgICAgICAgICAgICAgICBkYXRhICs9IGNodW5rO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJlcS5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24uaGFuZGxlSW5pdFNjcmlwdFJlc3VsdChkYXRhKTtcblxuICAgICAgICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX2Nvbm5lY3ROZXh0UmVtb3RlQnJvd3NlciAocmVxLCByZXMpIHtcbiAgICAgICAgcHJldmVudENhY2hpbmcocmVzKTtcblxuICAgICAgICB2YXIgcmVtb3RlQ29ubmVjdGlvbiA9IGF3YWl0IHRoaXMucmVtb3Rlc1F1ZXVlLnNoaWZ0KCk7XG5cbiAgICAgICAgaWYgKHJlbW90ZUNvbm5lY3Rpb24pXG4gICAgICAgICAgICByZWRpcmVjdChyZXMsIHJlbW90ZUNvbm5lY3Rpb24udXJsKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgcmVzcG9uZDUwMChyZXMsICdUaGVyZSBhcmUgbm8gYXZhaWxhYmxlIGNvbm5lY3Rpb25zIHRvIGVzdGFibGlzaC4nKTtcbiAgICB9XG5cbiAgICAvLyBBUElcbiAgICBzdGFydFNlcnZpbmdDb25uZWN0aW9uIChjb25uZWN0aW9uKSB7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbnNbY29ubmVjdGlvbi5pZF0gPSBjb25uZWN0aW9uO1xuXG4gICAgICAgIGlmIChjb25uZWN0aW9uLmJyb3dzZXJJbmZvLnByb3ZpZGVyTmFtZSA9PT0gJ3JlbW90ZScpXG4gICAgICAgICAgICB0aGlzLnJlbW90ZXNRdWV1ZS5hZGQoY29ubmVjdGlvbik7XG4gICAgfVxuXG4gICAgc3RvcFNlcnZpbmdDb25uZWN0aW9uIChjb25uZWN0aW9uKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmNvbm5lY3Rpb25zW2Nvbm5lY3Rpb24uaWRdO1xuXG4gICAgICAgIGlmIChjb25uZWN0aW9uLmJyb3dzZXJJbmZvLnByb3ZpZGVyTmFtZSA9PT0gJ3JlbW90ZScpXG4gICAgICAgICAgICB0aGlzLnJlbW90ZXNRdWV1ZS5yZW1vdmUoY29ubmVjdGlvbik7XG4gICAgfVxuXG4gICAgY2xvc2UgKCkge1xuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLmNvbm5lY3Rpb25zKS5mb3JFYWNoKGlkID0+IHRoaXMuY29ubmVjdGlvbnNbaWRdLmNsb3NlKCkpO1xuICAgIH1cbn1cblxuIl19
