'use strict';

exports.__esModule = true;

var _lodash = require('lodash');

var _pluginHost = require('./plugin-host');

var _pluginHost2 = _interopRequireDefault(_pluginHost);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Reporter {
    constructor(plugin, task, outStream) {
        this.plugin = new _pluginHost2.default(plugin, outStream);

        this.passed = 0;
        this.skipped = task.tests.filter(test => test.skip).length;
        this.testCount = task.tests.length - this.skipped;
        this.reportQueue = Reporter._createReportQueue(task);

        this._assignTaskEventHandlers(task);
    }

    // Static
    static _createReportQueue(task) {
        var runsPerTest = task.browserConnectionGroups.length;

        return task.tests.map(test => Reporter._createReportItem(test, runsPerTest));
    }

    static _createReportItem(test, runsPerTest) {
        return {
            fixture: test.fixture,
            test: test,
            screenshotPath: null,
            screenshots: [],
            quarantine: null,
            pendingRuns: runsPerTest,
            errs: [],
            unstable: false,
            startTime: null,
            testRunInfo: null
        };
    }

    static _createTestRunInfo(reportItem) {
        return {
            errs: (0, _lodash.sortBy)(reportItem.errs, ['userAgent', 'type']),
            durationMs: new Date() - reportItem.startTime,
            unstable: reportItem.unstable,
            screenshotPath: reportItem.screenshotPath,
            screenshots: reportItem.screenshots,
            quarantine: reportItem.quarantine,
            skipped: reportItem.test.skip
        };
    }

    _getReportItemForTestRun(testRun) {
        return (0, _lodash.find)(this.reportQueue, i => i.test === testRun.test);
    }

    _shiftReportQueue(reportItem) {
        var currentFixture = null;
        var nextReportItem = null;

        while (this.reportQueue.length && this.reportQueue[0].testRunInfo) {
            reportItem = this.reportQueue.shift();
            currentFixture = reportItem.fixture;

            this.plugin.reportTestDone(reportItem.test.name, reportItem.testRunInfo, reportItem.test.meta);

            // NOTE: here we assume that tests are sorted by fixture.
            // Therefore, if the next report item has a different
            // fixture, we can report this fixture start.
            nextReportItem = this.reportQueue[0];

            if (nextReportItem && nextReportItem.fixture !== currentFixture) this.plugin.reportFixtureStart(nextReportItem.fixture.name, nextReportItem.fixture.path, nextReportItem.fixture.meta);
        }
    }

    _assignTaskEventHandlers(task) {
        task.once('start', () => {
            var startTime = new Date();
            var userAgents = task.browserConnectionGroups.map(group => group[0].userAgent);
            var first = this.reportQueue[0];

            this.plugin.reportTaskStart(startTime, userAgents, this.testCount);
            this.plugin.reportFixtureStart(first.fixture.name, first.fixture.path, first.fixture.meta);
        });

        task.on('test-run-start', testRun => {
            var reportItem = this._getReportItemForTestRun(testRun);

            if (!reportItem.startTime) reportItem.startTime = new Date();
        });

        task.on('test-run-done', testRun => {
            var reportItem = this._getReportItemForTestRun(testRun);

            reportItem.pendingRuns--;
            reportItem.unstable = reportItem.unstable || testRun.unstable;
            reportItem.errs = reportItem.errs.concat(testRun.errs);

            if (!reportItem.pendingRuns) {
                if (task.screenshots.hasCapturedFor(testRun.test)) {
                    reportItem.screenshotPath = task.screenshots.getPathFor(testRun.test);
                    reportItem.screenshots = task.screenshots.getScreenshotsInfo(testRun.test);
                }

                if (testRun.quarantine) {
                    reportItem.quarantine = testRun.quarantine.attempts.reduce((result, errors, index) => {
                        const passed = !errors.length;
                        const quarantineAttempt = index + 1;

                        result[quarantineAttempt] = { passed };

                        return result;
                    }, {});
                }

                if (!reportItem.testRunInfo) {
                    reportItem.testRunInfo = Reporter._createTestRunInfo(reportItem);

                    if (!reportItem.errs.length && !reportItem.test.skip) this.passed++;
                }

                this._shiftReportQueue(reportItem);
            }
        });

        task.once('done', () => {
            var endTime = new Date();

            this.plugin.reportTaskDone(endTime, this.passed, task.warningLog.messages);
        });
    }
}
exports.default = Reporter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXBvcnRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJSZXBvcnRlciIsImNvbnN0cnVjdG9yIiwicGx1Z2luIiwidGFzayIsIm91dFN0cmVhbSIsIlJlcG9ydGVyUGx1Z2luSG9zdCIsInBhc3NlZCIsInNraXBwZWQiLCJ0ZXN0cyIsImZpbHRlciIsInRlc3QiLCJza2lwIiwibGVuZ3RoIiwidGVzdENvdW50IiwicmVwb3J0UXVldWUiLCJfY3JlYXRlUmVwb3J0UXVldWUiLCJfYXNzaWduVGFza0V2ZW50SGFuZGxlcnMiLCJydW5zUGVyVGVzdCIsImJyb3dzZXJDb25uZWN0aW9uR3JvdXBzIiwibWFwIiwiX2NyZWF0ZVJlcG9ydEl0ZW0iLCJmaXh0dXJlIiwic2NyZWVuc2hvdFBhdGgiLCJzY3JlZW5zaG90cyIsInF1YXJhbnRpbmUiLCJwZW5kaW5nUnVucyIsImVycnMiLCJ1bnN0YWJsZSIsInN0YXJ0VGltZSIsInRlc3RSdW5JbmZvIiwiX2NyZWF0ZVRlc3RSdW5JbmZvIiwicmVwb3J0SXRlbSIsImR1cmF0aW9uTXMiLCJEYXRlIiwiX2dldFJlcG9ydEl0ZW1Gb3JUZXN0UnVuIiwidGVzdFJ1biIsImkiLCJfc2hpZnRSZXBvcnRRdWV1ZSIsImN1cnJlbnRGaXh0dXJlIiwibmV4dFJlcG9ydEl0ZW0iLCJzaGlmdCIsInJlcG9ydFRlc3REb25lIiwibmFtZSIsIm1ldGEiLCJyZXBvcnRGaXh0dXJlU3RhcnQiLCJwYXRoIiwib25jZSIsInVzZXJBZ2VudHMiLCJncm91cCIsInVzZXJBZ2VudCIsImZpcnN0IiwicmVwb3J0VGFza1N0YXJ0Iiwib24iLCJjb25jYXQiLCJoYXNDYXB0dXJlZEZvciIsImdldFBhdGhGb3IiLCJnZXRTY3JlZW5zaG90c0luZm8iLCJhdHRlbXB0cyIsInJlZHVjZSIsInJlc3VsdCIsImVycm9ycyIsImluZGV4IiwicXVhcmFudGluZUF0dGVtcHQiLCJlbmRUaW1lIiwicmVwb3J0VGFza0RvbmUiLCJ3YXJuaW5nTG9n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QUNIO0FBQ0osU0FqQ0Q7O0FBbUNBNUIsYUFBSzJDLElBQUwsQ0FBVSxNQUFWLEVBQWtCLE1BQU07QUFDcEIsZ0JBQUlpQixVQUFVLElBQUk5QixJQUFKLEVBQWQ7O0FBRUEsaUJBQUsvQixNQUFMLENBQVk4RCxjQUFaLENBQTJCRCxPQUEzQixFQUFvQyxLQUFLekQsTUFBekMsRUFBaURILEtBQUs4RCxVQUFMLENBQWdCQyxRQUFqRTtBQUNILFNBSkQ7QUFLSDtBQS9IeUI7a0JBQVRsRSxRIiwiZmlsZSI6InJlcG9ydGVyL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZmluZCwgc29ydEJ5IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBSZXBvcnRlclBsdWdpbkhvc3QgZnJvbSAnLi9wbHVnaW4taG9zdCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlcG9ydGVyIHtcbiAgICBjb25zdHJ1Y3RvciAocGx1Z2luLCB0YXNrLCBvdXRTdHJlYW0pIHtcbiAgICAgICAgdGhpcy5wbHVnaW4gPSBuZXcgUmVwb3J0ZXJQbHVnaW5Ib3N0KHBsdWdpbiwgb3V0U3RyZWFtKTtcblxuICAgICAgICB0aGlzLnBhc3NlZCAgICAgID0gMDtcbiAgICAgICAgdGhpcy5za2lwcGVkICAgICA9IHRhc2sudGVzdHMuZmlsdGVyKHRlc3QgPT4gdGVzdC5za2lwKS5sZW5ndGg7XG4gICAgICAgIHRoaXMudGVzdENvdW50ICAgPSB0YXNrLnRlc3RzLmxlbmd0aCAtIHRoaXMuc2tpcHBlZDtcbiAgICAgICAgdGhpcy5yZXBvcnRRdWV1ZSA9IFJlcG9ydGVyLl9jcmVhdGVSZXBvcnRRdWV1ZSh0YXNrKTtcblxuICAgICAgICB0aGlzLl9hc3NpZ25UYXNrRXZlbnRIYW5kbGVycyh0YXNrKTtcbiAgICB9XG5cbiAgICAvLyBTdGF0aWNcbiAgICBzdGF0aWMgX2NyZWF0ZVJlcG9ydFF1ZXVlICh0YXNrKSB7XG4gICAgICAgIHZhciBydW5zUGVyVGVzdCA9IHRhc2suYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMubGVuZ3RoO1xuXG4gICAgICAgIHJldHVybiB0YXNrLnRlc3RzLm1hcCh0ZXN0ID0+IFJlcG9ydGVyLl9jcmVhdGVSZXBvcnRJdGVtKHRlc3QsIHJ1bnNQZXJUZXN0KSk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9jcmVhdGVSZXBvcnRJdGVtICh0ZXN0LCBydW5zUGVyVGVzdCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZml4dHVyZTogICAgICAgIHRlc3QuZml4dHVyZSxcbiAgICAgICAgICAgIHRlc3Q6ICAgICAgICAgICB0ZXN0LFxuICAgICAgICAgICAgc2NyZWVuc2hvdFBhdGg6IG51bGwsXG4gICAgICAgICAgICBzY3JlZW5zaG90czogICAgW10sXG4gICAgICAgICAgICBxdWFyYW50aW5lOiAgICAgbnVsbCxcbiAgICAgICAgICAgIHBlbmRpbmdSdW5zOiAgICBydW5zUGVyVGVzdCxcbiAgICAgICAgICAgIGVycnM6ICAgICAgICAgICBbXSxcbiAgICAgICAgICAgIHVuc3RhYmxlOiAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIHN0YXJ0VGltZTogICAgICBudWxsLFxuICAgICAgICAgICAgdGVzdFJ1bkluZm86ICAgIG51bGxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2NyZWF0ZVRlc3RSdW5JbmZvIChyZXBvcnRJdGVtKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBlcnJzOiAgICAgICAgICAgc29ydEJ5KHJlcG9ydEl0ZW0uZXJycywgWyd1c2VyQWdlbnQnLCAndHlwZSddKSxcbiAgICAgICAgICAgIGR1cmF0aW9uTXM6ICAgICBuZXcgRGF0ZSgpIC0gcmVwb3J0SXRlbS5zdGFydFRpbWUsXG4gICAgICAgICAgICB1bnN0YWJsZTogICAgICAgcmVwb3J0SXRlbS51bnN0YWJsZSxcbiAgICAgICAgICAgIHNjcmVlbnNob3RQYXRoOiByZXBvcnRJdGVtLnNjcmVlbnNob3RQYXRoLFxuICAgICAgICAgICAgc2NyZWVuc2hvdHM6ICAgIHJlcG9ydEl0ZW0uc2NyZWVuc2hvdHMsXG4gICAgICAgICAgICBxdWFyYW50aW5lOiAgICAgcmVwb3J0SXRlbS5xdWFyYW50aW5lLFxuICAgICAgICAgICAgc2tpcHBlZDogICAgICAgIHJlcG9ydEl0ZW0udGVzdC5za2lwXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2dldFJlcG9ydEl0ZW1Gb3JUZXN0UnVuICh0ZXN0UnVuKSB7XG4gICAgICAgIHJldHVybiBmaW5kKHRoaXMucmVwb3J0UXVldWUsIGkgPT4gaS50ZXN0ID09PSB0ZXN0UnVuLnRlc3QpO1xuICAgIH1cblxuICAgIF9zaGlmdFJlcG9ydFF1ZXVlIChyZXBvcnRJdGVtKSB7XG4gICAgICAgIHZhciBjdXJyZW50Rml4dHVyZSA9IG51bGw7XG4gICAgICAgIHZhciBuZXh0UmVwb3J0SXRlbSA9IG51bGw7XG5cbiAgICAgICAgd2hpbGUgKHRoaXMucmVwb3J0UXVldWUubGVuZ3RoICYmIHRoaXMucmVwb3J0UXVldWVbMF0udGVzdFJ1bkluZm8pIHtcbiAgICAgICAgICAgIHJlcG9ydEl0ZW0gICAgID0gdGhpcy5yZXBvcnRRdWV1ZS5zaGlmdCgpO1xuICAgICAgICAgICAgY3VycmVudEZpeHR1cmUgPSByZXBvcnRJdGVtLmZpeHR1cmU7XG5cbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydFRlc3REb25lKHJlcG9ydEl0ZW0udGVzdC5uYW1lLCByZXBvcnRJdGVtLnRlc3RSdW5JbmZvLCByZXBvcnRJdGVtLnRlc3QubWV0YSk7XG5cbiAgICAgICAgICAgIC8vIE5PVEU6IGhlcmUgd2UgYXNzdW1lIHRoYXQgdGVzdHMgYXJlIHNvcnRlZCBieSBmaXh0dXJlLlxuICAgICAgICAgICAgLy8gVGhlcmVmb3JlLCBpZiB0aGUgbmV4dCByZXBvcnQgaXRlbSBoYXMgYSBkaWZmZXJlbnRcbiAgICAgICAgICAgIC8vIGZpeHR1cmUsIHdlIGNhbiByZXBvcnQgdGhpcyBmaXh0dXJlIHN0YXJ0LlxuICAgICAgICAgICAgbmV4dFJlcG9ydEl0ZW0gPSB0aGlzLnJlcG9ydFF1ZXVlWzBdO1xuXG4gICAgICAgICAgICBpZiAobmV4dFJlcG9ydEl0ZW0gJiYgbmV4dFJlcG9ydEl0ZW0uZml4dHVyZSAhPT0gY3VycmVudEZpeHR1cmUpXG4gICAgICAgICAgICAgICAgdGhpcy5wbHVnaW4ucmVwb3J0Rml4dHVyZVN0YXJ0KG5leHRSZXBvcnRJdGVtLmZpeHR1cmUubmFtZSwgbmV4dFJlcG9ydEl0ZW0uZml4dHVyZS5wYXRoLCBuZXh0UmVwb3J0SXRlbS5maXh0dXJlLm1ldGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2Fzc2lnblRhc2tFdmVudEhhbmRsZXJzICh0YXNrKSB7XG4gICAgICAgIHRhc2sub25jZSgnc3RhcnQnLCAoKSA9PiB7XG4gICAgICAgICAgICB2YXIgc3RhcnRUaW1lICA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICB2YXIgdXNlckFnZW50cyA9IHRhc2suYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMubWFwKGdyb3VwID0+IGdyb3VwWzBdLnVzZXJBZ2VudCk7XG4gICAgICAgICAgICB2YXIgZmlyc3QgICAgICA9IHRoaXMucmVwb3J0UXVldWVbMF07XG5cbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydFRhc2tTdGFydChzdGFydFRpbWUsIHVzZXJBZ2VudHMsIHRoaXMudGVzdENvdW50KTtcbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydEZpeHR1cmVTdGFydChmaXJzdC5maXh0dXJlLm5hbWUsIGZpcnN0LmZpeHR1cmUucGF0aCwgZmlyc3QuZml4dHVyZS5tZXRhKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGFzay5vbigndGVzdC1ydW4tc3RhcnQnLCB0ZXN0UnVuID0+IHtcbiAgICAgICAgICAgIHZhciByZXBvcnRJdGVtID0gdGhpcy5fZ2V0UmVwb3J0SXRlbUZvclRlc3RSdW4odGVzdFJ1bik7XG5cbiAgICAgICAgICAgIGlmICghcmVwb3J0SXRlbS5zdGFydFRpbWUpXG4gICAgICAgICAgICAgICAgcmVwb3J0SXRlbS5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0YXNrLm9uKCd0ZXN0LXJ1bi1kb25lJywgdGVzdFJ1biA9PiB7XG4gICAgICAgICAgICB2YXIgcmVwb3J0SXRlbSA9IHRoaXMuX2dldFJlcG9ydEl0ZW1Gb3JUZXN0UnVuKHRlc3RSdW4pO1xuXG4gICAgICAgICAgICByZXBvcnRJdGVtLnBlbmRpbmdSdW5zLS07XG4gICAgICAgICAgICByZXBvcnRJdGVtLnVuc3RhYmxlID0gcmVwb3J0SXRlbS51bnN0YWJsZSB8fCB0ZXN0UnVuLnVuc3RhYmxlO1xuICAgICAgICAgICAgcmVwb3J0SXRlbS5lcnJzICAgICA9IHJlcG9ydEl0ZW0uZXJycy5jb25jYXQodGVzdFJ1bi5lcnJzKTtcblxuICAgICAgICAgICAgaWYgKCFyZXBvcnRJdGVtLnBlbmRpbmdSdW5zKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRhc2suc2NyZWVuc2hvdHMuaGFzQ2FwdHVyZWRGb3IodGVzdFJ1bi50ZXN0KSkge1xuICAgICAgICAgICAgICAgICAgICByZXBvcnRJdGVtLnNjcmVlbnNob3RQYXRoID0gdGFzay5zY3JlZW5zaG90cy5nZXRQYXRoRm9yKHRlc3RSdW4udGVzdCk7XG4gICAgICAgICAgICAgICAgICAgIHJlcG9ydEl0ZW0uc2NyZWVuc2hvdHMgICAgPSB0YXNrLnNjcmVlbnNob3RzLmdldFNjcmVlbnNob3RzSW5mbyh0ZXN0UnVuLnRlc3QpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0ZXN0UnVuLnF1YXJhbnRpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0SXRlbS5xdWFyYW50aW5lID0gdGVzdFJ1bi5xdWFyYW50aW5lLmF0dGVtcHRzLnJlZHVjZSgocmVzdWx0LCBlcnJvcnMsIGluZGV4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXNzZWQgICAgICAgICAgICAgID0gIWVycm9ycy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBxdWFyYW50aW5lQXR0ZW1wdCA9IGluZGV4ICsgMTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W3F1YXJhbnRpbmVBdHRlbXB0XSA9IHsgcGFzc2VkIH07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICAgICAgICAgIH0sIHt9KTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoIXJlcG9ydEl0ZW0udGVzdFJ1bkluZm8pIHtcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0SXRlbS50ZXN0UnVuSW5mbyA9IFJlcG9ydGVyLl9jcmVhdGVUZXN0UnVuSW5mbyhyZXBvcnRJdGVtKTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcG9ydEl0ZW0uZXJycy5sZW5ndGggJiYgIXJlcG9ydEl0ZW0udGVzdC5za2lwKVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXNzZWQrKztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLl9zaGlmdFJlcG9ydFF1ZXVlKHJlcG9ydEl0ZW0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0YXNrLm9uY2UoJ2RvbmUnLCAoKSA9PiB7XG4gICAgICAgICAgICB2YXIgZW5kVGltZSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgICAgICAgIHRoaXMucGx1Z2luLnJlcG9ydFRhc2tEb25lKGVuZFRpbWUsIHRoaXMucGFzc2VkLCB0YXNrLndhcm5pbmdMb2cubWVzc2FnZXMpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=
