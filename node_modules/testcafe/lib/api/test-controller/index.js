'use strict';

exports.__esModule = true;

var _set = require('babel-runtime/core-js/set');

var _set2 = _interopRequireDefault(_set);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _getCallsite = require('../../errors/get-callsite');

var _clientFunctionBuilder = require('../../client-functions/client-function-builder');

var _clientFunctionBuilder2 = _interopRequireDefault(_clientFunctionBuilder);

var _assertion = require('./assertion');

var _assertion2 = _interopRequireDefault(_assertion);

var _delegatedApi = require('../../utils/delegated-api');

var _actions = require('../../test-run/commands/actions');

var _browserManipulation = require('../../test-run/commands/browser-manipulation');

var _observation = require('../../test-run/commands/observation');

var _assertType = require('../request-hooks/assert-type');

var _assertType2 = _interopRequireDefault(_assertType);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class TestController {
    constructor(testRun) {
        this.testRun = testRun;
        this.executionChain = _pinkie2.default.resolve();
        this.callsitesWithoutAwait = new _set2.default();
    }

    // NOTE: we track missing `awaits` by exposing a special custom Promise to user code.
    // Action or assertion is awaited if:
    // a)someone used `await` so Promise's `then` function executed
    // b)Promise chained by using one of the mixed-in controller methods
    //
    // In both scenarios, we check that callsite that produced Promise is equal to the one
    // that is currently missing await. This is required to workaround scenarios like this:
    //
    // var t2 = t.click('#btn1'); // <-- stores new callsiteWithoutAwait
    // await t2;                  // <-- callsiteWithoutAwait = null
    // t.click('#btn2');          // <-- stores new callsiteWithoutAwait
    // await t2.click('#btn3');   // <-- without check it will set callsiteWithoutAwait = null, so we will lost tracking
    _createExtendedPromise(promise, callsite) {
        const extendedPromise = promise.then(_lodash.identity);
        const originalThen = extendedPromise.then;
        const markCallsiteAwaited = () => this.callsitesWithoutAwait.delete(callsite);

        extendedPromise.then = function () {
            markCallsiteAwaited();
            return originalThen.apply(this, arguments);
        };

        (0, _delegatedApi.delegateAPI)(extendedPromise, TestController.API_LIST, {
            handler: this,
            proxyMethod: markCallsiteAwaited
        });

        return extendedPromise;
    }

    _enqueueTask(apiMethodName, createTaskExecutor) {
        const callsite = (0, _getCallsite.getCallsiteForMethod)(apiMethodName);
        const executor = createTaskExecutor(callsite);

        this.executionChain = this.executionChain.then(executor);

        this.callsitesWithoutAwait.add(callsite);

        return this._createExtendedPromise(this.executionChain, callsite);
    }

    _enqueueCommand(apiMethodName, CmdCtor, cmdArgs) {
        return this._enqueueTask(apiMethodName, callsite => {
            let command = null;

            try {
                command = new CmdCtor(cmdArgs, this.testRun);
            } catch (err) {
                err.callsite = callsite;
                throw err;
            }

            return () => this.testRun.executeCommand(command, callsite);
        });
    }

    // API implementation
    // We need implementation methods to obtain correct callsites. If we use plain API
    // methods in chained wrappers then we will have callsite for the wrapped method
    // in this file instead of chained method callsite in user code.
    _ctx$getter() {
        return this.testRun.ctx;
    }

    _ctx$setter(val) {
        this.testRun.ctx = val;

        return this.testRun.ctx;
    }

    _fixtureCtx$getter() {
        return this.testRun.fixtureCtx;
    }

    _click$(selector, options) {
        return this._enqueueCommand('click', _actions.ClickCommand, { selector, options });
    }

    _rightClick$(selector, options) {
        return this._enqueueCommand('rightClick', _actions.RightClickCommand, { selector, options });
    }

    _doubleClick$(selector, options) {
        return this._enqueueCommand('doubleClick', _actions.DoubleClickCommand, { selector, options });
    }

    _hover$(selector, options) {
        return this._enqueueCommand('hover', _actions.HoverCommand, { selector, options });
    }

    _drag$(selector, dragOffsetX, dragOffsetY, options) {
        return this._enqueueCommand('drag', _actions.DragCommand, { selector, dragOffsetX, dragOffsetY, options });
    }

    _dragToElement$(selector, destinationSelector, options) {
        return this._enqueueCommand('dragToElement', _actions.DragToElementCommand, { selector, destinationSelector, options });
    }

    _typeText$(selector, text, options) {
        return this._enqueueCommand('typeText', _actions.TypeTextCommand, { selector, text, options });
    }

    _selectText$(selector, startPos, endPos, options) {
        return this._enqueueCommand('selectText', _actions.SelectTextCommand, { selector, startPos, endPos, options });
    }

    _selectTextAreaContent$(selector, startLine, startPos, endLine, endPos, options) {
        return this._enqueueCommand('selectTextAreaContent', _actions.SelectTextAreaContentCommand, {
            selector,
            startLine,
            startPos,
            endLine,
            endPos,
            options
        });
    }

    _selectEditableContent$(startSelector, endSelector, options) {
        return this._enqueueCommand('selectEditableContent', _actions.SelectEditableContentCommand, {
            startSelector,
            endSelector,
            options
        });
    }

    _pressKey$(keys, options) {
        return this._enqueueCommand('pressKey', _actions.PressKeyCommand, { keys, options });
    }

    _wait$(timeout) {
        return this._enqueueCommand('wait', _observation.WaitCommand, { timeout });
    }

    _navigateTo$(url) {
        return this._enqueueCommand('navigateTo', _actions.NavigateToCommand, { url });
    }

    _setFilesToUpload$(selector, filePath) {
        return this._enqueueCommand('setFilesToUpload', _actions.SetFilesToUploadCommand, { selector, filePath });
    }

    _clearUpload$(selector) {
        return this._enqueueCommand('clearUpload', _actions.ClearUploadCommand, { selector });
    }

    _takeScreenshot$(path) {
        return this._enqueueCommand('takeScreenshot', _browserManipulation.TakeScreenshotCommand, { path });
    }

    _takeElementScreenshot$(selector, ...args) {
        const commandArgs = { selector };

        if (args[1]) {
            commandArgs.path = args[0];
            commandArgs.options = args[1];
        } else if (typeof args[0] === 'object') commandArgs.options = args[0];else commandArgs.path = args[0];

        return this._enqueueCommand('takeElementScreenshot', _browserManipulation.TakeElementScreenshotCommand, commandArgs);
    }

    _resizeWindow$(width, height) {
        return this._enqueueCommand('resizeWindow', _browserManipulation.ResizeWindowCommand, { width, height });
    }

    _resizeWindowToFitDevice$(device, options) {
        return this._enqueueCommand('resizeWindowToFitDevice', _browserManipulation.ResizeWindowToFitDeviceCommand, { device, options });
    }

    _maximizeWindow$() {
        return this._enqueueCommand('maximizeWindow', _browserManipulation.MaximizeWindowCommand);
    }

    _switchToIframe$(selector) {
        return this._enqueueCommand('switchToIframe', _actions.SwitchToIframeCommand, { selector });
    }

    _switchToMainWindow$() {
        return this._enqueueCommand('switchToMainWindow', _actions.SwitchToMainWindowCommand);
    }

    _eval$(fn, options) {
        if (!(0, _lodash.isNil)(options)) options = (0, _lodash.assign)({}, options, { boundTestRun: this });

        const builder = new _clientFunctionBuilder2.default(fn, options, { instantiation: 'eval', execution: 'eval' });
        const clientFn = builder.getFunction();

        return clientFn();
    }

    _setNativeDialogHandler$(fn, options) {
        return this._enqueueCommand('setNativeDialogHandler', _actions.SetNativeDialogHandlerCommand, {
            dialogHandler: { fn, options }
        });
    }

    _getNativeDialogHistory$() {
        const callsite = (0, _getCallsite.getCallsiteForMethod)('getNativeDialogHistory');

        return this.testRun.executeCommand(new _actions.GetNativeDialogHistoryCommand(), callsite);
    }

    _getBrowserConsoleMessages$() {
        const callsite = (0, _getCallsite.getCallsiteForMethod)('getBrowserConsoleMessages');

        return this.testRun.executeCommand(new _actions.GetBrowserConsoleMessagesCommand(), callsite);
    }

    _expect$(actual) {
        return new _assertion2.default(actual, this);
    }

    _debug$() {
        return this._enqueueCommand('debug', _observation.DebugCommand);
    }

    _setTestSpeed$(speed) {
        return this._enqueueCommand('setTestSpeed', _actions.SetTestSpeedCommand, { speed });
    }

    _setPageLoadTimeout$(duration) {
        return this._enqueueCommand('setPageLoadTimeout', _actions.SetPageLoadTimeoutCommand, { duration });
    }

    _useRole$(role) {
        return this._enqueueCommand('useRole', _actions.UseRoleCommand, { role });
    }

    _addRequestHooks$(...hooks) {
        return this._enqueueTask('addRequestHooks', () => {
            hooks = (0, _lodash.flattenDeep)(hooks);

            (0, _assertType2.default)(hooks);

            hooks.forEach(hook => this.testRun.addRequestHook(hook));
        });
    }

    _removeRequestHooks$(...hooks) {
        return this._enqueueTask('removeRequestHooks', () => {
            hooks = (0, _lodash.flattenDeep)(hooks);

            (0, _assertType2.default)(hooks);

            hooks.forEach(hook => this.testRun.removeRequestHook(hook));
        });
    }
}

exports.default = TestController;
TestController.API_LIST = (0, _delegatedApi.getDelegatedAPIList)(TestController.prototype);

(0, _delegatedApi.delegateAPI)(TestController.prototype, TestController.API_LIST, { useCurrentCtxAsHandler: true });
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvdGVzdC1jb250cm9sbGVyL2luZGV4LmpzIl0sIm5hbWVzIjpbIlRlc3RDb250cm9sbGVyIiwiY29uc3RydWN0b3IiLCJ0ZXN0UnVuIiwiZXhlY3V0aW9uQ2hhaW4iLCJQcm9taXNlIiwicmVzb2x2ZSIsImNhbGxzaXRlc1dpdGhvdXRBd2FpdCIsIl9jcmVhdGVFeHRlbmRlZFByb21pc2UiLCJwcm9taXNlIiwiY2FsbHNpdGUiLCJleHRlbmRlZFByb21pc2UiLCJ0aGVuIiwiaWRlbnRpdHkiLCJvcmlnaW5hbFRoZW4iLCJtYXJrQ2FsbHNpdGVBd2FpdGVkIiwiZGVsZXRlIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJBUElfTElTVCIsImhhbmRsZXIiLCJwcm94eU1ldGhvZCIsIl9lbnF1ZXVlVGFzayIsImFwaU1ldGhvZE5hbWUiLCJjcmVhdGVUYXNrRXhlY3V0b3IiLCJleGVjdXRvciIsImFkZCIsIl9lbnF1ZXVlQ29tbWFuZCIsIkNtZEN0b3IiLCJjbWRBcmdzIiwiY29tbWFuZCIsImVyciIsImV4ZWN1dGVDb21tYW5kIiwiX2N0eCRnZXR0ZXIiLCJjdHgiLCJfY3R4JHNldHRlciIsInZhbCIsIl9maXh0dXJlQ3R4JGdldHRlciIsImZpeHR1cmVDdHgiLCJfY2xpY2skIiwic2VsZWN0b3IiLCJvcHRpb25zIiwiQ2xpY2tDb21tYW5kIiwiX3JpZ2h0Q2xpY2skIiwiUmlnaHRDbGlja0NvbW1hbmQiLCJfZG91YmxlQ2xpY2skIiwiRG91YmxlQ2xpY2tDb21tYW5kIiwiX2hvdmVyJCIsIkhvdmVyQ29tbWFuZCIsIl9kcmFnJCIsImRyYWdPZmZzZXRYIiwiZHJhZ09mZnNldFkiLCJEcmFnQ29tbWFuZCIsIl9kcmFnVG9FbGVtZW50JCIsImRlc3RpbmF0aW9uU2VsZWN0b3IiLCJEcmFnVG9FbGVtZW50Q29tbWFuZCIsIl90eXBlVGV4dCQiLCJ0ZXh0IiwiVHlwZVRleHRDb21tYW5kIiwiX3NlbGVjdFRleHQkIiwic3RhcnRQb3MiLCJlbmRQb3MiLCJTZWxlY3RUZXh0Q29tbWFuZCIsIl9zZWxlY3RUZXh0QXJlYUNvbnRlbnQkIiwic3RhcnRMaW5lIiwiZW5kTGluZSIsIlNlbGVjdFRleHRBcmVhQ29udGVudENvbW1hbmQiLCJfc2VsZWN0RWRpdGFibGVDb250ZW50JCIsInN0YXJ0U2VsZWN0b3IiLCJlbmRTZWxlY3RvciIsIlNlbGVjdEVkaXRhYmxlQ29udGVudENvbW1hbmQiLCJfcHJlc3NLZXkkIiwia2V5cyIsIlByZXNzS2V5Q29tbWFuZCIsIl93YWl0JCIsInRpbWVvdXQiLCJXYWl0Q29tbWFuZCIsIl9uYXZpZ2F0ZVRvJCIsInVybCIsIk5hdmlnYXRlVG9Db21tYW5kIiwiX3NldEZpbGVzVG9VcGxvYWQkIiwiZmlsZVBhdGgiLCJTZXRGaWxlc1RvVXBsb2FkQ29tbWFuZCIsIl9jbGVhclVwbG9hZCQiLCJDbGVhclVwbG9hZENvbW1hbmQiLCJfdGFrZVNjcmVlbnNob3QkIiwicGF0aCIsIlRha2VTY3JlZW5zaG90Q29tbWFuZCIsIl90YWtlRWxlbWVudFNjcmVlbnNob3QkIiwiYXJncyIsImNvbW1hbmRBcmdzIiwiVGFrZUVsZW1lbnRTY3JlZW5zaG90Q29tbWFuZCIsIl9yZXNpemVXaW5kb3ckIiwid2lkdGgiLCJoZWlnaHQiLCJSZXNpemVXaW5kb3dDb21tYW5kIiwiX3Jlc2l6ZVdpbmRvd1RvRml0RGV2aWNlJCIsImRldmljZSIsIlJlc2l6ZVdpbmRvd1RvRml0RGV2aWNlQ29tbWFuZCIsIl9tYXhpbWl6ZVdpbmRvdyQiLCJNYXhpbWl6ZVdpbmRvd0NvbW1hbmQiLCJfc3dpdGNoVG9JZnJhbWUkIiwiU3dpdGNoVG9JZnJhbWVDb21tYW5kIiwiX3N3aXRjaFRvTWFpbldpbmRvdyQiLCJTd2l0Y2hUb01haW5XaW5kb3dDb21tYW5kIiwiX2V2YWwkIiwiZm4iLCJib3VuZFRlc3RSdW4iLCJidWlsZGVyIiwiQ2xpZW50RnVuY3Rpb25CdWlsZGVyIiwiaW5zdGFudGlhdGlvbiIsImV4ZWN1dGlvbiIsImNsaWVudEZuIiwiZ2V0RnVuY3Rpb24iLCJfc2V0TmF0aXZlRGlhbG9nSGFuZGxlciQiLCJTZXROYXRpdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCIsImRpYWxvZ0hhbmRsZXIiLCJfZ2V0TmF0aXZlRGlhbG9nSGlzdG9yeSQiLCJHZXROYXRpdmVEaWFsb2dIaXN0b3J5Q29tbWFuZCIsIl9nZXRCcm93c2VyQ29uc29sZU1lc3NhZ2VzJCIsIkdldEJyb3dzZXJDb25zb2xlTWVzc2FnZXNDb21tYW5kIiwiX2V4cGVjdCQiLCJhY3R1YWwiLCJBc3NlcnRpb24iLCJfZGVidWckIiwiRGVidWdDb21tYW5kIiwiX3NldFRlc3RTcGVlZCQiLCJzcGVlZCIsIlNldFRlc3RTcGVlZENvbW1hbmQiLCJfc2V0UGFnZUxvYWRUaW1lb3V0JCIsImR1cmF0aW9uIiwiU2V0UGFnZUxvYWRUaW1lb3V0Q29tbWFuZCIsIl91c2VSb2xlJCIsInJvbGUiLCJVc2VSb2xlQ29tbWFuZCIsIl9hZGRSZXF1ZXN0SG9va3MkIiwiaG9va3MiLCJmb3JFYWNoIiwiaG9vayIsImFkZFJlcXVlc3RIb29rIiwiX3JlbW92ZVJlcXVlc3RIb29rcyQiLCJyZW1vdmVSZXF1ZXN0SG9vayIsInByb3RvdHlwZSIsInVzZUN1cnJlbnRDdHhBc0hhbmRsZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBRUE7O0FBeUJBOztBQVFBOztBQUNBOzs7Ozs7QUFFZSxNQUFNQSxjQUFOLENBQXFCO0FBQ2hDQyxnQkFBYUMsT0FBYixFQUFzQjtBQUNsQixhQUFLQSxPQUFMLEdBQTZCQSxPQUE3QjtBQUNBLGFBQUtDLGNBQUwsR0FBNkJDLGlCQUFRQyxPQUFSLEVBQTdCO0FBQ0EsYUFBS0MscUJBQUwsR0FBNkIsbUJBQTdCO0FBQ0g7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0FDLDJCQUF3QkMsT0FBeEIsRUFBaUNDLFFBQWpDLEVBQTJDO0FBQ3ZD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QUEzQixFQUFzQzdJLGVBQWVrQixRQUFyRCxFQUErRCxFQUFFNEgsd0JBQXdCLElBQTFCLEVBQS9EIiwiZmlsZSI6ImFwaS90ZXN0LWNvbnRyb2xsZXIvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHsgaWRlbnRpdHksIGFzc2lnbiwgaXNOaWwgYXMgaXNOdWxsT3JVbmRlZmluZWQsIGZsYXR0ZW5EZWVwIGFzIGZsYXR0ZW4gfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZ2V0Q2FsbHNpdGVGb3JNZXRob2QgfSBmcm9tICcuLi8uLi9lcnJvcnMvZ2V0LWNhbGxzaXRlJztcbmltcG9ydCBDbGllbnRGdW5jdGlvbkJ1aWxkZXIgZnJvbSAnLi4vLi4vY2xpZW50LWZ1bmN0aW9ucy9jbGllbnQtZnVuY3Rpb24tYnVpbGRlcic7XG5pbXBvcnQgQXNzZXJ0aW9uIGZyb20gJy4vYXNzZXJ0aW9uJztcbmltcG9ydCB7IGdldERlbGVnYXRlZEFQSUxpc3QsIGRlbGVnYXRlQVBJIH0gZnJvbSAnLi4vLi4vdXRpbHMvZGVsZWdhdGVkLWFwaSc7XG5cbmltcG9ydCB7XG4gICAgQ2xpY2tDb21tYW5kLFxuICAgIFJpZ2h0Q2xpY2tDb21tYW5kLFxuICAgIERvdWJsZUNsaWNrQ29tbWFuZCxcbiAgICBIb3ZlckNvbW1hbmQsXG4gICAgRHJhZ0NvbW1hbmQsXG4gICAgRHJhZ1RvRWxlbWVudENvbW1hbmQsXG4gICAgVHlwZVRleHRDb21tYW5kLFxuICAgIFNlbGVjdFRleHRDb21tYW5kLFxuICAgIFNlbGVjdFRleHRBcmVhQ29udGVudENvbW1hbmQsXG4gICAgU2VsZWN0RWRpdGFibGVDb250ZW50Q29tbWFuZCxcbiAgICBQcmVzc0tleUNvbW1hbmQsXG4gICAgTmF2aWdhdGVUb0NvbW1hbmQsXG4gICAgU2V0RmlsZXNUb1VwbG9hZENvbW1hbmQsXG4gICAgQ2xlYXJVcGxvYWRDb21tYW5kLFxuICAgIFN3aXRjaFRvSWZyYW1lQ29tbWFuZCxcbiAgICBTd2l0Y2hUb01haW5XaW5kb3dDb21tYW5kLFxuICAgIFNldE5hdGl2ZURpYWxvZ0hhbmRsZXJDb21tYW5kLFxuICAgIEdldE5hdGl2ZURpYWxvZ0hpc3RvcnlDb21tYW5kLFxuICAgIEdldEJyb3dzZXJDb25zb2xlTWVzc2FnZXNDb21tYW5kLFxuICAgIFNldFRlc3RTcGVlZENvbW1hbmQsXG4gICAgU2V0UGFnZUxvYWRUaW1lb3V0Q29tbWFuZCxcbiAgICBVc2VSb2xlQ29tbWFuZFxufSBmcm9tICcuLi8uLi90ZXN0LXJ1bi9jb21tYW5kcy9hY3Rpb25zJztcblxuaW1wb3J0IHtcbiAgICBUYWtlU2NyZWVuc2hvdENvbW1hbmQsXG4gICAgVGFrZUVsZW1lbnRTY3JlZW5zaG90Q29tbWFuZCxcbiAgICBSZXNpemVXaW5kb3dDb21tYW5kLFxuICAgIFJlc2l6ZVdpbmRvd1RvRml0RGV2aWNlQ29tbWFuZCxcbiAgICBNYXhpbWl6ZVdpbmRvd0NvbW1hbmRcbn0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvYnJvd3Nlci1tYW5pcHVsYXRpb24nO1xuXG5pbXBvcnQgeyBXYWl0Q29tbWFuZCwgRGVidWdDb21tYW5kIH0gZnJvbSAnLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvb2JzZXJ2YXRpb24nO1xuaW1wb3J0IGFzc2VydFJlcXVlc3RIb29rVHlwZSBmcm9tICcuLi9yZXF1ZXN0LWhvb2tzL2Fzc2VydC10eXBlJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVGVzdENvbnRyb2xsZXIge1xuICAgIGNvbnN0cnVjdG9yICh0ZXN0UnVuKSB7XG4gICAgICAgIHRoaXMudGVzdFJ1biAgICAgICAgICAgICAgID0gdGVzdFJ1bjtcbiAgICAgICAgdGhpcy5leGVjdXRpb25DaGFpbiAgICAgICAgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgdGhpcy5jYWxsc2l0ZXNXaXRob3V0QXdhaXQgPSBuZXcgU2V0KCk7XG4gICAgfVxuXG4gICAgLy8gTk9URTogd2UgdHJhY2sgbWlzc2luZyBgYXdhaXRzYCBieSBleHBvc2luZyBhIHNwZWNpYWwgY3VzdG9tIFByb21pc2UgdG8gdXNlciBjb2RlLlxuICAgIC8vIEFjdGlvbiBvciBhc3NlcnRpb24gaXMgYXdhaXRlZCBpZjpcbiAgICAvLyBhKXNvbWVvbmUgdXNlZCBgYXdhaXRgIHNvIFByb21pc2UncyBgdGhlbmAgZnVuY3Rpb24gZXhlY3V0ZWRcbiAgICAvLyBiKVByb21pc2UgY2hhaW5lZCBieSB1c2luZyBvbmUgb2YgdGhlIG1peGVkLWluIGNvbnRyb2xsZXIgbWV0aG9kc1xuICAgIC8vXG4gICAgLy8gSW4gYm90aCBzY2VuYXJpb3MsIHdlIGNoZWNrIHRoYXQgY2FsbHNpdGUgdGhhdCBwcm9kdWNlZCBQcm9taXNlIGlzIGVxdWFsIHRvIHRoZSBvbmVcbiAgICAvLyB0aGF0IGlzIGN1cnJlbnRseSBtaXNzaW5nIGF3YWl0LiBUaGlzIGlzIHJlcXVpcmVkIHRvIHdvcmthcm91bmQgc2NlbmFyaW9zIGxpa2UgdGhpczpcbiAgICAvL1xuICAgIC8vIHZhciB0MiA9IHQuY2xpY2soJyNidG4xJyk7IC8vIDwtLSBzdG9yZXMgbmV3IGNhbGxzaXRlV2l0aG91dEF3YWl0XG4gICAgLy8gYXdhaXQgdDI7ICAgICAgICAgICAgICAgICAgLy8gPC0tIGNhbGxzaXRlV2l0aG91dEF3YWl0ID0gbnVsbFxuICAgIC8vIHQuY2xpY2soJyNidG4yJyk7ICAgICAgICAgIC8vIDwtLSBzdG9yZXMgbmV3IGNhbGxzaXRlV2l0aG91dEF3YWl0XG4gICAgLy8gYXdhaXQgdDIuY2xpY2soJyNidG4zJyk7ICAgLy8gPC0tIHdpdGhvdXQgY2hlY2sgaXQgd2lsbCBzZXQgY2FsbHNpdGVXaXRob3V0QXdhaXQgPSBudWxsLCBzbyB3ZSB3aWxsIGxvc3QgdHJhY2tpbmdcbiAgICBfY3JlYXRlRXh0ZW5kZWRQcm9taXNlIChwcm9taXNlLCBjYWxsc2l0ZSkge1xuICAgICAgICBjb25zdCBleHRlbmRlZFByb21pc2UgICAgID0gcHJvbWlzZS50aGVuKGlkZW50aXR5KTtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxUaGVuICAgICAgICA9IGV4dGVuZGVkUHJvbWlzZS50aGVuO1xuICAgICAgICBjb25zdCBtYXJrQ2FsbHNpdGVBd2FpdGVkID0gKCkgPT4gdGhpcy5jYWxsc2l0ZXNXaXRob3V0QXdhaXQuZGVsZXRlKGNhbGxzaXRlKTtcblxuXG4gICAgICAgIGV4dGVuZGVkUHJvbWlzZS50aGVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgbWFya0NhbGxzaXRlQXdhaXRlZCgpO1xuICAgICAgICAgICAgcmV0dXJuIG9yaWdpbmFsVGhlbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGRlbGVnYXRlQVBJKGV4dGVuZGVkUHJvbWlzZSwgVGVzdENvbnRyb2xsZXIuQVBJX0xJU1QsIHtcbiAgICAgICAgICAgIGhhbmRsZXI6ICAgICB0aGlzLFxuICAgICAgICAgICAgcHJveHlNZXRob2Q6IG1hcmtDYWxsc2l0ZUF3YWl0ZWRcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGV4dGVuZGVkUHJvbWlzZTtcbiAgICB9XG5cbiAgICBfZW5xdWV1ZVRhc2sgKGFwaU1ldGhvZE5hbWUsIGNyZWF0ZVRhc2tFeGVjdXRvcikge1xuICAgICAgICBjb25zdCBjYWxsc2l0ZSA9IGdldENhbGxzaXRlRm9yTWV0aG9kKGFwaU1ldGhvZE5hbWUpO1xuICAgICAgICBjb25zdCBleGVjdXRvciA9IGNyZWF0ZVRhc2tFeGVjdXRvcihjYWxsc2l0ZSk7XG5cbiAgICAgICAgdGhpcy5leGVjdXRpb25DaGFpbiA9IHRoaXMuZXhlY3V0aW9uQ2hhaW4udGhlbihleGVjdXRvcik7XG5cbiAgICAgICAgdGhpcy5jYWxsc2l0ZXNXaXRob3V0QXdhaXQuYWRkKGNhbGxzaXRlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fY3JlYXRlRXh0ZW5kZWRQcm9taXNlKHRoaXMuZXhlY3V0aW9uQ2hhaW4sIGNhbGxzaXRlKTtcbiAgICB9XG5cbiAgICBfZW5xdWV1ZUNvbW1hbmQgKGFwaU1ldGhvZE5hbWUsIENtZEN0b3IsIGNtZEFyZ3MpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVUYXNrKGFwaU1ldGhvZE5hbWUsIGNhbGxzaXRlID0+IHtcbiAgICAgICAgICAgIGxldCBjb21tYW5kID0gbnVsbDtcblxuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb21tYW5kID0gbmV3IENtZEN0b3IoY21kQXJncywgdGhpcy50ZXN0UnVuKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICBlcnIuY2FsbHNpdGUgPSBjYWxsc2l0ZTtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiAoKSA9PiB0aGlzLnRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCwgY2FsbHNpdGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBBUEkgaW1wbGVtZW50YXRpb25cbiAgICAvLyBXZSBuZWVkIGltcGxlbWVudGF0aW9uIG1ldGhvZHMgdG8gb2J0YWluIGNvcnJlY3QgY2FsbHNpdGVzLiBJZiB3ZSB1c2UgcGxhaW4gQVBJXG4gICAgLy8gbWV0aG9kcyBpbiBjaGFpbmVkIHdyYXBwZXJzIHRoZW4gd2Ugd2lsbCBoYXZlIGNhbGxzaXRlIGZvciB0aGUgd3JhcHBlZCBtZXRob2RcbiAgICAvLyBpbiB0aGlzIGZpbGUgaW5zdGVhZCBvZiBjaGFpbmVkIG1ldGhvZCBjYWxsc2l0ZSBpbiB1c2VyIGNvZGUuXG4gICAgX2N0eCRnZXR0ZXIgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50ZXN0UnVuLmN0eDtcbiAgICB9XG5cbiAgICBfY3R4JHNldHRlciAodmFsKSB7XG4gICAgICAgIHRoaXMudGVzdFJ1bi5jdHggPSB2YWw7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFJ1bi5jdHg7XG4gICAgfVxuXG4gICAgX2ZpeHR1cmVDdHgkZ2V0dGVyICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFJ1bi5maXh0dXJlQ3R4O1xuICAgIH1cblxuICAgIF9jbGljayQgKHNlbGVjdG9yLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnY2xpY2snLCBDbGlja0NvbW1hbmQsIHsgc2VsZWN0b3IsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX3JpZ2h0Q2xpY2skIChzZWxlY3Rvciwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3JpZ2h0Q2xpY2snLCBSaWdodENsaWNrQ29tbWFuZCwgeyBzZWxlY3Rvciwgb3B0aW9ucyB9KTtcbiAgICB9XG5cbiAgICBfZG91YmxlQ2xpY2skIChzZWxlY3Rvciwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ2RvdWJsZUNsaWNrJywgRG91YmxlQ2xpY2tDb21tYW5kLCB7IHNlbGVjdG9yLCBvcHRpb25zIH0pO1xuICAgIH1cblxuICAgIF9ob3ZlciQgKHNlbGVjdG9yLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnaG92ZXInLCBIb3ZlckNvbW1hbmQsIHsgc2VsZWN0b3IsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX2RyYWckIChzZWxlY3RvciwgZHJhZ09mZnNldFgsIGRyYWdPZmZzZXRZLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnZHJhZycsIERyYWdDb21tYW5kLCB7IHNlbGVjdG9yLCBkcmFnT2Zmc2V0WCwgZHJhZ09mZnNldFksIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX2RyYWdUb0VsZW1lbnQkIChzZWxlY3RvciwgZGVzdGluYXRpb25TZWxlY3Rvciwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ2RyYWdUb0VsZW1lbnQnLCBEcmFnVG9FbGVtZW50Q29tbWFuZCwgeyBzZWxlY3RvciwgZGVzdGluYXRpb25TZWxlY3Rvciwgb3B0aW9ucyB9KTtcbiAgICB9XG5cbiAgICBfdHlwZVRleHQkIChzZWxlY3RvciwgdGV4dCwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3R5cGVUZXh0JywgVHlwZVRleHRDb21tYW5kLCB7IHNlbGVjdG9yLCB0ZXh0LCBvcHRpb25zIH0pO1xuICAgIH1cblxuICAgIF9zZWxlY3RUZXh0JCAoc2VsZWN0b3IsIHN0YXJ0UG9zLCBlbmRQb3MsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdzZWxlY3RUZXh0JywgU2VsZWN0VGV4dENvbW1hbmQsIHsgc2VsZWN0b3IsIHN0YXJ0UG9zLCBlbmRQb3MsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX3NlbGVjdFRleHRBcmVhQ29udGVudCQgKHNlbGVjdG9yLCBzdGFydExpbmUsIHN0YXJ0UG9zLCBlbmRMaW5lLCBlbmRQb3MsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdzZWxlY3RUZXh0QXJlYUNvbnRlbnQnLCBTZWxlY3RUZXh0QXJlYUNvbnRlbnRDb21tYW5kLCB7XG4gICAgICAgICAgICBzZWxlY3RvcixcbiAgICAgICAgICAgIHN0YXJ0TGluZSxcbiAgICAgICAgICAgIHN0YXJ0UG9zLFxuICAgICAgICAgICAgZW5kTGluZSxcbiAgICAgICAgICAgIGVuZFBvcyxcbiAgICAgICAgICAgIG9wdGlvbnNcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3NlbGVjdEVkaXRhYmxlQ29udGVudCQgKHN0YXJ0U2VsZWN0b3IsIGVuZFNlbGVjdG9yLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc2VsZWN0RWRpdGFibGVDb250ZW50JywgU2VsZWN0RWRpdGFibGVDb250ZW50Q29tbWFuZCwge1xuICAgICAgICAgICAgc3RhcnRTZWxlY3RvcixcbiAgICAgICAgICAgIGVuZFNlbGVjdG9yLFxuICAgICAgICAgICAgb3B0aW9uc1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcHJlc3NLZXkkIChrZXlzLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgncHJlc3NLZXknLCBQcmVzc0tleUNvbW1hbmQsIHsga2V5cywgb3B0aW9ucyB9KTtcbiAgICB9XG5cbiAgICBfd2FpdCQgKHRpbWVvdXQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCd3YWl0JywgV2FpdENvbW1hbmQsIHsgdGltZW91dCB9KTtcbiAgICB9XG5cbiAgICBfbmF2aWdhdGVUbyQgKHVybCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ25hdmlnYXRlVG8nLCBOYXZpZ2F0ZVRvQ29tbWFuZCwgeyB1cmwgfSk7XG4gICAgfVxuXG4gICAgX3NldEZpbGVzVG9VcGxvYWQkIChzZWxlY3RvciwgZmlsZVBhdGgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdzZXRGaWxlc1RvVXBsb2FkJywgU2V0RmlsZXNUb1VwbG9hZENvbW1hbmQsIHsgc2VsZWN0b3IsIGZpbGVQYXRoIH0pO1xuICAgIH1cblxuICAgIF9jbGVhclVwbG9hZCQgKHNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnY2xlYXJVcGxvYWQnLCBDbGVhclVwbG9hZENvbW1hbmQsIHsgc2VsZWN0b3IgfSk7XG4gICAgfVxuXG4gICAgX3Rha2VTY3JlZW5zaG90JCAocGF0aCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3Rha2VTY3JlZW5zaG90JywgVGFrZVNjcmVlbnNob3RDb21tYW5kLCB7IHBhdGggfSk7XG4gICAgfVxuXG4gICAgX3Rha2VFbGVtZW50U2NyZWVuc2hvdCQgKHNlbGVjdG9yLCAuLi5hcmdzKSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmRBcmdzID0geyBzZWxlY3RvciB9O1xuXG4gICAgICAgIGlmIChhcmdzWzFdKSB7XG4gICAgICAgICAgICBjb21tYW5kQXJncy5wYXRoICAgID0gYXJnc1swXTtcbiAgICAgICAgICAgIGNvbW1hbmRBcmdzLm9wdGlvbnMgPSBhcmdzWzFdO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHR5cGVvZiBhcmdzWzBdID09PSAnb2JqZWN0JylcbiAgICAgICAgICAgIGNvbW1hbmRBcmdzLm9wdGlvbnMgPSBhcmdzWzBdO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBjb21tYW5kQXJncy5wYXRoID0gYXJnc1swXTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3Rha2VFbGVtZW50U2NyZWVuc2hvdCcsIFRha2VFbGVtZW50U2NyZWVuc2hvdENvbW1hbmQsIGNvbW1hbmRBcmdzKTtcbiAgICB9XG5cbiAgICBfcmVzaXplV2luZG93JCAod2lkdGgsIGhlaWdodCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3Jlc2l6ZVdpbmRvdycsIFJlc2l6ZVdpbmRvd0NvbW1hbmQsIHsgd2lkdGgsIGhlaWdodCB9KTtcbiAgICB9XG5cbiAgICBfcmVzaXplV2luZG93VG9GaXREZXZpY2UkIChkZXZpY2UsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdyZXNpemVXaW5kb3dUb0ZpdERldmljZScsIFJlc2l6ZVdpbmRvd1RvRml0RGV2aWNlQ29tbWFuZCwgeyBkZXZpY2UsIG9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgX21heGltaXplV2luZG93JCAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnbWF4aW1pemVXaW5kb3cnLCBNYXhpbWl6ZVdpbmRvd0NvbW1hbmQpO1xuICAgIH1cblxuICAgIF9zd2l0Y2hUb0lmcmFtZSQgKHNlbGVjdG9yKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc3dpdGNoVG9JZnJhbWUnLCBTd2l0Y2hUb0lmcmFtZUNvbW1hbmQsIHsgc2VsZWN0b3IgfSk7XG4gICAgfVxuXG4gICAgX3N3aXRjaFRvTWFpbldpbmRvdyQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3N3aXRjaFRvTWFpbldpbmRvdycsIFN3aXRjaFRvTWFpbldpbmRvd0NvbW1hbmQpO1xuICAgIH1cblxuICAgIF9ldmFsJCAoZm4sIG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFpc051bGxPclVuZGVmaW5lZChvcHRpb25zKSlcbiAgICAgICAgICAgIG9wdGlvbnMgPSBhc3NpZ24oe30sIG9wdGlvbnMsIHsgYm91bmRUZXN0UnVuOiB0aGlzIH0pO1xuXG4gICAgICAgIGNvbnN0IGJ1aWxkZXIgID0gbmV3IENsaWVudEZ1bmN0aW9uQnVpbGRlcihmbiwgb3B0aW9ucywgeyBpbnN0YW50aWF0aW9uOiAnZXZhbCcsIGV4ZWN1dGlvbjogJ2V2YWwnIH0pO1xuICAgICAgICBjb25zdCBjbGllbnRGbiA9IGJ1aWxkZXIuZ2V0RnVuY3Rpb24oKTtcblxuICAgICAgICByZXR1cm4gY2xpZW50Rm4oKTtcbiAgICB9XG5cbiAgICBfc2V0TmF0aXZlRGlhbG9nSGFuZGxlciQgKGZuLCBvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc2V0TmF0aXZlRGlhbG9nSGFuZGxlcicsIFNldE5hdGl2ZURpYWxvZ0hhbmRsZXJDb21tYW5kLCB7XG4gICAgICAgICAgICBkaWFsb2dIYW5kbGVyOiB7IGZuLCBvcHRpb25zIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX2dldE5hdGl2ZURpYWxvZ0hpc3RvcnkkICgpIHtcbiAgICAgICAgY29uc3QgY2FsbHNpdGUgPSBnZXRDYWxsc2l0ZUZvck1ldGhvZCgnZ2V0TmF0aXZlRGlhbG9nSGlzdG9yeScpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQobmV3IEdldE5hdGl2ZURpYWxvZ0hpc3RvcnlDb21tYW5kKCksIGNhbGxzaXRlKTtcbiAgICB9XG5cbiAgICBfZ2V0QnJvd3NlckNvbnNvbGVNZXNzYWdlcyQgKCkge1xuICAgICAgICBjb25zdCBjYWxsc2l0ZSA9IGdldENhbGxzaXRlRm9yTWV0aG9kKCdnZXRCcm93c2VyQ29uc29sZU1lc3NhZ2VzJyk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFJ1bi5leGVjdXRlQ29tbWFuZChuZXcgR2V0QnJvd3NlckNvbnNvbGVNZXNzYWdlc0NvbW1hbmQoKSwgY2FsbHNpdGUpO1xuICAgIH1cblxuICAgIF9leHBlY3QkIChhY3R1YWwpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBBc3NlcnRpb24oYWN0dWFsLCB0aGlzKTtcbiAgICB9XG5cbiAgICBfZGVidWckICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdkZWJ1ZycsIERlYnVnQ29tbWFuZCk7XG4gICAgfVxuXG4gICAgX3NldFRlc3RTcGVlZCQgKHNwZWVkKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9lbnF1ZXVlQ29tbWFuZCgnc2V0VGVzdFNwZWVkJywgU2V0VGVzdFNwZWVkQ29tbWFuZCwgeyBzcGVlZCB9KTtcbiAgICB9XG5cbiAgICBfc2V0UGFnZUxvYWRUaW1lb3V0JCAoZHVyYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVDb21tYW5kKCdzZXRQYWdlTG9hZFRpbWVvdXQnLCBTZXRQYWdlTG9hZFRpbWVvdXRDb21tYW5kLCB7IGR1cmF0aW9uIH0pO1xuICAgIH1cblxuICAgIF91c2VSb2xlJCAocm9sZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoJ3VzZVJvbGUnLCBVc2VSb2xlQ29tbWFuZCwgeyByb2xlIH0pO1xuICAgIH1cblxuICAgIF9hZGRSZXF1ZXN0SG9va3MkICguLi5ob29rcykge1xuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZVRhc2soJ2FkZFJlcXVlc3RIb29rcycsICgpID0+IHtcbiAgICAgICAgICAgIGhvb2tzID0gZmxhdHRlbihob29rcyk7XG5cbiAgICAgICAgICAgIGFzc2VydFJlcXVlc3RIb29rVHlwZShob29rcyk7XG5cbiAgICAgICAgICAgIGhvb2tzLmZvckVhY2goaG9vayA9PiB0aGlzLnRlc3RSdW4uYWRkUmVxdWVzdEhvb2soaG9vaykpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcmVtb3ZlUmVxdWVzdEhvb2tzJCAoLi4uaG9va3MpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VucXVldWVUYXNrKCdyZW1vdmVSZXF1ZXN0SG9va3MnLCAoKSA9PiB7XG4gICAgICAgICAgICBob29rcyA9IGZsYXR0ZW4oaG9va3MpO1xuXG4gICAgICAgICAgICBhc3NlcnRSZXF1ZXN0SG9va1R5cGUoaG9va3MpO1xuXG4gICAgICAgICAgICBob29rcy5mb3JFYWNoKGhvb2sgPT4gdGhpcy50ZXN0UnVuLnJlbW92ZVJlcXVlc3RIb29rKGhvb2spKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5UZXN0Q29udHJvbGxlci5BUElfTElTVCA9IGdldERlbGVnYXRlZEFQSUxpc3QoVGVzdENvbnRyb2xsZXIucHJvdG90eXBlKTtcblxuZGVsZWdhdGVBUEkoVGVzdENvbnRyb2xsZXIucHJvdG90eXBlLCBUZXN0Q29udHJvbGxlci5BUElfTElTVCwgeyB1c2VDdXJyZW50Q3R4QXNIYW5kbGVyOiB0cnVlIH0pO1xuIl19
