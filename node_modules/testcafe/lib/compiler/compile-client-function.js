'use strict';

exports.__esModule = true;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

exports.default = compileClientFunction;

var _testcafeHammerhead = require('testcafe-hammerhead');

var _testcafeHammerhead2 = _interopRequireDefault(_testcafeHammerhead);

var _asyncToGenerator = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator2 = _interopRequireDefault(_asyncToGenerator);

var _lodash = require('lodash');

var _loadBabelLibs3 = require('./load-babel-libs');

var _loadBabelLibs4 = _interopRequireDefault(_loadBabelLibs3);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ANONYMOUS_FN_RE = /^function\s*\*?\s*\(/;
const ES6_OBJ_METHOD_NAME_RE = /^(\S+?)\s*\(/;
const USE_STRICT_RE = /^('|")use strict('|");?/;
const TRAILING_SEMICOLON_RE = /;\s*$/;
const REGENERATOR_FOOTPRINTS_RE = /(_index\d+\.default|_regenerator\d+\.default|regeneratorRuntime)\.wrap\(function _callee\$\(_context\)/;
const ASYNC_TO_GENERATOR_OUTPUT_CODE = (0, _asyncToGenerator2.default)(_lodash.noop).toString();

var babelArtifactPolyfills = {
    'Promise': {
        re: /_promise(\d+)\.default/,
        getCode: match => `var _promise${match[1]} = { default: Promise };`,
        removeMatchingCode: false
    },

    'Object.keys()': {
        re: /_keys(\d+)\.default/,
        getCode: match => `var _keys${match[1]} = { default: Object.keys };`,
        removeMatchingCode: false
    },

    'JSON.stringify()': {
        re: /_stringify(\d+)\.default/,
        getCode: match => `var _stringify${match[1]} = { default: JSON.stringify };`,
        removeMatchingCode: false
    }
};

function getBabelOptions() {
    var _loadBabelLibs = (0, _loadBabelLibs4.default)(),
        presetFallback = _loadBabelLibs.presetFallback,
        transformForOfAsArray = _loadBabelLibs.transformForOfAsArray;

    return {
        presets: [{ plugins: [transformForOfAsArray] }, presetFallback],
        sourceMaps: false,
        retainLines: true,
        ast: false,
        babelrc: false,
        highlightCode: false
    };
}

function downgradeES(fnCode) {
    var _loadBabelLibs2 = (0, _loadBabelLibs4.default)(),
        babel = _loadBabelLibs2.babel;

    var opts = getBabelOptions();
    var compiled = babel.transform(fnCode, opts);

    return compiled.code.replace(USE_STRICT_RE, '').trim();
}

function addBabelArtifactsPolyfills(fnCode, dependenciesDefinition) {
    var modifiedFnCode = fnCode;

    var polyfills = (0, _values2.default)(babelArtifactPolyfills).reduce((polyfillsCode, polyfill) => {
        var match = fnCode.match(polyfill.re);

        if (match) {
            if (polyfill.removeMatchingCode) modifiedFnCode = modifiedFnCode.replace(polyfill.re, '');

            return polyfillsCode + polyfill.getCode(match);
        }

        return polyfillsCode;
    }, '');

    return `(function(){${dependenciesDefinition}${polyfills} return ${modifiedFnCode}})();`;
}

function getDependenciesDefinition(dependencies) {
    return (0, _keys2.default)(dependencies).reduce((code, name) => {
        return code + `var ${name}=__dependencies$['${name}'];`;
    }, '');
}

function makeFnCodeSuitableForParsing(fnCode) {
    // NOTE: 'function() {}' -> '(function() {})'
    if (ANONYMOUS_FN_RE.test(fnCode)) return `(${fnCode})`;

    // NOTE: 'myFn () {}' -> 'function myFn() {}'
    var match = fnCode.match(ES6_OBJ_METHOD_NAME_RE);

    if (match && match[1] !== 'function') return `function ${fnCode}`;

    return fnCode;
}

function compileClientFunction(fnCode, dependencies, instantiationCallsiteName, compilationCallsiteName) {
    if (fnCode === ASYNC_TO_GENERATOR_OUTPUT_CODE) throw new _runtime.ClientFunctionAPIError(compilationCallsiteName, instantiationCallsiteName, _message2.default.regeneratorInClientFunctionCode);

    fnCode = makeFnCodeSuitableForParsing(fnCode);

    // NOTE: we need to recompile ES6 code for the browser if we are on newer versions of Node.
    fnCode = downgradeES(fnCode);
    fnCode = _testcafeHammerhead2.default.processScript(fnCode, false);

    // NOTE: check compiled code for regenerator injection: we have either generator
    // recompiled in Node.js 4+ for client or async function declared in function code.
    if (REGENERATOR_FOOTPRINTS_RE.test(fnCode)) throw new _runtime.ClientFunctionAPIError(compilationCallsiteName, instantiationCallsiteName, _message2.default.regeneratorInClientFunctionCode);

    if (!TRAILING_SEMICOLON_RE.test(fnCode)) fnCode += ';';

    var dependenciesDefinition = dependencies ? getDependenciesDefinition(dependencies) : '';

    return addBabelArtifactsPolyfills(fnCode, dependenciesDefinition);
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21waWxlci9jb21waWxlLWNsaWVudC1mdW5jdGlvbi5qcyJdLCJuYW1lcyI6WyJjb21waWxlQ2xpZW50RnVuY3Rpb24iLCJBTk9OWU1PVVNfRk5fUkUiLCJFUzZfT0JKX01FVEhPRF9OQU1FX1JFIiwiVVNFX1NUUklDVF9SRSIsIlRSQUlMSU5HX1NFTUlDT0xPTl9SRSIsIlJFR0VORVJBVE9SX0ZPT1RQUklOVFNfUkUiLCJBU1lOQ19UT19HRU5FUkFUT1JfT1VUUFVUX0NPREUiLCJub29wIiwidG9TdHJpbmciLCJiYWJlbEFydGlmYWN0UG9seWZpbGxzIiwicmUiLCJnZXRDb2RlIiwibWF0Y2giLCJyZW1vdmVNYXRjaGluZ0NvZGUiLCJnZXRCYWJlbE9wdGlvbnMiLCJwcmVzZXRGYWxsYmFjayIsInRyYW5zZm9ybUZvck9mQXNBcnJheSIsInByZXNldHMiLCJwbHVnaW5zIiwic291cmNlTWFwcyIsInJldGFpbkxpbmVzIiwiYXN0IiwiYmFiZWxyYyIsImhpZ2hsaWdodENvZGUiLCJkb3duZ3JhZGVFUyIsImZuQ29kZSIsImJhYmVsIiwib3B0cyIsImNvbXBpbGVkIiwidHJhbnNmb3JtIiwiY29kZSIsInJlcGxhY2UiLCJ0cmltIiwiYWRkQmFiZWxBcnRpZmFjdHNQb2x5ZmlsbHMiLCJkZXBlbmRlbmNpZXNEZWZpbml0aW9uIiwibW9kaWZpZWRGbkNvZGUiLCJwb2x5ZmlsbHMiLCJyZWR1Y2UiLCJwb2x5ZmlsbHNDb2RlIiwicG9seWZpbGwiLCJnZXREZXBlbmRlbmNpZXNEZWZpbml0aW9uIiwiZGVwZW5kZW5jaWVzIiwibmFtZSIsIm1ha2VGbkNvZGVTdWl0YWJsZUZvclBhcnNpbmciLCJ0ZXN0IiwiaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSIsImNvbXBpbGF0aW9uQ2FsbHNpdGVOYW1lIiwiQ2xpZW50RnVuY3Rpb25BUElFcnJvciIsIk1FU1NBR0UiLCJyZWdlbmVyYXRvckluQ2xpZW50RnVuY3Rpb25Db2RlIiwiaGFtbWVyaGVh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ZS1jbGllbnQtZnVuY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaGFtbWVyaGVhZCBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCBhc3luY1RvR2VuZXJhdG9yIGZyb20gJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9hc3luY1RvR2VuZXJhdG9yJztcbmltcG9ydCB7IG5vb3AgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvYWRCYWJlbExpYnMgZnJvbSAnLi9sb2FkLWJhYmVsLWxpYnMnO1xuaW1wb3J0IHsgQ2xpZW50RnVuY3Rpb25BUElFcnJvciB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCBNRVNTQUdFIGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL21lc3NhZ2UnO1xuXG5jb25zdCBBTk9OWU1PVVNfRk5fUkUgICAgICAgICAgICAgICAgPSAvXmZ1bmN0aW9uXFxzKlxcKj9cXHMqXFwoLztcbmNvbnN0IEVTNl9PQkpfTUVUSE9EX05BTUVfUkUgICAgICAgICA9IC9eKFxcUys/KVxccypcXCgvO1xuY29uc3QgVVNFX1NUUklDVF9SRSAgICAgICAgICAgICAgICAgID0gL14oJ3xcIil1c2Ugc3RyaWN0KCd8XCIpOz8vO1xuY29uc3QgVFJBSUxJTkdfU0VNSUNPTE9OX1JFICAgICAgICAgID0gLztcXHMqJC87XG5jb25zdCBSRUdFTkVSQVRPUl9GT09UUFJJTlRTX1JFICAgICAgPSAvKF9pbmRleFxcZCtcXC5kZWZhdWx0fF9yZWdlbmVyYXRvclxcZCtcXC5kZWZhdWx0fHJlZ2VuZXJhdG9yUnVudGltZSlcXC53cmFwXFwoZnVuY3Rpb24gX2NhbGxlZVxcJFxcKF9jb250ZXh0XFwpLztcbmNvbnN0IEFTWU5DX1RPX0dFTkVSQVRPUl9PVVRQVVRfQ09ERSA9IGFzeW5jVG9HZW5lcmF0b3Iobm9vcCkudG9TdHJpbmcoKTtcblxudmFyIGJhYmVsQXJ0aWZhY3RQb2x5ZmlsbHMgPSB7XG4gICAgJ1Byb21pc2UnOiB7XG4gICAgICAgIHJlOiAgICAgICAgICAgICAgICAgL19wcm9taXNlKFxcZCspXFwuZGVmYXVsdC8sXG4gICAgICAgIGdldENvZGU6ICAgICAgICAgICAgbWF0Y2ggPT4gYHZhciBfcHJvbWlzZSR7bWF0Y2hbMV19ID0geyBkZWZhdWx0OiBQcm9taXNlIH07YCxcbiAgICAgICAgcmVtb3ZlTWF0Y2hpbmdDb2RlOiBmYWxzZVxuICAgIH0sXG5cbiAgICAnT2JqZWN0LmtleXMoKSc6IHtcbiAgICAgICAgcmU6ICAgICAgICAgICAgICAgICAvX2tleXMoXFxkKylcXC5kZWZhdWx0LyxcbiAgICAgICAgZ2V0Q29kZTogICAgICAgICAgICBtYXRjaCA9PiBgdmFyIF9rZXlzJHttYXRjaFsxXX0gPSB7IGRlZmF1bHQ6IE9iamVjdC5rZXlzIH07YCxcbiAgICAgICAgcmVtb3ZlTWF0Y2hpbmdDb2RlOiBmYWxzZVxuICAgIH0sXG5cbiAgICAnSlNPTi5zdHJpbmdpZnkoKSc6IHtcbiAgICAgICAgcmU6ICAgICAgICAgICAgICAgICAvX3N0cmluZ2lmeShcXGQrKVxcLmRlZmF1bHQvLFxuICAgICAgICBnZXRDb2RlOiAgICAgICAgICAgIG1hdGNoID0+IGB2YXIgX3N0cmluZ2lmeSR7bWF0Y2hbMV19ID0geyBkZWZhdWx0OiBKU09OLnN0cmluZ2lmeSB9O2AsXG4gICAgICAgIHJlbW92ZU1hdGNoaW5nQ29kZTogZmFsc2VcbiAgICB9XG59O1xuXG5cbmZ1bmN0aW9uIGdldEJhYmVsT3B0aW9ucyAoKSB7XG4gICAgdmFyIHsgcHJlc2V0RmFsbGJhY2ssIHRyYW5zZm9ybUZvck9mQXNBcnJheSB9ID0gbG9hZEJhYmVsTGlicygpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgcHJlc2V0czogICAgICAgW3sgcGx1Z2luczogW3RyYW5zZm9ybUZvck9mQXNBcnJheV0gfSwgcHJlc2V0RmFsbGJhY2tdLFxuICAgICAgICBzb3VyY2VNYXBzOiAgICBmYWxzZSxcbiAgICAgICAgcmV0YWluTGluZXM6ICAgdHJ1ZSxcbiAgICAgICAgYXN0OiAgICAgICAgICAgZmFsc2UsXG4gICAgICAgIGJhYmVscmM6ICAgICAgIGZhbHNlLFxuICAgICAgICBoaWdobGlnaHRDb2RlOiBmYWxzZVxuICAgIH07XG59XG5cbmZ1bmN0aW9uIGRvd25ncmFkZUVTIChmbkNvZGUpIHtcbiAgICB2YXIgeyBiYWJlbCB9ID0gbG9hZEJhYmVsTGlicygpO1xuXG4gICAgdmFyIG9wdHMgICAgID0gZ2V0QmFiZWxPcHRpb25zKCk7XG4gICAgdmFyIGNvbXBpbGVkID0gYmFiZWwudHJhbnNmb3JtKGZuQ29kZSwgb3B0cyk7XG5cbiAgICByZXR1cm4gY29tcGlsZWQuY29kZVxuICAgICAgICAucmVwbGFjZShVU0VfU1RSSUNUX1JFLCAnJylcbiAgICAgICAgLnRyaW0oKTtcbn1cblxuZnVuY3Rpb24gYWRkQmFiZWxBcnRpZmFjdHNQb2x5ZmlsbHMgKGZuQ29kZSwgZGVwZW5kZW5jaWVzRGVmaW5pdGlvbikge1xuICAgIHZhciBtb2RpZmllZEZuQ29kZSA9IGZuQ29kZTtcblxuICAgIHZhciBwb2x5ZmlsbHMgPSBPYmplY3RcbiAgICAgICAgLnZhbHVlcyhiYWJlbEFydGlmYWN0UG9seWZpbGxzKVxuICAgICAgICAucmVkdWNlKChwb2x5ZmlsbHNDb2RlLCBwb2x5ZmlsbCkgPT4ge1xuICAgICAgICAgICAgdmFyIG1hdGNoID0gZm5Db2RlLm1hdGNoKHBvbHlmaWxsLnJlKTtcblxuICAgICAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBvbHlmaWxsLnJlbW92ZU1hdGNoaW5nQ29kZSlcbiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZWRGbkNvZGUgPSBtb2RpZmllZEZuQ29kZS5yZXBsYWNlKHBvbHlmaWxsLnJlLCAnJyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcG9seWZpbGxzQ29kZSArIHBvbHlmaWxsLmdldENvZGUobWF0Y2gpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcG9seWZpbGxzQ29kZTtcbiAgICAgICAgfSwgJycpO1xuXG4gICAgcmV0dXJuIGAoZnVuY3Rpb24oKXske2RlcGVuZGVuY2llc0RlZmluaXRpb259JHtwb2x5ZmlsbHN9IHJldHVybiAke21vZGlmaWVkRm5Db2RlfX0pKCk7YDtcbn1cblxuZnVuY3Rpb24gZ2V0RGVwZW5kZW5jaWVzRGVmaW5pdGlvbiAoZGVwZW5kZW5jaWVzKSB7XG4gICAgcmV0dXJuIE9iamVjdFxuICAgICAgICAua2V5cyhkZXBlbmRlbmNpZXMpXG4gICAgICAgIC5yZWR1Y2UoKGNvZGUsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBjb2RlICsgYHZhciAke25hbWV9PV9fZGVwZW5kZW5jaWVzJFsnJHtuYW1lfSddO2A7XG4gICAgICAgIH0sICcnKTtcbn1cblxuZnVuY3Rpb24gbWFrZUZuQ29kZVN1aXRhYmxlRm9yUGFyc2luZyAoZm5Db2RlKSB7XG4gICAgLy8gTk9URTogJ2Z1bmN0aW9uKCkge30nIC0+ICcoZnVuY3Rpb24oKSB7fSknXG4gICAgaWYgKEFOT05ZTU9VU19GTl9SRS50ZXN0KGZuQ29kZSkpXG4gICAgICAgIHJldHVybiBgKCR7Zm5Db2RlfSlgO1xuXG4gICAgLy8gTk9URTogJ215Rm4gKCkge30nIC0+ICdmdW5jdGlvbiBteUZuKCkge30nXG4gICAgdmFyIG1hdGNoID0gZm5Db2RlLm1hdGNoKEVTNl9PQkpfTUVUSE9EX05BTUVfUkUpO1xuXG4gICAgaWYgKG1hdGNoICYmIG1hdGNoWzFdICE9PSAnZnVuY3Rpb24nKVxuICAgICAgICByZXR1cm4gYGZ1bmN0aW9uICR7Zm5Db2RlfWA7XG5cbiAgICByZXR1cm4gZm5Db2RlO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBjb21waWxlQ2xpZW50RnVuY3Rpb24gKGZuQ29kZSwgZGVwZW5kZW5jaWVzLCBpbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lLCBjb21waWxhdGlvbkNhbGxzaXRlTmFtZSkge1xuICAgIGlmIChmbkNvZGUgPT09IEFTWU5DX1RPX0dFTkVSQVRPUl9PVVRQVVRfQ09ERSlcbiAgICAgICAgdGhyb3cgbmV3IENsaWVudEZ1bmN0aW9uQVBJRXJyb3IoY29tcGlsYXRpb25DYWxsc2l0ZU5hbWUsIGluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIE1FU1NBR0UucmVnZW5lcmF0b3JJbkNsaWVudEZ1bmN0aW9uQ29kZSk7XG5cbiAgICBmbkNvZGUgPSBtYWtlRm5Db2RlU3VpdGFibGVGb3JQYXJzaW5nKGZuQ29kZSk7XG5cbiAgICAvLyBOT1RFOiB3ZSBuZWVkIHRvIHJlY29tcGlsZSBFUzYgY29kZSBmb3IgdGhlIGJyb3dzZXIgaWYgd2UgYXJlIG9uIG5ld2VyIHZlcnNpb25zIG9mIE5vZGUuXG4gICAgZm5Db2RlID0gZG93bmdyYWRlRVMoZm5Db2RlKTtcbiAgICBmbkNvZGUgPSBoYW1tZXJoZWFkLnByb2Nlc3NTY3JpcHQoZm5Db2RlLCBmYWxzZSk7XG5cbiAgICAvLyBOT1RFOiBjaGVjayBjb21waWxlZCBjb2RlIGZvciByZWdlbmVyYXRvciBpbmplY3Rpb246IHdlIGhhdmUgZWl0aGVyIGdlbmVyYXRvclxuICAgIC8vIHJlY29tcGlsZWQgaW4gTm9kZS5qcyA0KyBmb3IgY2xpZW50IG9yIGFzeW5jIGZ1bmN0aW9uIGRlY2xhcmVkIGluIGZ1bmN0aW9uIGNvZGUuXG4gICAgaWYgKFJFR0VORVJBVE9SX0ZPT1RQUklOVFNfUkUudGVzdChmbkNvZGUpKVxuICAgICAgICB0aHJvdyBuZXcgQ2xpZW50RnVuY3Rpb25BUElFcnJvcihjb21waWxhdGlvbkNhbGxzaXRlTmFtZSwgaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSwgTUVTU0FHRS5yZWdlbmVyYXRvckluQ2xpZW50RnVuY3Rpb25Db2RlKTtcblxuICAgIGlmICghVFJBSUxJTkdfU0VNSUNPTE9OX1JFLnRlc3QoZm5Db2RlKSlcbiAgICAgICAgZm5Db2RlICs9ICc7JztcblxuICAgIHZhciBkZXBlbmRlbmNpZXNEZWZpbml0aW9uID0gZGVwZW5kZW5jaWVzID8gZ2V0RGVwZW5kZW5jaWVzRGVmaW5pdGlvbihkZXBlbmRlbmNpZXMpIDogJyc7XG5cbiAgICByZXR1cm4gYWRkQmFiZWxBcnRpZmFjdHNQb2x5ZmlsbHMoZm5Db2RlLCBkZXBlbmRlbmNpZXNEZWZpbml0aW9uKTtcbn1cbiJdfQ==
