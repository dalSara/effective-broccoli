'use strict';

exports.__esModule = true;
exports.resizeWindow = exports.takeScreenshot = exports.updateMobileViewportSize = exports.closeTab = exports.createClient = undefined;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let getActiveTab = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (cdpPort, browserId) {
        var tabs = yield _chromeRemoteInterface2.default.listTabs({ port: cdpPort });
        var tab = tabs.filter(function (t) {
            return t.type === 'page' && t.url.indexOf(browserId) > -1;
        })[0];

        return tab;
    });

    return function getActiveTab(_x, _x2) {
        return _ref.apply(this, arguments);
    };
})();

let setEmulationBounds = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* ({ client, config, viewportSize, emulatedDevicePixelRatio }) {
        yield client.Emulation.setDeviceMetricsOverride({
            width: viewportSize.width,
            height: viewportSize.height,
            deviceScaleFactor: emulatedDevicePixelRatio,
            mobile: config.mobile,
            fitWindow: false
        });

        yield client.Emulation.setVisibleSize({ width: viewportSize.width, height: viewportSize.height });
    });

    return function setEmulationBounds(_x3) {
        return _ref2.apply(this, arguments);
    };
})();

let setEmulation = (() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        var client = runtimeInfo.client,
            config = runtimeInfo.config;


        if (config.userAgent !== void 0) yield client.Network.setUserAgentOverride({ userAgent: config.userAgent });

        if (config.touch !== void 0) {
            const touchConfig = {
                enabled: config.touch,
                configuration: config.mobile ? 'mobile' : 'desktop',
                maxTouchPoints: 1
            };

            if (client.Emulation.setEmitTouchEventsForMouse) yield client.Emulation.setEmitTouchEventsForMouse(touchConfig);

            if (client.Emulation.setTouchEmulationEnabled) yield client.Emulation.setTouchEmulationEnabled(touchConfig);
        }

        yield resizeWindow({ width: config.width, height: config.height }, runtimeInfo);
    });

    return function setEmulation(_x4) {
        return _ref3.apply(this, arguments);
    };
})();

let createClient = exports.createClient = (() => {
    var _ref4 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        var browserId = runtimeInfo.browserId,
            config = runtimeInfo.config,
            cdpPort = runtimeInfo.cdpPort;


        try {
            var tab = yield getActiveTab(cdpPort, browserId);

            if (!tab) return;

            var client = yield (0, _chromeRemoteInterface2.default)({ target: tab, port: cdpPort });
        } catch (e) {
            return;
        }

        runtimeInfo.tab = tab;
        runtimeInfo.client = client;

        yield client.Page.enable();
        yield client.Network.enable();
        yield client.Runtime.enable();

        var devicePixelRatioQueryResult = yield client.Runtime.evaluate({ expression: 'window.devicePixelRatio' });

        runtimeInfo.originalDevicePixelRatio = devicePixelRatioQueryResult.result.value;
        runtimeInfo.emulatedDevicePixelRatio = config.scaleFactor || runtimeInfo.originalDevicePixelRatio;

        if (config.emulation) yield setEmulation(runtimeInfo);
    });

    return function createClient(_x5) {
        return _ref4.apply(this, arguments);
    };
})();

let closeTab = exports.closeTab = (() => {
    var _ref5 = (0, _asyncToGenerator3.default)(function* ({ tab, cdpPort }) {
        yield _chromeRemoteInterface2.default.closeTab({ id: tab.id, port: cdpPort });
    });

    return function closeTab(_x6) {
        return _ref5.apply(this, arguments);
    };
})();

let updateMobileViewportSize = exports.updateMobileViewportSize = (() => {
    var _ref6 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        const windowDimensionsQueryResult = yield runtimeInfo.client.Runtime.evaluate({
            expression: `(${_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT})()`,
            returnByValue: true
        });

        const windowDimensions = windowDimensionsQueryResult.result.value;

        runtimeInfo.viewportSize.width = windowDimensions.outerWidth;
        runtimeInfo.viewportSize.height = windowDimensions.outerHeight;
    });

    return function updateMobileViewportSize(_x7) {
        return _ref6.apply(this, arguments);
    };
})();

let takeScreenshot = exports.takeScreenshot = (() => {
    var _ref7 = (0, _asyncToGenerator3.default)(function* (path, { client }) {
        var _ref8 = yield client.Page.getLayoutMetrics();

        const visualViewport = _ref8.visualViewport;


        const clipRegion = {
            x: visualViewport.pageX,
            y: visualViewport.pageY,
            width: visualViewport.clientWidth,
            height: visualViewport.clientHeight,
            scale: visualViewport.scale
        };

        const screenshot = yield client.Page.captureScreenshot({ fromSurface: true, clip: clipRegion });

        yield (0, _promisifiedFunctions.writeFile)(path, screenshot.data, { encoding: 'base64' });
    });

    return function takeScreenshot(_x8, _x9) {
        return _ref7.apply(this, arguments);
    };
})();

let resizeWindow = exports.resizeWindow = (() => {
    var _ref9 = (0, _asyncToGenerator3.default)(function* (newDimensions, runtimeInfo) {
        var browserId = runtimeInfo.browserId,
            config = runtimeInfo.config,
            viewportSize = runtimeInfo.viewportSize,
            providerMethods = runtimeInfo.providerMethods;


        var currentWidth = viewportSize.width;
        var currentHeight = viewportSize.height;
        var newWidth = newDimensions.width || currentWidth;
        var newHeight = newDimensions.height || currentHeight;

        if (!config.headless) yield providerMethods.resizeLocalBrowserWindow(browserId, newWidth, newHeight, currentWidth, currentHeight);

        viewportSize.width = newWidth;
        viewportSize.height = newHeight;

        if (config.emulation) yield setEmulationBounds(runtimeInfo);
    });

    return function resizeWindow(_x10, _x11) {
        return _ref9.apply(this, arguments);
    };
})();

exports.isHeadlessTab = isHeadlessTab;

var _chromeRemoteInterface = require('chrome-remote-interface');

var _chromeRemoteInterface2 = _interopRequireDefault(_chromeRemoteInterface);

var _promisifiedFunctions = require('../../../../utils/promisified-functions');

var _clientFunctions = require('../../utils/client-functions');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isHeadlessTab({ tab, config }) {
    return tab && config.headless;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9jZHAuanMiXSwibmFtZXMiOlsiY2RwUG9ydCIsImJyb3dzZXJJZCIsInRhYnMiLCJyZW1vdGVDaHJvbWUiLCJsaXN0VGFicyIsInBvcnQiLCJ0YWIiLCJmaWx0ZXIiLCJ0IiwidHlwZSIsInVybCIsImluZGV4T2YiLCJnZXRBY3RpdmVUYWIiLCJjbGllbnQiLCJjb25maWciLCJ2aWV3cG9ydFNpemUiLCJlbXVsYXRlZERldmljZVBpeGVsUmF0aW8iLCJFbXVsYXRpb24iLCJzZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUiLCJ3aWR0aCIsImhlaWdodCIsImRldmljZVNjYWxlRmFjdG9yIiwibW9iaWxlIiwiZml0V2luZG93Iiwic2V0VmlzaWJsZVNpemUiLCJzZXRFbXVsYXRpb25Cb3VuZHMiLCJydW50aW1lSW5mbyIsInVzZXJBZ2VudCIsIk5ldHdvcmsiLCJzZXRVc2VyQWdlbnRPdmVycmlkZSIsInRvdWNoIiwidG91Y2hDb25maWciLCJlbmFibGVkIiwiY29uZmlndXJhdGlvbiIsIm1heFRvdWNoUG9pbnRzIiwic2V0RW1pdFRvdWNoRXZlbnRzRm9yTW91c2UiLCJzZXRUb3VjaEVtdWxhdGlvbkVuYWJsZWQiLCJyZXNpemVXaW5kb3ciLCJzZXRFbXVsYXRpb24iLCJ0YXJnZXQiLCJlIiwiUGFnZSIsImVuYWJsZSIsIlJ1bnRpbWUiLCJkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQiLCJldmFsdWF0ZSIsImV4cHJlc3Npb24iLCJvcmlnaW5hbERldmljZVBpeGVsUmF0aW8iLCJyZXN1bHQiLCJ2YWx1ZSIsInNjYWxlRmFjdG9yIiwiZW11bGF0aW9uIiwiY3JlYXRlQ2xpZW50IiwiY2xvc2VUYWIiLCJpZCIsIndpbmRvd0RpbWVuc2lvbnNRdWVyeVJlc3VsdCIsIkdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCIsInJldHVybkJ5VmFsdWUiLCJ3aW5kb3dEaW1lbnNpb25zIiwib3V0ZXJXaWR0aCIsIm91dGVySGVpZ2h0IiwidXBkYXRlTW9iaWxlVmlld3BvcnRTaXplIiwicGF0aCIsImdldExheW91dE1ldHJpY3MiLCJ2aXN1YWxWaWV3cG9ydCIsImNsaXBSZWdpb24iLCJ4IiwicGFnZVgiLCJ5IiwicGFnZVkiLCJjbGllbnRXaWR0aCIsImNsaWVudEhlaWdodCIsInNjYWxlIiwic2NyZWVuc2hvdCIsImNhcHR1cmVTY3JlZW5zaG90IiwiZnJvbVN1cmZhY2UiLCJjbGlwIiwiZGF0YSIsImVuY29kaW5nIiwidGFrZVNjcmVlbnNob3QiLCJuZXdEaW1lbnNpb25zIiwicHJvdmlkZXJNZXRob2RzIiwiY3VycmVudFdpZHRoIiwiY3VycmVudEhlaWdodCIsIm5ld1dpZHRoIiwibmV3SGVpZ2h0IiwiaGVhZGxlc3MiLCJyZXNpemVMb2NhbEJyb3dzZXJXaW5kb3ciLCJpc0hlYWRsZXNzVGFiIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OytDQUtBLFdBQTZCQSxPQUE3QixFQUFzQ0MsU0FBdEMsRUFBaUQ7QUFDN0MsWUFBSUMsT0FBTyxNQUFNQyxnQ0FBYUMsUUFBYixDQUFzQixFQUFFQyxNQUFNTCxPQUFSLEVBQXRCLENBQWpCO0FBQ0EsWUFBSU0sTUFBT0osS0FBS0ssTUFBTCxDQUFZO0FBQUEsbUJBQUtDLEVBQUVDLElBQUYsS0FBVyxNQUFYLElBQXFCRCxFQUFFRSxHQUFGLENBQU1DLE9BQU4sQ0FBY1YsU0FBZCxJQUEyQixDQUFDLENBQXREO0FBQUEsU0FBWixFQUFxRSxDQUFyRSxDQUFYOztBQUVBLGVBQU9LLEdBQVA7QUFDSCxLOztvQkFMY00sWTs7Ozs7O2dEQU9mLFdBQW1DLEVBQUVDLE1BQUYsRUFBVUMsTUFBVixFQUFrQkMsWUFBbEIsRUFBZ0NDLHdCQUFoQyxFQUFuQyxFQUErRjtBQUMzRixjQUFNSCxPQUFPSSxTQUFQLENBQWlCQyx3QkFBakIsQ0FBMEM7QUFDNUNDLG1CQUFtQkosYUFBYUksS0FEWTtBQUU1Q0Msb0JBQW1CTCxhQUFhSyxN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QUNILEs7O29CQWRxQkMsYzs7Ozs7O2dEQWdCZixXQUE2QkMsYUFBN0IsRUFBNEN0RCxXQUE1QyxFQUF5RDtBQUFBLFlBQ3REekIsU0FEc0QsR0FDRHlCLFdBREMsQ0FDdER6QixTQURzRDtBQUFBLFlBQzNDYSxNQUQyQyxHQUNEWSxXQURDLENBQzNDWixNQUQyQztBQUFBLFlBQ25DQyxZQURtQyxHQUNEVyxXQURDLENBQ25DWCxZQURtQztBQUFBLFlBQ3JCa0UsZUFEcUIsR0FDRHZELFdBREMsQ0FDckJ1RCxlQURxQjs7O0FBRzVELFlBQUlDLGVBQWdCbkUsYUFBYUksS0FBakM7QUFDQSxZQUFJZ0UsZ0JBQWdCcEUsYUFBYUssTUFBakM7QUFDQSxZQUFJZ0UsV0FBZ0JKLGNBQWM3RCxLQUFkLElBQXVCK0QsWUFBM0M7QUFDQSxZQUFJRyxZQUFnQkwsY0FBYzVELE1BQWQsSUFBd0IrRCxhQUE1Qzs7QUFFQSxZQUFJLENBQUNyRSxPQUFPd0UsUUFBWixFQUNJLE1BQU1MLGdCQUFnQk0sd0JBQWhCLENBQXlDdEYsU0FBekMsRUFBb0RtRixRQUFwRCxFQUE4REMsU0FBOUQsRUFBeUVILFlBQXpFLEVBQXVGQyxhQUF2RixDQUFOOztBQUVKcEUscUJBQWFJLEtBQWIsR0FBc0JpRSxRQUF0QjtBQUNBckUscUJBQWFLLE1BQWIsR0FBc0JpRSxTQUF0Qjs7QUFFQSxZQUFJdkUsT0FBT3FDLFNBQVgsRUFDSSxNQUFNMUIsbUJBQW1CQyxXQUFuQixDQUFOO0FBQ1AsSzs7b0JBaEJxQlcsWTs7Ozs7UUFwQ05tRCxhLEdBQUFBLGE7O0FBOUVoQjs7OztBQUNBOztBQUNBOzs7O0FBNEVPLFNBQVNBLGFBQVQsQ0FBd0IsRUFBRWxGLEdBQUYsRUFBT1EsTUFBUCxFQUF4QixFQUF5QztBQUM1QyxXQUFPUixPQUFPUSxPQUFPd0UsUUFBckI7QUFDSCIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9jZHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcmVtb3RlQ2hyb21lIGZyb20gJ2Nocm9tZS1yZW1vdGUtaW50ZXJmYWNlJztcbmltcG9ydCB7IHdyaXRlRmlsZSB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL3Byb21pc2lmaWVkLWZ1bmN0aW9ucyc7XG5pbXBvcnQgeyBHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQgfSBmcm9tICcuLi8uLi91dGlscy9jbGllbnQtZnVuY3Rpb25zJztcblxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY3RpdmVUYWIgKGNkcFBvcnQsIGJyb3dzZXJJZCkge1xuICAgIHZhciB0YWJzID0gYXdhaXQgcmVtb3RlQ2hyb21lLmxpc3RUYWJzKHsgcG9ydDogY2RwUG9ydCB9KTtcbiAgICB2YXIgdGFiICA9IHRhYnMuZmlsdGVyKHQgPT4gdC50eXBlID09PSAncGFnZScgJiYgdC51cmwuaW5kZXhPZihicm93c2VySWQpID4gLTEpWzBdO1xuXG4gICAgcmV0dXJuIHRhYjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0RW11bGF0aW9uQm91bmRzICh7IGNsaWVudCwgY29uZmlnLCB2aWV3cG9ydFNpemUsIGVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyB9KSB7XG4gICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXREZXZpY2VNZXRyaWNzT3ZlcnJpZGUoe1xuICAgICAgICB3aWR0aDogICAgICAgICAgICAgdmlld3BvcnRTaXplLndpZHRoLFxuICAgICAgICBoZWlnaHQ6ICAgICAgICAgICAgdmlld3BvcnRTaXplLmhlaWdodCxcbiAgICAgICAgZGV2aWNlU2NhbGVGYWN0b3I6IGVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyxcbiAgICAgICAgbW9iaWxlOiAgICAgICAgICAgIGNvbmZpZy5tb2JpbGUsXG4gICAgICAgIGZpdFdpbmRvdzogICAgICAgICBmYWxzZVxuICAgIH0pO1xuXG4gICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRWaXNpYmxlU2l6ZSh7IHdpZHRoOiB2aWV3cG9ydFNpemUud2lkdGgsIGhlaWdodDogdmlld3BvcnRTaXplLmhlaWdodCB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0RW11bGF0aW9uIChydW50aW1lSW5mbykge1xuICAgIHZhciB7IGNsaWVudCwgY29uZmlnIH0gPSBydW50aW1lSW5mbztcblxuICAgIGlmIChjb25maWcudXNlckFnZW50ICE9PSB2b2lkIDApXG4gICAgICAgIGF3YWl0IGNsaWVudC5OZXR3b3JrLnNldFVzZXJBZ2VudE92ZXJyaWRlKHsgdXNlckFnZW50OiBjb25maWcudXNlckFnZW50IH0pO1xuXG4gICAgaWYgKGNvbmZpZy50b3VjaCAhPT0gdm9pZCAwKSB7XG4gICAgICAgIGNvbnN0IHRvdWNoQ29uZmlnID0ge1xuICAgICAgICAgICAgZW5hYmxlZDogICAgICAgIGNvbmZpZy50b3VjaCxcbiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb246ICBjb25maWcubW9iaWxlID8gJ21vYmlsZScgOiAnZGVza3RvcCcsXG4gICAgICAgICAgICBtYXhUb3VjaFBvaW50czogMVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChjbGllbnQuRW11bGF0aW9uLnNldEVtaXRUb3VjaEV2ZW50c0Zvck1vdXNlKVxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRFbWl0VG91Y2hFdmVudHNGb3JNb3VzZSh0b3VjaENvbmZpZyk7XG5cbiAgICAgICAgaWYgKGNsaWVudC5FbXVsYXRpb24uc2V0VG91Y2hFbXVsYXRpb25FbmFibGVkKVxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRUb3VjaEVtdWxhdGlvbkVuYWJsZWQodG91Y2hDb25maWcpO1xuICAgIH1cblxuICAgIGF3YWl0IHJlc2l6ZVdpbmRvdyh7IHdpZHRoOiBjb25maWcud2lkdGgsIGhlaWdodDogY29uZmlnLmhlaWdodCB9LCBydW50aW1lSW5mbyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVDbGllbnQgKHJ1bnRpbWVJbmZvKSB7XG4gICAgdmFyIHsgYnJvd3NlcklkLCBjb25maWcsIGNkcFBvcnQgfSA9IHJ1bnRpbWVJbmZvO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgdmFyIHRhYiA9IGF3YWl0IGdldEFjdGl2ZVRhYihjZHBQb3J0LCBicm93c2VySWQpO1xuXG4gICAgICAgIGlmICghdGFiKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHZhciBjbGllbnQgPSBhd2FpdCByZW1vdGVDaHJvbWUoeyB0YXJnZXQ6IHRhYiwgcG9ydDogY2RwUG9ydCB9KTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJ1bnRpbWVJbmZvLnRhYiAgICA9IHRhYjtcbiAgICBydW50aW1lSW5mby5jbGllbnQgPSBjbGllbnQ7XG5cbiAgICBhd2FpdCBjbGllbnQuUGFnZS5lbmFibGUoKTtcbiAgICBhd2FpdCBjbGllbnQuTmV0d29yay5lbmFibGUoKTtcbiAgICBhd2FpdCBjbGllbnQuUnVudGltZS5lbmFibGUoKTtcblxuICAgIHZhciBkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQgPSBhd2FpdCBjbGllbnQuUnVudGltZS5ldmFsdWF0ZSh7IGV4cHJlc3Npb246ICd3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbycgfSk7XG5cbiAgICBydW50aW1lSW5mby5vcmlnaW5hbERldmljZVBpeGVsUmF0aW8gPSBkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgIHJ1bnRpbWVJbmZvLmVtdWxhdGVkRGV2aWNlUGl4ZWxSYXRpbyA9IGNvbmZpZy5zY2FsZUZhY3RvciB8fCBydW50aW1lSW5mby5vcmlnaW5hbERldmljZVBpeGVsUmF0aW87XG5cbiAgICBpZiAoY29uZmlnLmVtdWxhdGlvbilcbiAgICAgICAgYXdhaXQgc2V0RW11bGF0aW9uKHJ1bnRpbWVJbmZvKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzSGVhZGxlc3NUYWIgKHsgdGFiLCBjb25maWcgfSkge1xuICAgIHJldHVybiB0YWIgJiYgY29uZmlnLmhlYWRsZXNzO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xvc2VUYWIgKHsgdGFiLCBjZHBQb3J0IH0pIHtcbiAgICBhd2FpdCByZW1vdGVDaHJvbWUuY2xvc2VUYWIoeyBpZDogdGFiLmlkLCBwb3J0OiBjZHBQb3J0IH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlTW9iaWxlVmlld3BvcnRTaXplIChydW50aW1lSW5mbykge1xuICAgIGNvbnN0IHdpbmRvd0RpbWVuc2lvbnNRdWVyeVJlc3VsdCA9IGF3YWl0IHJ1bnRpbWVJbmZvLmNsaWVudC5SdW50aW1lLmV2YWx1YXRlKHtcbiAgICAgICAgZXhwcmVzc2lvbjogICAgYCgke0dFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVH0pKClgLFxuICAgICAgICByZXR1cm5CeVZhbHVlOiB0cnVlXG4gICAgfSk7XG5cbiAgICBjb25zdCB3aW5kb3dEaW1lbnNpb25zID0gd2luZG93RGltZW5zaW9uc1F1ZXJ5UmVzdWx0LnJlc3VsdC52YWx1ZTtcblxuICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZS53aWR0aCAgPSB3aW5kb3dEaW1lbnNpb25zLm91dGVyV2lkdGg7XG4gICAgcnVudGltZUluZm8udmlld3BvcnRTaXplLmhlaWdodCA9IHdpbmRvd0RpbWVuc2lvbnMub3V0ZXJIZWlnaHQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0YWtlU2NyZWVuc2hvdCAocGF0aCwgeyBjbGllbnQgfSkge1xuICAgIGNvbnN0IHsgdmlzdWFsVmlld3BvcnQgfSA9IGF3YWl0IGNsaWVudC5QYWdlLmdldExheW91dE1ldHJpY3MoKTtcblxuICAgIGNvbnN0IGNsaXBSZWdpb24gPSB7XG4gICAgICAgIHg6ICAgICAgdmlzdWFsVmlld3BvcnQucGFnZVgsXG4gICAgICAgIHk6ICAgICAgdmlzdWFsVmlld3BvcnQucGFnZVksXG4gICAgICAgIHdpZHRoOiAgdmlzdWFsVmlld3BvcnQuY2xpZW50V2lkdGgsXG4gICAgICAgIGhlaWdodDogdmlzdWFsVmlld3BvcnQuY2xpZW50SGVpZ2h0LFxuICAgICAgICBzY2FsZTogIHZpc3VhbFZpZXdwb3J0LnNjYWxlXG4gICAgfTtcblxuICAgIGNvbnN0IHNjcmVlbnNob3QgPSBhd2FpdCBjbGllbnQuUGFnZS5jYXB0dXJlU2NyZWVuc2hvdCh7IGZyb21TdXJmYWNlOiB0cnVlLCBjbGlwOiBjbGlwUmVnaW9uIH0pO1xuXG4gICAgYXdhaXQgd3JpdGVGaWxlKHBhdGgsIHNjcmVlbnNob3QuZGF0YSwgeyBlbmNvZGluZzogJ2Jhc2U2NCcgfSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXNpemVXaW5kb3cgKG5ld0RpbWVuc2lvbnMsIHJ1bnRpbWVJbmZvKSB7XG4gICAgdmFyIHsgYnJvd3NlcklkLCBjb25maWcsIHZpZXdwb3J0U2l6ZSwgcHJvdmlkZXJNZXRob2RzIH0gPSBydW50aW1lSW5mbztcblxuICAgIHZhciBjdXJyZW50V2lkdGggID0gdmlld3BvcnRTaXplLndpZHRoO1xuICAgIHZhciBjdXJyZW50SGVpZ2h0ID0gdmlld3BvcnRTaXplLmhlaWdodDtcbiAgICB2YXIgbmV3V2lkdGggICAgICA9IG5ld0RpbWVuc2lvbnMud2lkdGggfHwgY3VycmVudFdpZHRoO1xuICAgIHZhciBuZXdIZWlnaHQgICAgID0gbmV3RGltZW5zaW9ucy5oZWlnaHQgfHwgY3VycmVudEhlaWdodDtcblxuICAgIGlmICghY29uZmlnLmhlYWRsZXNzKVxuICAgICAgICBhd2FpdCBwcm92aWRlck1ldGhvZHMucmVzaXplTG9jYWxCcm93c2VyV2luZG93KGJyb3dzZXJJZCwgbmV3V2lkdGgsIG5ld0hlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KTtcblxuICAgIHZpZXdwb3J0U2l6ZS53aWR0aCAgPSBuZXdXaWR0aDtcbiAgICB2aWV3cG9ydFNpemUuaGVpZ2h0ID0gbmV3SGVpZ2h0O1xuXG4gICAgaWYgKGNvbmZpZy5lbXVsYXRpb24pXG4gICAgICAgIGF3YWl0IHNldEVtdWxhdGlvbkJvdW5kcyhydW50aW1lSW5mbyk7XG59XG4iXX0=
