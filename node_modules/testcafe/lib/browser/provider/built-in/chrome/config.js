'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _isNan = require('babel-runtime/core-js/number/is-nan');

var _isNan2 = _interopRequireDefault(_isNan);

exports.default = function (configString) {
    if (!configCache[configString]) configCache[configString] = getNewConfig(configString);

    return configCache[configString];
};

var _chromeEmulatedDevicesList = require('chrome-emulated-devices-list');

var _chromeEmulatedDevicesList2 = _interopRequireDefault(_chromeEmulatedDevicesList);

var _lodash = require('lodash');

var _argumentParsing = require('../../utils/argument-parsing');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const HEADLESS_DEFAULT_WIDTH = 1280;
const HEADLESS_DEFAULT_HEIGHT = 800;

const AVAILABLE_MODES = ['userProfile', 'headless', 'emulation'];

var configCache = {};

function hasCustomProfile(userArgs) {
    return !!userArgs.match(/--user-data-dir=/);
}

function parseModes(modesStr, userArgs) {
    var parsed = (0, _argumentParsing.splitEscaped)(modesStr, ':');
    var path = (0, _argumentParsing.getPathFromParsedModes)(parsed, AVAILABLE_MODES);
    var detectedModes = (0, _argumentParsing.getModes)(parsed, AVAILABLE_MODES);
    var optionsString = '';

    if (parsed.length) optionsString = parsed.shift();

    while (parsed.length) optionsString += ':' + parsed.shift();

    var modes = {
        path: path,
        userProfile: detectedModes.userProfile || hasCustomProfile(userArgs),
        headless: detectedModes.headless,
        emulation: detectedModes.emulation || detectedModes.headless
    };

    return { modes, optionsString };
}

function simplifyDeviceName(deviceName) {
    return deviceName.replace(/\s/g, '').toLowerCase();
}

function findDevice(deviceName) {
    var simpleName = simplifyDeviceName(deviceName);

    return _chromeEmulatedDevicesList2.default.filter(device => simplifyDeviceName(device.title).indexOf(simpleName) >= 0)[0];
}

function getDeviceBasedOptions(deviceName, orientation) {
    if (!deviceName) return {};

    var deviceData = findDevice(deviceName);

    if (!deviceData) return {};

    var mobile = deviceData.capabilities.indexOf('mobile') >= 0;

    if (!orientation) orientation = mobile ? 'vertical' : 'horizontal';

    return {
        mobile: mobile,
        orientation: orientation,
        touch: deviceData.capabilities.indexOf('touch') >= 0,
        width: deviceData.screen[orientation].width,
        height: deviceData.screen[orientation].height,
        scaleFactor: deviceData.screen['device-pixel-ratio'],
        userAgent: deviceData['user-agent']
    };
}

function parseOptions(str, modes) {
    var parsed = (0, _argumentParsing.splitEscaped)(str, ';');

    var baseOptions = {
        width: modes.headless ? HEADLESS_DEFAULT_WIDTH : 0,
        height: modes.headless ? HEADLESS_DEFAULT_HEIGHT : 0,
        scaleFactor: 0,
        mobile: false,
        cdpPort: (0, _argumentParsing.findMatch)(parsed, /^cdpPort=(.*)/)
    };

    var deviceName = (0, _argumentParsing.findMatch)(parsed, /^device=(.*)/);
    var orientation = (0, _argumentParsing.findMatch)(parsed, /^orientation=(.*)/);
    var deviceBasedOptions = getDeviceBasedOptions(deviceName, orientation);

    var specifiedDeviceOptions = {
        orientation: orientation,
        touch: (0, _argumentParsing.hasMatch)(parsed, /^touch=/) ? (0, _argumentParsing.isMatchTrue)(parsed, /^touch=(.*)/) : void 0,
        mobile: (0, _argumentParsing.isMatchTrue)(parsed, /^mobile=(.*)/),
        width: Number((0, _argumentParsing.findMatch)(parsed, /^width=(.*)/) || NaN),
        height: Number((0, _argumentParsing.findMatch)(parsed, /^height=(.*)/) || NaN),
        scaleFactor: Number((0, _argumentParsing.findMatch)(parsed, /^scaleFactor=(.*)/) || NaN),
        userAgent: (0, _argumentParsing.findMatch)(parsed, /^userAgent=(.*)/)
    };

    specifiedDeviceOptions = (0, _lodash.pickBy)(specifiedDeviceOptions, optionValue => {
        return optionValue !== void 0 && optionValue !== '' && !(0, _isNan2.default)(optionValue);
    });

    return (0, _assign2.default)(baseOptions, deviceBasedOptions, specifiedDeviceOptions);
}

function getNewConfig(configString) {
    var _parseConfig = (0, _argumentParsing.parseConfig)(configString),
        userArgs = _parseConfig.userArgs,
        modesString = _parseConfig.modesString;

    var _parseModes = parseModes(modesString, userArgs),
        modes = _parseModes.modes,
        optionsString = _parseModes.optionsString;

    var options = parseOptions(optionsString, modes);

    return (0, _assign2.default)({ userArgs }, modes, options);
}

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9jb25maWcuanMiXSwibmFtZXMiOlsiY29uZmlnU3RyaW5nIiwiY29uZmlnQ2FjaGUiLCJnZXROZXdDb25maWciLCJIRUFETEVTU19ERUZBVUxUX1dJRFRIIiwiSEVBRExFU1NfREVGQVVMVF9IRUlHSFQiLCJBVkFJTEFCTEVfTU9ERVMiLCJoYXNDdXN0b21Qcm9maWxlIiwidXNlckFyZ3MiLCJtYXRjaCIsInBhcnNlTW9kZXMiLCJtb2Rlc1N0ciIsInBhcnNlZCIsInBhdGgiLCJkZXRlY3RlZE1vZGVzIiwib3B0aW9uc1N0cmluZyIsImxlbmd0aCIsInNoaWZ0IiwibW9kZXMiLCJ1c2VyUHJvZmlsZSIsImhlYWRsZXNzIiwiZW11bGF0aW9uIiwic2ltcGxpZnlEZXZpY2VOYW1lIiwiZGV2aWNlTmFtZSIsInJlcGxhY2UiLCJ0b0xvd2VyQ2FzZSIsImZpbmREZXZpY2UiLCJzaW1wbGVOYW1lIiwiZW11bGF0ZWREZXZpY2VzIiwiZmlsdGVyIiwiZGV2aWNlIiwidGl0bGUiLCJpbmRleE9mIiwiZ2V0RGV2aWNlQmFzZWRPcHRpb25zIiwib3JpZW50YXRpb24iLCJkZXZpY2VEYXRhIiwibW9iaWxlIiwiY2FwYWJpbGl0aWVzIiwidG91Y2giLCJ3aWR0aCIsInNjcmVlbiIsImhlaWdodCIsInNjYWxlRmFjdG9yIiwidXNlckFnZW50IiwicGFyc2VPcHRpb25zIiwic3RyIiwiYmFzZU9wdGlvbnMiLCJjZHBQb3J0IiwiZGV2aWNlQmFzZWRPcHRpb25zIiwic3BlY2lmaWVkRGV2aWNlT3B0aW9ucyIsIk51bWJlciIsIk5hTiIsIm9wdGlvblZhbHVlIiwibW9kZXNTdHJpbmciLCJvcHRpb25zIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7a0JBb0hlLFVBQVVBLFlBQVYsRUFBd0I7QUFDbkMsUUFBSSxDQUFDQyxZQUFZRCxZQUFaLENBQUwsRUFDSUMsWUFBWUQsWUFBWixJQUE0QkUsYUFBYUYsWUFBYixDQUE1Qjs7QUFFSixXQUFPQyxZQUFZRCxZQUFaLENBQVA7QUFDSCxDOztBQXpIRDs7OztBQUNBOztBQUNBOzs7O0FBS0EsTUFBTUcseUJBQTBCLElBQWhDO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQWhDOztBQUVBLE1BQU1DLGtCQUFrQixDQUFDLGFBQUQsRUFBZ0IsVUFBaEIsRUFBNEIsV0FBNUIsQ0FBeEI7O0FBRUEsSUFBSUosY0FBYyxFQUFsQjs7QUFFQSxTQUFTSyxnQkFBVCxDQUEyQkMsUUFBM0IsRUFBcUM7QUFDakMsV0FBTyxDQUFDLENBQUNBLFNBQVNDLEtBQVQsQ0FBZSxrQkFBZixDQUFUO0FBQ0g7O0FBRUQsU0FBU0MsVUFBVCxDQUFxQkMsUUFBckIsRUFBK0JILFFBQS9CLEVBQXlDO0FBQ3JDLFFBQUlJLFNBQWdCLG1DQUFhRCxRQUFiLEVBQXVCLEdBQXZCLENBQXBCO0FBQ0EsUUFBSUUsT0FBZ0IsNkNBQXVCRCxNQUF2QixFQUErQk4sZUFBL0IsQ0FBcEI7QUFDQSxRQUFJUSxnQkFBZ0IsK0JBQVNGLE1BQVQsRUFBaUJOLGVBQWpCLENBQXBCO0FBQ0EsUUFBSVMsZ0JBQWdCLEVBQXBCOztBQUVBLFFBQUlILE9BQU9JLE1BQVgsRUFDSUQsZ0JBQWdCSCxPQUFPSyxLQUFQLEVBQWhCOztBQUVKLFdBQU9MLE9BQU9JLE1BQWQsRUFDSUQsaUJBQWlCLE1BQU1ILE9BQU9LLEtBQVAsRUFBdkI7O0FBRUosUUFBSUMsUUFBUTtBQUNSTCxjQUFhQSxJQURMO0FBRVJNLHFCQUFhTCxjQUFjSyxXQUFkLElBQTZCWixpQkFBaUJDLFFBQWpCLENBRmxDO0FBR1JZLGtCQUFhTixjQUFjTSxRQUhuQjtBQUlSQyxtQkFBYVAsY0FBY08sU0FBZCxJQUEyQlAsY0FBY007QUFKOUMsS0FBWjs7QUFPQSxXQUFPLEVBQUVGLEtBQUYsRUFBU0gsYUFBVCxFQUFQO0FBQ0g7O0FBRUQsU0FBU08sa0JBQVQsQ0FBNkJDLFVBQTdCLEVBQXlDO0FBQ3JDLFdBQU9BLFdBQVdDLE9BQVgsQ0FBbUIsS0FBbkIsRUFBMEIsRUFBMUIsRUFBOEJDLFdBQTlCLEVBQVA7QUFDSDs7QUFFRCxTQUFTQyxVQUFULENBQXFCSCxVQUFyQixFQUFpQztBQUM3QixRQUFJSSxhQUFhTCxtQkFBbUJDLFVBQW5CLENBQWpCOztBQUVBLFdBQU9LLG9DQUFnQkMsTUFBaEIsQ0FBdUJDLFVBQVVSLG1CQUFtQlEsT0FBT0MsS0FBMUIsRUFBaUNDLE9BQWpDLENBQXlDTCxVQUF6QyxLQUF3RCxDQUF6RixFQUE0RixDQUE1RixDQUFQO0FBQ0g7O0FBRUQsU0FBU00scUJBQVQsQ0FBZ0NWLFVBQWhDLEVBQTRDVyxXQUE1QyxFQUF5RDtBQUNyRCxRQUFJLENBQUNYLFVBQUwsRUFDSSxPQUFPLEVBQVA7O0FBRUosUUFBSVksYUFBYVQsV0FBV0gsVUFBWCxDQUFqQjs7QUFFQSxRQUFJLENBQUNZLFVBQUwsRUFDSSxPQUFPLEVBQVA7O0FBRUosUUFBSUMsU0FBU0QsV0FBV0UsWUFBWCxDQUF3QkwsT0FBeEIsQ0FBZ0MsUUFBaEMsS0FBNkMsQ0FBMUQ7O0FBRUEsUUFBSSxDQUFDRSxXQUFMLEVBQ0lBLGNBQWNFLFNBQVMsVUFBVCxHQUFzQixZQUFwQzs7QUFFSixXQUFPO0FBQ0hBLGdCQUFhQSxNQURWO0FBRUhGLHFCQUFhQSxXQUZWO0FBR0hJLGVBQWFILFdBQVdFLFlBQVgsQ0FBd0JMLE9BQXhCLENBQWdDLE9BQWhDLEtBQTRDLENBSHREO0FBSUhPLGVBQWFKLFdBQVdLLE1BQVgsQ0FBa0JOLFdBQWxCLEVBQStCSyxLQUp6QztBQUtIRSxnQkFBYU4sV0FBV0ssTUFBWCxDQUFrQk4sV0FBbEIsRUFBK0JPLE1BTHpDO0FBTUhDLHFCQUFhUCxXQUFXSyxNQUFYLENBQWtCLG9CQUFsQixDQU5WO0FBT0hHLG1CQUFhUixXQUFXLFlBQVg7QUFQVixLQUFQO0FBU0g7O0FBRUQsU0FBU1MsWUFBVCxDQUF1QkMsR0FBdkIsRUFBNEIzQixLQUE1QixFQUFtQztBQUMvQixRQUFJTixTQUFTLG1DQUFhaUMsR0FBYixFQUFrQixHQUFsQixDQUFiOztBQUVBLFFBQUlDLGNBQWM7QUFDZFAsZUFBYXJCLE1BQU1FLFFBQU4sR0FBaUJoQixzQkFBakIsR0FBMEMsQ0FEekM7QUFFZHFDLGdCQUFhdkIsTUFBTUUsUUFBTixHQUFpQmYsdUJBQWpCLEdBQTJDLENBRjFDO0FBR2RxQyxxQkFBYSxDQUhDO0FBSWROLGdCQUFhLEtBSkM7QUFLZFcsaUJBQWEsZ0NBQVVuQyxNQUFWLEVBQWtCLGVBQWxCO0FBTEMsS0FBbEI7O0FBUUEsUUFBSVcsYUFBcUIsZ0NBQVVYLE1BQVYsRUFBa0IsY0FBbEIsQ0FBekI7QUFDQSxRQUFJc0IsY0FBcUIsZ0NBQVV0QixNQUFWLEVBQWtCLG1CQUFsQixDQUF6QjtBQUNBLFFBQUlvQyxxQkFBcUJmLHNCQUFzQlYsVUFBdEIsRUFBa0NXLFdBQWxDLENBQXpCOztBQUVBLFFBQUllLHlCQUF5QjtBQUN6QmYscUJBQWFBLFdBRFk7QUFFekJJLGVBQWEsK0JBQVMxQixNQUFULEVBQWlCLFNBQWpCLElBQThCLGtDQUFZQSxNQUFaLEVBQW9CLGFBQXBCLENBQTlCLEdBQW1FLEtBQUssQ0FGNUQ7QUFHekJ3QixnQkFBYSxrQ0FBWXhCLE1BQVosRUFBb0IsY0FBcEIsQ0FIWTtBQUl6QjJCLGVBQWFXLE9BQU8sZ0NBQVV0QyxNQUFWLEVBQWtCLGFBQWxCLEtBQW9DdUMsR0FBM0MsQ0FKWTtBQUt6QlYsZ0JBQWFTLE9BQU8sZ0NBQVV0QyxNQUFWLEVBQWtCLGNBQWxCLEtBQXFDdUMsR0FBNUMsQ0FMWTtBQU16QlQscUJBQWFRLE9BQU8sZ0NBQVV0QyxNQUFWLEVBQWtCLG1CQUFsQixLQUEwQ3VDLEdBQWpELENBTlk7QUFPekJSLG1CQUFhLGdDQUFVL0IsTUFBVixFQUFrQixpQkFBbEI7QUFQWSxLQUE3Qjs7QUFVQXFDLDZCQUF5QixvQkFBaUJBLHNCQUFqQixFQUF5Q0csZUFBZTtBQUM3RSxlQUFPQSxnQkFBZ0IsS0FBSyxDQUFyQixJQUEwQkEsZ0JBQWdCLEVBQTFDLElBQWdELENBQUMscUJBQWFBLFdBQWIsQ0FBeEQ7QUFDSCxLQUZ3QixDQUF6Qjs7QUFJQSxXQUFPLHNCQUFjTixXQUFkLEVBQTJCRSxrQkFBM0IsRUFBK0NDLHNCQUEvQyxDQUFQO0FBQ0g7O0FBR0QsU0FBUzlDLFlBQVQsQ0FBdUJGLFlBQXZCLEVBQXFDO0FBQUEsdUJBQ0Qsa0NBQVlBLFlBQVosQ0FEQztBQUFBLFFBQzNCTyxRQUQyQixnQkFDM0JBLFFBRDJCO0FBQUEsUUFDakI2QyxXQURpQixnQkFDakJBLFdBRGlCOztBQUFBLHNCQUVEM0MsV0FBVzJDLFdBQVgsRUFBd0I3QyxRQUF4QixDQUZDO0FBQUEsUUFFM0JVLEtBRjJCLGVBRTNCQSxLQUYyQjtBQUFBLFFBRXBCSCxhQUZvQixlQUVwQkEsYUFGb0I7O0FBR2pDLFFBQUl1QyxVQUE0QlYsYUFBYTdCLGFBQWIsRUFBNEJHLEtBQTVCLENBQWhDOztBQUVBLFdBQU8sc0JBQWMsRUFBRVYsUUFBRixFQUFkLEVBQTRCVSxLQUE1QixFQUFtQ29DLE9BQW5DLENBQVA7QUFDSCIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2Nocm9tZS9jb25maWcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZW11bGF0ZWREZXZpY2VzIGZyb20gJ2Nocm9tZS1lbXVsYXRlZC1kZXZpY2VzLWxpc3QnO1xuaW1wb3J0IHsgcGlja0J5IGFzIGZpbHRlclByb3BlcnRpZXMgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtcbiAgICBoYXNNYXRjaCwgZmluZE1hdGNoLCBpc01hdGNoVHJ1ZSwgZ2V0TW9kZXMsIHNwbGl0RXNjYXBlZCwgZ2V0UGF0aEZyb21QYXJzZWRNb2RlcywgcGFyc2VDb25maWdcbn0gZnJvbSAnLi4vLi4vdXRpbHMvYXJndW1lbnQtcGFyc2luZyc7XG5cblxuY29uc3QgSEVBRExFU1NfREVGQVVMVF9XSURUSCAgPSAxMjgwO1xuY29uc3QgSEVBRExFU1NfREVGQVVMVF9IRUlHSFQgPSA4MDA7XG5cbmNvbnN0IEFWQUlMQUJMRV9NT0RFUyA9IFsndXNlclByb2ZpbGUnLCAnaGVhZGxlc3MnLCAnZW11bGF0aW9uJ107XG5cbnZhciBjb25maWdDYWNoZSA9IHt9O1xuXG5mdW5jdGlvbiBoYXNDdXN0b21Qcm9maWxlICh1c2VyQXJncykge1xuICAgIHJldHVybiAhIXVzZXJBcmdzLm1hdGNoKC8tLXVzZXItZGF0YS1kaXI9Lyk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlTW9kZXMgKG1vZGVzU3RyLCB1c2VyQXJncykge1xuICAgIHZhciBwYXJzZWQgICAgICAgID0gc3BsaXRFc2NhcGVkKG1vZGVzU3RyLCAnOicpO1xuICAgIHZhciBwYXRoICAgICAgICAgID0gZ2V0UGF0aEZyb21QYXJzZWRNb2RlcyhwYXJzZWQsIEFWQUlMQUJMRV9NT0RFUyk7XG4gICAgdmFyIGRldGVjdGVkTW9kZXMgPSBnZXRNb2RlcyhwYXJzZWQsIEFWQUlMQUJMRV9NT0RFUyk7XG4gICAgdmFyIG9wdGlvbnNTdHJpbmcgPSAnJztcblxuICAgIGlmIChwYXJzZWQubGVuZ3RoKVxuICAgICAgICBvcHRpb25zU3RyaW5nID0gcGFyc2VkLnNoaWZ0KCk7XG5cbiAgICB3aGlsZSAocGFyc2VkLmxlbmd0aClcbiAgICAgICAgb3B0aW9uc1N0cmluZyArPSAnOicgKyBwYXJzZWQuc2hpZnQoKTtcblxuICAgIHZhciBtb2RlcyA9IHtcbiAgICAgICAgcGF0aDogICAgICAgIHBhdGgsXG4gICAgICAgIHVzZXJQcm9maWxlOiBkZXRlY3RlZE1vZGVzLnVzZXJQcm9maWxlIHx8IGhhc0N1c3RvbVByb2ZpbGUodXNlckFyZ3MpLFxuICAgICAgICBoZWFkbGVzczogICAgZGV0ZWN0ZWRNb2Rlcy5oZWFkbGVzcyxcbiAgICAgICAgZW11bGF0aW9uOiAgIGRldGVjdGVkTW9kZXMuZW11bGF0aW9uIHx8IGRldGVjdGVkTW9kZXMuaGVhZGxlc3NcbiAgICB9O1xuXG4gICAgcmV0dXJuIHsgbW9kZXMsIG9wdGlvbnNTdHJpbmcgfTtcbn1cblxuZnVuY3Rpb24gc2ltcGxpZnlEZXZpY2VOYW1lIChkZXZpY2VOYW1lKSB7XG4gICAgcmV0dXJuIGRldmljZU5hbWUucmVwbGFjZSgvXFxzL2csICcnKS50b0xvd2VyQ2FzZSgpO1xufVxuXG5mdW5jdGlvbiBmaW5kRGV2aWNlIChkZXZpY2VOYW1lKSB7XG4gICAgdmFyIHNpbXBsZU5hbWUgPSBzaW1wbGlmeURldmljZU5hbWUoZGV2aWNlTmFtZSk7XG5cbiAgICByZXR1cm4gZW11bGF0ZWREZXZpY2VzLmZpbHRlcihkZXZpY2UgPT4gc2ltcGxpZnlEZXZpY2VOYW1lKGRldmljZS50aXRsZSkuaW5kZXhPZihzaW1wbGVOYW1lKSA+PSAwKVswXTtcbn1cblxuZnVuY3Rpb24gZ2V0RGV2aWNlQmFzZWRPcHRpb25zIChkZXZpY2VOYW1lLCBvcmllbnRhdGlvbikge1xuICAgIGlmICghZGV2aWNlTmFtZSlcbiAgICAgICAgcmV0dXJuIHt9O1xuXG4gICAgdmFyIGRldmljZURhdGEgPSBmaW5kRGV2aWNlKGRldmljZU5hbWUpO1xuXG4gICAgaWYgKCFkZXZpY2VEYXRhKVxuICAgICAgICByZXR1cm4ge307XG5cbiAgICB2YXIgbW9iaWxlID0gZGV2aWNlRGF0YS5jYXBhYmlsaXRpZXMuaW5kZXhPZignbW9iaWxlJykgPj0gMDtcblxuICAgIGlmICghb3JpZW50YXRpb24pXG4gICAgICAgIG9yaWVudGF0aW9uID0gbW9iaWxlID8gJ3ZlcnRpY2FsJyA6ICdob3Jpem9udGFsJztcblxuICAgIHJldHVybiB7XG4gICAgICAgIG1vYmlsZTogICAgICBtb2JpbGUsXG4gICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbixcbiAgICAgICAgdG91Y2g6ICAgICAgIGRldmljZURhdGEuY2FwYWJpbGl0aWVzLmluZGV4T2YoJ3RvdWNoJykgPj0gMCxcbiAgICAgICAgd2lkdGg6ICAgICAgIGRldmljZURhdGEuc2NyZWVuW29yaWVudGF0aW9uXS53aWR0aCxcbiAgICAgICAgaGVpZ2h0OiAgICAgIGRldmljZURhdGEuc2NyZWVuW29yaWVudGF0aW9uXS5oZWlnaHQsXG4gICAgICAgIHNjYWxlRmFjdG9yOiBkZXZpY2VEYXRhLnNjcmVlblsnZGV2aWNlLXBpeGVsLXJhdGlvJ10sXG4gICAgICAgIHVzZXJBZ2VudDogICBkZXZpY2VEYXRhWyd1c2VyLWFnZW50J10sXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gcGFyc2VPcHRpb25zIChzdHIsIG1vZGVzKSB7XG4gICAgdmFyIHBhcnNlZCA9IHNwbGl0RXNjYXBlZChzdHIsICc7Jyk7XG5cbiAgICB2YXIgYmFzZU9wdGlvbnMgPSB7XG4gICAgICAgIHdpZHRoOiAgICAgICBtb2Rlcy5oZWFkbGVzcyA/IEhFQURMRVNTX0RFRkFVTFRfV0lEVEggOiAwLFxuICAgICAgICBoZWlnaHQ6ICAgICAgbW9kZXMuaGVhZGxlc3MgPyBIRUFETEVTU19ERUZBVUxUX0hFSUdIVCA6IDAsXG4gICAgICAgIHNjYWxlRmFjdG9yOiAwLFxuICAgICAgICBtb2JpbGU6ICAgICAgZmFsc2UsXG4gICAgICAgIGNkcFBvcnQ6ICAgICBmaW5kTWF0Y2gocGFyc2VkLCAvXmNkcFBvcnQ9KC4qKS8pXG4gICAgfTtcblxuICAgIHZhciBkZXZpY2VOYW1lICAgICAgICAgPSBmaW5kTWF0Y2gocGFyc2VkLCAvXmRldmljZT0oLiopLyk7XG4gICAgdmFyIG9yaWVudGF0aW9uICAgICAgICA9IGZpbmRNYXRjaChwYXJzZWQsIC9eb3JpZW50YXRpb249KC4qKS8pO1xuICAgIHZhciBkZXZpY2VCYXNlZE9wdGlvbnMgPSBnZXREZXZpY2VCYXNlZE9wdGlvbnMoZGV2aWNlTmFtZSwgb3JpZW50YXRpb24pO1xuXG4gICAgdmFyIHNwZWNpZmllZERldmljZU9wdGlvbnMgPSB7XG4gICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbixcbiAgICAgICAgdG91Y2g6ICAgICAgIGhhc01hdGNoKHBhcnNlZCwgL150b3VjaD0vKSA/IGlzTWF0Y2hUcnVlKHBhcnNlZCwgL150b3VjaD0oLiopLykgOiB2b2lkIDAsXG4gICAgICAgIG1vYmlsZTogICAgICBpc01hdGNoVHJ1ZShwYXJzZWQsIC9ebW9iaWxlPSguKikvKSxcbiAgICAgICAgd2lkdGg6ICAgICAgIE51bWJlcihmaW5kTWF0Y2gocGFyc2VkLCAvXndpZHRoPSguKikvKSB8fCBOYU4pLFxuICAgICAgICBoZWlnaHQ6ICAgICAgTnVtYmVyKGZpbmRNYXRjaChwYXJzZWQsIC9eaGVpZ2h0PSguKikvKSB8fCBOYU4pLFxuICAgICAgICBzY2FsZUZhY3RvcjogTnVtYmVyKGZpbmRNYXRjaChwYXJzZWQsIC9ec2NhbGVGYWN0b3I9KC4qKS8pIHx8IE5hTiksXG4gICAgICAgIHVzZXJBZ2VudDogICBmaW5kTWF0Y2gocGFyc2VkLCAvXnVzZXJBZ2VudD0oLiopLylcbiAgICB9O1xuXG4gICAgc3BlY2lmaWVkRGV2aWNlT3B0aW9ucyA9IGZpbHRlclByb3BlcnRpZXMoc3BlY2lmaWVkRGV2aWNlT3B0aW9ucywgb3B0aW9uVmFsdWUgPT4ge1xuICAgICAgICByZXR1cm4gb3B0aW9uVmFsdWUgIT09IHZvaWQgMCAmJiBvcHRpb25WYWx1ZSAhPT0gJycgJiYgIU51bWJlci5pc05hTihvcHRpb25WYWx1ZSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihiYXNlT3B0aW9ucywgZGV2aWNlQmFzZWRPcHRpb25zLCBzcGVjaWZpZWREZXZpY2VPcHRpb25zKTtcbn1cblxuXG5mdW5jdGlvbiBnZXROZXdDb25maWcgKGNvbmZpZ1N0cmluZykge1xuICAgIHZhciB7IHVzZXJBcmdzLCBtb2Rlc1N0cmluZyB9ID0gcGFyc2VDb25maWcoY29uZmlnU3RyaW5nKTtcbiAgICB2YXIgeyBtb2Rlcywgb3B0aW9uc1N0cmluZyB9ICA9IHBhcnNlTW9kZXMobW9kZXNTdHJpbmcsIHVzZXJBcmdzKTtcbiAgICB2YXIgb3B0aW9ucyAgICAgICAgICAgICAgICAgICA9IHBhcnNlT3B0aW9ucyhvcHRpb25zU3RyaW5nLCBtb2Rlcyk7XG5cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7IHVzZXJBcmdzIH0sIG1vZGVzLCBvcHRpb25zKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKGNvbmZpZ1N0cmluZykge1xuICAgIGlmICghY29uZmlnQ2FjaGVbY29uZmlnU3RyaW5nXSlcbiAgICAgICAgY29uZmlnQ2FjaGVbY29uZmlnU3RyaW5nXSA9IGdldE5ld0NvbmZpZyhjb25maWdTdHJpbmcpO1xuXG4gICAgcmV0dXJuIGNvbmZpZ0NhY2hlW2NvbmZpZ1N0cmluZ107XG59XG4iXX0=
