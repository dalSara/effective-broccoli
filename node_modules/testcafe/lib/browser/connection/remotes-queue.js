'use strict';

exports.__esModule = true;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _events = require('events');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _timeLimitPromise = require('time-limit-promise');

var _timeLimitPromise2 = _interopRequireDefault(_timeLimitPromise);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const REMOTE_REDIRECT_TIMEOUT = 10000;
const ADDING_CONNECTION_WAITING_TIMEOUT = 10000;

class RemotesQueue {
    constructor() {
        this.events = new _events.EventEmitter();
        this.shiftingTimeout = _pinkie2.default.resolve();
        this.pendingConnections = {};
    }

    add(remoteConnection) {
        var connectionReadyPromise = (0, _promisifyEvent2.default)(remoteConnection, 'ready').then(() => this.remove(remoteConnection));

        this.pendingConnections[remoteConnection.id] = {
            connection: remoteConnection,
            readyPromise: connectionReadyPromise
        };

        this.events.emit('connection-added', remoteConnection.id);
    }

    remove(remoteConnection) {
        delete this.pendingConnections[remoteConnection.id];
    }

    shift() {
        var _this = this;

        var shiftingPromise = this.shiftingTimeout.then((0, _asyncToGenerator3.default)(function* () {
            var headId = (0, _keys2.default)(_this.pendingConnections)[0];

            if (!headId) headId = yield (0, _timeLimitPromise2.default)((0, _promisifyEvent2.default)(_this.events, 'connection-added'), ADDING_CONNECTION_WAITING_TIMEOUT);

            return headId ? _this.pendingConnections[headId].connection : null;
        }));

        this.shiftingTimeout = shiftingPromise.then(connection => {
            if (!connection) return _pinkie2.default.resolve();

            return (0, _timeLimitPromise2.default)(this.pendingConnections[connection.id].readyPromise, REMOTE_REDIRECT_TIMEOUT);
        });

        return shiftingPromise;
    }
}
exports.default = RemotesQueue;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2Nvbm5lY3Rpb24vcmVtb3Rlcy1xdWV1ZS5qcyJdLCJuYW1lcyI6WyJSRU1PVEVfUkVESVJFQ1RfVElNRU9VVCIsIkFERElOR19DT05ORUNUSU9OX1dBSVRJTkdfVElNRU9VVCIsIlJlbW90ZXNRdWV1ZSIsImNvbnN0cnVjdG9yIiwiZXZlbnRzIiwiRXZlbnRFbWl0dGVyIiwic2hpZnRpbmdUaW1lb3V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJwZW5kaW5nQ29ubmVjdGlvbnMiLCJhZGQiLCJyZW1vdGVDb25uZWN0aW9uIiwiY29ubmVjdGlvblJlYWR5UHJvbWlzZSIsInRoZW4iLCJyZW1vdmUiLCJpZCIsImNvbm5lY3Rpb24iLCJyZWFkeVByb21pc2UiLCJlbWl0Iiwic2hpZnQiLCJzaGlmdGluZ1Byb21pc2UiLCJoZWFkSWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBR0EsTUFBTUEsMEJBQW9DLEtBQTFDO0FBQ0EsTUFBTUMsb0NBQW9DLEtBQTFDOztBQUVlLE1BQU1DLFlBQU4sQ0FBbUI7QUFDOUJDLGtCQUFlO0FBQ1gsYUFBS0MsTUFBTCxHQUEwQixJQUFJQyxvQkFBSixFQUExQjtBQUNBLGFBQUtDLGVBQUwsR0FBMEJDLGlCQUFRQyxPQUFSLEVBQTFCO0FBQ0EsYUFBS0Msa0JBQUwsR0FBMEIsRUFBMUI7QUFDSDs7QUFFREMsUUFBS0MsZ0JBQUwsRUFBdUI7QUFDbkIsWUFBSUMseUJBQXlCLDhCQUFlRCxnQkFBZixFQUFpQyxPQUFqQyxFQUN4QkUsSUFEd0IsQ0FDbkIsTUFBTSxLQUFLQyxNQUFMLENBQVlILGdCQUFaLENBRGEsQ0FBN0I7O0FBR0EsYUFBS0Ysa0JBQUwsQ0FBd0JFLGlCQUFpQkksRUFBekMsSUFBK0M7QUFDM0NDLHdCQUFjTCxnQkFENkI7QUFFM0NNLDBCQUFjTDtBQUY2QixTQUEvQzs7QUFLQSxhQUFLUixNQUFMLENBQVljLElBQVosQ0FBaUIsa0JBQWpCLEVBQXFDUCxpQkFBaUJJLEVBQXREO0FBQ0g7O0FBRURELFdBQVFILGdCQUFSLEVBQTBCO0FBQ3RCLGVBQU8sS0FBS0Ysa0JBQUwsQ0FBd0JFLGlCQUFpQkksRUFBekMsQ0FBUDtBQUNIOztBQUVESSxZQUFTO0FBQUE7O0FBQ0wsWUFBSUMsa0JBQWtCLEtBQUtkLGVBQUwsQ0FDakJPLElBRGlCLGlDQUNaLGFBQVk7QUFDZCxnQkFBSVEsU0FBUyxvQkFBWSxNQUFLWixrQkFBakIsRUFBcUMsQ0FBckMsQ0FBYjs7QUFFQSxnQkFBSSxDQUFDWSxNQUFMLEVBQ0lBLFNBQVMsTUFBTSxnQ0FBVSw4QkFBZSxNQUFLakIsTUFBcEIsRUFBNEIsa0JBQTVCLENBQVYsRUFBMkRILGlDQUEzRCxDQUFmOztBQUVKLG1CQUFPb0IsU0FBUyxNQUFLWixrQkFBTCxDQUF3QlksTUFBeEIsRUFBZ0NMLFVBQXpDLEdBQXNELElBQTdEO0FBQ0gsU0FSaUIsRUFBdEI7O0FBVUEsYUFBS1YsZUFBTCxHQUF1QmMsZ0JBQ2xCUCxJQURrQixDQUNiRyxjQUFjO0FBQ2hCLGdCQUFJLENBQUNBLFVBQUwsRUFDSSxPQUFPVCxpQkFBUUMsT0FBUixFQUFQOztBQUVKLG1CQUFPLGdDQUFVLEtBQUtDLGtCQUFMLENBQXdCTyxXQUFXRCxFQUFuQyxFQUF1Q0UsWUFBakQsRUFBK0RqQix1QkFBL0QsQ0FBUDtBQUNILFNBTmtCLENBQXZCOztBQVFBLGVBQU9vQixlQUFQO0FBQ0g7QUEzQzZCO2tCQUFibEIsWSIsImZpbGUiOiJicm93c2VyL2Nvbm5lY3Rpb24vcmVtb3Rlcy1xdWV1ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IHByb21pc2lmeUV2ZW50IGZyb20gJ3Byb21pc2lmeS1ldmVudCc7XG5pbXBvcnQgdGltZUxpbWl0IGZyb20gJ3RpbWUtbGltaXQtcHJvbWlzZSc7XG5cblxuY29uc3QgUkVNT1RFX1JFRElSRUNUX1RJTUVPVVQgICAgICAgICAgID0gMTAwMDA7XG5jb25zdCBBRERJTkdfQ09OTkVDVElPTl9XQUlUSU5HX1RJTUVPVVQgPSAxMDAwMDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVtb3Rlc1F1ZXVlIHtcbiAgICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIHRoaXMuZXZlbnRzICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLnNoaWZ0aW5nVGltZW91dCAgICA9IFByb21pc2UucmVzb2x2ZSgpO1xuICAgICAgICB0aGlzLnBlbmRpbmdDb25uZWN0aW9ucyA9IHt9O1xuICAgIH1cblxuICAgIGFkZCAocmVtb3RlQ29ubmVjdGlvbikge1xuICAgICAgICB2YXIgY29ubmVjdGlvblJlYWR5UHJvbWlzZSA9IHByb21pc2lmeUV2ZW50KHJlbW90ZUNvbm5lY3Rpb24sICdyZWFkeScpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLnJlbW92ZShyZW1vdGVDb25uZWN0aW9uKSk7XG5cbiAgICAgICAgdGhpcy5wZW5kaW5nQ29ubmVjdGlvbnNbcmVtb3RlQ29ubmVjdGlvbi5pZF0gPSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uOiAgIHJlbW90ZUNvbm5lY3Rpb24sXG4gICAgICAgICAgICByZWFkeVByb21pc2U6IGNvbm5lY3Rpb25SZWFkeVByb21pc2VcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLmV2ZW50cy5lbWl0KCdjb25uZWN0aW9uLWFkZGVkJywgcmVtb3RlQ29ubmVjdGlvbi5pZCk7XG4gICAgfVxuXG4gICAgcmVtb3ZlIChyZW1vdGVDb25uZWN0aW9uKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLnBlbmRpbmdDb25uZWN0aW9uc1tyZW1vdGVDb25uZWN0aW9uLmlkXTtcbiAgICB9XG5cbiAgICBzaGlmdCAoKSB7XG4gICAgICAgIHZhciBzaGlmdGluZ1Byb21pc2UgPSB0aGlzLnNoaWZ0aW5nVGltZW91dFxuICAgICAgICAgICAgLnRoZW4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBoZWFkSWQgPSBPYmplY3Qua2V5cyh0aGlzLnBlbmRpbmdDb25uZWN0aW9ucylbMF07XG5cbiAgICAgICAgICAgICAgICBpZiAoIWhlYWRJZClcbiAgICAgICAgICAgICAgICAgICAgaGVhZElkID0gYXdhaXQgdGltZUxpbWl0KHByb21pc2lmeUV2ZW50KHRoaXMuZXZlbnRzLCAnY29ubmVjdGlvbi1hZGRlZCcpLCBBRERJTkdfQ09OTkVDVElPTl9XQUlUSU5HX1RJTUVPVVQpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhlYWRJZCA/IHRoaXMucGVuZGluZ0Nvbm5lY3Rpb25zW2hlYWRJZF0uY29ubmVjdGlvbiA6IG51bGw7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnNoaWZ0aW5nVGltZW91dCA9IHNoaWZ0aW5nUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oY29ubmVjdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0aW9uKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGltZUxpbWl0KHRoaXMucGVuZGluZ0Nvbm5lY3Rpb25zW2Nvbm5lY3Rpb24uaWRdLnJlYWR5UHJvbWlzZSwgUkVNT1RFX1JFRElSRUNUX1RJTUVPVVQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHNoaWZ0aW5nUHJvbWlzZTtcbiAgICB9XG59XG4iXX0=
