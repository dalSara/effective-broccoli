'use strict';

exports.__esModule = true;

var _getIterator2 = require('babel-runtime/core-js/get-iterator');

var _getIterator3 = _interopRequireDefault(_getIterator2);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _commander = require('commander');

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _dedent = require('dedent');

var _dedent2 = _interopRequireDefault(_dedent);

var _readFileRelative = require('read-file-relative');

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _typeAssertions = require('../errors/runtime/type-assertions');

var _getViewportWidth = require('../utils/get-viewport-width');

var _getViewportWidth2 = _interopRequireDefault(_getViewportWidth);

var _string = require('../utils/string');

var _promisifiedFunctions = require('../utils/promisified-functions');

var _parseSslOptions = require('./parse-ssl-options');

var _parseSslOptions2 = _interopRequireDefault(_parseSslOptions);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const REMOTE_ALIAS_RE = /^remote(?::(\d*))?$/;

const DESCRIPTION = (0, _dedent2.default)(`
    In the browser list, you can use browser names (e.g. "ie", "chrome", etc.) as well as paths to executables.

    To run tests against all installed browsers, use the "all" alias.

    To use a remote browser connection (e.g., to connect a mobile device), specify "remote" as the browser alias.
    If you need to connect multiple devices, add a colon and the number of browsers you want to connect (e.g., "remote:3").

    To run tests in a browser accessed through a browser provider plugin, specify a browser alias that consists of two parts - the browser provider name prefix and the name of the browser itself; for example, "saucelabs:chrome@51".

    You can use one or more file paths or glob patterns to specify which tests to run.

    More info: https://devexpress.github.io/testcafe/documentation
`);

class CLIArgumentParser {
    constructor(cwd) {
        this.program = new _commander.Command('testcafe');

        this.cwd = cwd || process.cwd();

        this.src = null;
        this.browsers = null;
        this.filter = null;
        this.remoteCount = 0;
        this.opts = null;

        this._describeProgram();
    }

    static _parsePortNumber(value) {
        (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Port number', value);

        return parseInt(value, 10);
    }

    static _optionValueToRegExp(name, value) {
        if (value === void 0) return value;

        try {
            return new RegExp(value);
        } catch (err) {
            throw new _runtime.GeneralError(_message2.default.optionValueIsNotValidRegExp, name);
        }
    }

    static _getDescription() {
        // NOTE: add empty line to workaround commander-forced indentation on the first line.
        return '\n' + (0, _string.wordWrap)(DESCRIPTION, 2, (0, _getViewportWidth2.default)(process.stdout));
    }

    _describeProgram() {
        var version = JSON.parse((0, _readFileRelative.readSync)('../../package.json')).version;

        this.program.version(version, '-v, --version').usage('[options] <comma-separated-browser-list> <file-or-glob ...>').description(CLIArgumentParser._getDescription()).option('-b, --list-browsers [provider]', 'output the aliases for local browsers or browsers available through the specified browser provider').option('-r, --reporter <name[:outputFile][,...]>', 'specify the reporters and optionally files where reports are saved').option('-s, --screenshots <path>', 'enable screenshot capturing and specify the path to save the screenshots to').option('-S, --screenshots-on-fails', 'take a screenshot whenever a test fails').option('-p, --screenshot-path-pattern <pattern>', 'use patterns to compose screenshot file names and paths: ${BROWSER}, ${BROWSER_VERSION}, ${OS}, etc.').option('-q, --quarantine-mode', 'enable the quarantine mode').option('-d, --debug-mode', 'execute test steps one by one pausing the test after each step').option('-e, --skip-js-errors', 'make tests not fail when a JS error happens on a page').option('-u, --skip-uncaught-errors', 'ignore uncaught errors and unhandled promise rejections, which occur during test execution').option('-t, --test <name>', 'run only tests with the specified name').option('-T, --test-grep <pattern>', 'run only tests matching the specified pattern').option('-f, --fixture <name>', 'run only fixtures with the specified name').option('-F, --fixture-grep <pattern>', 'run only fixtures matching the specified pattern').option('-a, --app <command>', 'launch the tested app using the specified command before running tests').option('-c, --concurrency <number>', 'run tests concurrently').option('--debug-on-fail', 'pause the test if it fails').option('--app-init-delay <ms>', 'specify how much time it takes for the tested app to initialize').option('--selector-timeout <ms>', 'set the amount of time within which selectors make attempts to obtain a node to be returned').option('--assertion-timeout <ms>', 'set the amount of time within which assertion should pass').option('--page-load-timeout <ms>', 'set the amount of time within which TestCafe waits for the `window.load` event to fire on page load before proceeding to the next test action').option('--speed <factor>', 'set the speed of test execution (0.01 ... 1)').option('--ports <port1,port2>', 'specify custom port numbers').option('--hostname <name>', 'specify the hostname').option('--proxy <host>', 'specify the host of the proxy server').option('--ssl', 'specify SSL options to run TestCafe proxy server over the HTTPS protocol').option('--proxy-bypass <rules>', 'specify a comma-separated list of rules that define URLs accessed bypassing the proxy server').option('--disable-page-reloads', 'disable page reloads between tests').option('--dev', 'enables mechanisms to log and diagnose errors').option('--qr-code', 'outputs QR-code that repeats URLs used to connect the remote browsers')

        // NOTE: these options will be handled by chalk internally
        .option('--color', 'force colors in command line').option('--no-color', 'disable colors in command line');
    }

    _filterAndCountRemotes(browser) {
        var remoteMatch = browser.match(REMOTE_ALIAS_RE);

        if (remoteMatch) {
            this.remoteCount += parseInt(remoteMatch[1], 10) || 1;
            return false;
        }

        return true;
    }

    _parseFilteringOptions() {
        this.opts.testGrep = CLIArgumentParser._optionValueToRegExp('--test-grep', this.opts.testGrep);
        this.opts.fixtureGrep = CLIArgumentParser._optionValueToRegExp('--fixture-grep', this.opts.fixtureGrep);

        this.filter = (testName, fixtureName) => {

            if (this.opts.test && testName !== this.opts.test) return false;

            if (this.opts.testGrep && !this.opts.testGrep.test(testName)) return false;

            if (this.opts.fixture && fixtureName !== this.opts.fixture) return false;

            if (this.opts.fixtureGrep && !this.opts.fixtureGrep.test(fixtureName)) return false;

            return true;
        };
    }

    _parseAppInitDelay() {
        if (this.opts.appInitDelay) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Tested app initialization delay', this.opts.appInitDelay);

            this.opts.appInitDelay = parseInt(this.opts.appInitDelay, 10);
        }
    }

    _parseSelectorTimeout() {
        if (this.opts.selectorTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Selector timeout', this.opts.selectorTimeout);

            this.opts.selectorTimeout = parseInt(this.opts.selectorTimeout, 10);
        }
    }

    _parseAssertionTimeout() {
        if (this.opts.assertionTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Assertion timeout', this.opts.assertionTimeout);

            this.opts.assertionTimeout = parseInt(this.opts.assertionTimeout, 10);
        }
    }

    _parsePageLoadTimeout() {
        if (this.opts.pageLoadTimeout) {
            (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumberString, null, 'Page load timeout', this.opts.pageLoadTimeout);

            this.opts.pageLoadTimeout = parseInt(this.opts.pageLoadTimeout, 10);
        }
    }

    _parseSpeed() {
        if (this.opts.speed) this.opts.speed = parseFloat(this.opts.speed);
    }

    _parseConcurrency() {
        if (this.opts.concurrency) this.concurrency = parseInt(this.opts.concurrency, 10);
    }

    _parsePorts() {
        if (this.opts.ports) {
            this.opts.ports = this.opts.ports.split(',').map(CLIArgumentParser._parsePortNumber);

            if (this.opts.ports.length < 2) throw new _runtime.GeneralError(_message2.default.portsOptionRequiresTwoNumbers);
        }
    }

    _parseBrowserList() {
        var browsersArg = this.program.args[0] || '';

        this.browsers = (0, _string.splitQuotedText)(browsersArg, ',').filter(browser => browser && this._filterAndCountRemotes(browser));
    }

    _parseSslOptions() {
        if (this.opts.ssl) this.opts.ssl = (0, _parseSslOptions2.default)(this.program.args[0]);
    }

    _parseReporters() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this.opts.reporter) {
                _this.opts.reporters = [];
                return;
            }

            const reporters = _this.opts.reporter.split(',');

            _this.opts.reporters = reporters.map(function (reporter) {
                const separatorIndex = reporter.indexOf(':');

                if (separatorIndex < 0) return { name: reporter };

                const name = reporter.substring(0, separatorIndex);
                const outFile = reporter.substring(separatorIndex + 1);

                return { name, outFile };
            });

            for (var _iterator = _this.opts.reporters, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : (0, _getIterator3.default)(_iterator);;) {
                var _ref;

                if (_isArray) {
                    if (_i >= _iterator.length) break;
                    _ref = _iterator[_i++];
                } else {
                    _i = _iterator.next();
                    if (_i.done) break;
                    _ref = _i.value;
                }

                const reporter = _ref;

                if (reporter.outFile) {
                    reporter.outFile = (0, _path.resolve)(_this.cwd, reporter.outFile);

                    yield (0, _promisifiedFunctions.ensureDir)((0, _path.dirname)(reporter.outFile));
                }
            }
        })();
    }

    _parseFileList() {
        this.src = this.program.args.slice(1);
    }

    _parseScreenshotsPath() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this2.opts.screenshots) {
                _this2.opts.screenshots = (0, _path.resolve)(_this2.cwd, _this2.opts.screenshots);

                yield (0, _promisifiedFunctions.ensureDir)(_this2.opts.screenshots);
            }
        })();
    }

    _getProviderName() {
        this.opts.providerName = this.opts.listBrowsers === true ? void 0 : this.opts.listBrowsers;
    }

    parse(argv) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this3.program.parse(argv);

            _this3.opts = _this3.program.opts();

            // NOTE: the '-list-browsers' option only lists browsers and immediately exits the app.
            // Therefore, we don't need to process other arguments.
            if (_this3.opts.listBrowsers) {
                _this3._getProviderName();
                return;
            }

            _this3._parseFilteringOptions();
            _this3._parseSelectorTimeout();
            _this3._parseAssertionTimeout();
            _this3._parsePageLoadTimeout();
            _this3._parseAppInitDelay();
            _this3._parseSpeed();
            _this3._parsePorts();
            _this3._parseBrowserList();
            _this3._parseConcurrency();
            _this3._parseSslOptions();
            _this3._parseFileList();

            yield _pinkie2.default.all([_this3._parseScreenshotsPath(), _this3._parseReporters()]);
        })();
    }
}
exports.default = CLIArgumentParser;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvYXJndW1lbnQtcGFyc2VyLmpzIl0sIm5hbWVzIjpbIlJFTU9URV9BTElBU19SRSIsIkRFU0NSSVBUSU9OIiwiQ0xJQXJndW1lbnRQYXJzZXIiLCJjb25zdHJ1Y3RvciIsImN3ZCIsInByb2dyYW0iLCJDb21tYW5kIiwicHJvY2VzcyIsInNyYyIsImJyb3dzZXJzIiwiZmlsdGVyIiwicmVtb3RlQ291bnQiLCJvcHRzIiwiX2Rlc2NyaWJlUHJvZ3JhbSIsIl9wYXJzZVBvcnROdW1iZXIiLCJ2YWx1ZSIsImlzIiwibm9uTmVnYXRpdmVOdW1iZXJTdHJpbmciLCJwYXJzZUludCIsIl9vcHRpb25WYWx1ZVRvUmVnRXhwIiwibmFtZSIsIlJlZ0V4cCIsImVyciIsIkdlbmVyYWxFcnJvciIsIk1FU1NBR0UiLCJvcHRpb25WYWx1ZUlzTm90VmFsaWRSZWdFeHAiLCJfZ2V0RGVzY3JpcHRpb24iLCJzdGRvdXQiLCJ2ZXJzaW9uIiwiSlNPTiIsInBhcnNlIiwidXNhZ2UiLCJkZXNjcmlwdGlvbiIsIm9wdGlvbiIsIl9maWx0ZXJBbmRDb3VudFJlbW90ZXMiLCJicm93c2VyIiwicmVtb3RlTWF0Y2giLCJtYXRjaCIsIl9wYXJzZUZpbHRlcmluZ09wdGlvbnMiLCJ0ZXN0R3JlcCIsImZpeHR1cmVHcmVwIiwidGVzdE5hbWUiLCJmaXh0dXJlTmFtZSIsInRlc3QiLCJmaXh0dXJlIiwiX3BhcnNlQXBwSW5pdERlbGF5IiwiYXBwSW5pdERlbGF5IiwiX3BhcnNlU2VsZWN0b3JUaW1lb3V0Iiwic2VsZWN0b3JUaW1lb3V0IiwiX3BhcnNlQXNzZXJ0aW9uVGltZW91dCIsImFzc2VydGlvblRpbWVvdXQiLCJfcGFyc2VQYWdlTG9hZFRpbWVvdXQiLCJwYWdlTG9hZFRpbWVvdXQiLCJfcGFyc2VTcGVlZCIsInNwZWVkIiwicGFyc2VGbG9hdCIsIl9wYXJzZUNvbmN1cnJlbmN5IiwiY29uY3VycmVuY3kiLCJfcGFyc2VQb3J0cyIsInBvcnRzIiwic3BsaXQiLCJtYXAiLCJsZW5ndGgiLCJwb3J0c09wdGlvblJlcXVpcmVzVHdvTnVtYmVycyIsIl9wYXJzZUJyb3dzZXJMaXN0IiwiYnJvd3NlcnNBcmciLCJhcmdzIiwiX3BhcnNlU3NsT3B0aW9ucyIsInNzbCIsIl9wYXJzZVJlcG9ydGVycyIsInJlcG9ydGVyIiwicmVwb3J0ZXJzIiwic2VwYXJhdG9ySW5kZXgiLCJpbmRleE9mIiwic3Vic3RyaW5nIiwib3V0RmlsZSIsIl9wYXJzZUZpbGVMaXN0Iiwic2xpY2UiLCJfcGFyc2VTY3JlZW5zaG90c1BhdGgiLCJzY3JlZW5zaG90cyIsIl9nZXRQcm92aWRlck5hbWUiLCJwcm92aWRlck5hbWUiLCJsaXN0QnJvd3NlcnMiLCJhcmd2IiwiUHJvbWlzZSIsImFsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsa0JBQWtCLHFCQUF4Qjs7QUFFQSxNQUFNQyxjQUFjLHNCQUFROzs7Ozs7Ozs7Ozs7O0NBQVIsQ0FBcEI7O0FBZWUsTUFBTUMsaUJBQU4sQ0FBd0I7QUFDbkNDLGdCQUFhQyxHQUFiLEVBQWtCO0FBQ2QsYUFBS0MsT0FBTCxHQUFlLElBQUlDLGtCQUFKLENBQVksVUFBWixDQUFmOztBQUVBLGFBQUtGLEdBQUwsR0FBV0EsT0FBT0csUUFBUUgsR0FBUixFQUFsQjs7QUFFQSxhQUFLSSxHQUFMLEdBQW1CLElBQW5CO0FBQ0EsYUFBS0MsUUFBTCxHQUFtQixJQUFuQjtBQUNBLGFBQUtDLE1BQUwsR0FBbUIsSUFBbkI7QUFDQSxhQUFLQyxXQUFMLEdBQW1CLENBQW5CO0FBQ0EsYUFBS0MsSUFBTCxHQUFtQixJQUFuQjs7QUFFQSxhQUFLQyxnQkFBTDtBQUNIOztBQUVELFdBQU9DLGdCQUFQLENBQXlCQyxLQUF6QixFQUFnQztBQUM1Qix3Q0FBV0MsbUJBQUdDLHVCQUFkLEVBQXVDLElBQXZD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UyxjQUFMOztBQUVBLGtCQUFNUSxpQkFBUUMsR0FBUixDQUFZLENBQ2QsT0FBS1AscUJBQUwsRUFEYyxFQUVkLE9BQUtULGVBQUwsRUFGYyxDQUFaLENBQU47QUF4QmU7QUE0QmxCO0FBN1BrQztrQkFBbEJuRSxpQiIsImZpbGUiOiJjbGkvYXJndW1lbnQtcGFyc2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVzb2x2ZSwgZGlybmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQ29tbWFuZCB9IGZyb20gJ2NvbW1hbmRlcic7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IGRlZGVudCBmcm9tICdkZWRlbnQnO1xuaW1wb3J0IHsgcmVhZFN5bmMgYXMgcmVhZCB9IGZyb20gJ3JlYWQtZmlsZS1yZWxhdGl2ZSc7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgTUVTU0FHRSBmcm9tICcuLi9lcnJvcnMvcnVudGltZS9tZXNzYWdlJztcbmltcG9ydCB7IGFzc2VydFR5cGUsIGlzIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvdHlwZS1hc3NlcnRpb25zJztcbmltcG9ydCBnZXRWaWV3UG9ydFdpZHRoIGZyb20gJy4uL3V0aWxzL2dldC12aWV3cG9ydC13aWR0aCc7XG5pbXBvcnQgeyB3b3JkV3JhcCwgc3BsaXRRdW90ZWRUZXh0IH0gZnJvbSAnLi4vdXRpbHMvc3RyaW5nJztcbmltcG9ydCB7IGVuc3VyZURpciB9IGZyb20gJy4uL3V0aWxzL3Byb21pc2lmaWVkLWZ1bmN0aW9ucyc7XG5pbXBvcnQgcGFyc2VTc2xPcHRpb25zIGZyb20gJy4vcGFyc2Utc3NsLW9wdGlvbnMnO1xuXG5jb25zdCBSRU1PVEVfQUxJQVNfUkUgPSAvXnJlbW90ZSg/OjooXFxkKikpPyQvO1xuXG5jb25zdCBERVNDUklQVElPTiA9IGRlZGVudChgXG4gICAgSW4gdGhlIGJyb3dzZXIgbGlzdCwgeW91IGNhbiB1c2UgYnJvd3NlciBuYW1lcyAoZS5nLiBcImllXCIsIFwiY2hyb21lXCIsIGV0Yy4pIGFzIHdlbGwgYXMgcGF0aHMgdG8gZXhlY3V0YWJsZXMuXG5cbiAgICBUbyBydW4gdGVzdHMgYWdhaW5zdCBhbGwgaW5zdGFsbGVkIGJyb3dzZXJzLCB1c2UgdGhlIFwiYWxsXCIgYWxpYXMuXG5cbiAgICBUbyB1c2UgYSByZW1vdGUgYnJvd3NlciBjb25uZWN0aW9uIChlLmcuLCB0byBjb25uZWN0IGEgbW9iaWxlIGRldmljZSksIHNwZWNpZnkgXCJyZW1vdGVcIiBhcyB0aGUgYnJvd3NlciBhbGlhcy5cbiAgICBJZiB5b3UgbmVlZCB0byBjb25uZWN0IG11bHRpcGxlIGRldmljZXMsIGFkZCBhIGNvbG9uIGFuZCB0aGUgbnVtYmVyIG9mIGJyb3dzZXJzIHlvdSB3YW50IHRvIGNvbm5lY3QgKGUuZy4sIFwicmVtb3RlOjNcIikuXG5cbiAgICBUbyBydW4gdGVzdHMgaW4gYSBicm93c2VyIGFjY2Vzc2VkIHRocm91Z2ggYSBicm93c2VyIHByb3ZpZGVyIHBsdWdpbiwgc3BlY2lmeSBhIGJyb3dzZXIgYWxpYXMgdGhhdCBjb25zaXN0cyBvZiB0d28gcGFydHMgLSB0aGUgYnJvd3NlciBwcm92aWRlciBuYW1lIHByZWZpeCBhbmQgdGhlIG5hbWUgb2YgdGhlIGJyb3dzZXIgaXRzZWxmOyBmb3IgZXhhbXBsZSwgXCJzYXVjZWxhYnM6Y2hyb21lQDUxXCIuXG5cbiAgICBZb3UgY2FuIHVzZSBvbmUgb3IgbW9yZSBmaWxlIHBhdGhzIG9yIGdsb2IgcGF0dGVybnMgdG8gc3BlY2lmeSB3aGljaCB0ZXN0cyB0byBydW4uXG5cbiAgICBNb3JlIGluZm86IGh0dHBzOi8vZGV2ZXhwcmVzcy5naXRodWIuaW8vdGVzdGNhZmUvZG9jdW1lbnRhdGlvblxuYCk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENMSUFyZ3VtZW50UGFyc2VyIHtcbiAgICBjb25zdHJ1Y3RvciAoY3dkKSB7XG4gICAgICAgIHRoaXMucHJvZ3JhbSA9IG5ldyBDb21tYW5kKCd0ZXN0Y2FmZScpO1xuXG4gICAgICAgIHRoaXMuY3dkID0gY3dkIHx8IHByb2Nlc3MuY3dkKCk7XG5cbiAgICAgICAgdGhpcy5zcmMgICAgICAgICA9IG51bGw7XG4gICAgICAgIHRoaXMuYnJvd3NlcnMgICAgPSBudWxsO1xuICAgICAgICB0aGlzLmZpbHRlciAgICAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5yZW1vdGVDb3VudCA9IDA7XG4gICAgICAgIHRoaXMub3B0cyAgICAgICAgPSBudWxsO1xuXG4gICAgICAgIHRoaXMuX2Rlc2NyaWJlUHJvZ3JhbSgpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfcGFyc2VQb3J0TnVtYmVyICh2YWx1ZSkge1xuICAgICAgICBhc3NlcnRUeXBlKGlzLm5vbk5lZ2F0aXZlTnVtYmVyU3RyaW5nLCBudWxsLCAnUG9ydCBudW1iZXInLCB2YWx1ZSk7XG5cbiAgICAgICAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCAxMCk7XG4gICAgfVxuXG4gICAgc3RhdGljIF9vcHRpb25WYWx1ZVRvUmVnRXhwIChuYW1lLCB2YWx1ZSkge1xuICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQgMClcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAodmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5vcHRpb25WYWx1ZUlzTm90VmFsaWRSZWdFeHAsIG5hbWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc3RhdGljIF9nZXREZXNjcmlwdGlvbiAoKSB7XG4gICAgICAgIC8vIE5PVEU6IGFkZCBlbXB0eSBsaW5lIHRvIHdvcmthcm91bmQgY29tbWFuZGVyLWZvcmNlZCBpbmRlbnRhdGlvbiBvbiB0aGUgZmlyc3QgbGluZS5cbiAgICAgICAgcmV0dXJuICdcXG4nICsgd29yZFdyYXAoREVTQ1JJUFRJT04sIDIsIGdldFZpZXdQb3J0V2lkdGgocHJvY2Vzcy5zdGRvdXQpKTtcbiAgICB9XG5cbiAgICBfZGVzY3JpYmVQcm9ncmFtICgpIHtcbiAgICAgICAgdmFyIHZlcnNpb24gPSBKU09OLnBhcnNlKHJlYWQoJy4uLy4uL3BhY2thZ2UuanNvbicpKS52ZXJzaW9uO1xuXG4gICAgICAgIHRoaXMucHJvZ3JhbVxuXG4gICAgICAgICAgICAudmVyc2lvbih2ZXJzaW9uLCAnLXYsIC0tdmVyc2lvbicpXG4gICAgICAgICAgICAudXNhZ2UoJ1tvcHRpb25zXSA8Y29tbWEtc2VwYXJhdGVkLWJyb3dzZXItbGlzdD4gPGZpbGUtb3ItZ2xvYiAuLi4+JylcbiAgICAgICAgICAgIC5kZXNjcmlwdGlvbihDTElBcmd1bWVudFBhcnNlci5fZ2V0RGVzY3JpcHRpb24oKSlcblxuICAgICAgICAgICAgLm9wdGlvbignLWIsIC0tbGlzdC1icm93c2VycyBbcHJvdmlkZXJdJywgJ291dHB1dCB0aGUgYWxpYXNlcyBmb3IgbG9jYWwgYnJvd3NlcnMgb3IgYnJvd3NlcnMgYXZhaWxhYmxlIHRocm91Z2ggdGhlIHNwZWNpZmllZCBicm93c2VyIHByb3ZpZGVyJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1yLCAtLXJlcG9ydGVyIDxuYW1lWzpvdXRwdXRGaWxlXVssLi4uXT4nLCAnc3BlY2lmeSB0aGUgcmVwb3J0ZXJzIGFuZCBvcHRpb25hbGx5IGZpbGVzIHdoZXJlIHJlcG9ydHMgYXJlIHNhdmVkJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1zLCAtLXNjcmVlbnNob3RzIDxwYXRoPicsICdlbmFibGUgc2NyZWVuc2hvdCBjYXB0dXJpbmcgYW5kIHNwZWNpZnkgdGhlIHBhdGggdG8gc2F2ZSB0aGUgc2NyZWVuc2hvdHMgdG8nKVxuICAgICAgICAgICAgLm9wdGlvbignLVMsIC0tc2NyZWVuc2hvdHMtb24tZmFpbHMnLCAndGFrZSBhIHNjcmVlbnNob3Qgd2hlbmV2ZXIgYSB0ZXN0IGZhaWxzJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1wLCAtLXNjcmVlbnNob3QtcGF0aC1wYXR0ZXJuIDxwYXR0ZXJuPicsICd1c2UgcGF0dGVybnMgdG8gY29tcG9zZSBzY3JlZW5zaG90IGZpbGUgbmFtZXMgYW5kIHBhdGhzOiAke0JST1dTRVJ9LCAke0JST1dTRVJfVkVSU0lPTn0sICR7T1N9LCBldGMuJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1xLCAtLXF1YXJhbnRpbmUtbW9kZScsICdlbmFibGUgdGhlIHF1YXJhbnRpbmUgbW9kZScpXG4gICAgICAgICAgICAub3B0aW9uKCctZCwgLS1kZWJ1Zy1tb2RlJywgJ2V4ZWN1dGUgdGVzdCBzdGVwcyBvbmUgYnkgb25lIHBhdXNpbmcgdGhlIHRlc3QgYWZ0ZXIgZWFjaCBzdGVwJylcbiAgICAgICAgICAgIC5vcHRpb24oJy1lLCAtLXNraXAtanMtZXJyb3JzJywgJ21ha2UgdGVzdHMgbm90IGZhaWwgd2hlbiBhIEpTIGVycm9yIGhhcHBlbnMgb24gYSBwYWdlJylcbiAgICAgICAgICAgIC5vcHRpb24oJy11LCAtLXNraXAtdW5jYXVnaHQtZXJyb3JzJywgJ2lnbm9yZSB1bmNhdWdodCBlcnJvcnMgYW5kIHVuaGFuZGxlZCBwcm9taXNlIHJlamVjdGlvbnMsIHdoaWNoIG9jY3VyIGR1cmluZyB0ZXN0IGV4ZWN1dGlvbicpXG4gICAgICAgICAgICAub3B0aW9uKCctdCwgLS10ZXN0IDxuYW1lPicsICdydW4gb25seSB0ZXN0cyB3aXRoIHRoZSBzcGVjaWZpZWQgbmFtZScpXG4gICAgICAgICAgICAub3B0aW9uKCctVCwgLS10ZXN0LWdyZXAgPHBhdHRlcm4+JywgJ3J1biBvbmx5IHRlc3RzIG1hdGNoaW5nIHRoZSBzcGVjaWZpZWQgcGF0dGVybicpXG4gICAgICAgICAgICAub3B0aW9uKCctZiwgLS1maXh0dXJlIDxuYW1lPicsICdydW4gb25seSBmaXh0dXJlcyB3aXRoIHRoZSBzcGVjaWZpZWQgbmFtZScpXG4gICAgICAgICAgICAub3B0aW9uKCctRiwgLS1maXh0dXJlLWdyZXAgPHBhdHRlcm4+JywgJ3J1biBvbmx5IGZpeHR1cmVzIG1hdGNoaW5nIHRoZSBzcGVjaWZpZWQgcGF0dGVybicpXG4gICAgICAgICAgICAub3B0aW9uKCctYSwgLS1hcHAgPGNvbW1hbmQ+JywgJ2xhdW5jaCB0aGUgdGVzdGVkIGFwcCB1c2luZyB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgYmVmb3JlIHJ1bm5pbmcgdGVzdHMnKVxuICAgICAgICAgICAgLm9wdGlvbignLWMsIC0tY29uY3VycmVuY3kgPG51bWJlcj4nLCAncnVuIHRlc3RzIGNvbmN1cnJlbnRseScpXG4gICAgICAgICAgICAub3B0aW9uKCctLWRlYnVnLW9uLWZhaWwnLCAncGF1c2UgdGhlIHRlc3QgaWYgaXQgZmFpbHMnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1hcHAtaW5pdC1kZWxheSA8bXM+JywgJ3NwZWNpZnkgaG93IG11Y2ggdGltZSBpdCB0YWtlcyBmb3IgdGhlIHRlc3RlZCBhcHAgdG8gaW5pdGlhbGl6ZScpXG4gICAgICAgICAgICAub3B0aW9uKCctLXNlbGVjdG9yLXRpbWVvdXQgPG1zPicsICdzZXQgdGhlIGFtb3VudCBvZiB0aW1lIHdpdGhpbiB3aGljaCBzZWxlY3RvcnMgbWFrZSBhdHRlbXB0cyB0byBvYnRhaW4gYSBub2RlIHRvIGJlIHJldHVybmVkJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tYXNzZXJ0aW9uLXRpbWVvdXQgPG1zPicsICdzZXQgdGhlIGFtb3VudCBvZiB0aW1lIHdpdGhpbiB3aGljaCBhc3NlcnRpb24gc2hvdWxkIHBhc3MnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1wYWdlLWxvYWQtdGltZW91dCA8bXM+JywgJ3NldCB0aGUgYW1vdW50IG9mIHRpbWUgd2l0aGluIHdoaWNoIFRlc3RDYWZlIHdhaXRzIGZvciB0aGUgYHdpbmRvdy5sb2FkYCBldmVudCB0byBmaXJlIG9uIHBhZ2UgbG9hZCBiZWZvcmUgcHJvY2VlZGluZyB0byB0aGUgbmV4dCB0ZXN0IGFjdGlvbicpXG4gICAgICAgICAgICAub3B0aW9uKCctLXNwZWVkIDxmYWN0b3I+JywgJ3NldCB0aGUgc3BlZWQgb2YgdGVzdCBleGVjdXRpb24gKDAuMDEgLi4uIDEpJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tcG9ydHMgPHBvcnQxLHBvcnQyPicsICdzcGVjaWZ5IGN1c3RvbSBwb3J0IG51bWJlcnMnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1ob3N0bmFtZSA8bmFtZT4nLCAnc3BlY2lmeSB0aGUgaG9zdG5hbWUnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1wcm94eSA8aG9zdD4nLCAnc3BlY2lmeSB0aGUgaG9zdCBvZiB0aGUgcHJveHkgc2VydmVyJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tc3NsJywgJ3NwZWNpZnkgU1NMIG9wdGlvbnMgdG8gcnVuIFRlc3RDYWZlIHByb3h5IHNlcnZlciBvdmVyIHRoZSBIVFRQUyBwcm90b2NvbCcpXG4gICAgICAgICAgICAub3B0aW9uKCctLXByb3h5LWJ5cGFzcyA8cnVsZXM+JywgJ3NwZWNpZnkgYSBjb21tYS1zZXBhcmF0ZWQgbGlzdCBvZiBydWxlcyB0aGF0IGRlZmluZSBVUkxzIGFjY2Vzc2VkIGJ5cGFzc2luZyB0aGUgcHJveHkgc2VydmVyJylcbiAgICAgICAgICAgIC5vcHRpb24oJy0tZGlzYWJsZS1wYWdlLXJlbG9hZHMnLCAnZGlzYWJsZSBwYWdlIHJlbG9hZHMgYmV0d2VlbiB0ZXN0cycpXG4gICAgICAgICAgICAub3B0aW9uKCctLWRldicsICdlbmFibGVzIG1lY2hhbmlzbXMgdG8gbG9nIGFuZCBkaWFnbm9zZSBlcnJvcnMnKVxuICAgICAgICAgICAgLm9wdGlvbignLS1xci1jb2RlJywgJ291dHB1dHMgUVItY29kZSB0aGF0IHJlcGVhdHMgVVJMcyB1c2VkIHRvIGNvbm5lY3QgdGhlIHJlbW90ZSBicm93c2VycycpXG5cbiAgICAgICAgICAgIC8vIE5PVEU6IHRoZXNlIG9wdGlvbnMgd2lsbCBiZSBoYW5kbGVkIGJ5IGNoYWxrIGludGVybmFsbHlcbiAgICAgICAgICAgIC5vcHRpb24oJy0tY29sb3InLCAnZm9yY2UgY29sb3JzIGluIGNvbW1hbmQgbGluZScpXG4gICAgICAgICAgICAub3B0aW9uKCctLW5vLWNvbG9yJywgJ2Rpc2FibGUgY29sb3JzIGluIGNvbW1hbmQgbGluZScpO1xuICAgIH1cblxuICAgIF9maWx0ZXJBbmRDb3VudFJlbW90ZXMgKGJyb3dzZXIpIHtcbiAgICAgICAgdmFyIHJlbW90ZU1hdGNoID0gYnJvd3Nlci5tYXRjaChSRU1PVEVfQUxJQVNfUkUpO1xuXG4gICAgICAgIGlmIChyZW1vdGVNYXRjaCkge1xuICAgICAgICAgICAgdGhpcy5yZW1vdGVDb3VudCArPSBwYXJzZUludChyZW1vdGVNYXRjaFsxXSwgMTApIHx8IDE7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBfcGFyc2VGaWx0ZXJpbmdPcHRpb25zICgpIHtcbiAgICAgICAgdGhpcy5vcHRzLnRlc3RHcmVwICAgID0gQ0xJQXJndW1lbnRQYXJzZXIuX29wdGlvblZhbHVlVG9SZWdFeHAoJy0tdGVzdC1ncmVwJywgdGhpcy5vcHRzLnRlc3RHcmVwKTtcbiAgICAgICAgdGhpcy5vcHRzLmZpeHR1cmVHcmVwID0gQ0xJQXJndW1lbnRQYXJzZXIuX29wdGlvblZhbHVlVG9SZWdFeHAoJy0tZml4dHVyZS1ncmVwJywgdGhpcy5vcHRzLmZpeHR1cmVHcmVwKTtcblxuICAgICAgICB0aGlzLmZpbHRlciA9ICh0ZXN0TmFtZSwgZml4dHVyZU5hbWUpID0+IHtcblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0cy50ZXN0ICYmIHRlc3ROYW1lICE9PSB0aGlzLm9wdHMudGVzdClcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMudGVzdEdyZXAgJiYgIXRoaXMub3B0cy50ZXN0R3JlcC50ZXN0KHRlc3ROYW1lKSlcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMuZml4dHVyZSAmJiBmaXh0dXJlTmFtZSAhPT0gdGhpcy5vcHRzLmZpeHR1cmUpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRzLmZpeHR1cmVHcmVwICYmICF0aGlzLm9wdHMuZml4dHVyZUdyZXAudGVzdChmaXh0dXJlTmFtZSkpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfcGFyc2VBcHBJbml0RGVsYXkgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLmFwcEluaXREZWxheSkge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ1Rlc3RlZCBhcHAgaW5pdGlhbGl6YXRpb24gZGVsYXknLCB0aGlzLm9wdHMuYXBwSW5pdERlbGF5KTtcblxuICAgICAgICAgICAgdGhpcy5vcHRzLmFwcEluaXREZWxheSA9IHBhcnNlSW50KHRoaXMub3B0cy5hcHBJbml0RGVsYXksIDEwKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wYXJzZVNlbGVjdG9yVGltZW91dCAoKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuc2VsZWN0b3JUaW1lb3V0KSB7XG4gICAgICAgICAgICBhc3NlcnRUeXBlKGlzLm5vbk5lZ2F0aXZlTnVtYmVyU3RyaW5nLCBudWxsLCAnU2VsZWN0b3IgdGltZW91dCcsIHRoaXMub3B0cy5zZWxlY3RvclRpbWVvdXQpO1xuXG4gICAgICAgICAgICB0aGlzLm9wdHMuc2VsZWN0b3JUaW1lb3V0ID0gcGFyc2VJbnQodGhpcy5vcHRzLnNlbGVjdG9yVGltZW91dCwgMTApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3BhcnNlQXNzZXJ0aW9uVGltZW91dCAoKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuYXNzZXJ0aW9uVGltZW91dCkge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ0Fzc2VydGlvbiB0aW1lb3V0JywgdGhpcy5vcHRzLmFzc2VydGlvblRpbWVvdXQpO1xuXG4gICAgICAgICAgICB0aGlzLm9wdHMuYXNzZXJ0aW9uVGltZW91dCA9IHBhcnNlSW50KHRoaXMub3B0cy5hc3NlcnRpb25UaW1lb3V0LCAxMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcGFyc2VQYWdlTG9hZFRpbWVvdXQgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLnBhZ2VMb2FkVGltZW91dCkge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShpcy5ub25OZWdhdGl2ZU51bWJlclN0cmluZywgbnVsbCwgJ1BhZ2UgbG9hZCB0aW1lb3V0JywgdGhpcy5vcHRzLnBhZ2VMb2FkVGltZW91dCk7XG5cbiAgICAgICAgICAgIHRoaXMub3B0cy5wYWdlTG9hZFRpbWVvdXQgPSBwYXJzZUludCh0aGlzLm9wdHMucGFnZUxvYWRUaW1lb3V0LCAxMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcGFyc2VTcGVlZCAoKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdHMuc3BlZWQpXG4gICAgICAgICAgICB0aGlzLm9wdHMuc3BlZWQgPSBwYXJzZUZsb2F0KHRoaXMub3B0cy5zcGVlZCk7XG4gICAgfVxuXG4gICAgX3BhcnNlQ29uY3VycmVuY3kgKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLmNvbmN1cnJlbmN5KVxuICAgICAgICAgICAgdGhpcy5jb25jdXJyZW5jeSA9IHBhcnNlSW50KHRoaXMub3B0cy5jb25jdXJyZW5jeSwgMTApO1xuICAgIH1cblxuICAgIF9wYXJzZVBvcnRzICgpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5wb3J0cykge1xuICAgICAgICAgICAgdGhpcy5vcHRzLnBvcnRzID0gdGhpcy5vcHRzLnBvcnRzXG4gICAgICAgICAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgICAgICAgICAubWFwKENMSUFyZ3VtZW50UGFyc2VyLl9wYXJzZVBvcnROdW1iZXIpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRzLnBvcnRzLmxlbmd0aCA8IDIpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLnBvcnRzT3B0aW9uUmVxdWlyZXNUd29OdW1iZXJzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wYXJzZUJyb3dzZXJMaXN0ICgpIHtcbiAgICAgICAgdmFyIGJyb3dzZXJzQXJnID0gdGhpcy5wcm9ncmFtLmFyZ3NbMF0gfHwgJyc7XG5cbiAgICAgICAgdGhpcy5icm93c2VycyA9IHNwbGl0UXVvdGVkVGV4dChicm93c2Vyc0FyZywgJywnKVxuICAgICAgICAgICAgLmZpbHRlcihicm93c2VyID0+IGJyb3dzZXIgJiYgdGhpcy5fZmlsdGVyQW5kQ291bnRSZW1vdGVzKGJyb3dzZXIpKTtcbiAgICB9XG5cbiAgICBfcGFyc2VTc2xPcHRpb25zICgpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5zc2wpXG4gICAgICAgICAgICB0aGlzLm9wdHMuc3NsID0gcGFyc2VTc2xPcHRpb25zKHRoaXMucHJvZ3JhbS5hcmdzWzBdKTtcbiAgICB9XG5cbiAgICBhc3luYyBfcGFyc2VSZXBvcnRlcnMgKCkge1xuICAgICAgICBpZiAoIXRoaXMub3B0cy5yZXBvcnRlcikge1xuICAgICAgICAgICAgdGhpcy5vcHRzLnJlcG9ydGVycyA9IFtdO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVwb3J0ZXJzID0gdGhpcy5vcHRzLnJlcG9ydGVyLnNwbGl0KCcsJyk7XG5cbiAgICAgICAgdGhpcy5vcHRzLnJlcG9ydGVycyA9IHJlcG9ydGVycy5tYXAocmVwb3J0ZXIgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc2VwYXJhdG9ySW5kZXggPSByZXBvcnRlci5pbmRleE9mKCc6Jyk7XG5cbiAgICAgICAgICAgIGlmIChzZXBhcmF0b3JJbmRleCA8IDApXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgbmFtZTogcmVwb3J0ZXIgfTtcblxuICAgICAgICAgICAgY29uc3QgbmFtZSAgICA9IHJlcG9ydGVyLnN1YnN0cmluZygwLCBzZXBhcmF0b3JJbmRleCk7XG4gICAgICAgICAgICBjb25zdCBvdXRGaWxlID0gcmVwb3J0ZXIuc3Vic3RyaW5nKHNlcGFyYXRvckluZGV4ICsgMSk7XG5cbiAgICAgICAgICAgIHJldHVybiB7IG5hbWUsIG91dEZpbGUgfTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZm9yIChjb25zdCByZXBvcnRlciBvZiB0aGlzLm9wdHMucmVwb3J0ZXJzKSB7XG4gICAgICAgICAgICBpZiAocmVwb3J0ZXIub3V0RmlsZSkge1xuICAgICAgICAgICAgICAgIHJlcG9ydGVyLm91dEZpbGUgPSByZXNvbHZlKHRoaXMuY3dkLCByZXBvcnRlci5vdXRGaWxlKTtcblxuICAgICAgICAgICAgICAgIGF3YWl0IGVuc3VyZURpcihkaXJuYW1lKHJlcG9ydGVyLm91dEZpbGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9wYXJzZUZpbGVMaXN0ICgpIHtcbiAgICAgICAgdGhpcy5zcmMgPSB0aGlzLnByb2dyYW0uYXJncy5zbGljZSgxKTtcbiAgICB9XG5cbiAgICBhc3luYyBfcGFyc2VTY3JlZW5zaG90c1BhdGggKCkge1xuICAgICAgICBpZiAodGhpcy5vcHRzLnNjcmVlbnNob3RzKSB7XG4gICAgICAgICAgICB0aGlzLm9wdHMuc2NyZWVuc2hvdHMgPSByZXNvbHZlKHRoaXMuY3dkLCB0aGlzLm9wdHMuc2NyZWVuc2hvdHMpO1xuXG4gICAgICAgICAgICBhd2FpdCBlbnN1cmVEaXIodGhpcy5vcHRzLnNjcmVlbnNob3RzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9nZXRQcm92aWRlck5hbWUgKCkge1xuICAgICAgICB0aGlzLm9wdHMucHJvdmlkZXJOYW1lID0gdGhpcy5vcHRzLmxpc3RCcm93c2VycyA9PT0gdHJ1ZSA/IHZvaWQgMCA6IHRoaXMub3B0cy5saXN0QnJvd3NlcnM7XG4gICAgfVxuXG4gICAgYXN5bmMgcGFyc2UgKGFyZ3YpIHtcbiAgICAgICAgdGhpcy5wcm9ncmFtLnBhcnNlKGFyZ3YpO1xuXG4gICAgICAgIHRoaXMub3B0cyA9IHRoaXMucHJvZ3JhbS5vcHRzKCk7XG5cbiAgICAgICAgLy8gTk9URTogdGhlICctbGlzdC1icm93c2Vycycgb3B0aW9uIG9ubHkgbGlzdHMgYnJvd3NlcnMgYW5kIGltbWVkaWF0ZWx5IGV4aXRzIHRoZSBhcHAuXG4gICAgICAgIC8vIFRoZXJlZm9yZSwgd2UgZG9uJ3QgbmVlZCB0byBwcm9jZXNzIG90aGVyIGFyZ3VtZW50cy5cbiAgICAgICAgaWYgKHRoaXMub3B0cy5saXN0QnJvd3NlcnMpIHtcbiAgICAgICAgICAgIHRoaXMuX2dldFByb3ZpZGVyTmFtZSgpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fcGFyc2VGaWx0ZXJpbmdPcHRpb25zKCk7XG4gICAgICAgIHRoaXMuX3BhcnNlU2VsZWN0b3JUaW1lb3V0KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlQXNzZXJ0aW9uVGltZW91dCgpO1xuICAgICAgICB0aGlzLl9wYXJzZVBhZ2VMb2FkVGltZW91dCgpO1xuICAgICAgICB0aGlzLl9wYXJzZUFwcEluaXREZWxheSgpO1xuICAgICAgICB0aGlzLl9wYXJzZVNwZWVkKCk7XG4gICAgICAgIHRoaXMuX3BhcnNlUG9ydHMoKTtcbiAgICAgICAgdGhpcy5fcGFyc2VCcm93c2VyTGlzdCgpO1xuICAgICAgICB0aGlzLl9wYXJzZUNvbmN1cnJlbmN5KCk7XG4gICAgICAgIHRoaXMuX3BhcnNlU3NsT3B0aW9ucygpO1xuICAgICAgICB0aGlzLl9wYXJzZUZpbGVMaXN0KCk7XG5cbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgdGhpcy5fcGFyc2VTY3JlZW5zaG90c1BhdGgoKSxcbiAgICAgICAgICAgIHRoaXMuX3BhcnNlUmVwb3J0ZXJzKClcbiAgICAgICAgXSk7XG4gICAgfVxufVxuIl19
