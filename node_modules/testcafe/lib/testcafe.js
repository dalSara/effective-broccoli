'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _sourceMapSupport = require('source-map-support');

var _sourceMapSupport2 = _interopRequireDefault(_sourceMapSupport);

var _readFileRelative = require('read-file-relative');

var _testcafeHammerhead = require('testcafe-hammerhead');

var _testcafeLegacyApi = require('testcafe-legacy-api');

var _gateway = require('./browser/connection/gateway');

var _gateway2 = _interopRequireDefault(_gateway);

var _connection = require('./browser/connection');

var _connection2 = _interopRequireDefault(_connection);

var _pool = require('./browser/provider/pool');

var _pool2 = _interopRequireDefault(_pool);

var _runner = require('./runner');

var _runner2 = _interopRequireDefault(_runner);

var _handleErrors = require('./utils/handle-errors');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Const
const UI_STYLE = (0, _readFileRelative.readSync)('./client/ui/styles.css');
const UI_SPRITE = (0, _readFileRelative.readSync)('./client/ui/sprite.png', true);
const FAVICON = (0, _readFileRelative.readSync)('./client/ui/favicon.ico', true);

class TestCafe {
    constructor(hostname, port1, port2, sslOptions, developmentMode) {
        this._setupSourceMapsSupport();

        (0, _handleErrors.registerErrorHandlers)();

        this.closed = false;
        this.proxy = new _testcafeHammerhead.Proxy(hostname, port1, port2, sslOptions, developmentMode);
        this.browserConnectionGateway = new _gateway2.default(this.proxy);
        this.runners = [];

        this._registerAssets(developmentMode);
    }

    _registerAssets(developmentMode) {
        const scriptNameSuffix = developmentMode ? 'js' : 'min.js';
        const coreScript = (0, _readFileRelative.readSync)(`./client/core/index.${scriptNameSuffix}`);
        const driverScript = (0, _readFileRelative.readSync)(`./client/driver/index.${scriptNameSuffix}`);
        const uiScript = (0, _readFileRelative.readSync)(`./client/ui/index.${scriptNameSuffix}`);
        const automationScript = (0, _readFileRelative.readSync)(`./client/automation/index.${scriptNameSuffix}`);

        this.proxy.GET('/testcafe-core.js', { content: coreScript, contentType: 'application/x-javascript' });
        this.proxy.GET('/testcafe-driver.js', { content: driverScript, contentType: 'application/x-javascript' });
        this.proxy.GET('/testcafe-legacy-runner.js', {
            content: _testcafeLegacyApi.CLIENT_RUNNER_SCRIPT,
            contentType: 'application/x-javascript'
        });
        this.proxy.GET('/testcafe-automation.js', { content: automationScript, contentType: 'application/x-javascript' });
        this.proxy.GET('/testcafe-ui.js', { content: uiScript, contentType: 'application/x-javascript' });
        this.proxy.GET('/testcafe-ui-sprite.png', { content: UI_SPRITE, contentType: 'image/png' });
        this.proxy.GET('/favicon.ico', { content: FAVICON, contentType: 'image/x-icon' });

        this.proxy.GET('/testcafe-ui-styles.css', {
            content: UI_STYLE,
            contentType: 'text/css',
            isShadowUIStylesheet: true
        });
    }

    _setupSourceMapsSupport() {
        _sourceMapSupport2.default.install({
            hookRequire: true,
            handleUncaughtExceptions: false,
            environment: 'node'
        });
    }

    // API
    createBrowserConnection() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var browserInfo = yield _pool2.default.getBrowserInfo('remote');

            return new _connection2.default(_this.browserConnectionGateway, browserInfo, true);
        })();
    }

    createRunner() {
        var newRunner = new _runner2.default(this.proxy, this.browserConnectionGateway);

        this.runners.push(newRunner);

        return newRunner;
    }

    close() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this2.closed) return;

            _this2.closed = true;

            yield _pinkie2.default.all(_this2.runners.map(function (runner) {
                return runner.stop();
            }));

            yield _pool2.default.dispose();

            _this2.browserConnectionGateway.close();
            _this2.proxy.close();
        })();
    }
}
exports.default = TestCafe;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90ZXN0Y2FmZS5qcyJdLCJuYW1lcyI6WyJVSV9TVFlMRSIsIlVJX1NQUklURSIsIkZBVklDT04iLCJUZXN0Q2FmZSIsImNvbnN0cnVjdG9yIiwiaG9zdG5hbWUiLCJwb3J0MSIsInBvcnQyIiwic3NsT3B0aW9ucyIsImRldmVsb3BtZW50TW9kZSIsIl9zZXR1cFNvdXJjZU1hcHNTdXBwb3J0IiwiY2xvc2VkIiwicHJveHkiLCJQcm94eSIsImJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSIsIkJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSIsInJ1bm5lcnMiLCJfcmVnaXN0ZXJBc3NldHMiLCJzY3JpcHROYW1lU3VmZml4IiwiY29yZVNjcmlwdCIsImRyaXZlclNjcmlwdCIsInVpU2NyaXB0IiwiYXV0b21hdGlvblNjcmlwdCIsIkdFVCIsImNvbnRlbnQiLCJjb250ZW50VHlwZSIsIkxFR0FDWV9SVU5ORVJfU0NSSVBUIiwiaXNTaGFkb3dVSVN0eWxlc2hlZXQiLCJzb3VyY2VNYXBTdXBwb3J0IiwiaW5zdGFsbCIsImhvb2tSZXF1aXJlIiwiaGFuZGxlVW5jYXVnaHRFeGNlcHRpb25zIiwiZW52aXJvbm1lbnQiLCJjcmVhdGVCcm93c2VyQ29ubmVjdGlvbiIsImJyb3dzZXJJbmZvIiwiYnJvd3NlclByb3ZpZGVyUG9vbCIsImdldEJyb3dzZXJJbmZvIiwiQnJvd3NlckNvbm5lY3Rpb24iLCJjcmVhdGVSdW5uZXIiLCJuZXdSdW5uZXIiLCJSdW5uZXIiLCJwdXNoIiwiY2xvc2UiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwicnVubmVyIiwic3RvcCIsImRpc3Bvc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTtBQUNBLE1BQU1BLFdBQVksZ0NBQUssd0JBQUwsQ0FBbEI7QUFDQSxNQUFNQyxZQUFZLGdDQUFLLHdCQUFM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S0Usd0JBQTVCLENBQWhCOztBQUVBLGFBQUtFLE9BQUwsQ0FBYXlCLElBQWIsQ0FBa0JGLFNBQWxCOztBQUVBLGVBQU9BLFNBQVA7QUFDSDs7QUFFS0csU0FBTixHQUFlO0FBQUE7O0FBQUE7QUFDWCxnQkFBSSxPQUFLL0IsTUFBVCxFQUNJOztBQUVKLG1CQUFLQSxNQUFMLEdBQWMsSUFBZDs7QUFFQSxrQkFBTWdDLGlCQUFRQyxHQUFSLENBQVksT0FBSzVCLE9BQUwsQ0FBYTZCLEdBQWIsQ0FBaUI7QUFBQSx1QkFBVUMsT0FBT0MsSUFBUCxFQUFWO0FBQUEsYUFBakIsQ0FBWixDQUFOOztBQUVBLGtCQUFNWixlQUFvQmEsT0FBcEIsRUFBTjs7QUFFQSxtQkFBS2xDLHdCQUFMLENBQThCNEIsS0FBOUI7QUFDQSxtQkFBSzlCLEtBQUwsQ0FBVzhCLEtBQVg7QUFYVztBQVlkO0FBMUV5QjtrQkFBVHZDLFEiLCJmaWxlIjoidGVzdGNhZmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHNvdXJjZU1hcFN1cHBvcnQgZnJvbSAnc291cmNlLW1hcC1zdXBwb3J0JztcbmltcG9ydCB7IHJlYWRTeW5jIGFzIHJlYWQgfSBmcm9tICdyZWFkLWZpbGUtcmVsYXRpdmUnO1xuaW1wb3J0IHsgUHJveHkgfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCB7IENMSUVOVF9SVU5ORVJfU0NSSVBUIGFzIExFR0FDWV9SVU5ORVJfU0NSSVBUIH0gZnJvbSAndGVzdGNhZmUtbGVnYWN5LWFwaSc7XG5pbXBvcnQgQnJvd3NlckNvbm5lY3Rpb25HYXRld2F5IGZyb20gJy4vYnJvd3Nlci9jb25uZWN0aW9uL2dhdGV3YXknO1xuaW1wb3J0IEJyb3dzZXJDb25uZWN0aW9uIGZyb20gJy4vYnJvd3Nlci9jb25uZWN0aW9uJztcbmltcG9ydCBicm93c2VyUHJvdmlkZXJQb29sIGZyb20gJy4vYnJvd3Nlci9wcm92aWRlci9wb29sJztcbmltcG9ydCBSdW5uZXIgZnJvbSAnLi9ydW5uZXInO1xuaW1wb3J0IHsgcmVnaXN0ZXJFcnJvckhhbmRsZXJzIH0gZnJvbSAnLi91dGlscy9oYW5kbGUtZXJyb3JzJztcblxuLy8gQ29uc3RcbmNvbnN0IFVJX1NUWUxFICA9IHJlYWQoJy4vY2xpZW50L3VpL3N0eWxlcy5jc3MnKTtcbmNvbnN0IFVJX1NQUklURSA9IHJlYWQoJy4vY2xpZW50L3VpL3Nwcml0ZS5wbmcnLCB0cnVlKTtcbmNvbnN0IEZBVklDT04gICA9IHJlYWQoJy4vY2xpZW50L3VpL2Zhdmljb24uaWNvJywgdHJ1ZSk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlc3RDYWZlIHtcbiAgICBjb25zdHJ1Y3RvciAoaG9zdG5hbWUsIHBvcnQxLCBwb3J0Miwgc3NsT3B0aW9ucywgZGV2ZWxvcG1lbnRNb2RlKSB7XG4gICAgICAgIHRoaXMuX3NldHVwU291cmNlTWFwc1N1cHBvcnQoKTtcblxuICAgICAgICByZWdpc3RlckVycm9ySGFuZGxlcnMoKTtcblxuICAgICAgICB0aGlzLmNsb3NlZCAgICAgICAgICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLnByb3h5ICAgICAgICAgICAgICAgICAgICA9IG5ldyBQcm94eShob3N0bmFtZSwgcG9ydDEsIHBvcnQyLCBzc2xPcHRpb25zLCBkZXZlbG9wbWVudE1vZGUpO1xuICAgICAgICB0aGlzLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSA9IG5ldyBCcm93c2VyQ29ubmVjdGlvbkdhdGV3YXkodGhpcy5wcm94eSk7XG4gICAgICAgIHRoaXMucnVubmVycyAgICAgICAgICAgICAgICAgID0gW107XG5cbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJBc3NldHMoZGV2ZWxvcG1lbnRNb2RlKTtcbiAgICB9XG5cbiAgICBfcmVnaXN0ZXJBc3NldHMgKGRldmVsb3BtZW50TW9kZSkge1xuICAgICAgICBjb25zdCBzY3JpcHROYW1lU3VmZml4ID0gZGV2ZWxvcG1lbnRNb2RlID8gJ2pzJyA6ICdtaW4uanMnO1xuICAgICAgICBjb25zdCBjb3JlU2NyaXB0ICAgICAgID0gcmVhZChgLi9jbGllbnQvY29yZS9pbmRleC4ke3NjcmlwdE5hbWVTdWZmaXh9YCk7XG4gICAgICAgIGNvbnN0IGRyaXZlclNjcmlwdCAgICAgPSByZWFkKGAuL2NsaWVudC9kcml2ZXIvaW5kZXguJHtzY3JpcHROYW1lU3VmZml4fWApO1xuICAgICAgICBjb25zdCB1aVNjcmlwdCAgICAgICAgID0gcmVhZChgLi9jbGllbnQvdWkvaW5kZXguJHtzY3JpcHROYW1lU3VmZml4fWApO1xuICAgICAgICBjb25zdCBhdXRvbWF0aW9uU2NyaXB0ID0gcmVhZChgLi9jbGllbnQvYXV0b21hdGlvbi9pbmRleC4ke3NjcmlwdE5hbWVTdWZmaXh9YCk7XG5cbiAgICAgICAgdGhpcy5wcm94eS5HRVQoJy90ZXN0Y2FmZS1jb3JlLmpzJywgeyBjb250ZW50OiBjb3JlU2NyaXB0LCBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL3gtamF2YXNjcmlwdCcgfSk7XG4gICAgICAgIHRoaXMucHJveHkuR0VUKCcvdGVzdGNhZmUtZHJpdmVyLmpzJywgeyBjb250ZW50OiBkcml2ZXJTY3JpcHQsIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24veC1qYXZhc2NyaXB0JyB9KTtcbiAgICAgICAgdGhpcy5wcm94eS5HRVQoJy90ZXN0Y2FmZS1sZWdhY3ktcnVubmVyLmpzJywge1xuICAgICAgICAgICAgY29udGVudDogICAgIExFR0FDWV9SVU5ORVJfU0NSSVBULFxuICAgICAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi94LWphdmFzY3JpcHQnXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnByb3h5LkdFVCgnL3Rlc3RjYWZlLWF1dG9tYXRpb24uanMnLCB7IGNvbnRlbnQ6IGF1dG9tYXRpb25TY3JpcHQsIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24veC1qYXZhc2NyaXB0JyB9KTtcbiAgICAgICAgdGhpcy5wcm94eS5HRVQoJy90ZXN0Y2FmZS11aS5qcycsIHsgY29udGVudDogdWlTY3JpcHQsIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24veC1qYXZhc2NyaXB0JyB9KTtcbiAgICAgICAgdGhpcy5wcm94eS5HRVQoJy90ZXN0Y2FmZS11aS1zcHJpdGUucG5nJywgeyBjb250ZW50OiBVSV9TUFJJVEUsIGNvbnRlbnRUeXBlOiAnaW1hZ2UvcG5nJyB9KTtcbiAgICAgICAgdGhpcy5wcm94eS5HRVQoJy9mYXZpY29uLmljbycsIHsgY29udGVudDogRkFWSUNPTiwgY29udGVudFR5cGU6ICdpbWFnZS94LWljb24nIH0pO1xuXG4gICAgICAgIHRoaXMucHJveHkuR0VUKCcvdGVzdGNhZmUtdWktc3R5bGVzLmNzcycsIHtcbiAgICAgICAgICAgIGNvbnRlbnQ6ICAgICAgICAgICAgICBVSV9TVFlMRSxcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAgICAgICAgICAndGV4dC9jc3MnLFxuICAgICAgICAgICAgaXNTaGFkb3dVSVN0eWxlc2hlZXQ6IHRydWVcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3NldHVwU291cmNlTWFwc1N1cHBvcnQgKCkge1xuICAgICAgICBzb3VyY2VNYXBTdXBwb3J0Lmluc3RhbGwoe1xuICAgICAgICAgICAgaG9va1JlcXVpcmU6ICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgaGFuZGxlVW5jYXVnaHRFeGNlcHRpb25zOiBmYWxzZSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiAgICAgICAgICAgICAgJ25vZGUnXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEFQSVxuICAgIGFzeW5jIGNyZWF0ZUJyb3dzZXJDb25uZWN0aW9uICgpIHtcbiAgICAgICAgdmFyIGJyb3dzZXJJbmZvID0gYXdhaXQgYnJvd3NlclByb3ZpZGVyUG9vbC5nZXRCcm93c2VySW5mbygncmVtb3RlJyk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBCcm93c2VyQ29ubmVjdGlvbih0aGlzLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSwgYnJvd3NlckluZm8sIHRydWUpO1xuICAgIH1cblxuICAgIGNyZWF0ZVJ1bm5lciAoKSB7XG4gICAgICAgIHZhciBuZXdSdW5uZXIgPSBuZXcgUnVubmVyKHRoaXMucHJveHksIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KTtcblxuICAgICAgICB0aGlzLnJ1bm5lcnMucHVzaChuZXdSdW5uZXIpO1xuXG4gICAgICAgIHJldHVybiBuZXdSdW5uZXI7XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvc2UgKCkge1xuICAgICAgICBpZiAodGhpcy5jbG9zZWQpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5jbG9zZWQgPSB0cnVlO1xuXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucnVubmVycy5tYXAocnVubmVyID0+IHJ1bm5lci5zdG9wKCkpKTtcblxuICAgICAgICBhd2FpdCBicm93c2VyUHJvdmlkZXJQb29sLmRpc3Bvc2UoKTtcblxuICAgICAgICB0aGlzLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5jbG9zZSgpO1xuICAgICAgICB0aGlzLnByb3h5LmNsb3NlKCk7XG4gICAgfVxufVxuIl19
