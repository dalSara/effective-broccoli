'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _testcafeLegacyApi = require('testcafe-legacy-api');

var _testRun = require('../test-run');

var _testRun2 = _interopRequireDefault(_testRun);

var _sessionController = require('../test-run/session-controller');

var _sessionController2 = _interopRequireDefault(_sessionController);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Const
const QUARANTINE_THRESHOLD = 3;

class Quarantine {
    constructor() {
        this.attempts = [];
    }

    getFailedAttempts() {
        return this.attempts.filter(errors => !!errors.length);
    }

    getPassedAttempts() {
        return this.attempts.filter(errors => errors.length === 0);
    }

    getNextAttemptNumber() {
        return this.attempts.length + 1;
    }
}

class TestRunController extends _events2.default {
    constructor(test, index, proxy, screenshots, warningLog, fixtureHookController, opts) {
        super();

        this.test = test;
        this.index = index;
        this.opts = opts;

        this.proxy = proxy;
        this.screenshots = screenshots;
        this.warningLog = warningLog;
        this.fixtureHookController = fixtureHookController;

        this.TestRunCtor = TestRunController._getTestRunCtor(test, opts);

        this.testRun = null;
        this.done = false;
        this.quarantine = null;

        if (this.opts.quarantineMode) this.quarantine = new Quarantine();
    }

    static _getTestRunCtor(test, opts) {
        if (opts.TestRunCtor) return opts.TestRunCtor;

        return test.isLegacy ? _testcafeLegacyApi.TestRun : _testRun2.default;
    }

    _createTestRun(connection) {
        var screenshotCapturer = this.screenshots.createCapturerFor(this.test, this.index, this.quarantine, connection, this.warningLog);
        var TestRunCtor = this.TestRunCtor;

        this.testRun = new TestRunCtor(this.test, connection, screenshotCapturer, this.warningLog, this.opts);

        if (this.testRun.addQuarantineInfo) this.testRun.addQuarantineInfo(this.quarantine);

        return this.testRun;
    }

    _endQuarantine() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this.quarantine.attempts.length > 1) _this.testRun.unstable = _this.quarantine.getPassedAttempts().length > 0;

            yield _this._emitTestRunDone();
        })();
    }

    _shouldKeepInQuarantine() {
        const errors = this.testRun.errs;
        const attempts = this.quarantine.attempts;

        attempts.push(errors);

        const failedTimes = this.quarantine.getFailedAttempts().length;
        const passedTimes = this.quarantine.getPassedAttempts().length;
        const hasErrors = !!errors.length;
        const isFirstAttempt = attempts.length === 1;
        const failedThresholdReached = failedTimes >= QUARANTINE_THRESHOLD;
        const passedThresholdReached = passedTimes >= QUARANTINE_THRESHOLD;

        return isFirstAttempt ? hasErrors : !failedThresholdReached && !passedThresholdReached;
    }

    _keepInQuarantine() {
        this.emit('test-run-restart');
    }

    _testRunDoneInQuarantineMode() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this2._shouldKeepInQuarantine()) _this2._keepInQuarantine();else yield _this2._endQuarantine();
        })();
    }

    _testRunDone() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this3.quarantine) yield _this3._testRunDoneInQuarantineMode();else yield _this3._emitTestRunDone();
        })();
    }

    _emitTestRunDone() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            // NOTE: we should report test run completion in order they were completed in browser.
            // To keep a sequence after fixture hook execution we use completion queue.
            yield _this4.fixtureHookController.runFixtureAfterHookIfNecessary(_this4.testRun);

            _this4.done = true;

            _this4.emit('test-run-done');
        })();
    }

    get blocked() {
        return this.fixtureHookController.isTestBlocked(this.test);
    }

    start(connection) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var testRun = _this5._createTestRun(connection);

            var hookOk = yield _this5.fixtureHookController.runFixtureBeforeHookIfNecessary(testRun);

            if (_this5.test.skip || !hookOk) {
                _this5.emit('test-run-start');
                yield _this5._emitTestRunDone();
                return null;
            }

            testRun.once('start', function () {
                return _this5.emit('test-run-start');
            });
            testRun.once('done', function () {
                return _this5._testRunDone();
            });

            testRun.start();

            return _sessionController2.default.getSessionUrl(testRun, _this5.proxy);
        })();
    }
}
exports.default = TestRunController;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvdGVzdC1ydW4tY29udHJvbGxlci5qcyJdLCJuYW1lcyI6WyJRVUFSQU5USU5FX1RIUkVTSE9MRCIsIlF1YXJhbnRpbmUiLCJjb25zdHJ1Y3RvciIsImF0dGVtcHRzIiwiZ2V0RmFpbGVkQXR0ZW1wdHMiLCJmaWx0ZXIiLCJlcnJvcnMiLCJsZW5ndGgiLCJnZXRQYXNzZWRBdHRlbXB0cyIsImdldE5leHRBdHRlbXB0TnVtYmVyIiwiVGVzdFJ1bkNvbnRyb2xsZXIiLCJFdmVudEVtaXR0ZXIiLCJ0ZXN0IiwiaW5kZXgiLCJwcm94eSIsInNjcmVlbnNob3RzIiwid2FybmluZ0xvZyIsImZpeHR1cmVIb29rQ29udHJvbGxlciIsIm9wdHMiLCJUZXN0UnVuQ3RvciIsIl9nZXRUZXN0UnVuQ3RvciIsInRlc3RSdW4iLCJkb25lIiwicXVhcmFudGluZSIsInF1YXJhbnRpbmVNb2RlIiwiaXNMZWdhY3kiLCJMZWdhY3lUZXN0UnVuIiwiVGVzdFJ1biIsIl9jcmVhdGVUZXN0UnVuIiwiY29ubmVjdGlvbiIsInNjcmVlbnNob3RDYXB0dXJlciIsImNyZWF0ZUNhcHR1cmVyRm9yIiwiYWRkUXVhcmFudGluZUluZm8iLCJfZW5kUXVhcmFudGluZSIsInVuc3RhYmxlIiwiX2VtaXRUZXN0UnVuRG9uZSIsIl9zaG91bGRLZWVwSW5RdWFyYW50aW5lIiwiZXJycyIsInB1c2giLCJmYWlsZWRUaW1lcyIsInBhc3NlZFRpbWVzIiwiaGFzRXJyb3JzIiwiaXNGaXJzdEF0dGVtcHQiLCJmYWlsZWRUaHJlc2hvbGRSZWFjaGVkIiwicGFzc2VkVGhyZXNob2xkUmVhY2hlZCIsIl9rZWVwSW5RdWFyYW50aW5lIiwiZW1pdCIsIl90ZXN0UnVuRG9uZUluUXVhcmFudGluZU1vZGUiLCJfdGVzdFJ1bkRvbmUiLCJydW5GaXh0dXJlQWZ0ZXJIb29rSWZOZWNlc3NhcnkiLCJibG9ja2VkIiwiaXNUZXN0QmxvY2tlZCIsInN0YXJ0IiwiaG9va09rIiwicnVuRml4dHVyZUJlZm9yZUhvb2tJZk5lY2Vzc2FyeSIsInNraXAiLCJvbmNlIiwiU2Vzc2lvbkNvbnRyb2xsZXIiLCJnZXRTZXNzaW9uVXJsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBR0E7QUFDQSxNQUFNQSx1QkFBdUIsQ0FBN0I7O0FBRUEsTUFBTUMsVUFBTixDQUFpQjtBQUNiQyxrQkFBZTtBQUNYLGFBQUtDLFFBQUwsR0FBZ0IsRUFBaEI7QUFDSDs7QUFFREMsd0JBQXFCO0FBQ2pCLGVBQU8sS0FBS0QsUUFBTCxDQUFjRSxNQUFkLENBQXFCQyxVQUFVLENBQUMsQ0FBQ0EsT0FBT0MsTUFBeEMsQ0FBUDtBQUNIOztBQUVEQyx3QkFBcUI7QUFDakIsZUFBTyxLQUFLTCxRQUFMLENBQWNFLE1BQWQsQ0FBcUJDLFVBQVVBLE9BQU9DLE1BQVAsS0FBa0IsQ0FBakQsQ0FBUDtBQUNIOztBQUVERSwyQkFBd0I7QUFDcEIsZUFBTyxLQUFLTixRQUFMLENBQWNJLE1BQWQsR0FBdUIsQ0FBOUI7QUFDSDtBQWZZOztBQWtCRixNQUFNRyxpQkFBTixTQUFnQ0MsZ0JBQWhDLENBQTZDO0FBQ3hEVCxnQkFBYVUsSUFBYixFQUFtQkMsS0FBbkIsRUFBMEJDLEtBQTFCLEVBQWlDQyxXQUFqQyxFQUE4Q0MsVUFBOUMsRUFBMERDLHFCQUExRCxFQUFpRkMsSUFBakYsRUFBdUY7QUFDbkY7O0FBRUEsYUFBS04sSUFBTCxHQUFhQSxJQUFiO0FBQ0EsYUFBS0MsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsYUFBS0ssSUFBTCxHQUFhQSxJQUFiOztBQUVBLGFBQUtKLEtBQUwsR0FBNkJBLEtBQTdCO0FBQ0EsYUFBS0MsV0FBTCxHQUE2QkEsV0FBN0I7QUFDQSxhQUFLQyxVQUFMLEdBQTZCQSxVQUE3QjtBQUNBLGFBQUtDLHFCQUFMLEdBQTZCQSxxQkFBN0I7O0FBRUEsYUFBS0UsV0FBTCxHQUFtQlQsa0JBQWtCVSxlQUFsQixDQUFrQ1IsSUFBbEMsRUFBd0NNLElBQXhDLENBQW5C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T0FBSzVCLE9BQS9ELENBQU47O0FBRUEsbUJBQUtDLElBQUwsR0FBWSxJQUFaOztBQUVBLG1CQUFLd0IsSUFBTCxDQUFVLGVBQVY7QUFQc0I7QUFRekI7O0FBRUQsUUFBSUksT0FBSixHQUFlO0FBQ1gsZUFBTyxLQUFLakMscUJBQUwsQ0FBMkJrQyxhQUEzQixDQUF5QyxLQUFLdkMsSUFBOUMsQ0FBUDtBQUNIOztBQUVLd0MsU0FBTixDQUFhdkIsVUFBYixFQUF5QjtBQUFBOztBQUFBO0FBQ3JCLGdCQUFJUixVQUFVLE9BQUtPLGNBQUwsQ0FBb0JDLFVBQXBCLENBQWQ7O0FBRUEsZ0JBQUl3QixTQUFTLE1BQU0sT0FBS3BDLHFCQUFMLENBQTJCcUMsK0JBQTNCLENBQTJEakMsT0FBM0QsQ0FBbkI7O0FBRUEsZ0JBQUksT0FBS1QsSUFBTCxDQUFVMkMsSUFBVixJQUFrQixDQUFDRixNQUF2QixFQUErQjtBQUMzQix1QkFBS1AsSUFBTCxDQUFVLGdCQUFWO0FBQ0Esc0JBQU0sT0FBS1gsZ0JBQUwsRUFBTjtBQUNBLHVCQUFPLElBQVA7QUFDSDs7QUFFRGQsb0JBQVFtQyxJQUFSLENBQWEsT0FBYixFQUFzQjtBQUFBLHVCQUFNLE9BQUtWLElBQUwsQ0FBVSxnQkFBVixDQUFOO0FBQUEsYUFBdEI7QUFDQXpCLG9CQUFRbUMsSUFBUixDQUFhLE1BQWIsRUFBcUI7QUFBQSx1QkFBTSxPQUFLUixZQUFMLEVBQU47QUFBQSxhQUFyQjs7QUFFQTNCLG9CQUFRK0IsS0FBUjs7QUFFQSxtQkFBT0ssNEJBQWtCQyxhQUFsQixDQUFnQ3JDLE9BQWhDLEVBQXlDLE9BQUtQLEtBQTlDLENBQVA7QUFoQnFCO0FBaUJ4QjtBQWxIdUQ7a0JBQXZDSixpQiIsImZpbGUiOiJydW5uZXIvdGVzdC1ydW4tY29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IFRlc3RSdW4gYXMgTGVnYWN5VGVzdFJ1biB9IGZyb20gJ3Rlc3RjYWZlLWxlZ2FjeS1hcGknO1xuaW1wb3J0IFRlc3RSdW4gZnJvbSAnLi4vdGVzdC1ydW4nO1xuaW1wb3J0IFNlc3Npb25Db250cm9sbGVyIGZyb20gJy4uL3Rlc3QtcnVuL3Nlc3Npb24tY29udHJvbGxlcic7XG5cblxuLy8gQ29uc3RcbmNvbnN0IFFVQVJBTlRJTkVfVEhSRVNIT0xEID0gMztcblxuY2xhc3MgUXVhcmFudGluZSB7XG4gICAgY29uc3RydWN0b3IgKCkge1xuICAgICAgICB0aGlzLmF0dGVtcHRzID0gW107XG4gICAgfVxuXG4gICAgZ2V0RmFpbGVkQXR0ZW1wdHMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5hdHRlbXB0cy5maWx0ZXIoZXJyb3JzID0+ICEhZXJyb3JzLmxlbmd0aCk7XG4gICAgfVxuXG4gICAgZ2V0UGFzc2VkQXR0ZW1wdHMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5hdHRlbXB0cy5maWx0ZXIoZXJyb3JzID0+IGVycm9ycy5sZW5ndGggPT09IDApO1xuICAgIH1cblxuICAgIGdldE5leHRBdHRlbXB0TnVtYmVyICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0ZW1wdHMubGVuZ3RoICsgMTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlc3RSdW5Db250cm9sbGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAodGVzdCwgaW5kZXgsIHByb3h5LCBzY3JlZW5zaG90cywgd2FybmluZ0xvZywgZml4dHVyZUhvb2tDb250cm9sbGVyLCBvcHRzKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy50ZXN0ICA9IHRlc3Q7XG4gICAgICAgIHRoaXMuaW5kZXggPSBpbmRleDtcbiAgICAgICAgdGhpcy5vcHRzICA9IG9wdHM7XG5cbiAgICAgICAgdGhpcy5wcm94eSAgICAgICAgICAgICAgICAgPSBwcm94eTtcbiAgICAgICAgdGhpcy5zY3JlZW5zaG90cyAgICAgICAgICAgPSBzY3JlZW5zaG90cztcbiAgICAgICAgdGhpcy53YXJuaW5nTG9nICAgICAgICAgICAgPSB3YXJuaW5nTG9nO1xuICAgICAgICB0aGlzLmZpeHR1cmVIb29rQ29udHJvbGxlciA9IGZpeHR1cmVIb29rQ29udHJvbGxlcjtcblxuICAgICAgICB0aGlzLlRlc3RSdW5DdG9yID0gVGVzdFJ1bkNvbnRyb2xsZXIuX2dldFRlc3RSdW5DdG9yKHRlc3QsIG9wdHMpO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1biAgICA9IG51bGw7XG4gICAgICAgIHRoaXMuZG9uZSAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLnF1YXJhbnRpbmUgPSBudWxsO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdHMucXVhcmFudGluZU1vZGUpXG4gICAgICAgICAgICB0aGlzLnF1YXJhbnRpbmUgPSBuZXcgUXVhcmFudGluZSgpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZ2V0VGVzdFJ1bkN0b3IgKHRlc3QsIG9wdHMpIHtcbiAgICAgICAgaWYgKG9wdHMuVGVzdFJ1bkN0b3IpXG4gICAgICAgICAgICByZXR1cm4gb3B0cy5UZXN0UnVuQ3RvcjtcblxuICAgICAgICByZXR1cm4gdGVzdC5pc0xlZ2FjeSA/IExlZ2FjeVRlc3RSdW4gOiBUZXN0UnVuO1xuICAgIH1cblxuICAgIF9jcmVhdGVUZXN0UnVuIChjb25uZWN0aW9uKSB7XG4gICAgICAgIHZhciBzY3JlZW5zaG90Q2FwdHVyZXIgPSB0aGlzLnNjcmVlbnNob3RzLmNyZWF0ZUNhcHR1cmVyRm9yKHRoaXMudGVzdCwgdGhpcy5pbmRleCwgdGhpcy5xdWFyYW50aW5lLCBjb25uZWN0aW9uLCB0aGlzLndhcm5pbmdMb2cpO1xuICAgICAgICB2YXIgVGVzdFJ1bkN0b3IgICAgICAgID0gdGhpcy5UZXN0UnVuQ3RvcjtcblxuICAgICAgICB0aGlzLnRlc3RSdW4gPSBuZXcgVGVzdFJ1bkN0b3IodGhpcy50ZXN0LCBjb25uZWN0aW9uLCBzY3JlZW5zaG90Q2FwdHVyZXIsIHRoaXMud2FybmluZ0xvZywgdGhpcy5vcHRzKTtcblxuICAgICAgICBpZiAodGhpcy50ZXN0UnVuLmFkZFF1YXJhbnRpbmVJbmZvKVxuICAgICAgICAgICAgdGhpcy50ZXN0UnVuLmFkZFF1YXJhbnRpbmVJbmZvKHRoaXMucXVhcmFudGluZSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFJ1bjtcbiAgICB9XG5cbiAgICBhc3luYyBfZW5kUXVhcmFudGluZSAoKSB7XG4gICAgICAgIGlmICh0aGlzLnF1YXJhbnRpbmUuYXR0ZW1wdHMubGVuZ3RoID4gMSlcbiAgICAgICAgICAgIHRoaXMudGVzdFJ1bi51bnN0YWJsZSA9IHRoaXMucXVhcmFudGluZS5nZXRQYXNzZWRBdHRlbXB0cygpLmxlbmd0aCA+IDA7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fZW1pdFRlc3RSdW5Eb25lKCk7XG4gICAgfVxuXG4gICAgX3Nob3VsZEtlZXBJblF1YXJhbnRpbmUgKCkge1xuICAgICAgICBjb25zdCBlcnJvcnMgICA9IHRoaXMudGVzdFJ1bi5lcnJzO1xuICAgICAgICBjb25zdCBhdHRlbXB0cyA9IHRoaXMucXVhcmFudGluZS5hdHRlbXB0cztcblxuICAgICAgICBhdHRlbXB0cy5wdXNoKGVycm9ycyk7XG5cbiAgICAgICAgY29uc3QgZmFpbGVkVGltZXMgICAgICAgICAgICA9IHRoaXMucXVhcmFudGluZS5nZXRGYWlsZWRBdHRlbXB0cygpLmxlbmd0aDtcbiAgICAgICAgY29uc3QgcGFzc2VkVGltZXMgICAgICAgICAgICA9IHRoaXMucXVhcmFudGluZS5nZXRQYXNzZWRBdHRlbXB0cygpLmxlbmd0aDtcbiAgICAgICAgY29uc3QgaGFzRXJyb3JzICAgICAgICAgICAgICA9ICEhZXJyb3JzLmxlbmd0aDtcbiAgICAgICAgY29uc3QgaXNGaXJzdEF0dGVtcHQgICAgICAgICA9IGF0dGVtcHRzLmxlbmd0aCA9PT0gMTtcbiAgICAgICAgY29uc3QgZmFpbGVkVGhyZXNob2xkUmVhY2hlZCA9IGZhaWxlZFRpbWVzID49IFFVQVJBTlRJTkVfVEhSRVNIT0xEO1xuICAgICAgICBjb25zdCBwYXNzZWRUaHJlc2hvbGRSZWFjaGVkID0gcGFzc2VkVGltZXMgPj0gUVVBUkFOVElORV9USFJFU0hPTEQ7XG5cbiAgICAgICAgcmV0dXJuIGlzRmlyc3RBdHRlbXB0ID8gaGFzRXJyb3JzIDogIWZhaWxlZFRocmVzaG9sZFJlYWNoZWQgJiYgIXBhc3NlZFRocmVzaG9sZFJlYWNoZWQ7XG4gICAgfVxuXG4gICAgX2tlZXBJblF1YXJhbnRpbmUgKCkge1xuICAgICAgICB0aGlzLmVtaXQoJ3Rlc3QtcnVuLXJlc3RhcnQnKTtcbiAgICB9XG5cbiAgICBhc3luYyBfdGVzdFJ1bkRvbmVJblF1YXJhbnRpbmVNb2RlICgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3Nob3VsZEtlZXBJblF1YXJhbnRpbmUoKSlcbiAgICAgICAgICAgIHRoaXMuX2tlZXBJblF1YXJhbnRpbmUoKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fZW5kUXVhcmFudGluZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIF90ZXN0UnVuRG9uZSAoKSB7XG4gICAgICAgIGlmICh0aGlzLnF1YXJhbnRpbmUpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl90ZXN0UnVuRG9uZUluUXVhcmFudGluZU1vZGUoKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fZW1pdFRlc3RSdW5Eb25lKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2VtaXRUZXN0UnVuRG9uZSAoKSB7XG4gICAgICAgIC8vIE5PVEU6IHdlIHNob3VsZCByZXBvcnQgdGVzdCBydW4gY29tcGxldGlvbiBpbiBvcmRlciB0aGV5IHdlcmUgY29tcGxldGVkIGluIGJyb3dzZXIuXG4gICAgICAgIC8vIFRvIGtlZXAgYSBzZXF1ZW5jZSBhZnRlciBmaXh0dXJlIGhvb2sgZXhlY3V0aW9uIHdlIHVzZSBjb21wbGV0aW9uIHF1ZXVlLlxuICAgICAgICBhd2FpdCB0aGlzLmZpeHR1cmVIb29rQ29udHJvbGxlci5ydW5GaXh0dXJlQWZ0ZXJIb29rSWZOZWNlc3NhcnkodGhpcy50ZXN0UnVuKTtcblxuICAgICAgICB0aGlzLmRvbmUgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuZW1pdCgndGVzdC1ydW4tZG9uZScpO1xuICAgIH1cblxuICAgIGdldCBibG9ja2VkICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZml4dHVyZUhvb2tDb250cm9sbGVyLmlzVGVzdEJsb2NrZWQodGhpcy50ZXN0KTtcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydCAoY29ubmVjdGlvbikge1xuICAgICAgICB2YXIgdGVzdFJ1biA9IHRoaXMuX2NyZWF0ZVRlc3RSdW4oY29ubmVjdGlvbik7XG5cbiAgICAgICAgdmFyIGhvb2tPayA9IGF3YWl0IHRoaXMuZml4dHVyZUhvb2tDb250cm9sbGVyLnJ1bkZpeHR1cmVCZWZvcmVIb29rSWZOZWNlc3NhcnkodGVzdFJ1bik7XG5cbiAgICAgICAgaWYgKHRoaXMudGVzdC5za2lwIHx8ICFob29rT2spIHtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgndGVzdC1ydW4tc3RhcnQnKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2VtaXRUZXN0UnVuRG9uZSgpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICB0ZXN0UnVuLm9uY2UoJ3N0YXJ0JywgKCkgPT4gdGhpcy5lbWl0KCd0ZXN0LXJ1bi1zdGFydCcpKTtcbiAgICAgICAgdGVzdFJ1bi5vbmNlKCdkb25lJywgKCkgPT4gdGhpcy5fdGVzdFJ1bkRvbmUoKSk7XG5cbiAgICAgICAgdGVzdFJ1bi5zdGFydCgpO1xuXG4gICAgICAgIHJldHVybiBTZXNzaW9uQ29udHJvbGxlci5nZXRTZXNzaW9uVXJsKHRlc3RSdW4sIHRoaXMucHJveHkpO1xuICAgIH1cbn1cbiJdfQ==
