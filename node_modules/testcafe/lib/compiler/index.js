'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _stripBom = require('strip-bom');

var _stripBom2 = _interopRequireDefault(_stripBom);

var _testcafeLegacyApi = require('testcafe-legacy-api');

var _testcafeHammerhead = require('testcafe-hammerhead');

var _testcafeHammerhead2 = _interopRequireDefault(_testcafeHammerhead);

var _compiler = require('./test-file/formats/es-next/compiler');

var _compiler2 = _interopRequireDefault(_compiler);

var _compiler3 = require('./test-file/formats/typescript/compiler');

var _compiler4 = _interopRequireDefault(_compiler3);

var _compiler5 = require('./test-file/formats/coffeescript/compiler');

var _compiler6 = _interopRequireDefault(_compiler5);

var _raw = require('./test-file/formats/raw');

var _raw2 = _interopRequireDefault(_raw);

var _promisifiedFunctions = require('../utils/promisified-functions');

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const SOURCE_CHUNK_LENGTH = 1000;

var testFileCompilers = [new _testcafeLegacyApi.Compiler(_testcafeHammerhead2.default.processScript), new _compiler2.default(), new _compiler4.default(), new _compiler6.default(), new _raw2.default()];

class Compiler {
    constructor(sources) {
        this.sources = sources;
    }

    static getSupportedTestFileExtensions() {
        return (0, _lodash.uniq)(testFileCompilers.map(c => c.getSupportedExtension()));
    }

    _compileTestFile(filename) {
        return (0, _asyncToGenerator3.default)(function* () {
            var code = null;

            try {
                code = yield (0, _promisifiedFunctions.readFile)(filename);
            } catch (err) {
                throw new _runtime.GeneralError(_message2.default.cantFindSpecifiedTestSource, filename);
            }

            code = (0, _stripBom2.default)(code).toString();

            var compiler = (0, _lodash.find)(testFileCompilers, function (c) {
                return c.canCompile(code, filename);
            });

            return compiler ? yield compiler.compile(code, filename) : null;
        })();
    }

    getTests() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var sourceChunks = (0, _lodash.chunk)(_this.sources, SOURCE_CHUNK_LENGTH);
            var tests = [];
            var compileUnits = [];

            // NOTE: split sources into chunks because the fs module can't read all files
            // simultaneously if the number of them is too large (several thousands).
            while (sourceChunks.length) {
                compileUnits = sourceChunks.shift().map(function (filename) {
                    return _this._compileTestFile(filename);
                });
                tests = tests.concat((yield _pinkie2.default.all(compileUnits)));
            }

            testFileCompilers.forEach(function (c) {
                return c.cleanUp();
            });

            tests = (0, _lodash.flattenDeep)(tests).filter(function (test) {
                return !!test;
            });

            return tests;
        })();
    }
}
exports.default = Compiler;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21waWxlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJTT1VSQ0VfQ0hVTktfTEVOR1RIIiwidGVzdEZpbGVDb21waWxlcnMiLCJMZWdhY3lUZXN0RmlsZUNvbXBpbGVyIiwiaGFtbWVyaGVhZCIsInByb2Nlc3NTY3JpcHQiLCJFc05leHRUZXN0RmlsZUNvbXBpbGVyIiwiVHlwZVNjcmlwdFRlc3RGaWxlQ29tcGlsZXIiLCJDb2ZmZWVTY3JpcHRUZXN0RmlsZUNvbXBpbGVyIiwiUmF3VGVzdEZpbGVDb21waWxlciIsIkNvbXBpbGVyIiwiY29uc3RydWN0b3IiLCJzb3VyY2VzIiwiZ2V0U3VwcG9ydGVkVGVzdEZpbGVFeHRlbnNpb25zIiwibWFwIiwiYyIsImdldFN1cHBvcnRlZEV4dGVuc2lvbiIsIl9jb21waWxlVGVzdEZpbGUiLCJmaWxlbmFtZSIsImNvZGUiLCJlcnIiLCJHZW5lcmFsRXJyb3IiLCJNRVNTQUdFIiwiY2FudEZpbmRTcGVjaWZpZWRUZXN0U291cmNlIiwidG9TdHJpbmciLCJjb21waWxlciIsImNhbkNvbXBpbGUiLCJjb21waWxlIiwiZ2V0VGVzdHMiLCJzb3VyY2VDaHVua3MiLCJ0ZXN0cyIsImNvbXBpbGVVbml0cyIsImxlbmd0aCIsInNoaWZ0IiwiY29uY2F0IiwiUHJvbWlzZSIsImFsbCIsImZvckVhY2giLCJjbGVhblVwIiwiZmlsdGVyIiwidGVzdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFHQSxNQUFNQSxzQkFBc0IsSUFBNUI7O0FBRUEsSUFBSUMsb0JBQW9CLENBQ3BCLElBQUlDLDJCQUFKLENBQTJCQyw2QkFBV0MsYUFBdEMsQ0FEb0IsRUFFcEIsSUFBSUMsa0JBQUosRUFGb0IsRUFHcEIsSUFBSUMsa0JBQUosRUFIb0IsRUFJcEIsSUFBSUMsa0JBQUosRUFKb0IsRUFLcEIsSUFBSUMsYUFBSixFQUxvQixDQUF4Qjs7QUFRZSxNQUFNQyxRQUFOLENBQWU7QUFDMUJDLGdCQUFhQyxPQUFiLEVBQXNCO0FBQ2xCLGFBQUtBLE9BQUwsR0FBZUEsT0FBZjtBQUNIOztBQUVELFdBQU9DLDhCQUFQLEdBQXlDO0FBQ3JDLGVBQU8sa0JBQUtYLGtCQUFrQlksR0FBbEIsQ0FBc0JDLEtBQUtBLEVBQUVDLHFCQUFGLEVBQTNCLENBQUwsQ0FBUDtBQUNIOztBQUVLQyxvQkFBTixDQUF3QkMsUUFBeEIsRUFBa0M7QUFBQTtBQUM5QixnQkFBSUMsT0FBTyxJQUFYOztBQUVBLGdCQUFJO0FBQ0FBLHVCQUFPLE1BQU0sb0NBQVNELFFBQVQsQ0FBYjtBQUNILGFBRkQsQ0FHQSxPQUFPRSxHQUFQLEVBQVk7QUFDUixzQkFBTSxJQUFJQyxxQkFBSixDQUFpQkMsa0JBQVFDLDJCQUF6QixFQUFzREwsUUFBdEQsQ0FBTjtBQUNIOztBQUVEQyxtQkFBTyx3QkFBU0EsSUFBVCxFQUFlSyxRQUFmLEVBQVA7O0FBRUEsZ0JBQUlDLFdBQVcsa0JBQUt2QixpQkFBTCxFQUF3QjtBQUFBLHVCQUFLYSxFQUFFVyxVQUFGLENBQWFQLElBQWIsRUFBbUJELFFBQW5CLENBQUw7QUFBQSxhQUF4QixDQUFmOztBQUVBLG1CQUFPTyxXQUFXLE1BQU1BLFNBQVNFLE9BQVQsQ0FBaUJSLElBQWpCLEVBQXVCRCxRQUF2QixDQUFqQixHQUFvRCxJQUEzRDtBQWQ4QjtBQWVqQzs7QUFFS1UsWUFBTixHQUFrQjtBQUFBOztBQUFBO0FBQ2QsZ0JBQUlDLGVBQWUsbUJBQU0sTUFBS2pCLE9BQVgsRUFBb0JYLG1CQUFwQixDQUFuQjtBQUNBLGdCQUFJNkIsUUFBZSxFQUFuQjtBQUNBLGdCQUFJQyxlQUFlLEVBQW5COztBQUVBO0FBQ0E7QUFDQSxtQkFBT0YsYUFBYUcsTUFBcEIsRUFBNEI7QUFDeEJELCtCQUFlRixhQUFhSSxLQUFiLEdBQXFCbkIsR0FBckIsQ0FBeUI7QUFBQSwyQkFBWSxNQUFLRyxnQkFBTCxDQUFzQkMsUUFBdEIsQ0FBWjtBQUFBLGlCQUF6QixDQUFmO0FBQ0FZLHdCQUFlQSxNQUFNSSxNQUFOLEVBQWEsTUFBTUMsaUJBQVFDLEdBQVIsQ0FBWUwsWUFBWixDQUFuQixFQUFmO0FBQ0g7O0FBRUQ3Qiw4QkFBa0JtQyxPQUFsQixDQUEwQjtBQUFBLHVCQUFLdEIsRUFBRXVCLE9BQUYsRUFBTDtBQUFBLGFBQTFCOztBQUVBUixvQkFBUSx5QkFBUUEsS0FBUixFQUFlUyxNQUFmLENBQXNCO0FBQUEsdUJBQVEsQ0FBQyxDQUFDQyxJQUFWO0FBQUEsYUFBdEIsQ0FBUjs7QUFFQSxtQkFBT1YsS0FBUDtBQWhCYztBQWlCakI7QUEzQ3lCO2tCQUFUcEIsUSIsImZpbGUiOiJjb21waWxlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgeyBmbGF0dGVuRGVlcCBhcyBmbGF0dGVuLCBmaW5kLCBjaHVuaywgdW5pcSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgc3RyaXBCb20gZnJvbSAnc3RyaXAtYm9tJztcbmltcG9ydCB7IENvbXBpbGVyIGFzIExlZ2FjeVRlc3RGaWxlQ29tcGlsZXIgfSBmcm9tICd0ZXN0Y2FmZS1sZWdhY3ktYXBpJztcbmltcG9ydCBoYW1tZXJoZWFkIGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IEVzTmV4dFRlc3RGaWxlQ29tcGlsZXIgZnJvbSAnLi90ZXN0LWZpbGUvZm9ybWF0cy9lcy1uZXh0L2NvbXBpbGVyJztcbmltcG9ydCBUeXBlU2NyaXB0VGVzdEZpbGVDb21waWxlciBmcm9tICcuL3Rlc3QtZmlsZS9mb3JtYXRzL3R5cGVzY3JpcHQvY29tcGlsZXInO1xuaW1wb3J0IENvZmZlZVNjcmlwdFRlc3RGaWxlQ29tcGlsZXIgZnJvbSAnLi90ZXN0LWZpbGUvZm9ybWF0cy9jb2ZmZWVzY3JpcHQvY29tcGlsZXInO1xuaW1wb3J0IFJhd1Rlc3RGaWxlQ29tcGlsZXIgZnJvbSAnLi90ZXN0LWZpbGUvZm9ybWF0cy9yYXcnO1xuaW1wb3J0IHsgcmVhZEZpbGUgfSBmcm9tICcuLi91dGlscy9wcm9taXNpZmllZC1mdW5jdGlvbnMnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IE1FU1NBR0UgZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUvbWVzc2FnZSc7XG5cblxuY29uc3QgU09VUkNFX0NIVU5LX0xFTkdUSCA9IDEwMDA7XG5cbnZhciB0ZXN0RmlsZUNvbXBpbGVycyA9IFtcbiAgICBuZXcgTGVnYWN5VGVzdEZpbGVDb21waWxlcihoYW1tZXJoZWFkLnByb2Nlc3NTY3JpcHQpLFxuICAgIG5ldyBFc05leHRUZXN0RmlsZUNvbXBpbGVyKCksXG4gICAgbmV3IFR5cGVTY3JpcHRUZXN0RmlsZUNvbXBpbGVyKCksXG4gICAgbmV3IENvZmZlZVNjcmlwdFRlc3RGaWxlQ29tcGlsZXIoKSxcbiAgICBuZXcgUmF3VGVzdEZpbGVDb21waWxlcigpXG5dO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21waWxlciB7XG4gICAgY29uc3RydWN0b3IgKHNvdXJjZXMpIHtcbiAgICAgICAgdGhpcy5zb3VyY2VzID0gc291cmNlcztcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0U3VwcG9ydGVkVGVzdEZpbGVFeHRlbnNpb25zICgpIHtcbiAgICAgICAgcmV0dXJuIHVuaXEodGVzdEZpbGVDb21waWxlcnMubWFwKGMgPT4gYy5nZXRTdXBwb3J0ZWRFeHRlbnNpb24oKSkpO1xuICAgIH1cblxuICAgIGFzeW5jIF9jb21waWxlVGVzdEZpbGUgKGZpbGVuYW1lKSB7XG4gICAgICAgIHZhciBjb2RlID0gbnVsbDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29kZSA9IGF3YWl0IHJlYWRGaWxlKGZpbGVuYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKE1FU1NBR0UuY2FudEZpbmRTcGVjaWZpZWRUZXN0U291cmNlLCBmaWxlbmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb2RlID0gc3RyaXBCb20oY29kZSkudG9TdHJpbmcoKTtcblxuICAgICAgICB2YXIgY29tcGlsZXIgPSBmaW5kKHRlc3RGaWxlQ29tcGlsZXJzLCBjID0+IGMuY2FuQ29tcGlsZShjb2RlLCBmaWxlbmFtZSkpO1xuXG4gICAgICAgIHJldHVybiBjb21waWxlciA/IGF3YWl0IGNvbXBpbGVyLmNvbXBpbGUoY29kZSwgZmlsZW5hbWUpIDogbnVsbDtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRUZXN0cyAoKSB7XG4gICAgICAgIHZhciBzb3VyY2VDaHVua3MgPSBjaHVuayh0aGlzLnNvdXJjZXMsIFNPVVJDRV9DSFVOS19MRU5HVEgpO1xuICAgICAgICB2YXIgdGVzdHMgICAgICAgID0gW107XG4gICAgICAgIHZhciBjb21waWxlVW5pdHMgPSBbXTtcblxuICAgICAgICAvLyBOT1RFOiBzcGxpdCBzb3VyY2VzIGludG8gY2h1bmtzIGJlY2F1c2UgdGhlIGZzIG1vZHVsZSBjYW4ndCByZWFkIGFsbCBmaWxlc1xuICAgICAgICAvLyBzaW11bHRhbmVvdXNseSBpZiB0aGUgbnVtYmVyIG9mIHRoZW0gaXMgdG9vIGxhcmdlIChzZXZlcmFsIHRob3VzYW5kcykuXG4gICAgICAgIHdoaWxlIChzb3VyY2VDaHVua3MubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb21waWxlVW5pdHMgPSBzb3VyY2VDaHVua3Muc2hpZnQoKS5tYXAoZmlsZW5hbWUgPT4gdGhpcy5fY29tcGlsZVRlc3RGaWxlKGZpbGVuYW1lKSk7XG4gICAgICAgICAgICB0ZXN0cyAgICAgICAgPSB0ZXN0cy5jb25jYXQoYXdhaXQgUHJvbWlzZS5hbGwoY29tcGlsZVVuaXRzKSk7XG4gICAgICAgIH1cblxuICAgICAgICB0ZXN0RmlsZUNvbXBpbGVycy5mb3JFYWNoKGMgPT4gYy5jbGVhblVwKCkpO1xuXG4gICAgICAgIHRlc3RzID0gZmxhdHRlbih0ZXN0cykuZmlsdGVyKHRlc3QgPT4gISF0ZXN0KTtcblxuICAgICAgICByZXR1cm4gdGVzdHM7XG4gICAgfVxufVxuIl19
