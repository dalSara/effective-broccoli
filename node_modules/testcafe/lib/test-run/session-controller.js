'use strict';

exports.__esModule = true;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _testcafeHammerhead = require('testcafe-hammerhead');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ACTIVE_SESSIONS_MAP = {};

class SessionController extends _testcafeHammerhead.Session {
    constructor(uploadsRoot) {
        super(uploadsRoot);

        this.currentTestRun = null;
    }

    // Hammerhead payload
    _getPayloadScript() {
        return this.currentTestRun._getPayloadScript();
    }

    _getIframePayloadScript() {
        return this.currentTestRun._getIframePayloadScript();
    }

    // Hammerhead handlers
    handleServiceMessage(msg, serverInfo) {
        if (this.currentTestRun[msg.cmd]) return super.handleServiceMessage.call(this.currentTestRun, msg, serverInfo);

        return super.handleServiceMessage(msg, serverInfo);
    }

    getAuthCredentials() {
        return this.currentTestRun.getAuthCredentials();
    }

    handleFileDownload() {
        return this.currentTestRun.handleFileDownload();
    }

    handlePageError(ctx, err) {
        return this.currentTestRun.handlePageError(ctx, err);
    }

    // API
    static getSession(testRun) {
        let sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];

        if (!sessionInfo || !testRun.disablePageReloads) {
            if (sessionInfo && sessionInfo.url) SessionController.closeSession(testRun);

            let session = null;

            if (testRun.test.isLegacy) session = testRun;else {
                session = new SessionController(_path2.default.dirname(testRun.test.fixture.path));

                session.currentTestRun = testRun;
            }

            sessionInfo = {
                session: session,
                proxy: null,
                url: null
            };

            ACTIVE_SESSIONS_MAP[testRun.browserConnection.id] = sessionInfo;
        } else if (!testRun.test.isLegacy) sessionInfo.session.currentTestRun = testRun;

        return sessionInfo.session;
    }

    static getSessionUrl(testRun, proxy) {
        let sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];

        if (!sessionInfo || testRun.test.isLegacy) {
            SessionController.getSession(testRun);

            sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];
        }

        if (!sessionInfo.url) {
            const pageUrl = testRun.test.pageUrl;
            const externalProxyHost = testRun.opts.externalProxyHost;
            let externalProxySettings = null;

            if (externalProxyHost) {
                externalProxySettings = {
                    url: externalProxyHost,
                    bypassRules: testRun.opts.proxyBypass
                };
            }

            sessionInfo.proxy = proxy;
            sessionInfo.url = proxy.openSession(pageUrl, sessionInfo.session, externalProxySettings);
        }

        return sessionInfo.url;
    }

    static closeSession(testRun) {
        const sessionInfo = ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];

        if (!sessionInfo || !sessionInfo.url || !sessionInfo.proxy) return;

        sessionInfo.proxy.closeSession(sessionInfo.session);

        delete ACTIVE_SESSIONS_MAP[testRun.browserConnection.id];
    }
}
exports.default = SessionController;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXN0LXJ1bi9zZXNzaW9uLWNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiQUNUSVZFX1NFU1NJT05TX01BUCIsIlNlc3Npb25Db250cm9sbGVyIiwiU2Vzc2lvbiIsImNvbnN0cnVjdG9yIiwidXBsb2Fkc1Jvb3QiLCJjdXJyZW50VGVzdFJ1biIsIl9nZXRQYXlsb2FkU2NyaXB0IiwiX2dldElmcmFtZVBheWxvYWRTY3JpcHQiLCJoYW5kbGVTZXJ2aWNlTWVzc2FnZSIsIm1zZyIsInNlcnZlckluZm8iLCJjbWQiLCJjYWxsIiwiZ2V0QXV0aENyZWRlbnRpYWxzIiwiaGFuZGxlRmlsZURvd25sb2FkIiwiaGFuZGxlUGFnZUVycm9yIiwiY3R4IiwiZXJyIiwiZ2V0U2Vzc2lvbiIsInRlc3RSdW4iLCJzZXNzaW9uSW5mbyIsImJyb3dzZXJDb25uZWN0aW9uIiwiaWQiLCJkaXNhYmxlUGFnZVJlbG9hZHMiLCJ1cmwiLCJjbG9zZVNlc3Npb24iLCJzZXNzaW9uIiwidGVzdCIsImlzTGVnYWN5IiwicGF0aCIsImRpcm5hbWUiLCJmaXh0dXJlIiwicHJveHkiLCJnZXRTZXNzaW9uVXJsIiwicGFnZVVybCIsImV4dGVybmFsUHJveHlIb3N0Iiwib3B0cyIsImV4dGVybmFsUHJveHlTZXR0aW5ncyIsImJ5cGFzc1J1bGVzIiwicHJveHlCeXBhc3MiLCJvcGVuU2Vzc2lvbiJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFHQSxNQUFNQSxzQkFBc0IsRUFBNUI7O0FBRWUsTUFBTUMsaUJBQU4sU0FBZ0NDLDJCQUFoQyxDQUF3QztBQUNuREMsZ0JBQWFDLFdBQWIsRUFBMEI7QUFDdEIsY0FBTUEsV0FBTjs7QUFFQSxhQUFLQyxjQUFMLEdBQXNCLElBQXRCO0FBQ0g7O0FBRUQ7QUFDQUMsd0JBQXFCO0FBQ2pCLGVBQU8sS0FBS0QsY0FBTCxDQUFvQkMsaUJBQXBCLEVBQVA7QUFDSDs7QUFFREMsOEJBQTJCO0FBQ3ZCLGVBQU8sS0FBS0Ys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QyxFQUFnRFcscUJBQWhELENBQXBCO0FBQ0g7O0FBRUQsZUFBT2pCLFlBQVlJLEdBQW5CO0FBQ0g7O0FBRUQsV0FBT0MsWUFBUCxDQUFxQk4sT0FBckIsRUFBOEI7QUFDMUIsY0FBTUMsY0FBY3BCLG9CQUFvQm1CLFFBQVFFLGlCQUFSLENBQTBCQyxFQUE5QyxDQUFwQjs7QUFFQSxZQUFJLENBQUNGLFdBQUQsSUFBZ0IsQ0FBQ0EsWUFBWUksR0FBN0IsSUFBb0MsQ0FBQ0osWUFBWVksS0FBckQsRUFDSTs7QUFFSlosb0JBQVlZLEtBQVosQ0FBa0JQLFlBQWxCLENBQStCTCxZQUFZTSxPQUEzQzs7QUFFQSxlQUFPMUIsb0JBQW9CbUIsUUFBUUUsaUJBQVIsQ0FBMEJDLEVBQTlDLENBQVA7QUFDSDtBQTFHa0Q7a0JBQWxDckIsaUIiLCJmaWxlIjoidGVzdC1ydW4vc2Vzc2lvbi1jb250cm9sbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBTZXNzaW9uIH0gZnJvbSAndGVzdGNhZmUtaGFtbWVyaGVhZCc7XG5cblxuY29uc3QgQUNUSVZFX1NFU1NJT05TX01BUCA9IHt9O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTZXNzaW9uQ29udHJvbGxlciBleHRlbmRzIFNlc3Npb24ge1xuICAgIGNvbnN0cnVjdG9yICh1cGxvYWRzUm9vdCkge1xuICAgICAgICBzdXBlcih1cGxvYWRzUm9vdCk7XG5cbiAgICAgICAgdGhpcy5jdXJyZW50VGVzdFJ1biA9IG51bGw7XG4gICAgfVxuXG4gICAgLy8gSGFtbWVyaGVhZCBwYXlsb2FkXG4gICAgX2dldFBheWxvYWRTY3JpcHQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50VGVzdFJ1bi5fZ2V0UGF5bG9hZFNjcmlwdCgpO1xuICAgIH1cblxuICAgIF9nZXRJZnJhbWVQYXlsb2FkU2NyaXB0ICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFRlc3RSdW4uX2dldElmcmFtZVBheWxvYWRTY3JpcHQoKTtcbiAgICB9XG5cblxuICAgIC8vIEhhbW1lcmhlYWQgaGFuZGxlcnNcbiAgICBoYW5kbGVTZXJ2aWNlTWVzc2FnZSAobXNnLCBzZXJ2ZXJJbmZvKSB7XG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRUZXN0UnVuW21zZy5jbWRdKVxuICAgICAgICAgICAgcmV0dXJuIHN1cGVyLmhhbmRsZVNlcnZpY2VNZXNzYWdlLmNhbGwodGhpcy5jdXJyZW50VGVzdFJ1biwgbXNnLCBzZXJ2ZXJJbmZvKTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuaGFuZGxlU2VydmljZU1lc3NhZ2UobXNnLCBzZXJ2ZXJJbmZvKTtcbiAgICB9XG5cbiAgICBnZXRBdXRoQ3JlZGVudGlhbHMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50VGVzdFJ1bi5nZXRBdXRoQ3JlZGVudGlhbHMoKTtcbiAgICB9XG5cbiAgICBoYW5kbGVGaWxlRG93bmxvYWQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50VGVzdFJ1bi5oYW5kbGVGaWxlRG93bmxvYWQoKTtcbiAgICB9XG5cbiAgICBoYW5kbGVQYWdlRXJyb3IgKGN0eCwgZXJyKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRUZXN0UnVuLmhhbmRsZVBhZ2VFcnJvcihjdHgsIGVycik7XG4gICAgfVxuXG4gICAgLy8gQVBJXG4gICAgc3RhdGljIGdldFNlc3Npb24gKHRlc3RSdW4pIHtcbiAgICAgICAgbGV0IHNlc3Npb25JbmZvID0gQUNUSVZFX1NFU1NJT05TX01BUFt0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLmlkXTtcblxuICAgICAgICBpZiAoIXNlc3Npb25JbmZvIHx8ICF0ZXN0UnVuLmRpc2FibGVQYWdlUmVsb2Fkcykge1xuICAgICAgICAgICAgaWYgKHNlc3Npb25JbmZvICYmIHNlc3Npb25JbmZvLnVybClcbiAgICAgICAgICAgICAgICBTZXNzaW9uQ29udHJvbGxlci5jbG9zZVNlc3Npb24odGVzdFJ1bik7XG5cbiAgICAgICAgICAgIGxldCBzZXNzaW9uID0gbnVsbDtcblxuICAgICAgICAgICAgaWYgKHRlc3RSdW4udGVzdC5pc0xlZ2FjeSlcbiAgICAgICAgICAgICAgICBzZXNzaW9uID0gdGVzdFJ1bjtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHNlc3Npb24gPSBuZXcgU2Vzc2lvbkNvbnRyb2xsZXIocGF0aC5kaXJuYW1lKHRlc3RSdW4udGVzdC5maXh0dXJlLnBhdGgpKTtcblxuICAgICAgICAgICAgICAgIHNlc3Npb24uY3VycmVudFRlc3RSdW4gPSB0ZXN0UnVuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uSW5mbyA9IHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uOiBzZXNzaW9uLFxuICAgICAgICAgICAgICAgIHByb3h5OiAgIG51bGwsXG4gICAgICAgICAgICAgICAgdXJsOiAgICAgbnVsbFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgQUNUSVZFX1NFU1NJT05TX01BUFt0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLmlkXSA9IHNlc3Npb25JbmZvO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKCF0ZXN0UnVuLnRlc3QuaXNMZWdhY3kpXG4gICAgICAgICAgICBzZXNzaW9uSW5mby5zZXNzaW9uLmN1cnJlbnRUZXN0UnVuID0gdGVzdFJ1bjtcblxuICAgICAgICByZXR1cm4gc2Vzc2lvbkluZm8uc2Vzc2lvbjtcbiAgICB9XG5cbiAgICBzdGF0aWMgZ2V0U2Vzc2lvblVybCAodGVzdFJ1biwgcHJveHkpIHtcbiAgICAgICAgbGV0IHNlc3Npb25JbmZvID0gQUNUSVZFX1NFU1NJT05TX01BUFt0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLmlkXTtcblxuICAgICAgICBpZiAoIXNlc3Npb25JbmZvIHx8IHRlc3RSdW4udGVzdC5pc0xlZ2FjeSkge1xuICAgICAgICAgICAgU2Vzc2lvbkNvbnRyb2xsZXIuZ2V0U2Vzc2lvbih0ZXN0UnVuKTtcblxuICAgICAgICAgICAgc2Vzc2lvbkluZm8gPSBBQ1RJVkVfU0VTU0lPTlNfTUFQW3Rlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uaWRdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFzZXNzaW9uSW5mby51cmwpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhZ2VVcmwgICAgICAgICAgICAgPSB0ZXN0UnVuLnRlc3QucGFnZVVybDtcbiAgICAgICAgICAgIGNvbnN0IGV4dGVybmFsUHJveHlIb3N0ICAgPSB0ZXN0UnVuLm9wdHMuZXh0ZXJuYWxQcm94eUhvc3Q7XG4gICAgICAgICAgICBsZXQgZXh0ZXJuYWxQcm94eVNldHRpbmdzID0gbnVsbDtcblxuICAgICAgICAgICAgaWYgKGV4dGVybmFsUHJveHlIb3N0KSB7XG4gICAgICAgICAgICAgICAgZXh0ZXJuYWxQcm94eVNldHRpbmdzID0ge1xuICAgICAgICAgICAgICAgICAgICB1cmw6ICAgICAgICAgZXh0ZXJuYWxQcm94eUhvc3QsXG4gICAgICAgICAgICAgICAgICAgIGJ5cGFzc1J1bGVzOiB0ZXN0UnVuLm9wdHMucHJveHlCeXBhc3NcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZXNzaW9uSW5mby5wcm94eSA9IHByb3h5O1xuICAgICAgICAgICAgc2Vzc2lvbkluZm8udXJsICAgPSBwcm94eS5vcGVuU2Vzc2lvbihwYWdlVXJsLCBzZXNzaW9uSW5mby5zZXNzaW9uLCBleHRlcm5hbFByb3h5U2V0dGluZ3MpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHNlc3Npb25JbmZvLnVybDtcbiAgICB9XG5cbiAgICBzdGF0aWMgY2xvc2VTZXNzaW9uICh0ZXN0UnVuKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb25JbmZvID0gQUNUSVZFX1NFU1NJT05TX01BUFt0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLmlkXTtcblxuICAgICAgICBpZiAoIXNlc3Npb25JbmZvIHx8ICFzZXNzaW9uSW5mby51cmwgfHwgIXNlc3Npb25JbmZvLnByb3h5KVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHNlc3Npb25JbmZvLnByb3h5LmNsb3NlU2Vzc2lvbihzZXNzaW9uSW5mby5zZXNzaW9uKTtcblxuICAgICAgICBkZWxldGUgQUNUSVZFX1NFU1NJT05TX01BUFt0ZXN0UnVuLmJyb3dzZXJDb25uZWN0aW9uLmlkXTtcbiAgICB9XG59XG5cbiJdfQ==
