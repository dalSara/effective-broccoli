'use strict';

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let runTests = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (argParser) {
        var opts = argParser.opts;
        var port1 = opts.ports && opts.ports[0];
        var port2 = opts.ports && opts.ports[1];
        var externalProxyHost = opts.proxy;
        var proxyBypass = opts.proxyBypass;

        _log2.default.showSpinner();

        const testCafe = yield (0, _2.default)(opts.hostname, port1, port2, opts.ssl, opts.dev);
        var concurrency = argParser.concurrency || 1;
        var remoteBrowsers = yield (0, _remotesWizard2.default)(testCafe, argParser.remoteCount, opts.qrCode);
        var browsers = argParser.browsers.concat(remoteBrowsers);
        var runner = testCafe.createRunner();
        var failed = 0;
        var reporters = argParser.opts.reporters.map(function (r) {
            return {
                name: r.name,
                outStream: r.outFile ? _fs2.default.createWriteStream(r.outFile) : void 0
            };
        });

        reporters.forEach(function (r) {
            return runner.reporter(r.name, r.outStream);
        });

        runner.useProxy(externalProxyHost, proxyBypass).src(argParser.src).browsers(browsers).concurrency(concurrency).filter(argParser.filter).screenshots(opts.screenshots, opts.screenshotsOnFails, opts.screenshotPathPattern).startApp(opts.app, opts.appInitDelay);

        runner.once('done-bootstrapping', function () {
            return _log2.default.hideSpinner();
        });

        try {
            failed = yield runner.run(opts);
        } finally {
            showMessageOnExit = false;
            yield testCafe.close();
        }

        exit(failed);
    });

    return function runTests(_x) {
        return _ref.apply(this, arguments);
    };
})();

let listBrowsers = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* (providerName = 'locally-installed') {
        var provider = yield _pool2.default.getProvider(providerName);

        if (!provider) throw new _runtime.GeneralError(_message2.default.browserProviderNotFound, providerName);

        if (provider.isMultiBrowser) {
            var browserNames = yield provider.getBrowserList();

            yield _pool2.default.dispose();

            if (providerName === 'locally-installed') console.log(browserNames.join('\n'));else console.log(browserNames.map(function (browserName) {
                return `"${providerName}:${browserName}"`;
            }).join('\n'));
        } else console.log(`"${providerName}"`);

        exit(0);
    });

    return function listBrowsers() {
        return _ref2.apply(this, arguments);
    };
})();

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _pool = require('../browser/provider/pool');

var _pool2 = _interopRequireDefault(_pool);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _argumentParser = require('./argument-parser');

var _argumentParser2 = _interopRequireDefault(_argumentParser);

var _terminationHandler = require('./termination-handler');

var _terminationHandler2 = _interopRequireDefault(_terminationHandler);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

var _remotesWizard = require('./remotes-wizard');

var _remotesWizard2 = _interopRequireDefault(_remotesWizard);

var _ = require('../');

var _2 = _interopRequireDefault(_);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var showMessageOnExit = true;
var exitMessageShown = false;
var exiting = false;

function exitHandler(terminationLevel) {
    if (showMessageOnExit && !exitMessageShown) {
        exitMessageShown = true;

        _log2.default.hideSpinner();
        _log2.default.write('Stopping TestCafe...');
        _log2.default.showSpinner();

        process.on('exit', () => _log2.default.hideSpinner(true));
    }

    if (exiting || terminationLevel < 2) return;

    exiting = true;

    exit(0);
}

function exit(code) {
    _log2.default.hideSpinner(true);

    // NOTE: give a process time to flush the output.
    // It's necessary in some environments.
    setTimeout(() => process.exit(code), 0);
}

function error(err) {
    _log2.default.hideSpinner();

    var message = null;

    // HACK: workaround for the `instanceof` problem
    // (see: http://stackoverflow.com/questions/33870684/why-doesnt-instanceof-work-on-instances-of-error-subclasses-under-babel-node)
    if (err.constructor === _runtime.GeneralError) message = err.message;else if (err.constructor === _runtime.APIError) message = err.coloredStack;else message = err.stack;

    _log2.default.write(_chalk2.default.red('ERROR ') + message + '\n');
    _log2.default.write(_chalk2.default.gray('Type "testcafe -h" for help.'));

    exit(1);
}

(() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* () {
        var terminationHandler = new _terminationHandler2.default();

        terminationHandler.on(_terminationHandler2.default.TERMINATION_LEVEL_INCREASED_EVENT, exitHandler);

        try {
            var argParser = new _argumentParser2.default();

            yield argParser.parse(process.argv);

            if (argParser.opts.listBrowsers) yield listBrowsers(argParser.opts.providerName);else yield runTests(argParser);
        } catch (err) {
            showMessageOnExit = false;
            error(err);
        }
    });

    function cli() {
        return _ref3.apply(this, arguments);
    }

    return cli;
})()();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY2xpLmpzIl0sIm5hbWVzIjpbImFyZ1BhcnNlciIsIm9wdHMiLCJwb3J0MSIsInBvcnRzIiwicG9ydDIiLCJleHRlcm5hbFByb3h5SG9zdCIsInByb3h5IiwicHJveHlCeXBhc3MiLCJsb2ciLCJzaG93U3Bpbm5lciIsInRlc3RDYWZlIiwiaG9zdG5hbWUiLCJzc2wiLCJkZXYiLCJjb25jdXJyZW5jeSIsInJlbW90ZUJyb3dzZXJzIiwicmVtb3RlQ291bnQiLCJxckNvZGUiLCJicm93c2VycyIsImNvbmNhdCIsInJ1bm5lciIsImNyZWF0ZVJ1bm5lciIsImZhaWxlZCIsInJlcG9ydGVycyIsIm1hcCIsIm5hbWUiLCJyIiwib3V0U3RyZWFtIiwib3V0RmlsZSIsImZzIiwiY3JlYXRlV3JpdGVTdHJlYW0iLCJmb3JFYWNoIiwicmVwb3J0ZXIiLCJ1c2VQcm94eSIsInNyYyIsImZpbHRlciIsInNjcmVlbnNob3RzIiwic2NyZWVuc2hvdHNPbkZhaWxzIiwic2NyZWVuc2hvdFBhdGhQYXR0ZXJuIiwic3RhcnRBcHAiLCJhcHAiLCJhcHBJbml0RGVsYXkiLCJvbmNlIiwiaGlkZVNwaW5uZXIiLCJydW4iLCJzaG93TWVzc2FnZU9uRXhpdCIsImNsb3NlIiwiZXhpdCIsInJ1blRlc3RzIiwicHJvdmlkZXJOYW1lIiwicHJvdmlkZXIiLCJicm93c2VyUHJvdmlkZXJQb29sIiwiZ2V0UHJvdmlkZXIiLCJHZW5lcmFsRXJyb3IiLCJNRVNTQUdFIiwiYnJvd3NlclByb3ZpZGVyTm90Rm91bmQiLCJpc011bHRpQnJvd3NlciIsImJyb3dzZXJOYW1lcyIsImdldEJyb3dzZXJMaXN0IiwiZGlzcG9zZSIsImNvbnNvbGUiLCJqb2luIiwiYnJvd3Nlck5hbWUiLCJsaXN0QnJvd3NlcnMiLCJleGl0TWVzc2FnZVNob3duIiwiZXhpdGluZyIsImV4aXRIYW5kbGVyIiwidGVybWluYXRpb25MZXZlbCIsIndyaXRlIiwicHJvY2VzcyIsIm9uIiwiY29kZSIsInNldFRpbWVvdXQiLCJlcnJvciIsImVyciIsIm1lc3NhZ2UiLCJjb25zdHJ1Y3RvciIsIkFQSUVycm9yIiwiY29sb3JlZFN0YWNrIiwic3RhY2siLCJjaGFsayIsInJlZCIsImdyYXkiLCJ0ZXJtaW5hdGlvbkhhbmRsZXIiLCJUZXJtaW5hdGlvbkhhbmRsZXIiLCJURVJNSU5BVElPTl9MRVZFTF9JTkNSRUFTRURfRVZFTlQiLCJDbGlBcmd1bWVudFBhcnNlciIsInBhcnNlIiwiYXJndiIsImNsaSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OzsrQ0FpRUEsV0FBeUJBLFNBQXpCLEVBQW9DO0FBQ2hDLFlBQUlDLE9BQW9CRCxVQUFVQyxJQUFsQztBQUNBLFlBQUlDLFFBQW9CRCxLQUFLRSxLQUFMLElBQWNGLEtBQUtFLEtBQUwsQ0FBVyxDQUFYLENBQXRDO0FBQ0EsWUFBSUMsUUFBb0JILEtBQUtFLEtBQUwsSUFBY0YsS0FBS0UsS0FBTCxDQUFXLENBQVgsQ0FBdEM7QUFDQSxZQUFJRSxvQkFBb0JKLEtBQUtLLEtBQTdCO0FBQ0EsWUFBSUMsY0FBb0JOLEtBQUtNLFdBQTdCOztBQUVBQyxzQkFBSUMsV0FBSjs7QUFFQSxjQUFNQyxXQUFlLE1BQU0sZ0JBQWVULEtBQUtVLFFBQXBCLEVBQThCVCxLQUE5QixFQUFxQ0UsS0FBckMsRUFBNENILEtBQUtXLEdBQWpELEVBQXNEWCxLQUFLWSxHQUEzRCxDQUEzQjtBQUNBLFlBQUlDLGNBQWlCZCxVQUFVYyxXQUFWLElBQXlCLENBQTlDO0FBQ0EsWUFBSUMsaUJBQWlCLE1BQU0sNkJBQWNMLFFBQWQsRUFBd0JWLFVBQVVnQixXQUFsQyxFQUErQ2YsS0FBS2dCLE1BQXBELENBQTNCO0FBQ0EsWUFBSUMsV0FBaUJsQixVQUFVa0IsUUFBVixDQUFtQkMsTUFBbkIsQ0FBMEJKLGNBQTFCLENBQXJCO0FBQ0EsWUFBSUssU0FBaUJWLFNBQVNXLFlBQVQsRUFBckI7QUFDQSxZQUFJQyxTQUFpQixDQUFyQjtBQUNBLFlBQUlDLFlBQWlCdkIsVUFBVUMsSUFBVixDQUFlc0IsU0FB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QUdJLE1BQU1ELFNBQVNoRCxTQUFULENBQU47QUFDUCxTQVRELENBVUEsT0FBTzBFLEdBQVAsRUFBWTtBQUNSN0IsZ0NBQW9CLEtBQXBCO0FBQ0E0QixrQkFBTUMsR0FBTjtBQUNIO0FBQ0osS0FuQkQ7O0FBQUEsYUFBZ0JlLEdBQWhCO0FBQUE7QUFBQTs7QUFBQSxXQUFnQkEsR0FBaEI7QUFBQSIsImZpbGUiOiJjbGkvY2xpLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgYnJvd3NlclByb3ZpZGVyUG9vbCBmcm9tICcuLi9icm93c2VyL3Byb3ZpZGVyL3Bvb2wnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yLCBBUElFcnJvciB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCBNRVNTQUdFIGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL21lc3NhZ2UnO1xuaW1wb3J0IENsaUFyZ3VtZW50UGFyc2VyIGZyb20gJy4vYXJndW1lbnQtcGFyc2VyJztcbmltcG9ydCBUZXJtaW5hdGlvbkhhbmRsZXIgZnJvbSAnLi90ZXJtaW5hdGlvbi1oYW5kbGVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2cnO1xuaW1wb3J0IHJlbW90ZXNXaXphcmQgZnJvbSAnLi9yZW1vdGVzLXdpemFyZCc7XG5pbXBvcnQgY3JlYXRlVGVzdENhZmUgZnJvbSAnLi4vJztcblxuXG52YXIgc2hvd01lc3NhZ2VPbkV4aXQgPSB0cnVlO1xudmFyIGV4aXRNZXNzYWdlU2hvd24gID0gZmFsc2U7XG52YXIgZXhpdGluZyAgICAgICAgICAgPSBmYWxzZTtcblxuZnVuY3Rpb24gZXhpdEhhbmRsZXIgKHRlcm1pbmF0aW9uTGV2ZWwpIHtcbiAgICBpZiAoc2hvd01lc3NhZ2VPbkV4aXQgJiYgIWV4aXRNZXNzYWdlU2hvd24pIHtcbiAgICAgICAgZXhpdE1lc3NhZ2VTaG93biA9IHRydWU7XG5cbiAgICAgICAgbG9nLmhpZGVTcGlubmVyKCk7XG4gICAgICAgIGxvZy53cml0ZSgnU3RvcHBpbmcgVGVzdENhZmUuLi4nKTtcbiAgICAgICAgbG9nLnNob3dTcGlubmVyKCk7XG5cbiAgICAgICAgcHJvY2Vzcy5vbignZXhpdCcsICgpID0+IGxvZy5oaWRlU3Bpbm5lcih0cnVlKSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXRpbmcgfHwgdGVybWluYXRpb25MZXZlbCA8IDIpXG4gICAgICAgIHJldHVybjtcblxuICAgIGV4aXRpbmcgPSB0cnVlO1xuXG4gICAgZXhpdCgwKTtcbn1cblxuZnVuY3Rpb24gZXhpdCAoY29kZSkge1xuICAgIGxvZy5oaWRlU3Bpbm5lcih0cnVlKTtcblxuICAgIC8vIE5PVEU6IGdpdmUgYSBwcm9jZXNzIHRpbWUgdG8gZmx1c2ggdGhlIG91dHB1dC5cbiAgICAvLyBJdCdzIG5lY2Vzc2FyeSBpbiBzb21lIGVudmlyb25tZW50cy5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHByb2Nlc3MuZXhpdChjb2RlKSwgMCk7XG59XG5cbmZ1bmN0aW9uIGVycm9yIChlcnIpIHtcbiAgICBsb2cuaGlkZVNwaW5uZXIoKTtcblxuICAgIHZhciBtZXNzYWdlID0gbnVsbDtcblxuICAgIC8vIEhBQ0s6IHdvcmthcm91bmQgZm9yIHRoZSBgaW5zdGFuY2VvZmAgcHJvYmxlbVxuICAgIC8vIChzZWU6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzM4NzA2ODQvd2h5LWRvZXNudC1pbnN0YW5jZW9mLXdvcmstb24taW5zdGFuY2VzLW9mLWVycm9yLXN1YmNsYXNzZXMtdW5kZXItYmFiZWwtbm9kZSlcbiAgICBpZiAoZXJyLmNvbnN0cnVjdG9yID09PSBHZW5lcmFsRXJyb3IpXG4gICAgICAgIG1lc3NhZ2UgPSBlcnIubWVzc2FnZTtcblxuICAgIGVsc2UgaWYgKGVyci5jb25zdHJ1Y3RvciA9PT0gQVBJRXJyb3IpXG4gICAgICAgIG1lc3NhZ2UgPSBlcnIuY29sb3JlZFN0YWNrO1xuXG4gICAgZWxzZVxuICAgICAgICBtZXNzYWdlID0gZXJyLnN0YWNrO1xuXG4gICAgbG9nLndyaXRlKGNoYWxrLnJlZCgnRVJST1IgJykgKyBtZXNzYWdlICsgJ1xcbicpO1xuICAgIGxvZy53cml0ZShjaGFsay5ncmF5KCdUeXBlIFwidGVzdGNhZmUgLWhcIiBmb3IgaGVscC4nKSk7XG5cbiAgICBleGl0KDEpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5UZXN0cyAoYXJnUGFyc2VyKSB7XG4gICAgdmFyIG9wdHMgICAgICAgICAgICAgID0gYXJnUGFyc2VyLm9wdHM7XG4gICAgdmFyIHBvcnQxICAgICAgICAgICAgID0gb3B0cy5wb3J0cyAmJiBvcHRzLnBvcnRzWzBdO1xuICAgIHZhciBwb3J0MiAgICAgICAgICAgICA9IG9wdHMucG9ydHMgJiYgb3B0cy5wb3J0c1sxXTtcbiAgICB2YXIgZXh0ZXJuYWxQcm94eUhvc3QgPSBvcHRzLnByb3h5O1xuICAgIHZhciBwcm94eUJ5cGFzcyAgICAgICA9IG9wdHMucHJveHlCeXBhc3M7XG5cbiAgICBsb2cuc2hvd1NwaW5uZXIoKTtcblxuICAgIGNvbnN0IHRlc3RDYWZlICAgICA9IGF3YWl0IGNyZWF0ZVRlc3RDYWZlKG9wdHMuaG9zdG5hbWUsIHBvcnQxLCBwb3J0Miwgb3B0cy5zc2wsIG9wdHMuZGV2KTtcbiAgICB2YXIgY29uY3VycmVuY3kgICAgPSBhcmdQYXJzZXIuY29uY3VycmVuY3kgfHwgMTtcbiAgICB2YXIgcmVtb3RlQnJvd3NlcnMgPSBhd2FpdCByZW1vdGVzV2l6YXJkKHRlc3RDYWZlLCBhcmdQYXJzZXIucmVtb3RlQ291bnQsIG9wdHMucXJDb2RlKTtcbiAgICB2YXIgYnJvd3NlcnMgICAgICAgPSBhcmdQYXJzZXIuYnJvd3NlcnMuY29uY2F0KHJlbW90ZUJyb3dzZXJzKTtcbiAgICB2YXIgcnVubmVyICAgICAgICAgPSB0ZXN0Q2FmZS5jcmVhdGVSdW5uZXIoKTtcbiAgICB2YXIgZmFpbGVkICAgICAgICAgPSAwO1xuICAgIHZhciByZXBvcnRlcnMgICAgICA9IGFyZ1BhcnNlci5vcHRzLnJlcG9ydGVycy5tYXAociA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiAgICAgIHIubmFtZSxcbiAgICAgICAgICAgIG91dFN0cmVhbTogci5vdXRGaWxlID8gZnMuY3JlYXRlV3JpdGVTdHJlYW0oci5vdXRGaWxlKSA6IHZvaWQgMFxuICAgICAgICB9O1xuICAgIH0pO1xuXG4gICAgcmVwb3J0ZXJzLmZvckVhY2gociA9PiBydW5uZXIucmVwb3J0ZXIoci5uYW1lLCByLm91dFN0cmVhbSkpO1xuXG4gICAgcnVubmVyXG4gICAgICAgIC51c2VQcm94eShleHRlcm5hbFByb3h5SG9zdCwgcHJveHlCeXBhc3MpXG4gICAgICAgIC5zcmMoYXJnUGFyc2VyLnNyYylcbiAgICAgICAgLmJyb3dzZXJzKGJyb3dzZXJzKVxuICAgICAgICAuY29uY3VycmVuY3koY29uY3VycmVuY3kpXG4gICAgICAgIC5maWx0ZXIoYXJnUGFyc2VyLmZpbHRlcilcbiAgICAgICAgLnNjcmVlbnNob3RzKG9wdHMuc2NyZWVuc2hvdHMsIG9wdHMuc2NyZWVuc2hvdHNPbkZhaWxzLCBvcHRzLnNjcmVlbnNob3RQYXRoUGF0dGVybilcbiAgICAgICAgLnN0YXJ0QXBwKG9wdHMuYXBwLCBvcHRzLmFwcEluaXREZWxheSk7XG5cbiAgICBydW5uZXIub25jZSgnZG9uZS1ib290c3RyYXBwaW5nJywgKCkgPT4gbG9nLmhpZGVTcGlubmVyKCkpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgZmFpbGVkID0gYXdhaXQgcnVubmVyLnJ1bihvcHRzKTtcbiAgICB9XG5cbiAgICBmaW5hbGx5IHtcbiAgICAgICAgc2hvd01lc3NhZ2VPbkV4aXQgPSBmYWxzZTtcbiAgICAgICAgYXdhaXQgdGVzdENhZmUuY2xvc2UoKTtcbiAgICB9XG5cbiAgICBleGl0KGZhaWxlZCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxpc3RCcm93c2VycyAocHJvdmlkZXJOYW1lID0gJ2xvY2FsbHktaW5zdGFsbGVkJykge1xuICAgIHZhciBwcm92aWRlciA9IGF3YWl0IGJyb3dzZXJQcm92aWRlclBvb2wuZ2V0UHJvdmlkZXIocHJvdmlkZXJOYW1lKTtcblxuICAgIGlmICghcHJvdmlkZXIpXG4gICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5icm93c2VyUHJvdmlkZXJOb3RGb3VuZCwgcHJvdmlkZXJOYW1lKTtcblxuICAgIGlmIChwcm92aWRlci5pc011bHRpQnJvd3Nlcikge1xuICAgICAgICB2YXIgYnJvd3Nlck5hbWVzID0gYXdhaXQgcHJvdmlkZXIuZ2V0QnJvd3Nlckxpc3QoKTtcblxuICAgICAgICBhd2FpdCBicm93c2VyUHJvdmlkZXJQb29sLmRpc3Bvc2UoKTtcblxuICAgICAgICBpZiAocHJvdmlkZXJOYW1lID09PSAnbG9jYWxseS1pbnN0YWxsZWQnKVxuICAgICAgICAgICAgY29uc29sZS5sb2coYnJvd3Nlck5hbWVzLmpvaW4oJ1xcbicpKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgY29uc29sZS5sb2coYnJvd3Nlck5hbWVzLm1hcChicm93c2VyTmFtZSA9PiBgXCIke3Byb3ZpZGVyTmFtZX06JHticm93c2VyTmFtZX1cImApLmpvaW4oJ1xcbicpKTtcbiAgICB9XG4gICAgZWxzZVxuICAgICAgICBjb25zb2xlLmxvZyhgXCIke3Byb3ZpZGVyTmFtZX1cImApO1xuXG4gICAgZXhpdCgwKTtcbn1cblxuKGFzeW5jIGZ1bmN0aW9uIGNsaSAoKSB7XG4gICAgdmFyIHRlcm1pbmF0aW9uSGFuZGxlciA9IG5ldyBUZXJtaW5hdGlvbkhhbmRsZXIoKTtcblxuICAgIHRlcm1pbmF0aW9uSGFuZGxlci5vbihUZXJtaW5hdGlvbkhhbmRsZXIuVEVSTUlOQVRJT05fTEVWRUxfSU5DUkVBU0VEX0VWRU5ULCBleGl0SGFuZGxlcik7XG5cbiAgICB0cnkge1xuICAgICAgICB2YXIgYXJnUGFyc2VyID0gbmV3IENsaUFyZ3VtZW50UGFyc2VyKCk7XG5cbiAgICAgICAgYXdhaXQgYXJnUGFyc2VyLnBhcnNlKHByb2Nlc3MuYXJndik7XG5cbiAgICAgICAgaWYgKGFyZ1BhcnNlci5vcHRzLmxpc3RCcm93c2VycylcbiAgICAgICAgICAgIGF3YWl0IGxpc3RCcm93c2VycyhhcmdQYXJzZXIub3B0cy5wcm92aWRlck5hbWUpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBhd2FpdCBydW5UZXN0cyhhcmdQYXJzZXIpO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHNob3dNZXNzYWdlT25FeGl0ID0gZmFsc2U7XG4gICAgICAgIGVycm9yKGVycik7XG4gICAgfVxufSkoKTtcblxuIl19
