'use strict';

exports.__esModule = true;

var _loadBabelLibs3 = require('../../../load-babel-libs');

var _loadBabelLibs4 = _interopRequireDefault(_loadBabelLibs3);

var _apiBased = require('../../api-based');

var _apiBased2 = _interopRequireDefault(_apiBased);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BABEL_RUNTIME_RE = /^babel-runtime(\\|\/|$)/;
const FLOW_MARKER_RE = /^\s*\/\/\s*@flow\s*\n|^\s*\/\*\s*@flow\s*\*\//;

class ESNextTestFileCompiler extends _apiBased2.default {
    static getBabelOptions(filename, code) {
        var _loadBabelLibs = (0, _loadBabelLibs4.default)(),
            presetStage2 = _loadBabelLibs.presetStage2,
            presetFlow = _loadBabelLibs.presetFlow,
            transformRuntime = _loadBabelLibs.transformRuntime,
            transformClassProperties = _loadBabelLibs.transformClassProperties,
            presetEnv = _loadBabelLibs.presetEnv;

        // NOTE: passPrePreset and complex presets is a workaround for https://github.com/babel/babel/issues/2877
        // Fixes https://github.com/DevExpress/testcafe/issues/969


        return {
            passPerPreset: true,
            presets: [{
                passPerPreset: false,
                presets: [{ plugins: [transformRuntime] }, presetStage2, presetEnv]
            }, FLOW_MARKER_RE.test(code) ? {
                passPerPreset: false,
                presets: [{ plugins: [transformClassProperties] }, presetFlow]
            } : {}],
            filename: filename,
            retainLines: true,
            sourceMaps: 'inline',
            ast: false,
            babelrc: false,
            highlightCode: false,

            resolveModuleSource: source => {
                if (source === 'testcafe') return _apiBased2.default.EXPORTABLE_LIB_PATH;

                if (BABEL_RUNTIME_RE.test(source)) {
                    try {
                        return require.resolve(source);
                    } catch (err) {
                        return source;
                    }
                }

                return source;
            }
        };
    }

    _compileCode(code, filename) {
        var _loadBabelLibs2 = (0, _loadBabelLibs4.default)(),
            babel = _loadBabelLibs2.babel;

        if (this.cache[filename]) return this.cache[filename];

        var opts = ESNextTestFileCompiler.getBabelOptions(filename, code);
        var compiled = babel.transform(code, opts);

        this.cache[filename] = compiled.code;

        return compiled.code;
    }

    _getRequireCompilers() {
        return { '.js': (code, filename) => this._compileCode(code, filename) };
    }

    getSupportedExtension() {
        return '.js';
    }
}
exports.default = ESNextTestFileCompiler;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9jb21waWxlci90ZXN0LWZpbGUvZm9ybWF0cy9lcy1uZXh0L2NvbXBpbGVyLmpzIl0sIm5hbWVzIjpbIkJBQkVMX1JVTlRJTUVfUkUiLCJGTE9XX01BUktFUl9SRSIsIkVTTmV4dFRlc3RGaWxlQ29tcGlsZXIiLCJBUElCYXNlZFRlc3RGaWxlQ29tcGlsZXJCYXNlIiwiZ2V0QmFiZWxPcHRpb25zIiwiZmlsZW5hbWUiLCJjb2RlIiwicHJlc2V0U3RhZ2UyIiwicHJlc2V0RmxvdyIsInRyYW5zZm9ybVJ1bnRpbWUiLCJ0cmFuc2Zvcm1DbGFzc1Byb3BlcnRpZXMiLCJwcmVzZXRFbnYiLCJwYXNzUGVyUHJlc2V0IiwicHJlc2V0cyIsInBsdWdpbnMiLCJ0ZXN0IiwicmV0YWluTGluZXMiLCJzb3VyY2VNYXBzIiwiYXN0IiwiYmFiZWxyYyIsImhpZ2hsaWdodENvZGUiLCJyZXNvbHZlTW9kdWxlU291cmNlIiwic291cmNlIiwiRVhQT1JUQUJMRV9MSUJfUEFUSCIsInJlcXVpcmUiLCJyZXNvbHZlIiwiZXJyIiwiX2NvbXBpbGVDb2RlIiwiYmFiZWwiLCJjYWNoZSIsIm9wdHMiLCJjb21waWxlZCIsInRyYW5zZm9ybSIsIl9nZXRSZXF1aXJlQ29tcGlsZXJzIiwiZ2V0U3VwcG9ydGVkRXh0ZW5zaW9uIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUE7Ozs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsbUJBQW1CLHlCQUF6QjtBQUNBLE1BQU1DLGlCQUFtQiwrQ0FBekI7O0FBRWUsTUFBTUMsc0JBQU4sU0FBcUNDLGtCQUFyQyxDQUFrRTtBQUM3RSxXQUFPQyxlQUFQLENBQXdCQyxRQUF4QixFQUFrQ0MsSUFBbEMsRUFBd0M7QUFBQSw2QkFDc0QsOEJBRHREO0FBQUEsWUFDOUJDLFlBRDhCLGtCQUM5QkEsWUFEOEI7QUFBQSxZQUNoQkMsVUFEZ0Isa0JBQ2hCQSxVQURnQjtBQUFBLFlBQ0pDLGdCQURJLGtCQUNKQSxnQkFESTtBQUFBLFlBQ2NDLHdCQURkLGtCQUNjQSx3QkFEZDtBQUFBLFlBQ3dDQyxTQUR4QyxrQkFDd0NBLFNBRHhDOztBQUdwQztBQUNBOzs7QUFDQSxlQUFPO0FBQ0hDLDJCQUFlLElBRFo7QUFFSEMscUJBQWUsQ0FDWDtBQUNJRCwrQkFBZSxLQURuQjtBQUVJQyx5QkFBZSxDQUFDLEVBQUVDLFNBQVMsQ0FBQ0wsZ0JBQUQsQ0FBWCxFQUFELEVBQWtDRixZQUFsQyxFQUFnREksU0FBaEQ7QUFGbkIsYUFEVyxFQUtYVixlQUFlYyxJQUFmLENBQW9CVCxJQUFwQixJQUE0QjtBQUN4Qk0sK0JBQWUsS0FEUztBQUV4QkMseUJBQWUsQ0FBQyxFQUFFQyxTQUFTLENBQUNKLHdCQUFELENBQVgsRUFBRCxFQUEwQ0YsVUFBMUM7QUFGUyxhQUE1QixHQUdJLEVBUk8sQ0FGWjtBQVlISCxzQkFBZUEsUUFaWjtBQWFIVyx5QkFBZSxJQWJaO0FBY0hDLHdCQUFlLFFBZFo7QUFlSEMsaUJBQWUsS0FmWjtBQWdCSEMscUJBQWUsS0FoQlo7QUFpQkhDLDJCQUFlLEtBakJaOztBQW1CSEMsaUNBQXFCQyxVQUFVO0FBQzNCLG9CQUFJQSxXQUFXLFVBQWYsRUFDSSxPQUFPbkIsbUJBQTZCb0IsbUJBQXBDOztBQUVKLG9CQUFJdkIsaUJBQWlCZSxJQUFqQixDQUFzQk8sTUFBdEIsQ0FBSixFQUFtQztBQUMvQix3QkFBSTtBQUNBLCtCQUFPRSxRQUFRQyxPQUFSLENBQWdCSCxNQUFoQixDQUFQO0FBQ0gscUJBRkQsQ0FHQSxPQUFPSSxHQUFQLEVBQVk7QUFDUiwrQkFBT0osTUFBUDtBQUNIO0FBQ0o7O0FBRUQsdUJBQU9BLE1BQVA7QUFDSDtBQWpDRSxTQUFQO0FBbUNIOztBQUVESyxpQkFBY3JCLElBQWQsRUFBb0JELFFBQXBCLEVBQThCO0FBQUEsOEJBQ1YsOEJBRFU7QUFBQSxZQUNwQnVCLEtBRG9CLG1CQUNwQkEsS0FEb0I7O0FBRzFCLFlBQUksS0FBS0MsS0FBTCxDQUFXeEIsUUFBWCxDQUFKLEVBQ0ksT0FBTyxLQUFLd0IsS0FBTCxDQUFXeEIsUUFBWCxDQUFQOztBQUVKLFlBQUl5QixPQUFXNUIsdUJBQXVCRSxlQUF2QixDQUF1Q0MsUUFBdkMsRUFBaURDLElBQWpELENBQWY7QUFDQSxZQUFJeUIsV0FBV0gsTUFBTUksU0FBTixDQUFnQjFCLElBQWhCLEVBQXNCd0IsSUFBdEIsQ0FBZjs7QUFFQSxhQUFLRCxLQUFMLENBQVd4QixRQUFYLElBQXVCMEIsU0FBU3pCLElBQWhDOztBQUVBLGVBQU95QixTQUFTekIsSUFBaEI7QUFDSDs7QUFFRDJCLDJCQUF3QjtBQUNwQixlQUFPLEVBQUUsT0FBTyxDQUFDM0IsSUFBRCxFQUFPRCxRQUFQLEtBQW9CLEtBQUtzQixZQUFMLENBQWtCckIsSUFBbEIsRUFBd0JELFFBQXhCLENBQTdCLEVBQVA7QUFDSDs7QUFFRDZCLDRCQUF5QjtBQUNyQixlQUFPLEtBQVA7QUFDSDtBQS9ENEU7a0JBQTVEaEMsc0IiLCJmaWxlIjoiY29tcGlsZXIvdGVzdC1maWxlL2Zvcm1hdHMvZXMtbmV4dC9jb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2FkQmFiZWxMaWJzIGZyb20gJy4uLy4uLy4uL2xvYWQtYmFiZWwtbGlicyc7XG5pbXBvcnQgQVBJQmFzZWRUZXN0RmlsZUNvbXBpbGVyQmFzZSBmcm9tICcuLi8uLi9hcGktYmFzZWQnO1xuXG5jb25zdCBCQUJFTF9SVU5USU1FX1JFID0gL15iYWJlbC1ydW50aW1lKFxcXFx8XFwvfCQpLztcbmNvbnN0IEZMT1dfTUFSS0VSX1JFICAgPSAvXlxccypcXC9cXC9cXHMqQGZsb3dcXHMqXFxufF5cXHMqXFwvXFwqXFxzKkBmbG93XFxzKlxcKlxcLy87XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEVTTmV4dFRlc3RGaWxlQ29tcGlsZXIgZXh0ZW5kcyBBUElCYXNlZFRlc3RGaWxlQ29tcGlsZXJCYXNlIHtcbiAgICBzdGF0aWMgZ2V0QmFiZWxPcHRpb25zIChmaWxlbmFtZSwgY29kZSkge1xuICAgICAgICB2YXIgeyBwcmVzZXRTdGFnZTIsIHByZXNldEZsb3csIHRyYW5zZm9ybVJ1bnRpbWUsIHRyYW5zZm9ybUNsYXNzUHJvcGVydGllcywgcHJlc2V0RW52IH0gPSBsb2FkQmFiZWxMaWJzKCk7XG5cbiAgICAgICAgLy8gTk9URTogcGFzc1ByZVByZXNldCBhbmQgY29tcGxleCBwcmVzZXRzIGlzIGEgd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL2JhYmVsL2JhYmVsL2lzc3Vlcy8yODc3XG4gICAgICAgIC8vIEZpeGVzIGh0dHBzOi8vZ2l0aHViLmNvbS9EZXZFeHByZXNzL3Rlc3RjYWZlL2lzc3Vlcy85NjlcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHBhc3NQZXJQcmVzZXQ6IHRydWUsXG4gICAgICAgICAgICBwcmVzZXRzOiAgICAgICBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBwYXNzUGVyUHJlc2V0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgcHJlc2V0czogICAgICAgW3sgcGx1Z2luczogW3RyYW5zZm9ybVJ1bnRpbWVdIH0sIHByZXNldFN0YWdlMiwgcHJlc2V0RW52XVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgRkxPV19NQVJLRVJfUkUudGVzdChjb2RlKSA/IHtcbiAgICAgICAgICAgICAgICAgICAgcGFzc1BlclByZXNldDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIHByZXNldHM6ICAgICAgIFt7IHBsdWdpbnM6IFt0cmFuc2Zvcm1DbGFzc1Byb3BlcnRpZXNdIH0sIHByZXNldEZsb3ddXG4gICAgICAgICAgICAgICAgfSA6IHt9XG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgZmlsZW5hbWU6ICAgICAgZmlsZW5hbWUsXG4gICAgICAgICAgICByZXRhaW5MaW5lczogICB0cnVlLFxuICAgICAgICAgICAgc291cmNlTWFwczogICAgJ2lubGluZScsXG4gICAgICAgICAgICBhc3Q6ICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGJhYmVscmM6ICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgaGlnaGxpZ2h0Q29kZTogZmFsc2UsXG5cbiAgICAgICAgICAgIHJlc29sdmVNb2R1bGVTb3VyY2U6IHNvdXJjZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gJ3Rlc3RjYWZlJylcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEFQSUJhc2VkVGVzdEZpbGVDb21waWxlckJhc2UuRVhQT1JUQUJMRV9MSUJfUEFUSDtcblxuICAgICAgICAgICAgICAgIGlmIChCQUJFTF9SVU5USU1FX1JFLnRlc3Qoc291cmNlKSkge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcXVpcmUucmVzb2x2ZShzb3VyY2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gc291cmNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIF9jb21waWxlQ29kZSAoY29kZSwgZmlsZW5hbWUpIHtcbiAgICAgICAgdmFyIHsgYmFiZWwgfSA9IGxvYWRCYWJlbExpYnMoKTtcblxuICAgICAgICBpZiAodGhpcy5jYWNoZVtmaWxlbmFtZV0pXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jYWNoZVtmaWxlbmFtZV07XG5cbiAgICAgICAgdmFyIG9wdHMgICAgID0gRVNOZXh0VGVzdEZpbGVDb21waWxlci5nZXRCYWJlbE9wdGlvbnMoZmlsZW5hbWUsIGNvZGUpO1xuICAgICAgICB2YXIgY29tcGlsZWQgPSBiYWJlbC50cmFuc2Zvcm0oY29kZSwgb3B0cyk7XG5cbiAgICAgICAgdGhpcy5jYWNoZVtmaWxlbmFtZV0gPSBjb21waWxlZC5jb2RlO1xuXG4gICAgICAgIHJldHVybiBjb21waWxlZC5jb2RlO1xuICAgIH1cblxuICAgIF9nZXRSZXF1aXJlQ29tcGlsZXJzICgpIHtcbiAgICAgICAgcmV0dXJuIHsgJy5qcyc6IChjb2RlLCBmaWxlbmFtZSkgPT4gdGhpcy5fY29tcGlsZUNvZGUoY29kZSwgZmlsZW5hbWUpIH07XG4gICAgfVxuXG4gICAgZ2V0U3VwcG9ydGVkRXh0ZW5zaW9uICgpIHtcbiAgICAgICAgcmV0dXJuICcuanMnO1xuICAgIH1cbn1cbiJdfQ==
