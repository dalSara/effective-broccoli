'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _mapReverse = require('map-reverse');

var _mapReverse2 = _interopRequireDefault(_mapReverse);

var _events = require('events');

var _lodash = require('lodash');

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _reporter = require('../reporter');

var _reporter2 = _interopRequireDefault(_reporter);

var _task = require('./task');

var _task2 = _interopRequireDefault(_task);

var _runtime = require('../errors/runtime');

var _message = require('../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

var _typeAssertions = require('../errors/runtime/type-assertions');

var _handleErrors = require('../utils/handle-errors');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_SELECTOR_TIMEOUT = 10000;
const DEFAULT_ASSERTION_TIMEOUT = 3000;
const DEFAULT_PAGE_LOAD_TIMEOUT = 3000;

class Runner extends _events.EventEmitter {
    constructor(proxy, browserConnectionGateway) {
        super();

        this.proxy = proxy;
        this.bootstrapper = new _bootstrapper2.default(browserConnectionGateway);
        this.pendingTaskPromises = [];

        this.opts = {
            externalProxyHost: null,
            proxyBypass: null,
            screenshotPath: null,
            takeScreenshotsOnFails: false,
            screenshotPathPattern: null,
            skipJsErrors: false,
            quarantineMode: false,
            debugMode: false,
            selectorTimeout: DEFAULT_SELECTOR_TIMEOUT,
            pageLoadTimeout: DEFAULT_PAGE_LOAD_TIMEOUT
        };
    }

    static _disposeTaskAndRelatedAssets(task, browserSet, testedApp) {
        return (0, _asyncToGenerator3.default)(function* () {
            task.abort();
            task.removeAllListeners();

            yield Runner._disposeBrowserSetAndTestedApp(browserSet, testedApp);
        })();
    }

    static _disposeBrowserSetAndTestedApp(browserSet, testedApp) {
        return (0, _asyncToGenerator3.default)(function* () {
            yield browserSet.dispose();

            if (testedApp) yield testedApp.kill();
        })();
    }

    _createCancelablePromise(taskPromise) {
        var promise = taskPromise.then(({ completionPromise }) => completionPromise);
        var removeFromPending = () => (0, _lodash.pull)(this.pendingTaskPromises, promise);

        promise.then(removeFromPending).catch(removeFromPending);

        promise.cancel = () => taskPromise.then(({ cancelTask }) => cancelTask()).then(removeFromPending);

        this.pendingTaskPromises.push(promise);
        return promise;
    }

    // Run task
    _getTaskResult(task, browserSet, reporter, testedApp) {
        return (0, _asyncToGenerator3.default)(function* () {
            task.on('browser-job-done', function (job) {
                return browserSet.releaseConnection(job.browserConnection);
            });

            var promises = [(0, _promisifyEvent2.default)(task, 'done'), (0, _promisifyEvent2.default)(browserSet, 'error')];

            if (testedApp) promises.push(testedApp.errorPromise);

            try {
                yield _pinkie2.default.race(promises);
            } catch (err) {
                yield Runner._disposeTaskAndRelatedAssets(task, browserSet, testedApp);

                throw err;
            }

            yield Runner._disposeBrowserSetAndTestedApp(browserSet, testedApp);

            return reporter.testCount - reporter.passed;
        })();
    }

    _runTask(reporterPlugins, browserSet, tests, testedApp) {
        var completed = false;
        var task = new _task2.default(tests, browserSet.browserConnectionGroups, this.proxy, this.opts);
        var reporters = reporterPlugins.map(reporter => new _reporter2.default(reporter.plugin, task, reporter.outStream));
        var completionPromise = this._getTaskResult(task, browserSet, reporters[0], testedApp);

        task.once('start', _handleErrors.startHandlingTestErrors);

        if (!this.opts.skipUncaughtErrors) {
            task.on('test-run-start', _handleErrors.addRunningTest);
            task.on('test-run-done', _handleErrors.removeRunningTest);
        }

        task.once('done', _handleErrors.stopHandlingTestErrors);

        var setCompleted = () => {
            completed = true;
        };

        completionPromise.then(setCompleted).catch(setCompleted);

        var cancelTask = (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* () {
                if (!completed) yield Runner._disposeTaskAndRelatedAssets(task, browserSet, testedApp);
            });

            return function cancelTask() {
                return _ref.apply(this, arguments);
            };
        })();

        return { completionPromise, cancelTask };
    }

    _registerAssets(assets) {
        assets.forEach(asset => this.proxy.GET(asset.path, asset.info));
    }

    _validateRunOptions() {
        const concurrency = this.bootstrapper.concurrency;
        const speed = this.opts.speed;
        let proxyBypass = this.opts.proxyBypass;

        if (typeof speed !== 'number' || isNaN(speed) || speed < 0.01 || speed > 1) throw new _runtime.GeneralError(_message2.default.invalidSpeedValue);

        if (typeof concurrency !== 'number' || isNaN(concurrency) || concurrency < 1) throw new _runtime.GeneralError(_message2.default.invalidConcurrencyFactor);

        if (proxyBypass) {
            (0, _typeAssertions.assertType)([_typeAssertions.is.string, _typeAssertions.is.array], null, '"proxyBypass" argument', proxyBypass);

            if (typeof proxyBypass === 'string') proxyBypass = [proxyBypass];

            proxyBypass = proxyBypass.reduce((arr, rules) => {
                (0, _typeAssertions.assertType)(_typeAssertions.is.string, null, '"proxyBypass" argument', rules);

                return arr.concat(rules.split(','));
            }, []);

            this.opts.proxyBypass = proxyBypass;
        }
    }

    // API
    embeddingOptions(opts) {
        this._registerAssets(opts.assets);
        this.opts.TestRunCtor = opts.TestRunCtor;

        return this;
    }

    src(...sources) {
        this.bootstrapper.sources = this.bootstrapper.sources.concat((0, _lodash.flattenDeep)(sources));

        return this;
    }

    browsers(...browsers) {
        this.bootstrapper.browsers = this.bootstrapper.browsers.concat((0, _lodash.flattenDeep)(browsers));

        return this;
    }

    concurrency(concurrency) {
        this.bootstrapper.concurrency = concurrency;

        return this;
    }

    reporter(name, outStream) {
        this.bootstrapper.reporters.push({
            name,
            outStream
        });

        return this;
    }

    filter(filter) {
        this.bootstrapper.filter = filter;

        return this;
    }

    useProxy(externalProxyHost, proxyBypass) {
        this.opts.externalProxyHost = externalProxyHost;
        this.opts.proxyBypass = proxyBypass;

        return this;
    }

    screenshots(path, takeOnFails = false, pattern = null) {
        this.opts.takeScreenshotsOnFails = takeOnFails;
        this.opts.screenshotPath = path;
        this.opts.screenshotPathPattern = pattern;

        return this;
    }

    startApp(command, initDelay) {
        this.bootstrapper.appCommand = command;
        this.bootstrapper.appInitDelay = initDelay;

        return this;
    }

    run({ skipJsErrors, disablePageReloads, quarantineMode, debugMode, selectorTimeout, assertionTimeout, pageLoadTimeout, speed = 1, debugOnFail, skipUncaughtErrors } = {}) {
        this.opts.skipJsErrors = !!skipJsErrors;
        this.opts.disablePageReloads = !!disablePageReloads;
        this.opts.quarantineMode = !!quarantineMode;
        this.opts.debugMode = !!debugMode;
        this.opts.debugOnFail = !!debugOnFail;
        this.opts.selectorTimeout = selectorTimeout === void 0 ? DEFAULT_SELECTOR_TIMEOUT : selectorTimeout;
        this.opts.assertionTimeout = assertionTimeout === void 0 ? DEFAULT_ASSERTION_TIMEOUT : assertionTimeout;
        this.opts.pageLoadTimeout = pageLoadTimeout === void 0 ? DEFAULT_PAGE_LOAD_TIMEOUT : pageLoadTimeout;
        this.opts.speed = speed;
        this.opts.skipUncaughtErrors = !!skipUncaughtErrors;

        var runTaskPromise = _pinkie2.default.resolve().then(() => {
            this._validateRunOptions();

            return this.bootstrapper.createRunnableConfiguration();
        }).then(({ reporterPlugins, browserSet, tests, testedApp }) => {
            this.emit('done-bootstrapping');

            return this._runTask(reporterPlugins, browserSet, tests, testedApp);
        });

        return this._createCancelablePromise(runTaskPromise);
    }

    stop() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            // NOTE: When taskPromise is cancelled, it is removed from
            // the pendingTaskPromises array, which leads to shifting indexes
            // towards the beginning. So, we must copy the array in order to iterate it,
            // or we can perform iteration from the end to the beginning.
            var cancellationPromises = (0, _mapReverse2.default)(_this.pendingTaskPromises, function (taskPromise) {
                return taskPromise.cancel();
            });

            yield _pinkie2.default.all(cancellationPromises);
        })();
    }
}
exports.default = Runner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvaW5kZXguanMiXSwibmFtZXMiOlsiREVGQVVMVF9TRUxFQ1RPUl9USU1FT1VUIiwiREVGQVVMVF9BU1NFUlRJT05fVElNRU9VVCIsIkRFRkFVTFRfUEFHRV9MT0FEX1RJTUVPVVQiLCJSdW5uZXIiLCJFdmVudEVtaXR0ZXIiLCJjb25zdHJ1Y3RvciIsInByb3h5IiwiYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5IiwiYm9vdHN0cmFwcGVyIiwiQm9vdHN0cmFwcGVyIiwicGVuZGluZ1Rhc2tQcm9taXNlcyIsIm9wdHMiLCJleHRlcm5hbFByb3h5SG9zdCIsInByb3h5QnlwYXNzIiwic2NyZWVuc2hvdFBhdGgiLCJ0YWtlU2NyZWVuc2hvdHNPbkZhaWxzIiwic2NyZWVuc2hvdFBhdGhQYXR0ZXJuIiwic2tpcEpzRXJyb3JzIiwicXVhcmFudGluZU1vZGUiLCJkZWJ1Z01vZGUiLCJzZWxlY3RvclRpbWVvdXQiLCJwYWdlTG9hZFRpbWVvdXQiLCJfZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzIiwidGFzayIsImJyb3dzZXJTZXQiLCJ0ZXN0ZWRBcHAiLCJhYm9ydCIsInJlbW92ZUFsbExpc3RlbmVycyIsIl9kaXNwb3NlQnJvd3NlclNldEFuZFRlc3RlZEFwcCIsImRpc3Bvc2UiLCJraWxsIiwiX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlIiwidGFza1Byb21pc2UiLCJwcm9taXNlIiwidGhlbiIsImNvbXBsZXRpb25Qcm9taXNlIiwicmVtb3ZlRnJvbVBlbmRpbmciLCJjYXRjaCIsImNhbmNlbCIsImNhbmNlbFRhc2siLCJwdXNoIiwiX2dldFRhc2tSZXN1bHQiLCJyZXBvcnRlciIsIm9uIiwicmVsZWFzZUNvbm5lY3Rpb24iLCJqb2IiLCJicm93c2VyQ29ubmVjdGlvbiIsInByb21pc2VzIiwiZXJyb3JQcm9taXNlIiwiUHJvbWlzZSIsInJhY2UiLCJlcnIiLCJ0ZXN0Q291bnQiLCJwYXNzZWQiLCJfcnVuVGFzayIsInJlcG9ydGVyUGx1Z2lucyIsInRlc3RzIiwiY29tcGxldGVkIiwiVGFzayIsImJyb3dzZXJDb25uZWN0aW9uR3JvdXBzIiwicmVwb3J0ZXJzIiwibWFwIiwiUmVwb3J0ZXIiLCJwbHVnaW4iLCJvdXRTdHJlYW0iLCJvbmNlIiwic3RhcnRIYW5kbGluZ1Rlc3RFcnJvcnMiLCJza2lwVW5jYXVnaHRFcnJvcnMiLCJhZGRSdW5uaW5nVGVzdCIsInJlbW92ZVJ1bm5pbmdUZXN0Iiwic3RvcEhhbmRsaW5nVGVzdEVycm9ycyIsInNldENvbXBsZXRlZCIsIl9yZWdpc3RlckFzc2V0cyIsImFzc2V0cyIsImZvckVhY2giLCJhc3NldCIsIkdFVCIsInBhdGgiLCJpbmZvIiwiX3ZhbGlkYXRlUnVuT3B0aW9ucyIsImNvbmN1cnJlbmN5Iiwic3BlZWQiLCJpc05hTiIsIkdlbmVyYWxFcnJvciIsIk1FU1NBR0UiLCJpbnZhbGlkU3BlZWRWYWx1ZSIsImludmFsaWRDb25jdXJyZW5jeUZhY3RvciIsImlzIiwic3RyaW5nIiwiYXJyYXkiLCJyZWR1Y2UiLCJhcnIiLCJydWxlcyIsImNvbmNhdCIsInNwbGl0IiwiZW1iZWRkaW5nT3B0aW9ucyIsIlRlc3RSdW5DdG9yIiwic3JjIiwic291cmNlcyIsImJyb3dzZXJzIiwibmFtZSIsImZpbHRlciIsInVzZVByb3h5Iiwic2NyZWVuc2hvdHMiLCJ0YWtlT25GYWlscyIsInBhdHRlcm4iLCJzdGFydEFwcCIsImNvbW1hbmQiLCJpbml0RGVsYXkiLCJhcHBDb21tYW5kIiwiYXBwSW5pdERlbGF5IiwicnVuIiwiZGlzYWJsZVBhZ2VSZWxvYWRzIiwiYXNzZXJ0aW9uVGltZW91dCIsImRlYnVnT25GYWlsIiwicnVuVGFza1Byb21pc2UiLCJyZXNvbHZlIiwiY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwiZW1pdCIsInN0b3AiLCJjYW5jZWxsYXRpb25Qcm9taXNlcyIsImFsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7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UUFBTixHQUFjO0FBQUE7O0FBQUE7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBLGdCQUFJQyx1QkFBdUIsMEJBQVcsTUFBSzlHLG1CQUFoQixFQUFxQztBQUFBLHVCQUFlc0IsWUFBWU0sTUFBWixFQUFmO0FBQUEsYUFBckMsQ0FBM0I7O0FBRUEsa0JBQU1XLGlCQUFRd0UsR0FBUixDQUFZRCxvQkFBWixDQUFOO0FBUFU7QUFRYjtBQTlPNEM7a0JBQTVCckgsTSIsImZpbGUiOiJydW5uZXIvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHByb21pc2lmeUV2ZW50IGZyb20gJ3Byb21pc2lmeS1ldmVudCc7XG5pbXBvcnQgbWFwUmV2ZXJzZSBmcm9tICdtYXAtcmV2ZXJzZSc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgZmxhdHRlbkRlZXAgYXMgZmxhdHRlbiwgcHVsbCBhcyByZW1vdmUgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEJvb3RzdHJhcHBlciBmcm9tICcuL2Jvb3RzdHJhcHBlcic7XG5pbXBvcnQgUmVwb3J0ZXIgZnJvbSAnLi4vcmVwb3J0ZXInO1xuaW1wb3J0IFRhc2sgZnJvbSAnLi90YXNrJztcbmltcG9ydCB7IEdlbmVyYWxFcnJvciB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCBNRVNTQUdFIGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL21lc3NhZ2UnO1xuaW1wb3J0IHsgYXNzZXJ0VHlwZSwgaXMgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZS90eXBlLWFzc2VydGlvbnMnO1xuaW1wb3J0IHsgYWRkUnVubmluZ1Rlc3QsIHJlbW92ZVJ1bm5pbmdUZXN0LCBzdGFydEhhbmRsaW5nVGVzdEVycm9ycywgc3RvcEhhbmRsaW5nVGVzdEVycm9ycyB9IGZyb20gJy4uL3V0aWxzL2hhbmRsZS1lcnJvcnMnO1xuXG5jb25zdCBERUZBVUxUX1NFTEVDVE9SX1RJTUVPVVQgID0gMTAwMDA7XG5jb25zdCBERUZBVUxUX0FTU0VSVElPTl9USU1FT1VUID0gMzAwMDtcbmNvbnN0IERFRkFVTFRfUEFHRV9MT0FEX1RJTUVPVVQgPSAzMDAwO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSdW5uZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yIChwcm94eSwgYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5wcm94eSAgICAgICAgICAgICAgID0gcHJveHk7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyICAgICAgICA9IG5ldyBCb290c3RyYXBwZXIoYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5KTtcbiAgICAgICAgdGhpcy5wZW5kaW5nVGFza1Byb21pc2VzID0gW107XG5cbiAgICAgICAgdGhpcy5vcHRzID0ge1xuICAgICAgICAgICAgZXh0ZXJuYWxQcm94eUhvc3Q6ICAgICAgbnVsbCxcbiAgICAgICAgICAgIHByb3h5QnlwYXNzOiAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogICAgICAgICBudWxsLFxuICAgICAgICAgICAgdGFrZVNjcmVlbnNob3RzT25GYWlsczogZmFsc2UsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aFBhdHRlcm46ICBudWxsLFxuICAgICAgICAgICAgc2tpcEpzRXJyb3JzOiAgICAgICAgICAgZmFsc2UsXG4gICAgICAgICAgICBxdWFyYW50aW5lTW9kZTogICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGRlYnVnTW9kZTogICAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgc2VsZWN0b3JUaW1lb3V0OiAgICAgICAgREVGQVVMVF9TRUxFQ1RPUl9USU1FT1VULFxuICAgICAgICAgICAgcGFnZUxvYWRUaW1lb3V0OiAgICAgICAgREVGQVVMVF9QQUdFX0xPQURfVElNRU9VVFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBfZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzICh0YXNrLCBicm93c2VyU2V0LCB0ZXN0ZWRBcHApIHtcbiAgICAgICAgdGFzay5hYm9ydCgpO1xuICAgICAgICB0YXNrLnJlbW92ZUFsbExpc3RlbmVycygpO1xuXG4gICAgICAgIGF3YWl0IFJ1bm5lci5fZGlzcG9zZUJyb3dzZXJTZXRBbmRUZXN0ZWRBcHAoYnJvd3NlclNldCwgdGVzdGVkQXBwKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgX2Rpc3Bvc2VCcm93c2VyU2V0QW5kVGVzdGVkQXBwIChicm93c2VyU2V0LCB0ZXN0ZWRBcHApIHtcbiAgICAgICAgYXdhaXQgYnJvd3NlclNldC5kaXNwb3NlKCk7XG5cbiAgICAgICAgaWYgKHRlc3RlZEFwcClcbiAgICAgICAgICAgIGF3YWl0IHRlc3RlZEFwcC5raWxsKCk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlICh0YXNrUHJvbWlzZSkge1xuICAgICAgICB2YXIgcHJvbWlzZSAgICAgICAgICAgPSB0YXNrUHJvbWlzZS50aGVuKCh7IGNvbXBsZXRpb25Qcm9taXNlIH0pID0+IGNvbXBsZXRpb25Qcm9taXNlKTtcbiAgICAgICAgdmFyIHJlbW92ZUZyb21QZW5kaW5nID0gKCkgPT4gcmVtb3ZlKHRoaXMucGVuZGluZ1Rhc2tQcm9taXNlcywgcHJvbWlzZSk7XG5cbiAgICAgICAgcHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4ocmVtb3ZlRnJvbVBlbmRpbmcpXG4gICAgICAgICAgICAuY2F0Y2gocmVtb3ZlRnJvbVBlbmRpbmcpO1xuXG4gICAgICAgIHByb21pc2UuY2FuY2VsID0gKCkgPT4gdGFza1Byb21pc2VcbiAgICAgICAgICAgIC50aGVuKCh7IGNhbmNlbFRhc2sgfSkgPT4gY2FuY2VsVGFzaygpKVxuICAgICAgICAgICAgLnRoZW4ocmVtb3ZlRnJvbVBlbmRpbmcpO1xuXG4gICAgICAgIHRoaXMucGVuZGluZ1Rhc2tQcm9taXNlcy5wdXNoKHByb21pc2UpO1xuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9XG5cbiAgICAvLyBSdW4gdGFza1xuICAgIGFzeW5jIF9nZXRUYXNrUmVzdWx0ICh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlciwgdGVzdGVkQXBwKSB7XG4gICAgICAgIHRhc2sub24oJ2Jyb3dzZXItam9iLWRvbmUnLCBqb2IgPT4gYnJvd3NlclNldC5yZWxlYXNlQ29ubmVjdGlvbihqb2IuYnJvd3NlckNvbm5lY3Rpb24pKTtcblxuICAgICAgICB2YXIgcHJvbWlzZXMgPSBbXG4gICAgICAgICAgICBwcm9taXNpZnlFdmVudCh0YXNrLCAnZG9uZScpLFxuICAgICAgICAgICAgcHJvbWlzaWZ5RXZlbnQoYnJvd3NlclNldCwgJ2Vycm9yJylcbiAgICAgICAgXTtcblxuICAgICAgICBpZiAodGVzdGVkQXBwKVxuICAgICAgICAgICAgcHJvbWlzZXMucHVzaCh0ZXN0ZWRBcHAuZXJyb3JQcm9taXNlKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5yYWNlKHByb21pc2VzKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBhd2FpdCBSdW5uZXIuX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyh0YXNrLCBicm93c2VyU2V0LCB0ZXN0ZWRBcHApO1xuXG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBSdW5uZXIuX2Rpc3Bvc2VCcm93c2VyU2V0QW5kVGVzdGVkQXBwKGJyb3dzZXJTZXQsIHRlc3RlZEFwcCk7XG5cbiAgICAgICAgcmV0dXJuIHJlcG9ydGVyLnRlc3RDb3VudCAtIHJlcG9ydGVyLnBhc3NlZDtcbiAgICB9XG5cbiAgICBfcnVuVGFzayAocmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwKSB7XG4gICAgICAgIHZhciBjb21wbGV0ZWQgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB2YXIgdGFzayAgICAgICAgICAgICAgPSBuZXcgVGFzayh0ZXN0cywgYnJvd3NlclNldC5icm93c2VyQ29ubmVjdGlvbkdyb3VwcywgdGhpcy5wcm94eSwgdGhpcy5vcHRzKTtcbiAgICAgICAgdmFyIHJlcG9ydGVycyAgICAgICAgID0gcmVwb3J0ZXJQbHVnaW5zLm1hcChyZXBvcnRlciA9PiBuZXcgUmVwb3J0ZXIocmVwb3J0ZXIucGx1Z2luLCB0YXNrLCByZXBvcnRlci5vdXRTdHJlYW0pKTtcbiAgICAgICAgdmFyIGNvbXBsZXRpb25Qcm9taXNlID0gdGhpcy5fZ2V0VGFza1Jlc3VsdCh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnNbMF0sIHRlc3RlZEFwcCk7XG5cbiAgICAgICAgdGFzay5vbmNlKCdzdGFydCcsIHN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzKTtcblxuICAgICAgICBpZiAoIXRoaXMub3B0cy5za2lwVW5jYXVnaHRFcnJvcnMpIHtcbiAgICAgICAgICAgIHRhc2sub24oJ3Rlc3QtcnVuLXN0YXJ0JywgYWRkUnVubmluZ1Rlc3QpO1xuICAgICAgICAgICAgdGFzay5vbigndGVzdC1ydW4tZG9uZScsIHJlbW92ZVJ1bm5pbmdUZXN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRhc2sub25jZSgnZG9uZScsIHN0b3BIYW5kbGluZ1Rlc3RFcnJvcnMpO1xuXG4gICAgICAgIHZhciBzZXRDb21wbGV0ZWQgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb21wbGV0ZWQgPSB0cnVlO1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbXBsZXRpb25Qcm9taXNlXG4gICAgICAgICAgICAudGhlbihzZXRDb21wbGV0ZWQpXG4gICAgICAgICAgICAuY2F0Y2goc2V0Q29tcGxldGVkKTtcblxuICAgICAgICB2YXIgY2FuY2VsVGFzayA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGlmICghY29tcGxldGVkKVxuICAgICAgICAgICAgICAgIGF3YWl0IFJ1bm5lci5fZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzKHRhc2ssIGJyb3dzZXJTZXQsIHRlc3RlZEFwcCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHsgY29tcGxldGlvblByb21pc2UsIGNhbmNlbFRhc2sgfTtcbiAgICB9XG5cbiAgICBfcmVnaXN0ZXJBc3NldHMgKGFzc2V0cykge1xuICAgICAgICBhc3NldHMuZm9yRWFjaChhc3NldCA9PiB0aGlzLnByb3h5LkdFVChhc3NldC5wYXRoLCBhc3NldC5pbmZvKSk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlUnVuT3B0aW9ucyAoKSB7XG4gICAgICAgIGNvbnN0IGNvbmN1cnJlbmN5ID0gdGhpcy5ib290c3RyYXBwZXIuY29uY3VycmVuY3k7XG4gICAgICAgIGNvbnN0IHNwZWVkICAgICAgID0gdGhpcy5vcHRzLnNwZWVkO1xuICAgICAgICBsZXQgcHJveHlCeXBhc3MgICA9IHRoaXMub3B0cy5wcm94eUJ5cGFzcztcblxuICAgICAgICBpZiAodHlwZW9mIHNwZWVkICE9PSAnbnVtYmVyJyB8fCBpc05hTihzcGVlZCkgfHwgc3BlZWQgPCAwLjAxIHx8IHNwZWVkID4gMSlcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5pbnZhbGlkU3BlZWRWYWx1ZSk7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb25jdXJyZW5jeSAhPT0gJ251bWJlcicgfHwgaXNOYU4oY29uY3VycmVuY3kpIHx8IGNvbmN1cnJlbmN5IDwgMSlcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoTUVTU0FHRS5pbnZhbGlkQ29uY3VycmVuY3lGYWN0b3IpO1xuXG4gICAgICAgIGlmIChwcm94eUJ5cGFzcykge1xuICAgICAgICAgICAgYXNzZXJ0VHlwZShbIGlzLnN0cmluZywgaXMuYXJyYXkgXSwgbnVsbCwgJ1wicHJveHlCeXBhc3NcIiBhcmd1bWVudCcsIHByb3h5QnlwYXNzKTtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm94eUJ5cGFzcyA9PT0gJ3N0cmluZycpXG4gICAgICAgICAgICAgICAgcHJveHlCeXBhc3MgPSBbcHJveHlCeXBhc3NdO1xuXG4gICAgICAgICAgICBwcm94eUJ5cGFzcyA9IHByb3h5QnlwYXNzLnJlZHVjZSgoYXJyLCBydWxlcykgPT4ge1xuICAgICAgICAgICAgICAgIGFzc2VydFR5cGUoaXMuc3RyaW5nLCBudWxsLCAnXCJwcm94eUJ5cGFzc1wiIGFyZ3VtZW50JywgcnVsZXMpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFyci5jb25jYXQocnVsZXMuc3BsaXQoJywnKSk7XG4gICAgICAgICAgICB9LCBbXSk7XG5cbiAgICAgICAgICAgIHRoaXMub3B0cy5wcm94eUJ5cGFzcyA9IHByb3h5QnlwYXNzO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gQVBJXG4gICAgZW1iZWRkaW5nT3B0aW9ucyAob3B0cykge1xuICAgICAgICB0aGlzLl9yZWdpc3RlckFzc2V0cyhvcHRzLmFzc2V0cyk7XG4gICAgICAgIHRoaXMub3B0cy5UZXN0UnVuQ3RvciA9IG9wdHMuVGVzdFJ1bkN0b3I7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgc3JjICguLi5zb3VyY2VzKSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLnNvdXJjZXMgPSB0aGlzLmJvb3RzdHJhcHBlci5zb3VyY2VzLmNvbmNhdChmbGF0dGVuKHNvdXJjZXMpKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBicm93c2VycyAoLi4uYnJvd3NlcnMpIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuYnJvd3NlcnMgPSB0aGlzLmJvb3RzdHJhcHBlci5icm93c2Vycy5jb25jYXQoZmxhdHRlbihicm93c2VycykpO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGNvbmN1cnJlbmN5IChjb25jdXJyZW5jeSkge1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5jb25jdXJyZW5jeSA9IGNvbmN1cnJlbmN5O1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHJlcG9ydGVyIChuYW1lLCBvdXRTdHJlYW0pIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIucmVwb3J0ZXJzLnB1c2goe1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIG91dFN0cmVhbVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBmaWx0ZXIgKGZpbHRlcikge1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5maWx0ZXIgPSBmaWx0ZXI7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgdXNlUHJveHkgKGV4dGVybmFsUHJveHlIb3N0LCBwcm94eUJ5cGFzcykge1xuICAgICAgICB0aGlzLm9wdHMuZXh0ZXJuYWxQcm94eUhvc3QgPSBleHRlcm5hbFByb3h5SG9zdDtcbiAgICAgICAgdGhpcy5vcHRzLnByb3h5QnlwYXNzICAgICAgID0gcHJveHlCeXBhc3M7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgc2NyZWVuc2hvdHMgKHBhdGgsIHRha2VPbkZhaWxzID0gZmFsc2UsIHBhdHRlcm4gPSBudWxsKSB7XG4gICAgICAgIHRoaXMub3B0cy50YWtlU2NyZWVuc2hvdHNPbkZhaWxzID0gdGFrZU9uRmFpbHM7XG4gICAgICAgIHRoaXMub3B0cy5zY3JlZW5zaG90UGF0aCAgICAgICAgID0gcGF0aDtcbiAgICAgICAgdGhpcy5vcHRzLnNjcmVlbnNob3RQYXRoUGF0dGVybiAgPSBwYXR0ZXJuO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHN0YXJ0QXBwIChjb21tYW5kLCBpbml0RGVsYXkpIHtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuYXBwQ29tbWFuZCAgID0gY29tbWFuZDtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuYXBwSW5pdERlbGF5ID0gaW5pdERlbGF5O1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHJ1biAoeyBza2lwSnNFcnJvcnMsIGRpc2FibGVQYWdlUmVsb2FkcywgcXVhcmFudGluZU1vZGUsIGRlYnVnTW9kZSwgc2VsZWN0b3JUaW1lb3V0LCBhc3NlcnRpb25UaW1lb3V0LCBwYWdlTG9hZFRpbWVvdXQsIHNwZWVkID0gMSwgZGVidWdPbkZhaWwsIHNraXBVbmNhdWdodEVycm9ycyB9ID0ge30pIHtcbiAgICAgICAgdGhpcy5vcHRzLnNraXBKc0Vycm9ycyAgICAgICAgID0gISFza2lwSnNFcnJvcnM7XG4gICAgICAgIHRoaXMub3B0cy5kaXNhYmxlUGFnZVJlbG9hZHMgICA9ICEhZGlzYWJsZVBhZ2VSZWxvYWRzO1xuICAgICAgICB0aGlzLm9wdHMucXVhcmFudGluZU1vZGUgICAgICAgPSAhIXF1YXJhbnRpbmVNb2RlO1xuICAgICAgICB0aGlzLm9wdHMuZGVidWdNb2RlICAgICAgICAgICAgPSAhIWRlYnVnTW9kZTtcbiAgICAgICAgdGhpcy5vcHRzLmRlYnVnT25GYWlsICAgICAgICAgID0gISFkZWJ1Z09uRmFpbDtcbiAgICAgICAgdGhpcy5vcHRzLnNlbGVjdG9yVGltZW91dCAgICAgID0gc2VsZWN0b3JUaW1lb3V0ID09PSB2b2lkIDAgPyBERUZBVUxUX1NFTEVDVE9SX1RJTUVPVVQgOiBzZWxlY3RvclRpbWVvdXQ7XG4gICAgICAgIHRoaXMub3B0cy5hc3NlcnRpb25UaW1lb3V0ICAgICA9IGFzc2VydGlvblRpbWVvdXQgPT09IHZvaWQgMCA/IERFRkFVTFRfQVNTRVJUSU9OX1RJTUVPVVQgOiBhc3NlcnRpb25UaW1lb3V0O1xuICAgICAgICB0aGlzLm9wdHMucGFnZUxvYWRUaW1lb3V0ICAgICAgPSBwYWdlTG9hZFRpbWVvdXQgPT09IHZvaWQgMCA/IERFRkFVTFRfUEFHRV9MT0FEX1RJTUVPVVQgOiBwYWdlTG9hZFRpbWVvdXQ7XG4gICAgICAgIHRoaXMub3B0cy5zcGVlZCAgICAgICAgICAgICAgICA9IHNwZWVkO1xuICAgICAgICB0aGlzLm9wdHMuc2tpcFVuY2F1Z2h0RXJyb3JzID0gISFza2lwVW5jYXVnaHRFcnJvcnM7XG5cbiAgICAgICAgdmFyIHJ1blRhc2tQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl92YWxpZGF0ZVJ1bk9wdGlvbnMoKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJvb3RzdHJhcHBlci5jcmVhdGVSdW5uYWJsZUNvbmZpZ3VyYXRpb24oKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbigoeyByZXBvcnRlclBsdWdpbnMsIGJyb3dzZXJTZXQsIHRlc3RzLCB0ZXN0ZWRBcHAgfSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZG9uZS1ib290c3RyYXBwaW5nJyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcnVuVGFzayhyZXBvcnRlclBsdWdpbnMsIGJyb3dzZXJTZXQsIHRlc3RzLCB0ZXN0ZWRBcHApO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlKHJ1blRhc2tQcm9taXNlKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdG9wICgpIHtcbiAgICAgICAgLy8gTk9URTogV2hlbiB0YXNrUHJvbWlzZSBpcyBjYW5jZWxsZWQsIGl0IGlzIHJlbW92ZWQgZnJvbVxuICAgICAgICAvLyB0aGUgcGVuZGluZ1Rhc2tQcm9taXNlcyBhcnJheSwgd2hpY2ggbGVhZHMgdG8gc2hpZnRpbmcgaW5kZXhlc1xuICAgICAgICAvLyB0b3dhcmRzIHRoZSBiZWdpbm5pbmcuIFNvLCB3ZSBtdXN0IGNvcHkgdGhlIGFycmF5IGluIG9yZGVyIHRvIGl0ZXJhdGUgaXQsXG4gICAgICAgIC8vIG9yIHdlIGNhbiBwZXJmb3JtIGl0ZXJhdGlvbiBmcm9tIHRoZSBlbmQgdG8gdGhlIGJlZ2lubmluZy5cbiAgICAgICAgdmFyIGNhbmNlbGxhdGlvblByb21pc2VzID0gbWFwUmV2ZXJzZSh0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMsIHRhc2tQcm9taXNlID0+IHRhc2tQcm9taXNlLmNhbmNlbCgpKTtcblxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChjYW5jZWxsYXRpb25Qcm9taXNlcyk7XG4gICAgfVxufVxuIl19
