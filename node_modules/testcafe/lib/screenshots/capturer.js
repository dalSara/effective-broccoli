'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _testcafeBrowserTools = require('testcafe-browser-tools');

var _crop = require('./crop');

var _crop2 = _interopRequireDefault(_crop);

var _promisifiedFunctions = require('../utils/promisified-functions');

var _asyncQueue = require('../utils/async-queue');

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _escapeUserAgent = require('../utils/escape-user-agent');

var _escapeUserAgent2 = _interopRequireDefault(_escapeUserAgent);

var _correctFilePath = require('../utils/correct-file-path');

var _correctFilePath2 = _interopRequireDefault(_correctFilePath);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Capturer {
    constructor(baseScreenshotsPath, testEntry, connection, pathPattern, warningLog) {
        this.enabled = !!baseScreenshotsPath;
        this.baseScreenshotsPath = baseScreenshotsPath;
        this.testEntry = testEntry;
        this.provider = connection.provider;
        this.browserId = connection.id;
        this.warningLog = warningLog;
        this.pathPattern = pathPattern;
    }

    static _getDimensionWithoutScrollbar(fullDimension, documentDimension, bodyDimension) {
        if (bodyDimension > fullDimension) return documentDimension;

        if (documentDimension > fullDimension) return bodyDimension;

        return Math.max(documentDimension, bodyDimension);
    }

    static _getCropDimensions(cropDimensions, pageDimensions) {
        if (!cropDimensions || !pageDimensions) return null;

        const dpr = pageDimensions.dpr;
        const top = cropDimensions.top,
              left = cropDimensions.left,
              bottom = cropDimensions.bottom,
              right = cropDimensions.right;


        return {
            top: Math.round(top * dpr),
            left: Math.round(left * dpr),
            bottom: Math.round(bottom * dpr),
            right: Math.round(right * dpr)
        };
    }

    static _getClientAreaDimensions(pageDimensions) {
        if (!pageDimensions) return null;

        const innerWidth = pageDimensions.innerWidth,
              documentWidth = pageDimensions.documentWidth,
              bodyWidth = pageDimensions.bodyWidth,
              innerHeight = pageDimensions.innerHeight,
              documentHeight = pageDimensions.documentHeight,
              bodyHeight = pageDimensions.bodyHeight,
              dpr = pageDimensions.dpr;


        return {
            width: Math.floor(Capturer._getDimensionWithoutScrollbar(innerWidth, documentWidth, bodyWidth) * dpr),
            height: Math.floor(Capturer._getDimensionWithoutScrollbar(innerHeight, documentHeight, bodyHeight) * dpr)
        };
    }

    _joinWithBaseScreenshotPath(path) {
        return (0, _path.join)(this.baseScreenshotsPath, path);
    }

    _updateScreenshotPathForTestEntry(customPath) {
        // NOTE: if test contains takeScreenshot action with custom path
        // we should specify the most common screenshot folder in report
        let screenshotPathForTestEntry = this.baseScreenshotsPath;

        if (!customPath) {
            const pathForReport = this.pathPattern.getPathForReport();

            screenshotPathForTestEntry = this._joinWithBaseScreenshotPath(pathForReport);
        }

        this.testEntry.path = screenshotPathForTestEntry;
    }

    _incrementFileIndexes(forError) {
        if (forError) this.pathPattern.data.errorFileIndex++;else this.pathPattern.data.fileIndex++;
    }

    _getCustomScreenshotPath(customPath) {
        const correctedCustomPath = (0, _correctFilePath2.default)(customPath);

        return this._joinWithBaseScreenshotPath(correctedCustomPath);
    }

    _getScreenshotPath(forError) {
        const path = this.pathPattern.getPath(forError);

        this._incrementFileIndexes(forError);

        return this._joinWithBaseScreenshotPath(path);
    }

    _getThumbnailPath(screenshotPath) {
        const imageName = (0, _path.basename)(screenshotPath);
        const imageDir = (0, _path.dirname)(screenshotPath);

        return (0, _path.join)(imageDir, 'thumbnails', imageName);
    }

    _takeScreenshot(filePath, pageWidth, pageHeight) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield (0, _promisifiedFunctions.ensureDir)((0, _path.dirname)(filePath));
            yield _this.provider.takeScreenshot(_this.browserId, filePath, pageWidth, pageHeight);
        })();
    }

    _capture(forError, { pageDimensions, cropDimensions, markSeed, customPath } = {}) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this2.enabled) return null;

            const screenshotPath = customPath ? _this2._getCustomScreenshotPath(customPath) : _this2._getScreenshotPath(forError);
            const thumbnailPath = _this2._getThumbnailPath(screenshotPath);

            if ((0, _asyncQueue.isInQueue)(screenshotPath)) _this2.warningLog.addWarning(_warningMessage2.default.screenshotRewritingError, screenshotPath);

            yield (0, _asyncQueue.addToQueue)(screenshotPath, (0, _asyncToGenerator3.default)(function* () {
                yield _this2._takeScreenshot(screenshotPath, ...(pageDimensions ? [pageDimensions.innerWidth, pageDimensions.innerHeight] : []));

                yield (0, _crop2.default)(screenshotPath, markSeed, Capturer._getClientAreaDimensions(pageDimensions), Capturer._getCropDimensions(cropDimensions, pageDimensions));

                yield (0, _testcafeBrowserTools.generateThumbnail)(screenshotPath, thumbnailPath);
            }));

            _this2._updateScreenshotPathForTestEntry(customPath);

            const screenshot = {
                screenshotPath,
                thumbnailPath,
                userAgent: (0, _escapeUserAgent2.default)(_this2.pathPattern.data.parsedUserAgent),
                quarantineAttempt: _this2.pathPattern.data.quarantineAttempt,
                takenOnFail: forError
            };

            _this2.testEntry.screenshots.push(screenshot);

            return screenshotPath;
        })();
    }

    captureAction(options) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this3._capture(false, options);
        })();
    }

    captureError(options) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this4._capture(true, options);
        })();
    }
}
exports.default = Capturer;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9jYXB0dXJlci5qcyJdLCJuYW1lcyI6WyJDYXB0dXJlciIsImNvbnN0cnVjdG9yIiwiYmFzZVNjcmVlbnNob3RzUGF0aCIsInRlc3RFbnRyeSIsImNvbm5lY3Rpb24iLCJwYXRoUGF0dGVybiIsIndhcm5pbmdMb2ciLCJlbmFibGVkIiwicHJvdmlkZXIiLCJicm93c2VySWQiLCJpZCIsIl9nZXREaW1lbnNpb25XaXRob3V0U2Nyb2xsYmFyIiwiZnVsbERpbWVuc2lvbiIsImRvY3VtZW50RGltZW5zaW9uIiwiYm9keURpbWVuc2lvbiIsIk1hdGgiLCJtYXgiLCJfZ2V0Q3JvcERpbWVuc2lvbnMiLCJjcm9wRGltZW5zaW9ucyIsInBhZ2VEaW1lbnNpb25zIiwiZHByIiwidG9wIiwibGVmdCIsImJvdHRvbSIsInJpZ2h0Iiwicm91bmQiLCJfZ2V0Q2xpZW50QXJlYURpbWVuc2lvbnMiLCJpbm5lcldpZHRoIiwiZG9jdW1lbnRXaWR0aCIsImJvZHlXaWR0aCIsImlubmVySGVpZ2h0IiwiZG9jdW1lbnRIZWlnaHQiLCJib2R5SGVpZ2h0Iiwid2lkdGgiLCJmbG9vciIsImhlaWdodCIsIl9qb2luV2l0aEJhc2VTY3JlZW5zaG90UGF0aCIsInBhdGgiLCJfdXBkYXRlU2NyZWVuc2hvdFBhdGhGb3JUZXN0RW50cnkiLCJjdXN0b21QYXRoIiwic2NyZWVuc2hvdFBhdGhGb3JUZXN0RW50cnkiLCJwYXRoRm9yUmVwb3J0IiwiZ2V0UGF0aEZvclJlcG9ydCIsIl9pbmNyZW1lbnRGaWxlSW5kZXhlcyIsImZvckVycm9yIiwiZGF0YSIsImVycm9yRmlsZUluZGV4IiwiZmlsZUluZGV4IiwiX2dldEN1c3RvbVNjcmVlbnNob3RQYXRoIiwiY29ycmVjdGVkQ3VzdG9tUGF0aCIsIl9nZXRTY3JlZW5zaG90UGF0aCIsImdldFBhdGgiLCJfZ2V0VGh1bWJuYWlsUGF0aCIsInNjcmVlbnNob3RQYXRoIiwiaW1hZ2VOYW1lIiwiaW1hZ2VEaXIiLCJfdGFrZVNjcmVlbnNob3QiLCJmaWxlUGF0aCIsInBhZ2VXaWR0aCIsInBhZ2VIZWlnaHQiLCJ0YWtlU2NyZWVuc2hvdCIsIl9jYXB0dXJlIiwibWFya1NlZWQiLCJ0aHVtYm5haWxQYXRoIiwiYWRkV2FybmluZyIsIldBUk5JTkdfTUVTU0FHRSIsInNjcmVlbnNob3RSZXdyaXRpbmdFcnJvciIsInNjcmVlbnNob3QiLCJ1c2VyQWdlbnQiLCJwYXJzZWRVc2VyQWdlbnQiLCJxdWFyYW50aW5lQXR0ZW1wdCIsInRha2VuT25GYWlsIiwic2NyZWVuc2hvdHMiLCJwdXNoIiwiY2FwdHVyZUFjdGlvbiIsIm9wdGlvbnMiLCJjYXB0dXJlRXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVlLE1BQU1BLFFBQU4sQ0FBZTtBQUMxQkMsZ0JBQWFDLG1CQUFiLEVBQWtDQyxTQUFsQyxFQUE2Q0MsVUFBN0MsRUFBeURDLFdBQXpELEVBQXNFQyxVQUF0RSxFQUFrRjtBQUM5RSxhQUFLQyxPQUFMLEdBQTJCLENBQUMsQ0FBQ0wsbUJBQTdCO0FBQ0EsYUFBS0EsbUJBQUwsR0FBMkJBLG1CQUEzQjtBQUNBLGFBQUtDLFNBQUwsR0FBMkJBLFNBQTNCO0FBQ0EsYUFBS0ssUUFBTCxHQUEyQkosV0FBV0ksUUFBdEM7QUFDQSxhQUFLQyxTQUFMLEdBQTJCTCxXQUFXTSxFQUF0QztBQUNBLGFBQUtKLFVBQUwsR0FBMkJBLFVBQTNCO0FBQ0EsYUFBS0QsV0FBTCxHQUEyQkEsV0FBM0I7QUFDSDs7QUFFRCxXQUFPTSw2QkFBUCxDQUFzQ0MsYUFBdEMsRUFBcURDLGlCQUFyRCxFQUF3RUMsYUFBeEUsRUFBdUY7QUFDbkYsWUFBSUEsZ0JBQWdCRixhQUFwQixFQUNJLE9BQU9DLGlCQUFQOztBQUVKLFlBQUlBLG9CQUFvQkQsYUFBeEIsRUFDSSxPQUFPRSxhQUFQOztBQUVKLGVBQU9DLEtBQUtDLEdBQUwsQ0FBU0gsaUJB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OiJzY3JlZW5zaG90cy9jYXB0dXJlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGpvaW4gYXMgam9pblBhdGgsIGRpcm5hbWUsIGJhc2VuYW1lIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBnZW5lcmF0ZVRodW1ibmFpbCB9IGZyb20gJ3Rlc3RjYWZlLWJyb3dzZXItdG9vbHMnO1xuaW1wb3J0IGNyb3BTY3JlZW5zaG90IGZyb20gJy4vY3JvcCc7XG5pbXBvcnQgeyBlbnN1cmVEaXIgfSBmcm9tICcuLi91dGlscy9wcm9taXNpZmllZC1mdW5jdGlvbnMnO1xuaW1wb3J0IHsgaXNJblF1ZXVlLCBhZGRUb1F1ZXVlIH0gZnJvbSAnLi4vdXRpbHMvYXN5bmMtcXVldWUnO1xuaW1wb3J0IFdBUk5JTkdfTUVTU0FHRSBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5pbXBvcnQgZXNjYXBlVXNlckFnZW50IGZyb20gJy4uL3V0aWxzL2VzY2FwZS11c2VyLWFnZW50JztcbmltcG9ydCBjb3JyZWN0RmlsZVBhdGggZnJvbSAnLi4vdXRpbHMvY29ycmVjdC1maWxlLXBhdGgnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDYXB0dXJlciB7XG4gICAgY29uc3RydWN0b3IgKGJhc2VTY3JlZW5zaG90c1BhdGgsIHRlc3RFbnRyeSwgY29ubmVjdGlvbiwgcGF0aFBhdHRlcm4sIHdhcm5pbmdMb2cpIHtcbiAgICAgICAgdGhpcy5lbmFibGVkICAgICAgICAgICAgID0gISFiYXNlU2NyZWVuc2hvdHNQYXRoO1xuICAgICAgICB0aGlzLmJhc2VTY3JlZW5zaG90c1BhdGggPSBiYXNlU2NyZWVuc2hvdHNQYXRoO1xuICAgICAgICB0aGlzLnRlc3RFbnRyeSAgICAgICAgICAgPSB0ZXN0RW50cnk7XG4gICAgICAgIHRoaXMucHJvdmlkZXIgICAgICAgICAgICA9IGNvbm5lY3Rpb24ucHJvdmlkZXI7XG4gICAgICAgIHRoaXMuYnJvd3NlcklkICAgICAgICAgICA9IGNvbm5lY3Rpb24uaWQ7XG4gICAgICAgIHRoaXMud2FybmluZ0xvZyAgICAgICAgICA9IHdhcm5pbmdMb2c7XG4gICAgICAgIHRoaXMucGF0aFBhdHRlcm4gICAgICAgICA9IHBhdGhQYXR0ZXJuO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZ2V0RGltZW5zaW9uV2l0aG91dFNjcm9sbGJhciAoZnVsbERpbWVuc2lvbiwgZG9jdW1lbnREaW1lbnNpb24sIGJvZHlEaW1lbnNpb24pIHtcbiAgICAgICAgaWYgKGJvZHlEaW1lbnNpb24gPiBmdWxsRGltZW5zaW9uKVxuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50RGltZW5zaW9uO1xuXG4gICAgICAgIGlmIChkb2N1bWVudERpbWVuc2lvbiA+IGZ1bGxEaW1lbnNpb24pXG4gICAgICAgICAgICByZXR1cm4gYm9keURpbWVuc2lvbjtcblxuICAgICAgICByZXR1cm4gTWF0aC5tYXgoZG9jdW1lbnREaW1lbnNpb24sIGJvZHlEaW1lbnNpb24pO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZ2V0Q3JvcERpbWVuc2lvbnMgKGNyb3BEaW1lbnNpb25zLCBwYWdlRGltZW5zaW9ucykge1xuICAgICAgICBpZiAoIWNyb3BEaW1lbnNpb25zIHx8ICFwYWdlRGltZW5zaW9ucylcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IHsgZHByIH0gICAgICAgICAgICAgICAgICAgICAgPSBwYWdlRGltZW5zaW9ucztcbiAgICAgICAgY29uc3QgeyB0b3AsIGxlZnQsIGJvdHRvbSwgcmlnaHQgfSA9IGNyb3BEaW1lbnNpb25zO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0b3A6ICAgIE1hdGgucm91bmQodG9wICogZHByKSxcbiAgICAgICAgICAgIGxlZnQ6ICAgTWF0aC5yb3VuZChsZWZ0ICogZHByKSxcbiAgICAgICAgICAgIGJvdHRvbTogTWF0aC5yb3VuZChib3R0b20gKiBkcHIpLFxuICAgICAgICAgICAgcmlnaHQ6ICBNYXRoLnJvdW5kKHJpZ2h0ICogZHByKVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHN0YXRpYyBfZ2V0Q2xpZW50QXJlYURpbWVuc2lvbnMgKHBhZ2VEaW1lbnNpb25zKSB7XG4gICAgICAgIGlmICghcGFnZURpbWVuc2lvbnMpXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCB7IGlubmVyV2lkdGgsIGRvY3VtZW50V2lkdGgsIGJvZHlXaWR0aCwgaW5uZXJIZWlnaHQsIGRvY3VtZW50SGVpZ2h0LCBib2R5SGVpZ2h0LCBkcHIgfSA9IHBhZ2VEaW1lbnNpb25zO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB3aWR0aDogIE1hdGguZmxvb3IoQ2FwdHVyZXIuX2dldERpbWVuc2lvbldpdGhvdXRTY3JvbGxiYXIoaW5uZXJXaWR0aCwgZG9jdW1lbnRXaWR0aCwgYm9keVdpZHRoKSAqIGRwciksXG4gICAgICAgICAgICBoZWlnaHQ6IE1hdGguZmxvb3IoQ2FwdHVyZXIuX2dldERpbWVuc2lvbldpdGhvdXRTY3JvbGxiYXIoaW5uZXJIZWlnaHQsIGRvY3VtZW50SGVpZ2h0LCBib2R5SGVpZ2h0KSAqIGRwcilcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfam9pbldpdGhCYXNlU2NyZWVuc2hvdFBhdGggKHBhdGgpIHtcbiAgICAgICAgcmV0dXJuIGpvaW5QYXRoKHRoaXMuYmFzZVNjcmVlbnNob3RzUGF0aCwgcGF0aCk7XG4gICAgfVxuXG4gICAgX3VwZGF0ZVNjcmVlbnNob3RQYXRoRm9yVGVzdEVudHJ5IChjdXN0b21QYXRoKSB7XG4gICAgICAgIC8vIE5PVEU6IGlmIHRlc3QgY29udGFpbnMgdGFrZVNjcmVlbnNob3QgYWN0aW9uIHdpdGggY3VzdG9tIHBhdGhcbiAgICAgICAgLy8gd2Ugc2hvdWxkIHNwZWNpZnkgdGhlIG1vc3QgY29tbW9uIHNjcmVlbnNob3QgZm9sZGVyIGluIHJlcG9ydFxuICAgICAgICBsZXQgc2NyZWVuc2hvdFBhdGhGb3JUZXN0RW50cnkgPSB0aGlzLmJhc2VTY3JlZW5zaG90c1BhdGg7XG5cbiAgICAgICAgaWYgKCFjdXN0b21QYXRoKSB7XG4gICAgICAgICAgICBjb25zdCBwYXRoRm9yUmVwb3J0ID0gdGhpcy5wYXRoUGF0dGVybi5nZXRQYXRoRm9yUmVwb3J0KCk7XG5cbiAgICAgICAgICAgIHNjcmVlbnNob3RQYXRoRm9yVGVzdEVudHJ5ID0gdGhpcy5fam9pbldpdGhCYXNlU2NyZWVuc2hvdFBhdGgocGF0aEZvclJlcG9ydCk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIHRoaXMudGVzdEVudHJ5LnBhdGggPSBzY3JlZW5zaG90UGF0aEZvclRlc3RFbnRyeTtcbiAgICB9XG5cbiAgICBfaW5jcmVtZW50RmlsZUluZGV4ZXMgKGZvckVycm9yKSB7XG4gICAgICAgIGlmIChmb3JFcnJvcilcbiAgICAgICAgICAgIHRoaXMucGF0aFBhdHRlcm4uZGF0YS5lcnJvckZpbGVJbmRleCsrO1xuXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRoaXMucGF0aFBhdHRlcm4uZGF0YS5maWxlSW5kZXgrKztcbiAgICB9XG5cbiAgICBfZ2V0Q3VzdG9tU2NyZWVuc2hvdFBhdGggKGN1c3RvbVBhdGgpIHtcbiAgICAgICAgY29uc3QgY29ycmVjdGVkQ3VzdG9tUGF0aCA9IGNvcnJlY3RGaWxlUGF0aChjdXN0b21QYXRoKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fam9pbldpdGhCYXNlU2NyZWVuc2hvdFBhdGgoY29ycmVjdGVkQ3VzdG9tUGF0aCk7XG4gICAgfVxuXG4gICAgX2dldFNjcmVlbnNob3RQYXRoIChmb3JFcnJvcikge1xuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5wYXRoUGF0dGVybi5nZXRQYXRoKGZvckVycm9yKTtcblxuICAgICAgICB0aGlzLl9pbmNyZW1lbnRGaWxlSW5kZXhlcyhmb3JFcnJvcik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2pvaW5XaXRoQmFzZVNjcmVlbnNob3RQYXRoKHBhdGgpO1xuICAgIH1cblxuICAgIF9nZXRUaHVtYm5haWxQYXRoIChzY3JlZW5zaG90UGF0aCkge1xuICAgICAgICBjb25zdCBpbWFnZU5hbWUgPSBiYXNlbmFtZShzY3JlZW5zaG90UGF0aCk7XG4gICAgICAgIGNvbnN0IGltYWdlRGlyICA9IGRpcm5hbWUoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgICAgIHJldHVybiBqb2luUGF0aChpbWFnZURpciwgJ3RodW1ibmFpbHMnLCBpbWFnZU5hbWUpO1xuICAgIH1cblxuICAgIGFzeW5jIF90YWtlU2NyZWVuc2hvdCAoZmlsZVBhdGgsIHBhZ2VXaWR0aCwgcGFnZUhlaWdodCkge1xuICAgICAgICBhd2FpdCBlbnN1cmVEaXIoZGlybmFtZShmaWxlUGF0aCkpO1xuICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVyLnRha2VTY3JlZW5zaG90KHRoaXMuYnJvd3NlcklkLCBmaWxlUGF0aCwgcGFnZVdpZHRoLCBwYWdlSGVpZ2h0KTtcbiAgICB9XG5cbiAgICBhc3luYyBfY2FwdHVyZSAoZm9yRXJyb3IsIHsgcGFnZURpbWVuc2lvbnMsIGNyb3BEaW1lbnNpb25zLCBtYXJrU2VlZCwgY3VzdG9tUGF0aCB9ID0ge30pIHtcbiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQpXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcblxuICAgICAgICBjb25zdCBzY3JlZW5zaG90UGF0aCA9IGN1c3RvbVBhdGggPyB0aGlzLl9nZXRDdXN0b21TY3JlZW5zaG90UGF0aChjdXN0b21QYXRoKSA6IHRoaXMuX2dldFNjcmVlbnNob3RQYXRoKGZvckVycm9yKTtcbiAgICAgICAgY29uc3QgdGh1bWJuYWlsUGF0aCAgPSB0aGlzLl9nZXRUaHVtYm5haWxQYXRoKHNjcmVlbnNob3RQYXRoKTtcblxuICAgICAgICBpZiAoaXNJblF1ZXVlKHNjcmVlbnNob3RQYXRoKSlcbiAgICAgICAgICAgIHRoaXMud2FybmluZ0xvZy5hZGRXYXJuaW5nKFdBUk5JTkdfTUVTU0FHRS5zY3JlZW5zaG90UmV3cml0aW5nRXJyb3IsIHNjcmVlbnNob3RQYXRoKTtcblxuICAgICAgICBhd2FpdCBhZGRUb1F1ZXVlKHNjcmVlbnNob3RQYXRoLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl90YWtlU2NyZWVuc2hvdChzY3JlZW5zaG90UGF0aCwgLi4uIHBhZ2VEaW1lbnNpb25zID8gW3BhZ2VEaW1lbnNpb25zLmlubmVyV2lkdGgsIHBhZ2VEaW1lbnNpb25zLmlubmVySGVpZ2h0XSA6IFtdKTtcblxuICAgICAgICAgICAgYXdhaXQgY3JvcFNjcmVlbnNob3Qoc2NyZWVuc2hvdFBhdGgsIG1hcmtTZWVkLCBDYXB0dXJlci5fZ2V0Q2xpZW50QXJlYURpbWVuc2lvbnMocGFnZURpbWVuc2lvbnMpLCBDYXB0dXJlci5fZ2V0Q3JvcERpbWVuc2lvbnMoY3JvcERpbWVuc2lvbnMsIHBhZ2VEaW1lbnNpb25zKSk7XG5cbiAgICAgICAgICAgIGF3YWl0IGdlbmVyYXRlVGh1bWJuYWlsKHNjcmVlbnNob3RQYXRoLCB0aHVtYm5haWxQYXRoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fdXBkYXRlU2NyZWVuc2hvdFBhdGhGb3JUZXN0RW50cnkoY3VzdG9tUGF0aCk7XG5cbiAgICAgICAgY29uc3Qgc2NyZWVuc2hvdCA9IHtcbiAgICAgICAgICAgIHNjcmVlbnNob3RQYXRoLFxuICAgICAgICAgICAgdGh1bWJuYWlsUGF0aCxcbiAgICAgICAgICAgIHVzZXJBZ2VudDogICAgICAgICBlc2NhcGVVc2VyQWdlbnQodGhpcy5wYXRoUGF0dGVybi5kYXRhLnBhcnNlZFVzZXJBZ2VudCksXG4gICAgICAgICAgICBxdWFyYW50aW5lQXR0ZW1wdDogdGhpcy5wYXRoUGF0dGVybi5kYXRhLnF1YXJhbnRpbmVBdHRlbXB0LFxuICAgICAgICAgICAgdGFrZW5PbkZhaWw6ICAgICAgIGZvckVycm9yLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMudGVzdEVudHJ5LnNjcmVlbnNob3RzLnB1c2goc2NyZWVuc2hvdCk7XG5cbiAgICAgICAgcmV0dXJuIHNjcmVlbnNob3RQYXRoO1xuICAgIH1cblxuICAgIGFzeW5jIGNhcHR1cmVBY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2NhcHR1cmUoZmFsc2UsIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIGFzeW5jIGNhcHR1cmVFcnJvciAob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fY2FwdHVyZSh0cnVlLCBvcHRpb25zKTtcbiAgICB9XG59XG5cbiJdfQ==
