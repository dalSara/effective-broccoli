'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _events = require('events');

var _lodash = require('lodash');

var _testRunController = require('./test-run-controller');

var _testRunController2 = _interopRequireDefault(_testRunController);

var _sessionController = require('../test-run/session-controller');

var _sessionController2 = _interopRequireDefault(_sessionController);

var _browserJobResult = require('./browser-job-result');

var _browserJobResult2 = _interopRequireDefault(_browserJobResult);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Browser job
class BrowserJob extends _events.EventEmitter {
    constructor(tests, browserConnections, proxy, screenshots, warningLog, fixtureHookController, opts) {
        super();

        this.started = false;

        this.total = 0;
        this.passed = 0;
        this.opts = opts;
        this.proxy = proxy;
        this.browserConnections = browserConnections;
        this.screenshots = screenshots;
        this.warningLog = warningLog;
        this.fixtureHookController = fixtureHookController;
        this.result = null;

        this.testRunControllerQueue = tests.map((test, index) => this._createTestRunController(test, index));

        this.completionQueue = [];

        this.connectionErrorListener = error => this._setResult(_browserJobResult2.default.errored, error);

        this.browserConnections.map(bc => bc.once('error', this.connectionErrorListener));
    }

    _createTestRunController(test, index) {
        var testRunController = new _testRunController2.default(test, index + 1, this.proxy, this.screenshots, this.warningLog, this.fixtureHookController, this.opts);

        testRunController.on('test-run-start', () => this.emit('test-run-start', testRunController.testRun));
        testRunController.on('test-run-restart', () => this._onTestRunRestart(testRunController));
        testRunController.on('test-run-done', () => this._onTestRunDone(testRunController));

        return testRunController;
    }

    _setResult(status, data) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this.result) return;

            _this.result = { status, data };

            _this.browserConnections.forEach(function (bc) {
                return bc.removeListener('error', _this.connectionErrorListener);
            });

            yield _pinkie2.default.all(_this.browserConnections.map(function (bc) {
                return bc.reportJobResult(_this.result.status, _this.result.data);
            }));
        })();
    }

    _addToCompletionQueue(testRunInfo) {
        this.completionQueue.push(testRunInfo);
    }

    _removeFromCompletionQueue(testRunInfo) {
        (0, _lodash.remove)(this.completionQueue, testRunInfo);
    }

    _onTestRunRestart(testRunController) {
        this._removeFromCompletionQueue(testRunController);
        this.testRunControllerQueue.unshift(testRunController);
    }

    _onTestRunDone(testRunController) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this2.total++;

            if (!testRunController.testRun.errs.length) _this2.passed++;

            while (_this2.completionQueue.length && _this2.completionQueue[0].done) {
                testRunController = _this2.completionQueue.shift();

                _this2.emit('test-run-done', testRunController.testRun);
            }

            if (!_this2.completionQueue.length && !_this2.hasQueuedTestRuns) {
                _sessionController2.default.closeSession(testRunController.testRun);

                _this2._setResult(_browserJobResult2.default.done, { total: _this2.total, passed: _this2.passed }).then(function () {
                    return _this2.emit('done');
                });
            }
        })();
    }

    // API
    get hasQueuedTestRuns() {
        return !!this.testRunControllerQueue.length;
    }

    popNextTestRunUrl(connection) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            while (_this3.testRunControllerQueue.length) {
                // NOTE: before hook for test run fixture is currently
                // executing, so test run is temporary blocked
                if (_this3.testRunControllerQueue[0].blocked) break;

                var testRunController = _this3.testRunControllerQueue.shift();

                _this3._addToCompletionQueue(testRunController);

                if (!_this3.started) {
                    _this3.started = true;
                    _this3.emit('start');
                }

                var testRunUrl = yield testRunController.start(connection);

                if (testRunUrl) return testRunUrl;
            }

            return null;
        })();
    }

    abort() {
        this.removeAllListeners();
        this._setResult(_browserJobResult2.default.aborted);
        this.browserConnections.map(bc => bc.removeJob(this));
    }
}
exports.default = BrowserJob;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvYnJvd3Nlci1qb2IuanMiXSwibmFtZXMiOlsiQnJvd3NlckpvYiIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwidGVzdHMiLCJicm93c2VyQ29ubmVjdGlvbnMiLCJwcm94eSIsInNjcmVlbnNob3RzIiwid2FybmluZ0xvZyIsImZpeHR1cmVIb29rQ29udHJvbGxlciIsIm9wdHMiLCJzdGFydGVkIiwidG90YWwiLCJwYXNzZWQiLCJyZXN1bHQiLCJ0ZXN0UnVuQ29udHJvbGxlclF1ZXVlIiwibWFwIiwidGVzdCIsImluZGV4IiwiX2NyZWF0ZVRlc3RSdW5Db250cm9sbGVyIiwiY29tcGxldGlvblF1ZXVlIiwiY29ubmVjdGlvbkVycm9yTGlzdGVuZXIiLCJlcnJvciIsIl9zZXRSZXN1bHQiLCJSRVNVTFQiLCJlcnJvcmVkIiwiYmMiLCJvbmNlIiwidGVzdFJ1bkNvbnRyb2xsZXIiLCJUZXN0UnVuQ29udHJvbGxlciIsIm9uIiwiZW1pdCIsInRlc3RSdW4iLCJfb25UZXN0UnVuUmVzdGFydCIsIl9vblRlc3RSdW5Eb25lIiwic3RhdHVzIiwiZGF0YSIsImZvckVhY2giLCJyZW1vdmVMaXN0ZW5lciIsIlByb21pc2UiLCJhbGwiLCJyZXBvcnRKb2JSZXN1bHQiLCJfYWRkVG9Db21wbGV0aW9uUXVldWUiLCJ0ZXN0UnVuSW5mbyIsInB1c2giLCJfcmVtb3ZlRnJvbUNvbXBsZXRpb25RdWV1ZSIsInVuc2hpZnQiLCJlcnJzIiwibGVuZ3RoIiwiZG9uZSIsInNoaWZ0IiwiaGFzUXVldWVkVGVzdFJ1bnMiLCJTZXNzaW9uQ29udHJvbGxlciIsImNsb3NlU2Vzc2lvbiIsInRoZW4iLCJwb3BOZXh0VGVzdFJ1blVybCIsImNvbm5lY3Rpb24iLCJibG9ja2VkIiwidGVzdFJ1blVybCIsInN0YXJ0IiwiYWJvcnQiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJhYm9ydGVkIiwicmVtb3ZlSm9iIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFHQTtBQUNlLE1BQU1BLFVBQU4sU0FBeUJDLG9CQUF6QixDQUFzQztBQUNqREMsZ0JBQWFDLEtBQWIsRUFBb0JDLGtCQUFwQixFQUF3Q0MsS0FBeEMsRUFBK0NDLFdBQS9DLEVBQTREQyxVQUE1RCxFQUF3RUMscUJBQXhFLEVBQStGQyxJQUEvRixFQUFxRztBQUNqRzs7QUFFQSxhQUFLQyxPQUFMLEdBQWUsS0FBZjs7QUFFQSxhQUFLQyxLQUFMLEdBQTZCLENBQTdCO0FBQ0EsYUFBS0MsTUFBTCxHQUE2QixDQUE3QjtBQUNBLGFBQUtILElBQUwsR0FBNkJBLElBQTdCO0FBQ0EsYUFBS0osS0FBTCxHQUE2QkEsS0FBN0I7QUFDQSxhQUFLRCxrQkFBTCxHQUE2QkEsa0JBQTdCO0FBQ0EsYUFBS0UsV0FBTCxHQUE2QkEsV0FBN0I7QUFDQSxhQUFLQyxVQUFMLEdBQTZCQSxVQUE3QjtBQUNBLGFBQUtDLHFCQUFMLEdBQTZCQSxxQkFBN0I7QUFDQSxhQUFLSyxNQUFMLEdBQTZCLElBQTdCOztBQUVBLGFBQUtDLHNCQUFMLEdBQThCWCxNQUFNWSxHQUFOLENBQVUsQ0FBQ0MsSUFBRCxFQUFPQyxLQUFQLEtBQWlCLEtBQUtDLHdCQUFMLENBQThCRixJQUE5QixFQUFvQ0MsS0FBcEMsQ0FBM0IsQ0FBOUI7O0FBRUEsYUFBS0UsZUFBTCxHQUF1QixFQUF2Qjs7QUFFQSxhQUFLQyx1QkFBTCxHQUErQkMsU0FBUyxLQUFLQyxVQUFMLENBQWdCQywyQkFBT0MsT0FBdkIsRUFBZ0NILEtBQWhDLENBQXhDOztBQUVBLGFBQUtqQixrQkFBTCxDQUF3QlcsR0FBeEIsQ0FBNEJVLE1BQU1BLEdBQUdDLElBQUgsQ0FBUSxPQUFSLEVBQWlCLEtBQUtOLHVCQUF0QixDQUFsQztBQUNIOztBQUVERiw2QkFBMEJGLElBQTFCLEVBQWdDQyxLQUFoQyxFQUF1QztBQUNuQyxZQUFJVSxvQkFBb0IsSUFBSUMsMkJBQUosQ0FBc0JaLElBQXRCLEVBQTRCQyxRQUFRLENBQXBDLEVBQXVDLEtBQUtaLEtBQTVDLEVBQW1ELEtBQUtDLFdBQXhELEVBQXFFLEtBQUtDLFVBQTFFLEVBQ3BCLEtBQUtDLHFCQURlLEVBQ1EsS0FBS0MsSUFEYixDQUF4Qjs7QUFHQWtCLDBCQUFrQkUsRUFBbEIsQ0FBcUIsZ0JBQXJCLEVBQXVDLE1BQU0sS0FBS0MsSUFBTCxDQUFVLGdCQUFWLEVBQTRCSCxrQkFBa0JJLE9BQTlDLENBQTdDO0FBQ0FKLDBCQUFrQkUsRUFBbEIsQ0FBcUIsa0JBQXJCLEVBQXlDLE1BQU0sS0FBS0csaUJBQUwsQ0FBdUJMLGlCQUF2QixDQUEvQztBQUNBQSwwQkFBa0JFLEVBQWxCLENBQXFCLGVBQXJCLEVBQXNDLE1BQU0sS0FBS0ksY0FBTCxDQUFvQk4saUJBQXBCLENBQTVDOztBQUVBLGVBQU9BLGlCQUFQO0FBQ0g7O0FBRUtMLGNBQU4sQ0FBa0JZLE1BQWxCLEVBQTBCQyxJQUExQixFQUFnQztBQUFBOztBQUFBO0FBQzVCLGdCQUFJLE1BQUt0QixNQUFULEVBQ0k7O0FBRUosa0JBQUtBLE1BQUwsR0FBYyxFQUFFcUIsTUFBRixFQUFVQyxJQUFWLEVBQWQ7O0FBRUEsa0JBQUsvQixrQkFBTCxDQUF3QmdDLE9BQXhCLENBQWdDO0FBQUEsdUJBQU1YLEdBQUdZLGNBQUgsQ0FBa0IsT0FBbEIsRUFBMkIsTUFBS2pCLHVCQUFoQyxDQUFOO0FBQUEsYUFBaEM7O0FBRUEsa0JBQU1rQixpQkFBUUMsR0FBUixDQUFZLE1BQUtuQyxrQkFBTCxDQUF3QlcsR0FBeEIsQ0FBNEI7QUFBQSx1QkFBTVUsR0FBR2UsZUFBSCxDQUFtQixNQUFLM0IsTUFBTCxDQUFZcUIsTUFBL0IsRUFBdUMsTUFBS3JCLE1BQUwsQ0FBWXNCLElBQW5ELENBQU47QUFBQSxhQUE1QixDQUFaLENBQU47QUFSNEI7QUFTL0I7O0FBRURNLDBCQUF1QkMsV0FBdkIsRUFBb0M7QUFDaEMsYUFBS3ZCLGVBQUwsQ0FBcUJ3QixJQUFyQixDQUEwQkQsV0FBMUI7QUFDSDs7QUFFREUsK0JBQTRCRixXQUE1QixFQUF5QztBQUNyQyw0QkFBTyxLQUFLdkIsZUFBWixFQUE2QnVCLFdBQTdCO0FBQ0g7O0FBRURWLHNCQUFtQkwsaUJBQW5CLEVBQXNDO0FBQ2xDLGFBQUtpQiwwQkFBTCxDQUFnQ2pCLGlCQUFoQztBQUNBLGFBQUtiLHNCQUFMLENBQTRCK0IsT0FBNUIsQ0FBb0NsQixpQkFBcEM7QUFDSDs7QUFFS00sa0JBQU4sQ0FBc0JOLGlCQUF0QixFQUF5QztBQUFBOztBQUFBO0FBQ3JDLG1CQUFLaEIsS0FBTDs7QUFFQSxnQkFBSSxDQUFDZ0Isa0JBQWtCSSxPQUFsQixDQUEwQmUsSUFBMUIsQ0FBK0JDLE1BQXBDLEVBQ0ksT0FBS25DLE1BQUw7O0FBRUosbUJBQU8sT0FBS08sZUFBTCxDQUFxQjRCLE1BQXJCLElBQStCLE9BQUs1QixlQUFMLENBQXFCLENBQXJCLEVBQXdCNkIsSUFBOUQsRUFBb0U7QUFDaEVyQixvQ0FBb0IsT0FBS1IsZUFBTCxDQUFxQjhCLEtBQXJCLEVBQXBCOztBQUVBLHVCQUFLbkIsSUFBTCxDQUFVLGVBQVYsRUFBMkJILGtCQUFrQkksT0FBN0M7QUFDSDs7QUFFRCxnQkFBSSxDQUFDLE9BQUtaLGVBQUwsQ0FBcUI0QixNQUF0QixJQUFnQyxDQUFDLE9BQUtHLGlCQUExQyxFQUE2RDtBQUN6REMsNENBQWtCQyxZQUFsQixDQUErQnpCLGtCQUFrQkksT0FBakQ7O0FBRUEsdUJBQ0tULFVBREwsQ0FDZ0JDLDJCQUFPeUIsSUFEdkIsRUFDNkIsRUFBRXJDLE9BQU8sT0FBS0EsS0FBZCxFQUFxQkMsUUFBUSxPQUFLQSxNQUFsQyxFQUQ3QixFQUVLeUMsSUFGTCxDQUVVO0FBQUEsMkJBQU0sT0FBS3ZCLElBQUwsQ0FBVSxNQUFWLENBQU47QUFBQSxpQkFGVjtBQUdIO0FBbEJvQztBQW1CeEM7O0FBRUQ7QUFDQSxRQUFJb0IsaUJBQUosR0FBeUI7QUFDckIsZUFBTyxDQUFDLENBQUMsS0FBS3BDLHNCQUFMLENBQTRCaUMsTUFBckM7QUFDSDs7QUFFS08scUJBQU4sQ0FBeUJDLFVBQXpCLEVBQXFDO0FBQUE7O0FBQUE7QUFDakMsbUJBQU8sT0FBS3pDLHNCQUFMLENBQTRCaUMsTUFBbkMsRUFBMkM7QUFDdkM7QUFDQTtBQUNBLG9CQUFJLE9BQUtqQyxzQkFBTCxDQUE0QixDQUE1QixFQUErQjBDLE9BQW5DLEVBQ0k7O0FBRUosb0JBQUk3QixvQkFBb0IsT0FBS2Isc0JBQUwsQ0FBNEJtQyxLQUE1QixFQUF4Qjs7QUFFQSx1QkFBS1IscUJBQUwsQ0FBMkJkLGlCQUEzQjs7QUFFQSxvQkFBSSxDQUFDLE9BQUtqQixPQUFWLEVBQW1CO0FBQ2YsMkJBQUtBLE9BQUwsR0FBZSxJQUFmO0FBQ0EsMkJBQUtvQixJQUFMLENBQVUsT0FBVjtBQUNIOztBQUVELG9CQUFJMkIsYUFBYSxNQUFNOUIsa0JBQWtCK0IsS0FBbEIsQ0FBd0JILFVBQXhCLENBQXZCOztBQUVBLG9CQUFJRSxVQUFKLEVBQ0ksT0FBT0EsVUFBUDtBQUNQOztBQUVELG1CQUFPLElBQVA7QUF0QmlDO0FBdUJwQzs7QUFFREUsWUFBUztBQUNMLGFBQUtDLGtCQUFMO0FBQ0EsYUFBS3RDLFVBQUwsQ0FBZ0JDLDJCQUFPc0MsT0FBdkI7QUFDQSxhQUFLekQsa0JBQUwsQ0FBd0JXLEdBQXhCLENBQTRCVSxNQUFNQSxHQUFHcUMsU0FBSCxDQUFhLElBQWIsQ0FBbEM7QUFDSDtBQW5IZ0Q7a0JBQWhDOUQsVSIsImZpbGUiOiJydW5uZXIvYnJvd3Nlci1qb2IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgVGVzdFJ1bkNvbnRyb2xsZXIgZnJvbSAnLi90ZXN0LXJ1bi1jb250cm9sbGVyJztcbmltcG9ydCBTZXNzaW9uQ29udHJvbGxlciBmcm9tICcuLi90ZXN0LXJ1bi9zZXNzaW9uLWNvbnRyb2xsZXInO1xuaW1wb3J0IFJFU1VMVCBmcm9tICcuL2Jyb3dzZXItam9iLXJlc3VsdCc7XG5cblxuLy8gQnJvd3NlciBqb2JcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJyb3dzZXJKb2IgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yICh0ZXN0cywgYnJvd3NlckNvbm5lY3Rpb25zLCBwcm94eSwgc2NyZWVuc2hvdHMsIHdhcm5pbmdMb2csIGZpeHR1cmVIb29rQ29udHJvbGxlciwgb3B0cykge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuXG4gICAgICAgIHRoaXMudG90YWwgICAgICAgICAgICAgICAgID0gMDtcbiAgICAgICAgdGhpcy5wYXNzZWQgICAgICAgICAgICAgICAgPSAwO1xuICAgICAgICB0aGlzLm9wdHMgICAgICAgICAgICAgICAgICA9IG9wdHM7XG4gICAgICAgIHRoaXMucHJveHkgICAgICAgICAgICAgICAgID0gcHJveHk7XG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zICAgID0gYnJvd3NlckNvbm5lY3Rpb25zO1xuICAgICAgICB0aGlzLnNjcmVlbnNob3RzICAgICAgICAgICA9IHNjcmVlbnNob3RzO1xuICAgICAgICB0aGlzLndhcm5pbmdMb2cgICAgICAgICAgICA9IHdhcm5pbmdMb2c7XG4gICAgICAgIHRoaXMuZml4dHVyZUhvb2tDb250cm9sbGVyID0gZml4dHVyZUhvb2tDb250cm9sbGVyO1xuICAgICAgICB0aGlzLnJlc3VsdCAgICAgICAgICAgICAgICA9IG51bGw7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuQ29udHJvbGxlclF1ZXVlID0gdGVzdHMubWFwKCh0ZXN0LCBpbmRleCkgPT4gdGhpcy5fY3JlYXRlVGVzdFJ1bkNvbnRyb2xsZXIodGVzdCwgaW5kZXgpKTtcblxuICAgICAgICB0aGlzLmNvbXBsZXRpb25RdWV1ZSA9IFtdO1xuXG4gICAgICAgIHRoaXMuY29ubmVjdGlvbkVycm9yTGlzdGVuZXIgPSBlcnJvciA9PiB0aGlzLl9zZXRSZXN1bHQoUkVTVUxULmVycm9yZWQsIGVycm9yKTtcblxuICAgICAgICB0aGlzLmJyb3dzZXJDb25uZWN0aW9ucy5tYXAoYmMgPT4gYmMub25jZSgnZXJyb3InLCB0aGlzLmNvbm5lY3Rpb25FcnJvckxpc3RlbmVyKSk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVRlc3RSdW5Db250cm9sbGVyICh0ZXN0LCBpbmRleCkge1xuICAgICAgICB2YXIgdGVzdFJ1bkNvbnRyb2xsZXIgPSBuZXcgVGVzdFJ1bkNvbnRyb2xsZXIodGVzdCwgaW5kZXggKyAxLCB0aGlzLnByb3h5LCB0aGlzLnNjcmVlbnNob3RzLCB0aGlzLndhcm5pbmdMb2csXG4gICAgICAgICAgICB0aGlzLmZpeHR1cmVIb29rQ29udHJvbGxlciwgdGhpcy5vcHRzKTtcblxuICAgICAgICB0ZXN0UnVuQ29udHJvbGxlci5vbigndGVzdC1ydW4tc3RhcnQnLCAoKSA9PiB0aGlzLmVtaXQoJ3Rlc3QtcnVuLXN0YXJ0JywgdGVzdFJ1bkNvbnRyb2xsZXIudGVzdFJ1bikpO1xuICAgICAgICB0ZXN0UnVuQ29udHJvbGxlci5vbigndGVzdC1ydW4tcmVzdGFydCcsICgpID0+IHRoaXMuX29uVGVzdFJ1blJlc3RhcnQodGVzdFJ1bkNvbnRyb2xsZXIpKTtcbiAgICAgICAgdGVzdFJ1bkNvbnRyb2xsZXIub24oJ3Rlc3QtcnVuLWRvbmUnLCAoKSA9PiB0aGlzLl9vblRlc3RSdW5Eb25lKHRlc3RSdW5Db250cm9sbGVyKSk7XG5cbiAgICAgICAgcmV0dXJuIHRlc3RSdW5Db250cm9sbGVyO1xuICAgIH1cblxuICAgIGFzeW5jIF9zZXRSZXN1bHQgKHN0YXR1cywgZGF0YSkge1xuICAgICAgICBpZiAodGhpcy5yZXN1bHQpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5yZXN1bHQgPSB7IHN0YXR1cywgZGF0YSB9O1xuXG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zLmZvckVhY2goYmMgPT4gYmMucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgdGhpcy5jb25uZWN0aW9uRXJyb3JMaXN0ZW5lcikpO1xuXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zLm1hcChiYyA9PiBiYy5yZXBvcnRKb2JSZXN1bHQodGhpcy5yZXN1bHQuc3RhdHVzLCB0aGlzLnJlc3VsdC5kYXRhKSkpO1xuICAgIH1cblxuICAgIF9hZGRUb0NvbXBsZXRpb25RdWV1ZSAodGVzdFJ1bkluZm8pIHtcbiAgICAgICAgdGhpcy5jb21wbGV0aW9uUXVldWUucHVzaCh0ZXN0UnVuSW5mbyk7XG4gICAgfVxuXG4gICAgX3JlbW92ZUZyb21Db21wbGV0aW9uUXVldWUgKHRlc3RSdW5JbmZvKSB7XG4gICAgICAgIHJlbW92ZSh0aGlzLmNvbXBsZXRpb25RdWV1ZSwgdGVzdFJ1bkluZm8pO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5SZXN0YXJ0ICh0ZXN0UnVuQ29udHJvbGxlcikge1xuICAgICAgICB0aGlzLl9yZW1vdmVGcm9tQ29tcGxldGlvblF1ZXVlKHRlc3RSdW5Db250cm9sbGVyKTtcbiAgICAgICAgdGhpcy50ZXN0UnVuQ29udHJvbGxlclF1ZXVlLnVuc2hpZnQodGVzdFJ1bkNvbnRyb2xsZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vblRlc3RSdW5Eb25lICh0ZXN0UnVuQ29udHJvbGxlcikge1xuICAgICAgICB0aGlzLnRvdGFsKys7XG5cbiAgICAgICAgaWYgKCF0ZXN0UnVuQ29udHJvbGxlci50ZXN0UnVuLmVycnMubGVuZ3RoKVxuICAgICAgICAgICAgdGhpcy5wYXNzZWQrKztcblxuICAgICAgICB3aGlsZSAodGhpcy5jb21wbGV0aW9uUXVldWUubGVuZ3RoICYmIHRoaXMuY29tcGxldGlvblF1ZXVlWzBdLmRvbmUpIHtcbiAgICAgICAgICAgIHRlc3RSdW5Db250cm9sbGVyID0gdGhpcy5jb21wbGV0aW9uUXVldWUuc2hpZnQoKTtcblxuICAgICAgICAgICAgdGhpcy5lbWl0KCd0ZXN0LXJ1bi1kb25lJywgdGVzdFJ1bkNvbnRyb2xsZXIudGVzdFJ1bik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMuY29tcGxldGlvblF1ZXVlLmxlbmd0aCAmJiAhdGhpcy5oYXNRdWV1ZWRUZXN0UnVucykge1xuICAgICAgICAgICAgU2Vzc2lvbkNvbnRyb2xsZXIuY2xvc2VTZXNzaW9uKHRlc3RSdW5Db250cm9sbGVyLnRlc3RSdW4pO1xuXG4gICAgICAgICAgICB0aGlzXG4gICAgICAgICAgICAgICAgLl9zZXRSZXN1bHQoUkVTVUxULmRvbmUsIHsgdG90YWw6IHRoaXMudG90YWwsIHBhc3NlZDogdGhpcy5wYXNzZWQgfSlcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmVtaXQoJ2RvbmUnKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBUElcbiAgICBnZXQgaGFzUXVldWVkVGVzdFJ1bnMgKCkge1xuICAgICAgICByZXR1cm4gISF0aGlzLnRlc3RSdW5Db250cm9sbGVyUXVldWUubGVuZ3RoO1xuICAgIH1cblxuICAgIGFzeW5jIHBvcE5leHRUZXN0UnVuVXJsIChjb25uZWN0aW9uKSB7XG4gICAgICAgIHdoaWxlICh0aGlzLnRlc3RSdW5Db250cm9sbGVyUXVldWUubGVuZ3RoKSB7XG4gICAgICAgICAgICAvLyBOT1RFOiBiZWZvcmUgaG9vayBmb3IgdGVzdCBydW4gZml4dHVyZSBpcyBjdXJyZW50bHlcbiAgICAgICAgICAgIC8vIGV4ZWN1dGluZywgc28gdGVzdCBydW4gaXMgdGVtcG9yYXJ5IGJsb2NrZWRcbiAgICAgICAgICAgIGlmICh0aGlzLnRlc3RSdW5Db250cm9sbGVyUXVldWVbMF0uYmxvY2tlZClcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgdmFyIHRlc3RSdW5Db250cm9sbGVyID0gdGhpcy50ZXN0UnVuQ29udHJvbGxlclF1ZXVlLnNoaWZ0KCk7XG5cbiAgICAgICAgICAgIHRoaXMuX2FkZFRvQ29tcGxldGlvblF1ZXVlKHRlc3RSdW5Db250cm9sbGVyKTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLnN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnc3RhcnQnKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHRlc3RSdW5VcmwgPSBhd2FpdCB0ZXN0UnVuQ29udHJvbGxlci5zdGFydChjb25uZWN0aW9uKTtcblxuICAgICAgICAgICAgaWYgKHRlc3RSdW5VcmwpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRlc3RSdW5Vcmw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBhYm9ydCAoKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuX3NldFJlc3VsdChSRVNVTFQuYWJvcnRlZCk7XG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zLm1hcChiYyA9PiBiYy5yZW1vdmVKb2IodGhpcykpO1xuICAgIH1cbn1cbiJdfQ==
