'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _events = require('events');

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _mustache = require('mustache');

var _mustache2 = _interopRequireDefault(_mustache);

var _lodash = require('lodash');

var _useragent = require('useragent');

var _readFileRelative = require('read-file-relative');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _nanoid = require('nanoid');

var _nanoid2 = _interopRequireDefault(_nanoid);

var _command = require('./command');

var _command2 = _interopRequireDefault(_command);

var _status = require('./status');

var _status2 = _interopRequireDefault(_status);

var _runtime = require('../../errors/runtime');

var _message = require('../../errors/runtime/message');

var _message2 = _interopRequireDefault(_message);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const IDLE_PAGE_TEMPLATE = (0, _readFileRelative.readSync)('../../client/browser/idle-page/index.html.mustache');

var connections = {};

class BrowserConnection extends _events.EventEmitter {
    constructor(gateway, browserInfo, permanent) {
        super();

        this.HEARTBEAT_TIMEOUT = 2 * 60 * 1000;

        this.id = BrowserConnection._generateId();
        this.jobQueue = [];
        this.initScriptsQueue = [];
        this.browserConnectionGateway = gateway;

        this.browserInfo = browserInfo;
        this.browserInfo.userAgent = '';
        this.browserInfo.userAgentProviderMetaInfo = '';

        this.provider = browserInfo.provider;

        this.permanent = permanent;
        this.closing = false;
        this.closed = false;
        this.ready = false;
        this.opened = false;
        this.idle = true;
        this.heartbeatTimeout = null;
        this.pendingTestRunUrl = null;

        this.url = `${gateway.domain}/browser/connect/${this.id}`;
        this.idleUrl = `${gateway.domain}/browser/idle/${this.id}`;
        this.forcedIdleUrl = `${gateway.domain}/browser/idle-forced/${this.id}`;
        this.initScriptUrl = `${gateway.domain}/browser/init-script/${this.id}`;

        this.heartbeatRelativeUrl = `/browser/heartbeat/${this.id}`;
        this.statusRelativeUrl = `/browser/status/${this.id}`;
        this.statusDoneRelativeUrl = `/browser/status-done/${this.id}`;

        this.heartbeatUrl = `${gateway.domain}${this.heartbeatRelativeUrl}`;
        this.statusUrl = `${gateway.domain}${this.statusRelativeUrl}`;
        this.statusDoneUrl = `${gateway.domain}${this.statusDoneRelativeUrl}`;

        this.on('error', () => {
            this._forceIdle();
            this.close();
        });

        connections[this.id] = this;

        this.browserConnectionGateway.startServingConnection(this);

        this._runBrowser();
    }

    static _generateId() {
        return (0, _nanoid2.default)(7);
    }

    _runBrowser() {
        var _this = this;

        // NOTE: Give caller time to assign event listeners
        process.nextTick((0, _asyncToGenerator3.default)(function* () {
            try {
                yield _this.provider.openBrowser(_this.id, _this.url, _this.browserInfo.browserName);

                if (!_this.ready) yield (0, _promisifyEvent2.default)(_this, 'ready');

                _this.opened = true;
                _this.emit('opened');
            } catch (err) {
                _this.emit('error', new _runtime.GeneralError(_message2.default.unableToOpenBrowser, _this.browserInfo.providerName + ':' + _this.browserInfo.browserName, err.stack));
            }
        }));
    }

    _closeBrowser() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this2.idle) yield (0, _promisifyEvent2.default)(_this2, 'idle');

            try {
                yield _this2.provider.closeBrowser(_this2.id);
            } catch (err) {
                // NOTE: A warning would be really nice here, but it can't be done while log is stored in a task.
            }
        })();
    }

    _forceIdle() {
        if (!this.idle) {
            this.switchingToIdle = false;
            this.idle = true;
            this.emit('idle');
        }
    }

    _waitForHeartbeat() {
        this.heartbeatTimeout = setTimeout(() => {
            this.emit('error', new _runtime.GeneralError(_message2.default.browserDisconnected, this.userAgent));
        }, this.HEARTBEAT_TIMEOUT);
    }

    _getTestRunUrl(isTestDone) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (isTestDone || !_this3.pendingTestRunUrl) _this3.pendingTestRunUrl = yield _this3._popNextTestRunUrl();

            return _this3.pendingTestRunUrl;
        })();
    }

    _popNextTestRunUrl() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            while (_this4.hasQueuedJobs && !_this4.currentJob.hasQueuedTestRuns) _this4.jobQueue.shift();

            return _this4.hasQueuedJobs ? yield _this4.currentJob.popNextTestRunUrl(_this4) : null;
        })();
    }

    static getById(id) {
        return connections[id] || null;
    }

    addWarning(...args) {
        if (this.currentJob) this.currentJob.warningLog.addWarning(...args);
    }

    setProviderMetaInfo(str) {
        this.browserInfo.userAgentProviderMetaInfo = str;
    }

    get userAgent() {
        var userAgent = this.browserInfo.userAgent;

        if (this.browserInfo.userAgentProviderMetaInfo) userAgent += ` (${this.browserInfo.userAgentProviderMetaInfo})`;

        return userAgent;
    }

    get hasQueuedJobs() {
        return !!this.jobQueue.length;
    }

    get currentJob() {
        return this.jobQueue[0];
    }

    // API
    runInitScript(code) {
        return new _pinkie2.default(resolve => this.initScriptsQueue.push({ code, resolve }));
    }

    addJob(job) {
        this.jobQueue.push(job);
    }

    removeJob(job) {
        (0, _lodash.pull)(this.jobQueue, job);
    }

    close() {
        if (this.closed || this.closing) return;

        this.closing = true;

        this._closeBrowser().then(() => {
            this.browserConnectionGateway.stopServingConnection(this);
            clearTimeout(this.heartbeatTimeout);

            delete connections[this.id];

            this.ready = false;
            this.closed = true;

            this.emit('closed');
        });
    }

    establish(userAgent) {
        this.ready = true;

        const parsedUserAgent = (0, _useragent.parse)(userAgent);

        this.browserInfo.userAgent = parsedUserAgent.toString();
        this.browserInfo.fullUserAgent = userAgent;
        this.browserInfo.parsedUserAgent = parsedUserAgent;

        this._waitForHeartbeat();
        this.emit('ready');
    }

    heartbeat() {
        clearTimeout(this.heartbeatTimeout);
        this._waitForHeartbeat();

        return {
            code: this.closing ? _status2.default.closing : _status2.default.ok,
            url: this.closing ? this.idleUrl : ''
        };
    }

    renderIdlePage() {
        return _mustache2.default.render(IDLE_PAGE_TEMPLATE, {
            userAgent: this.userAgent,
            statusUrl: this.statusUrl,
            heartbeatUrl: this.heartbeatUrl,
            initScriptUrl: this.initScriptUrl
        });
    }

    getInitScript() {
        var initScriptPromise = this.initScriptsQueue[0];

        return { code: initScriptPromise ? initScriptPromise.code : null };
    }

    handleInitScriptResult(data) {
        var initScriptPromise = this.initScriptsQueue.shift();

        if (initScriptPromise) initScriptPromise.resolve(JSON.parse(data));
    }

    reportJobResult(status, data) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this5.provider.reportJobResult(_this5.id, status, data);
        })();
    }

    getStatus(isTestDone) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this6.idle && !isTestDone) {
                _this6.idle = true;
                _this6.emit('idle');
            }

            if (_this6.opened) {
                var testRunUrl = yield _this6._getTestRunUrl(isTestDone);

                if (testRunUrl) {
                    _this6.idle = false;
                    return { cmd: _command2.default.run, url: testRunUrl };
                }
            }

            return { cmd: _command2.default.idle, url: _this6.idleUrl };
        })();
    }
}
exports.default = BrowserConnection;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2Nvbm5lY3Rpb24vaW5kZXguanMiXSwibmFtZXMiOlsiSURMRV9QQUdFX1RFTVBMQVRFIiwiY29ubmVjdGlvbnMiLCJCcm93c2VyQ29ubmVjdGlvbiIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwiZ2F0ZXdheSIsImJyb3dzZXJJbmZvIiwicGVybWFuZW50IiwiSEVBUlRCRUFUX1RJTUVPVVQiLCJpZCIsIl9nZW5lcmF0ZUlkIiwiam9iUXVldWUiLCJpbml0U2NyaXB0c1F1ZXVlIiwiYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5IiwidXNlckFnZW50IiwidXNlckFnZW50UHJvdmlkZXJNZXRhSW5mbyIsInByb3ZpZGVyIiwiY2xvc2luZyIsImNsb3NlZCIsInJlYWR5Iiwib3BlbmVkIiwiaWRsZSIsImhlYXJ0YmVhdFRpbWVvdXQiLCJwZW5kaW5nVGVzdFJ1blVybCIsInVybCIsImRvbWFpbiIsImlkbGVVcmwiLCJmb3JjZWRJZGxlVXJsIiwiaW5pdFNjcmlwdFVybCIsImhlYXJ0YmVhdFJlbGF0aXZlVXJsIiwic3RhdHVzUmVsYXRpdmVVcmwiLCJzdGF0dXNEb25lUmVsYXRpdmVVcmwiLCJoZWFydGJlYXRVcmwiLCJzdGF0dXNVcmwiLCJzdGF0dXNEb25lVXJsIiwib24iLCJfZm9yY2VJZGxlIiwiY2xvc2UiLCJzdGFydFNlcnZpbmdDb25uZWN0aW9uIiwiX3J1bkJyb3dzZXIiLCJwcm9jZXNzIiwibmV4dFRpY2siLCJvcGVuQnJvd3NlciIsImJyb3dzZXJOYW1lIiwiZW1pdCIsImVyciIsIkdlbmVyYWxFcnJvciIsIk1FU1NBR0UiLCJ1bmFibGVUb09wZW5Ccm93c2VyIiwicHJvdmlkZXJOYW1lIiwic3RhY2siLCJfY2xvc2VCcm93c2VyIiwiY2xvc2VCcm93c2VyIiwic3dpdGNoaW5nVG9JZGxlIiwiX3dhaXRGb3JIZWFydGJlYXQiLCJzZXRUaW1lb3V0IiwiYnJvd3NlckRpc2Nvbm5lY3RlZCIsIl9nZXRUZXN0UnVuVXJsIiwiaXNUZXN0RG9uZSIsIl9wb3BOZXh0VGVzdFJ1blVybCIsImhhc1F1ZXVlZEpvYnMiLCJjdXJyZW50Sm9iIiwiaGFzUXVldWVkVGVzdFJ1bnMiLCJzaGlmdCIsInBvcE5leHRUZXN0UnVuVXJsIiwiZ2V0QnlJZCIsImFkZFdhcm5pbmciLCJhcmdzIiwid2FybmluZ0xvZyIsInNldFByb3ZpZGVyTWV0YUluZm8iLCJzdHIiLCJsZW5ndGgiLCJydW5Jbml0U2NyaXB0IiwiY29kZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicHVzaCIsImFkZEpvYiIsImpvYiIsInJlbW92ZUpvYiIsInRoZW4iLCJzdG9wU2VydmluZ0Nvbm5lY3Rpb24iLCJjbGVhclRpbWVvdXQiLCJlc3RhYmxpc2giLCJwYXJzZWRVc2VyQWdlbnQiLCJ0b1N0cmluZyIsImZ1bGxVc2VyQWdlbnQiLCJoZWFydGJlYXQiLCJTVEFUVVMiLCJvayIsInJlbmRlcklkbGVQYWdlIiwiTXVzdGFjaGUiLCJyZW5kZXIiLCJnZXRJbml0U2NyaXB0IiwiaW5pdFNjcmlwdFByb21pc2UiLCJoYW5kbGVJbml0U2NyaXB0UmVzdWx0IiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsInJlcG9ydEpvYlJlc3VsdCIsInN0YXR1cyIsImdldFN0YXR1cyIsInRlc3RSdW5VcmwiLCJjbWQiLCJDT01NQU5EIiwicnVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxxQkFBcUIsZ0NBQUssb0RBQUwsQ0FBM0I7O0FBRUEsSUFBSUMsY0FBYyxFQUFsQjs7QUFFZSxNQUFNQyxpQkFBTixTQUFnQ0Msb0JBQWhDLENBQTZDO0FBQ3hEQyxnQkFBYUMsT0FBYixFQUFzQkMsV0FBdEIsRUFBbUNDLFNBQW5DLEVBQThDO0FBQzFDOztBQUVBLGFBQUtDLGlCQUFMLEdBQXlCLElBQUksRUFBSixH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QUtqRixJQUFMLEdBQVksS0FBWjtBQUNBLDJCQUFPLEVBQUVrRixLQUFLQyxrQkFBUUMsR0FBZixFQUFvQmpGLEtBQUs4RSxVQUF6QixFQUFQO0FBQ0g7QUFDSjs7QUFFRCxtQkFBTyxFQUFFQyxLQUFLQyxrQkFBUW5GLElBQWYsRUFBcUJHLEtBQUssT0FBS0UsT0FBL0IsRUFBUDtBQWZ5QjtBQWdCNUI7QUFyUHVEO2tCQUF2Q3hCLGlCIiwiZmlsZSI6ImJyb3dzZXIvY29ubmVjdGlvbi9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IE11c3RhY2hlIGZyb20gJ211c3RhY2hlJztcbmltcG9ydCB7IHB1bGwgYXMgcmVtb3ZlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHBhcnNlIGFzIHBhcnNlVXNlckFnZW50IH0gZnJvbSAndXNlcmFnZW50JztcbmltcG9ydCB7IHJlYWRTeW5jIGFzIHJlYWQgfSBmcm9tICdyZWFkLWZpbGUtcmVsYXRpdmUnO1xuaW1wb3J0IHByb21pc2lmeUV2ZW50IGZyb20gJ3Byb21pc2lmeS1ldmVudCc7XG5pbXBvcnQgbmFub2lkIGZyb20gJ25hbm9pZCc7XG5pbXBvcnQgQ09NTUFORCBmcm9tICcuL2NvbW1hbmQnO1xuaW1wb3J0IFNUQVRVUyBmcm9tICcuL3N0YXR1cyc7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgTUVTU0FHRSBmcm9tICcuLi8uLi9lcnJvcnMvcnVudGltZS9tZXNzYWdlJztcblxuY29uc3QgSURMRV9QQUdFX1RFTVBMQVRFID0gcmVhZCgnLi4vLi4vY2xpZW50L2Jyb3dzZXIvaWRsZS1wYWdlL2luZGV4Lmh0bWwubXVzdGFjaGUnKTtcblxudmFyIGNvbm5lY3Rpb25zID0ge307XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJyb3dzZXJDb25uZWN0aW9uIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoZ2F0ZXdheSwgYnJvd3NlckluZm8sIHBlcm1hbmVudCkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuSEVBUlRCRUFUX1RJTUVPVVQgPSAyICogNjAgKiAxMDAwO1xuXG4gICAgICAgIHRoaXMuaWQgICAgICAgICAgICAgICAgICAgICAgID0gQnJvd3NlckNvbm5lY3Rpb24uX2dlbmVyYXRlSWQoKTtcbiAgICAgICAgdGhpcy5qb2JRdWV1ZSAgICAgICAgICAgICAgICAgPSBbXTtcbiAgICAgICAgdGhpcy5pbml0U2NyaXB0c1F1ZXVlICAgICAgICAgPSBbXTtcbiAgICAgICAgdGhpcy5icm93c2VyQ29ubmVjdGlvbkdhdGV3YXkgPSBnYXRld2F5O1xuXG4gICAgICAgIHRoaXMuYnJvd3NlckluZm8gICAgICAgICAgICAgICAgICAgICAgICAgICA9IGJyb3dzZXJJbmZvO1xuICAgICAgICB0aGlzLmJyb3dzZXJJbmZvLnVzZXJBZ2VudCAgICAgICAgICAgICAgICAgPSAnJztcbiAgICAgICAgdGhpcy5icm93c2VySW5mby51c2VyQWdlbnRQcm92aWRlck1ldGFJbmZvID0gJyc7XG5cbiAgICAgICAgdGhpcy5wcm92aWRlciA9IGJyb3dzZXJJbmZvLnByb3ZpZGVyO1xuXG4gICAgICAgIHRoaXMucGVybWFuZW50ICAgICAgICAgPSBwZXJtYW5lbnQ7XG4gICAgICAgIHRoaXMuY2xvc2luZyAgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jbG9zZWQgICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlYWR5ICAgICAgICAgICAgID0gZmFsc2U7XG4gICAgICAgIHRoaXMub3BlbmVkICAgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pZGxlICAgICAgICAgICAgICA9IHRydWU7XG4gICAgICAgIHRoaXMuaGVhcnRiZWF0VGltZW91dCAgPSBudWxsO1xuICAgICAgICB0aGlzLnBlbmRpbmdUZXN0UnVuVXJsID0gbnVsbDtcblxuICAgICAgICB0aGlzLnVybCAgICAgICAgICAgPSBgJHtnYXRld2F5LmRvbWFpbn0vYnJvd3Nlci9jb25uZWN0LyR7dGhpcy5pZH1gO1xuICAgICAgICB0aGlzLmlkbGVVcmwgICAgICAgPSBgJHtnYXRld2F5LmRvbWFpbn0vYnJvd3Nlci9pZGxlLyR7dGhpcy5pZH1gO1xuICAgICAgICB0aGlzLmZvcmNlZElkbGVVcmwgPSBgJHtnYXRld2F5LmRvbWFpbn0vYnJvd3Nlci9pZGxlLWZvcmNlZC8ke3RoaXMuaWR9YDtcbiAgICAgICAgdGhpcy5pbml0U2NyaXB0VXJsID0gYCR7Z2F0ZXdheS5kb21haW59L2Jyb3dzZXIvaW5pdC1zY3JpcHQvJHt0aGlzLmlkfWA7XG5cbiAgICAgICAgdGhpcy5oZWFydGJlYXRSZWxhdGl2ZVVybCAgPSBgL2Jyb3dzZXIvaGVhcnRiZWF0LyR7dGhpcy5pZH1gO1xuICAgICAgICB0aGlzLnN0YXR1c1JlbGF0aXZlVXJsICAgICA9IGAvYnJvd3Nlci9zdGF0dXMvJHt0aGlzLmlkfWA7XG4gICAgICAgIHRoaXMuc3RhdHVzRG9uZVJlbGF0aXZlVXJsID0gYC9icm93c2VyL3N0YXR1cy1kb25lLyR7dGhpcy5pZH1gO1xuXG4gICAgICAgIHRoaXMuaGVhcnRiZWF0VXJsICA9IGAke2dhdGV3YXkuZG9tYWlufSR7dGhpcy5oZWFydGJlYXRSZWxhdGl2ZVVybH1gO1xuICAgICAgICB0aGlzLnN0YXR1c1VybCAgICAgPSBgJHtnYXRld2F5LmRvbWFpbn0ke3RoaXMuc3RhdHVzUmVsYXRpdmVVcmx9YDtcbiAgICAgICAgdGhpcy5zdGF0dXNEb25lVXJsID0gYCR7Z2F0ZXdheS5kb21haW59JHt0aGlzLnN0YXR1c0RvbmVSZWxhdGl2ZVVybH1gO1xuXG4gICAgICAgIHRoaXMub24oJ2Vycm9yJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fZm9yY2VJZGxlKCk7XG4gICAgICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbm5lY3Rpb25zW3RoaXMuaWRdID0gdGhpcztcblxuICAgICAgICB0aGlzLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5zdGFydFNlcnZpbmdDb25uZWN0aW9uKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuX3J1bkJyb3dzZXIoKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX2dlbmVyYXRlSWQgKCkge1xuICAgICAgICByZXR1cm4gbmFub2lkKDcpO1xuICAgIH1cblxuICAgIF9ydW5Ccm93c2VyICgpIHtcbiAgICAgICAgLy8gTk9URTogR2l2ZSBjYWxsZXIgdGltZSB0byBhc3NpZ24gZXZlbnQgbGlzdGVuZXJzXG4gICAgICAgIHByb2Nlc3MubmV4dFRpY2soYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVyLm9wZW5Ccm93c2VyKHRoaXMuaWQsIHRoaXMudXJsLCB0aGlzLmJyb3dzZXJJbmZvLmJyb3dzZXJOYW1lKTtcblxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5yZWFkeSlcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcHJvbWlzaWZ5RXZlbnQodGhpcywgJ3JlYWR5Jyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdvcGVuZWQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEdlbmVyYWxFcnJvcihcbiAgICAgICAgICAgICAgICAgICAgTUVTU0FHRS51bmFibGVUb09wZW5Ccm93c2VyLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJyb3dzZXJJbmZvLnByb3ZpZGVyTmFtZSArICc6JyArIHRoaXMuYnJvd3NlckluZm8uYnJvd3Nlck5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGVyci5zdGFja1xuICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBfY2xvc2VCcm93c2VyICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlkbGUpXG4gICAgICAgICAgICBhd2FpdCBwcm9taXNpZnlFdmVudCh0aGlzLCAnaWRsZScpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVyLmNsb3NlQnJvd3Nlcih0aGlzLmlkKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAvLyBOT1RFOiBBIHdhcm5pbmcgd291bGQgYmUgcmVhbGx5IG5pY2UgaGVyZSwgYnV0IGl0IGNhbid0IGJlIGRvbmUgd2hpbGUgbG9nIGlzIHN0b3JlZCBpbiBhIHRhc2suXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfZm9yY2VJZGxlICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlkbGUpIHtcbiAgICAgICAgICAgIHRoaXMuc3dpdGNoaW5nVG9JZGxlID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLmlkbGUgICAgICAgICAgICA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2lkbGUnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF93YWl0Rm9ySGVhcnRiZWF0ICgpIHtcbiAgICAgICAgdGhpcy5oZWFydGJlYXRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEdlbmVyYWxFcnJvcihNRVNTQUdFLmJyb3dzZXJEaXNjb25uZWN0ZWQsIHRoaXMudXNlckFnZW50KSk7XG4gICAgICAgIH0sIHRoaXMuSEVBUlRCRUFUX1RJTUVPVVQpO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRUZXN0UnVuVXJsIChpc1Rlc3REb25lKSB7XG4gICAgICAgIGlmIChpc1Rlc3REb25lIHx8ICF0aGlzLnBlbmRpbmdUZXN0UnVuVXJsKVxuICAgICAgICAgICAgdGhpcy5wZW5kaW5nVGVzdFJ1blVybCA9IGF3YWl0IHRoaXMuX3BvcE5leHRUZXN0UnVuVXJsKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucGVuZGluZ1Rlc3RSdW5Vcmw7XG4gICAgfVxuXG4gICAgYXN5bmMgX3BvcE5leHRUZXN0UnVuVXJsICgpIHtcbiAgICAgICAgd2hpbGUgKHRoaXMuaGFzUXVldWVkSm9icyAmJiAhdGhpcy5jdXJyZW50Sm9iLmhhc1F1ZXVlZFRlc3RSdW5zKVxuICAgICAgICAgICAgdGhpcy5qb2JRdWV1ZS5zaGlmdCgpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmhhc1F1ZXVlZEpvYnMgPyBhd2FpdCB0aGlzLmN1cnJlbnRKb2IucG9wTmV4dFRlc3RSdW5VcmwodGhpcykgOiBudWxsO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRCeUlkIChpZCkge1xuICAgICAgICByZXR1cm4gY29ubmVjdGlvbnNbaWRdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgYWRkV2FybmluZyAoLi4uYXJncykge1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50Sm9iKVxuICAgICAgICAgICAgdGhpcy5jdXJyZW50Sm9iLndhcm5pbmdMb2cuYWRkV2FybmluZyguLi5hcmdzKTtcbiAgICB9XG5cbiAgICBzZXRQcm92aWRlck1ldGFJbmZvIChzdHIpIHtcbiAgICAgICAgdGhpcy5icm93c2VySW5mby51c2VyQWdlbnRQcm92aWRlck1ldGFJbmZvID0gc3RyO1xuICAgIH1cblxuICAgIGdldCB1c2VyQWdlbnQgKCkge1xuICAgICAgICB2YXIgdXNlckFnZW50ID0gdGhpcy5icm93c2VySW5mby51c2VyQWdlbnQ7XG5cbiAgICAgICAgaWYgKHRoaXMuYnJvd3NlckluZm8udXNlckFnZW50UHJvdmlkZXJNZXRhSW5mbylcbiAgICAgICAgICAgIHVzZXJBZ2VudCArPSBgICgke3RoaXMuYnJvd3NlckluZm8udXNlckFnZW50UHJvdmlkZXJNZXRhSW5mb30pYDtcblxuICAgICAgICByZXR1cm4gdXNlckFnZW50O1xuICAgIH1cblxuICAgIGdldCBoYXNRdWV1ZWRKb2JzICgpIHtcbiAgICAgICAgcmV0dXJuICEhdGhpcy5qb2JRdWV1ZS5sZW5ndGg7XG4gICAgfVxuXG4gICAgZ2V0IGN1cnJlbnRKb2IgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5qb2JRdWV1ZVswXTtcbiAgICB9XG5cbiAgICAvLyBBUElcbiAgICBydW5Jbml0U2NyaXB0IChjb2RlKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHRoaXMuaW5pdFNjcmlwdHNRdWV1ZS5wdXNoKHsgY29kZSwgcmVzb2x2ZSB9KSk7XG4gICAgfVxuXG4gICAgYWRkSm9iIChqb2IpIHtcbiAgICAgICAgdGhpcy5qb2JRdWV1ZS5wdXNoKGpvYik7XG4gICAgfVxuXG4gICAgcmVtb3ZlSm9iIChqb2IpIHtcbiAgICAgICAgcmVtb3ZlKHRoaXMuam9iUXVldWUsIGpvYik7XG4gICAgfVxuXG4gICAgY2xvc2UgKCkge1xuICAgICAgICBpZiAodGhpcy5jbG9zZWQgfHwgdGhpcy5jbG9zaW5nKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuY2xvc2luZyA9IHRydWU7XG5cbiAgICAgICAgdGhpcy5fY2xvc2VCcm93c2VyKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheS5zdG9wU2VydmluZ0Nvbm5lY3Rpb24odGhpcyk7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuaGVhcnRiZWF0VGltZW91dCk7XG5cbiAgICAgICAgICAgICAgICBkZWxldGUgY29ubmVjdGlvbnNbdGhpcy5pZF07XG5cbiAgICAgICAgICAgICAgICB0aGlzLnJlYWR5ICA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnY2xvc2VkJyk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBlc3RhYmxpc2ggKHVzZXJBZ2VudCkge1xuICAgICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcblxuICAgICAgICBjb25zdCBwYXJzZWRVc2VyQWdlbnQgPSBwYXJzZVVzZXJBZ2VudCh1c2VyQWdlbnQpO1xuXG4gICAgICAgIHRoaXMuYnJvd3NlckluZm8udXNlckFnZW50ICAgICAgID0gcGFyc2VkVXNlckFnZW50LnRvU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuYnJvd3NlckluZm8uZnVsbFVzZXJBZ2VudCAgID0gdXNlckFnZW50O1xuICAgICAgICB0aGlzLmJyb3dzZXJJbmZvLnBhcnNlZFVzZXJBZ2VudCA9IHBhcnNlZFVzZXJBZ2VudDtcblxuICAgICAgICB0aGlzLl93YWl0Rm9ySGVhcnRiZWF0KCk7XG4gICAgICAgIHRoaXMuZW1pdCgncmVhZHknKTtcbiAgICB9XG5cbiAgICBoZWFydGJlYXQgKCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5oZWFydGJlYXRUaW1lb3V0KTtcbiAgICAgICAgdGhpcy5fd2FpdEZvckhlYXJ0YmVhdCgpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb2RlOiB0aGlzLmNsb3NpbmcgPyBTVEFUVVMuY2xvc2luZyA6IFNUQVRVUy5vayxcbiAgICAgICAgICAgIHVybDogIHRoaXMuY2xvc2luZyA/IHRoaXMuaWRsZVVybCA6ICcnXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcmVuZGVySWRsZVBhZ2UgKCkge1xuICAgICAgICByZXR1cm4gTXVzdGFjaGUucmVuZGVyKElETEVfUEFHRV9URU1QTEFURSwge1xuICAgICAgICAgICAgdXNlckFnZW50OiAgICAgdGhpcy51c2VyQWdlbnQsXG4gICAgICAgICAgICBzdGF0dXNVcmw6ICAgICB0aGlzLnN0YXR1c1VybCxcbiAgICAgICAgICAgIGhlYXJ0YmVhdFVybDogIHRoaXMuaGVhcnRiZWF0VXJsLFxuICAgICAgICAgICAgaW5pdFNjcmlwdFVybDogdGhpcy5pbml0U2NyaXB0VXJsXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldEluaXRTY3JpcHQgKCkge1xuICAgICAgICB2YXIgaW5pdFNjcmlwdFByb21pc2UgPSB0aGlzLmluaXRTY3JpcHRzUXVldWVbMF07XG5cbiAgICAgICAgcmV0dXJuIHsgY29kZTogaW5pdFNjcmlwdFByb21pc2UgPyBpbml0U2NyaXB0UHJvbWlzZS5jb2RlIDogbnVsbCB9O1xuICAgIH1cblxuICAgIGhhbmRsZUluaXRTY3JpcHRSZXN1bHQgKGRhdGEpIHtcbiAgICAgICAgdmFyIGluaXRTY3JpcHRQcm9taXNlID0gdGhpcy5pbml0U2NyaXB0c1F1ZXVlLnNoaWZ0KCk7XG5cbiAgICAgICAgaWYgKGluaXRTY3JpcHRQcm9taXNlKVxuICAgICAgICAgICAgaW5pdFNjcmlwdFByb21pc2UucmVzb2x2ZShKU09OLnBhcnNlKGRhdGEpKTtcbiAgICB9XG5cbiAgICBhc3luYyByZXBvcnRKb2JSZXN1bHQgKHN0YXR1cywgZGF0YSkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb3ZpZGVyLnJlcG9ydEpvYlJlc3VsdCh0aGlzLmlkLCBzdGF0dXMsIGRhdGEpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFN0YXR1cyAoaXNUZXN0RG9uZSkge1xuICAgICAgICBpZiAoIXRoaXMuaWRsZSAmJiAhaXNUZXN0RG9uZSkge1xuICAgICAgICAgICAgdGhpcy5pZGxlID0gdHJ1ZTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnaWRsZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMub3BlbmVkKSB7XG4gICAgICAgICAgICB2YXIgdGVzdFJ1blVybCA9IGF3YWl0IHRoaXMuX2dldFRlc3RSdW5VcmwoaXNUZXN0RG9uZSk7XG5cbiAgICAgICAgICAgIGlmICh0ZXN0UnVuVXJsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pZGxlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY21kOiBDT01NQU5ELnJ1biwgdXJsOiB0ZXN0UnVuVXJsIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyBjbWQ6IENPTU1BTkQuaWRsZSwgdXJsOiB0aGlzLmlkbGVVcmwgfTtcbiAgICB9XG59XG4iXX0=
